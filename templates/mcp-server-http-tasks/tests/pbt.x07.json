{"decls":[{"kind":"export","names":["pbt.tasks_store_invariants"]},{"body":["begin",["let","doc_b",["ext.json.data_model.parse","list_json"]],["let","doc",["bytes.view","doc_b"]],["if",["=",["ext.data_model.doc_is_err","doc"],1],["return",["bytes.alloc",0]],0],["if",["!=",["ext.data_model.root_kind","doc"],5],["return",["bytes.alloc",0]],0],["let","root",["ext.data_model.root_offset","doc"]],["let","k_next",["bytes.lit","nextCursor"]],["let","off",["ext.data_model.map_find","doc","root",["bytes.view","k_next"]]],["if",["if",["<","off",0],1,["!=",["ext.data_model.kind_at","doc","off"],3]],["return",["bytes.alloc",0]],0],["ext.data_model.string_get","doc","off"]],"kind":"defn","name":"pbt._list_next_cursor_v1","params":[{"name":"list_json","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","doc_b",["ext.json.data_model.parse","list_json"]],["let","doc",["bytes.view","doc_b"]],["if",["=",["ext.data_model.doc_is_err","doc"],1],["return",["bytes.alloc",0]],0],["if",["!=",["ext.data_model.root_kind","doc"],5],["return",["bytes.alloc",0]],0],["let","root",["ext.data_model.root_offset","doc"]],["let","k_tasks",["bytes.lit","tasks"]],["let","tasks_off",["ext.data_model.map_find","doc","root",["bytes.view","k_tasks"]]],["if",["if",["<","tasks_off",0],1,["!=",["ext.data_model.kind_at","doc","tasks_off"],4]],["return",["bytes.alloc",0]],0],["let","task_off",["ext.data_model.seq_get","doc","tasks_off","idx"]],["if",["<","task_off",0],["return",["bytes.alloc",0]],0],["let","k_task_id",["bytes.lit","taskId"]],["let","tid_off",["ext.data_model.map_find","doc","task_off",["bytes.view","k_task_id"]]],["if",["if",["<","tid_off",0],1,["!=",["ext.data_model.kind_at","doc","tid_off"],3]],["return",["bytes.alloc",0]],0],["ext.data_model.string_get","doc","tid_off"]],"kind":"defn","name":"pbt._list_task_id_at_v1","params":[{"name":"list_json","ty":"bytes_view"},{"name":"idx","ty":"i32"}],"result":"bytes"},{"body":["begin",["let","doc_b",["ext.json.data_model.parse","list_json"]],["let","doc",["bytes.view","doc_b"]],["if",["=",["ext.data_model.doc_is_err","doc"],1],["return",-1],0],["if",["!=",["ext.data_model.root_kind","doc"],5],["return",-1],0],["let","root",["ext.data_model.root_offset","doc"]],["let","k_tasks",["bytes.lit","tasks"]],["let","tasks_off",["ext.data_model.map_find","doc","root",["bytes.view","k_tasks"]]],["if",["if",["<","tasks_off",0],1,["!=",["ext.data_model.kind_at","doc","tasks_off"],4]],["return",-1],0],["ext.data_model.seq_len","doc","tasks_off"]],"kind":"defn","name":"pbt._list_tasks_len_v1","params":[{"name":"list_json","ty":"bytes_view"}],"result":"i32"},{"body":["begin",["let","auth_a",["bytes.lit","authA"]],["let","auth_b",["bytes.lit","authB"]],["let","tool_name",["bytes.lit","hello.wait"]],["let","args_json",["bytes.lit","{}"]],["let","progress_token_json",["bytes.lit","null"]],["let","ttl_ms",60000],["let","poll_ms",250],["let","store",["bytes.alloc",0]],["if",["=","store_kind",0],["set","store",["std.mcp.sandbox.task_store_any_v1.new_v1",100]],["begin",["let","db_path",["bytes.lit","../target/x07test/pbt_tasks.sqlite"]],["let","caps_fs",["std.os.fs.spec.caps_default_v1"]],["let","_rm",["std.os.fs.remove_file_v1","db_path","caps_fs"]],["let","db_path2",["bytes.lit","../target/x07test/pbt_tasks.sqlite"]],["let","res",["std.mcp.sandbox.task_store_any_v1.new_sqlite_v1",["bytes.view","db_path2"],100]],["try",["std.test.assert_i32_eq",["result_bytes.err_code","res"],0,3100]],["set","store",["result_bytes.unwrap_or","res",["bytes.alloc",0]]],0]],["let","prefix_a",["bytes.lit","a"]],["let","prefix_b",["bytes.lit","b"]],["for","i",1,6,["begin",["let","task_id",["pbt._task_id_v1",["bytes.view","prefix_a"],"i"]],["let","created_at",["pbt._time_for_i_v1","i"]],["let","req_id_json",["std.fmt.s32_to_dec","i"]],["let","put_res",["std.mcp.sandbox.task_store_any_v1.put_tool_task_new_v1","store",["bytes.view","auth_a"],["bytes.view","task_id"],["bytes.view","created_at"],["bytes.view","created_at"],"ttl_ms","poll_ms",["bytes.view","tool_name"],["bytes.view","args_json"],["bytes.view","req_id_json"],["bytes.view","progress_token_json"]]],["try",["std.test.assert_i32_eq",["result_bytes.err_code","put_res"],0,3101]],["set","store",["result_bytes.unwrap_or","put_res",["bytes.alloc",0]]],0]],["let","b1",["pbt._task_id_v1",["bytes.view","prefix_b"],1]],["let","created_b",["pbt._time_for_i_v1",1]],["let","req_id_b1",["bytes.lit","1"]],["let","putb_res",["std.mcp.sandbox.task_store_any_v1.put_tool_task_new_v1","store",["bytes.view","auth_b"],["bytes.view","b1"],["bytes.view","created_b"],["bytes.view","created_b"],"ttl_ms","poll_ms",["bytes.view","tool_name"],["bytes.view","args_json"],["bytes.view","req_id_b1"],["bytes.view","progress_token_json"]]],["try",["std.test.assert_i32_eq",["result_bytes.err_code","putb_res"],0,3102]],["set","store",["result_bytes.unwrap_or","putb_res",["bytes.alloc",0]]],["let","get_wrong",["std.mcp.sandbox.task_store_any_v1.get_task_json_v1",["bytes.view","store"],["bytes.view","auth_a"],["bytes.view","b1"]]],["try",["std.test.assert_i32_eq",["!=",["result_bytes.err_code","get_wrong"],0],1,3103]],["let","empty_cursor",["bytes.alloc",0]],["let","list_all_res",["std.mcp.sandbox.task_store_any_v1.list_tasks_json_v1",["bytes.view","store"],["bytes.view","auth_a"],["bytes.view","empty_cursor"],10]],["try",["std.test.assert_i32_eq",["result_bytes.err_code","list_all_res"],0,3104]],["let","list_all",["result_bytes.unwrap_or","list_all_res",["bytes.alloc",0]]],["try",["std.test.assert_i32_eq",["pbt._list_tasks_len_v1",["bytes.view","list_all"]],5,3105]],["for","j",0,5,["begin",["let","tid",["pbt._list_task_id_at_v1",["bytes.view","list_all"],"j"]],["try",["std.test.assert_i32_eq",["std.bytes.starts_with",["bytes.view","tid"],["bytes.view","prefix_a"]],1,3106]],0]],["let","page1_res",["std.mcp.sandbox.task_store_any_v1.list_tasks_json_v1",["bytes.view","store"],["bytes.view","auth_a"],["bytes.view","empty_cursor"],2]],["try",["std.test.assert_i32_eq",["result_bytes.err_code","page1_res"],0,3110]],["let","page1",["result_bytes.unwrap_or","page1_res",["bytes.alloc",0]]],["try",["std.test.assert_i32_eq",["pbt._list_tasks_len_v1",["bytes.view","page1"]],2,3111]],["let","c1",["pbt._list_next_cursor_v1",["bytes.view","page1"]]],["try",["std.test.assert_i32_eq",[">",["bytes.len",["bytes.view","c1"]],0],1,3112]],["let","c1_off_res",["std.mcp.sandbox.task_store_any_v1.cursor_decode_v1",["bytes.view","auth_a"],["bytes.view","c1"]]],["try",["std.test.assert_i32_eq",["result_i32.is_ok","c1_off_res"],1,3113]],["let","c1_off",["result_i32.unwrap_or","c1_off_res",-1]],["try",["std.test.assert_i32_eq","c1_off",2,3114]],["let","c1_re",["std.mcp.sandbox.task_store_any_v1.cursor_encode_v1",["bytes.view","auth_a"],"c1_off"]],["try",["std.test.assert_i32_eq",["bytes.eq",["bytes.view","c1_re"],["bytes.view","c1"]],1,3115]],["let","c1_wrong_res",["std.mcp.sandbox.task_store_any_v1.cursor_decode_v1",["bytes.view","auth_b"],["bytes.view","c1"]]],["try",["std.test.assert_i32_eq",["result_i32.is_ok","c1_wrong_res"],0,3116]],["let","page2_res",["std.mcp.sandbox.task_store_any_v1.list_tasks_json_v1",["bytes.view","store"],["bytes.view","auth_a"],["bytes.view","c1"],2]],["try",["std.test.assert_i32_eq",["result_bytes.err_code","page2_res"],0,3120]],["let","page2",["result_bytes.unwrap_or","page2_res",["bytes.alloc",0]]],["try",["std.test.assert_i32_eq",["pbt._list_tasks_len_v1",["bytes.view","page2"]],2,3121]],["let","c2",["pbt._list_next_cursor_v1",["bytes.view","page2"]]],["try",["std.test.assert_i32_eq",[">",["bytes.len",["bytes.view","c2"]],0],1,3122]],["let","c2_off_res",["std.mcp.sandbox.task_store_any_v1.cursor_decode_v1",["bytes.view","auth_a"],["bytes.view","c2"]]],["try",["std.test.assert_i32_eq",["result_i32.is_ok","c2_off_res"],1,3123]],["let","c2_off",["result_i32.unwrap_or","c2_off_res",-1]],["try",["std.test.assert_i32_eq","c2_off",4,3124]],["let","page3_res",["std.mcp.sandbox.task_store_any_v1.list_tasks_json_v1",["bytes.view","store"],["bytes.view","auth_a"],["bytes.view","c2"],2]],["try",["std.test.assert_i32_eq",["result_bytes.err_code","page3_res"],0,3130]],["let","page3",["result_bytes.unwrap_or","page3_res",["bytes.alloc",0]]],["try",["std.test.assert_i32_eq",["pbt._list_tasks_len_v1",["bytes.view","page3"]],1,3131]],["let","c3",["pbt._list_next_cursor_v1",["bytes.view","page3"]]],["try",["std.test.assert_i32_eq",["bytes.len",["bytes.view","c3"]],0,3132]],["let","p1_0",["pbt._list_task_id_at_v1",["bytes.view","page1"],0]],["let","p1_1",["pbt._list_task_id_at_v1",["bytes.view","page1"],1]],["let","p2_0",["pbt._list_task_id_at_v1",["bytes.view","page2"],0]],["let","p2_1",["pbt._list_task_id_at_v1",["bytes.view","page2"],1]],["let","p3_0",["pbt._list_task_id_at_v1",["bytes.view","page3"],0]],["try",["std.test.assert_i32_eq",["std.bytes.starts_with",["bytes.view","p1_0"],["bytes.view","prefix_a"]],1,3140]],["try",["std.test.assert_i32_eq",["std.bytes.starts_with",["bytes.view","p1_1"],["bytes.view","prefix_a"]],1,3141]],["try",["std.test.assert_i32_eq",["std.bytes.starts_with",["bytes.view","p2_0"],["bytes.view","prefix_a"]],1,3142]],["try",["std.test.assert_i32_eq",["std.bytes.starts_with",["bytes.view","p2_1"],["bytes.view","prefix_a"]],1,3143]],["try",["std.test.assert_i32_eq",["std.bytes.starts_with",["bytes.view","p3_0"],["bytes.view","prefix_a"]],1,3144]],["try",["std.test.assert_i32_eq",["bytes.eq",["bytes.view","p1_0"],["bytes.view","p1_1"]],0,3145]],["try",["std.test.assert_i32_eq",["bytes.eq",["bytes.view","p1_0"],["bytes.view","p2_0"]],0,3146]],["try",["std.test.assert_i32_eq",["bytes.eq",["bytes.view","p1_0"],["bytes.view","p2_1"]],0,3147]],["try",["std.test.assert_i32_eq",["bytes.eq",["bytes.view","p1_0"],["bytes.view","p3_0"]],0,3148]],["try",["std.test.assert_i32_eq",["bytes.eq",["bytes.view","p1_1"],["bytes.view","p2_0"]],0,3149]],["try",["std.test.assert_i32_eq",["bytes.eq",["bytes.view","p1_1"],["bytes.view","p2_1"]],0,3150]],["try",["std.test.assert_i32_eq",["bytes.eq",["bytes.view","p1_1"],["bytes.view","p3_0"]],0,3151]],["try",["std.test.assert_i32_eq",["bytes.eq",["bytes.view","p2_0"],["bytes.view","p2_1"]],0,3152]],["try",["std.test.assert_i32_eq",["bytes.eq",["bytes.view","p2_0"],["bytes.view","p3_0"]],0,3153]],["try",["std.test.assert_i32_eq",["bytes.eq",["bytes.view","p2_1"],["bytes.view","p3_0"]],0,3154]],["let","result_json",["bytes.lit","{\"content\":[],\"isError\":false}"]],["let","updated1",["bytes.lit","2026-02-13T00:00:10Z"]],["let","comp_res",["std.mcp.sandbox.task_store_any_v1.set_task_completed_v1","store",["bytes.view","auth_a"],["bytes.view","p1_0"],["bytes.view","updated1"],["bytes.view","result_json"]]],["try",["std.test.assert_i32_eq",["result_bytes.err_code","comp_res"],0,3160]],["set","store",["result_bytes.unwrap_or","comp_res",["bytes.alloc",0]]],["let","st_terminal",["std.mcp.sandbox.task_store_any_v1.get_task_status_v1",["bytes.view","store"],["bytes.view","auth_a"],["bytes.view","p1_0"]]],["try",["std.test.assert_i32_eq","st_terminal",2,31601]],["let","upd2",["bytes.lit","2026-02-13T00:00:11Z"]],["let","fail_status",["bytes.lit","fail"]],["let","fail_detail",["bytes.lit","{}"]],["let","work_res",["std.mcp.sandbox.task_store_any_v1.set_task_working_step_v1","store",["bytes.view","auth_a"],["bytes.view","p1_0"],["bytes.view","upd2"],2,3]],["try",["std.test.assert_i32_eq",["result_bytes.err_code","work_res"],0,3161]],["set","store",["result_bytes.unwrap_or","work_res",["bytes.alloc",0]]],["try",["std.test.assert_i32_eq",["std.mcp.sandbox.task_store_any_v1.get_task_status_v1",["bytes.view","store"],["bytes.view","auth_a"],["bytes.view","p1_0"]],"st_terminal",3162]],["let","fail_res",["std.mcp.sandbox.task_store_any_v1.set_task_failed_with_result_v1","store",["bytes.view","auth_a"],["bytes.view","p1_0"],["bytes.view","upd2"],["bytes.view","fail_status"],["bytes.view","fail_detail"]]],["try",["std.test.assert_i32_eq",["result_bytes.err_code","fail_res"],0,3163]],["set","store",["result_bytes.unwrap_or","fail_res",["bytes.alloc",0]]],["try",["std.test.assert_i32_eq",["std.mcp.sandbox.task_store_any_v1.get_task_status_v1",["bytes.view","store"],["bytes.view","auth_a"],["bytes.view","p1_0"]],"st_terminal",3164]],["let","cancel_err",["bytes.lit","{\"code\":-32000,\"message\":\"Task cancelled\"}"]],["let","cancel_res",["std.mcp.sandbox.task_store_any_v1.set_task_cancelled_v1","store",["bytes.view","auth_a"],["bytes.view","p1_0"],["bytes.view","upd2"],["bytes.view","cancel_err"]]],["try",["std.test.assert_i32_eq",["result_bytes.err_code","cancel_res"],0,3165]],["set","store",["result_bytes.unwrap_or","cancel_res",["bytes.alloc",0]]],["try",["std.test.assert_i32_eq",["std.mcp.sandbox.task_store_any_v1.get_task_status_v1",["bytes.view","store"],["bytes.view","auth_a"],["bytes.view","p1_0"]],"st_terminal",3166]],["let","cancel2_res",["std.mcp.sandbox.task_store_any_v1.set_task_cancelled_v1","store",["bytes.view","auth_a"],["bytes.view","p1_1"],["bytes.view","upd2"],["bytes.view","cancel_err"]]],["try",["std.test.assert_i32_eq",["result_bytes.err_code","cancel2_res"],0,3170]],["set","store",["result_bytes.unwrap_or","cancel2_res",["bytes.alloc",0]]],["let","st_cancel",["std.mcp.sandbox.task_store_any_v1.get_task_status_v1",["bytes.view","store"],["bytes.view","auth_a"],["bytes.view","p1_1"]]],["let","comp2_res",["std.mcp.sandbox.task_store_any_v1.set_task_completed_v1","store",["bytes.view","auth_a"],["bytes.view","p1_1"],["bytes.view","upd2"],["bytes.view","result_json"]]],["try",["std.test.assert_i32_eq",["result_bytes.err_code","comp2_res"],0,3171]],["set","store",["result_bytes.unwrap_or","comp2_res",["bytes.alloc",0]]],["try",["std.test.assert_i32_eq",["std.mcp.sandbox.task_store_any_v1.get_task_status_v1",["bytes.view","store"],["bytes.view","auth_a"],["bytes.view","p1_1"]],"st_cancel",3172]],["let","fail2_res",["std.mcp.sandbox.task_store_any_v1.set_task_failed_with_result_v1","store",["bytes.view","auth_a"],["bytes.view","p1_1"],["bytes.view","upd2"],["bytes.view","fail_status"],["bytes.view","fail_detail"]]],["try",["std.test.assert_i32_eq",["result_bytes.err_code","fail2_res"],0,3173]],["set","store",["result_bytes.unwrap_or","fail2_res",["bytes.alloc",0]]],["try",["std.test.assert_i32_eq",["std.mcp.sandbox.task_store_any_v1.get_task_status_v1",["bytes.view","store"],["bytes.view","auth_a"],["bytes.view","p1_1"]],"st_cancel",3174]],["std.test.pass"]],"kind":"defn","name":"pbt._run_for_store_v1","params":[{"name":"store_kind","ty":"i32"}],"result":"result_i32"},{"body":["begin",["let","i_dec",["std.fmt.s32_to_dec",["if",["<","i",0],0,"i"]]],["std.bytes.concat","prefix",["bytes.view","i_dec"]]],"kind":"defn","name":"pbt._task_id_v1","params":[{"name":"prefix","ty":"bytes_view"},{"name":"i","ty":"i32"}],"result":"bytes"},{"body":["begin",["let","base",["bytes.lit","2037-01-01T00:00:0"]],["let","z",["bytes.lit","Z"]],["let","i_dec",["std.fmt.s32_to_dec",["if",["<","i",0],0,"i"]]],["let","t1",["std.bytes.concat",["bytes.view","base"],["bytes.view","i_dec"]]],["std.bytes.concat",["bytes.view","t1"],["bytes.view","z"]]],"kind":"defn","name":"pbt._time_for_i_v1","params":[{"name":"i","ty":"i32"}],"result":"bytes"},{"body":["begin",["try",["pbt._run_for_store_v1",0]],["try",["pbt._run_for_store_v1",1]],["std.test.pass"]],"kind":"defn","name":"pbt.tasks_store_invariants","params":[],"result":"result_i32"}],"imports":["ext.data_model","ext.json.data_model","std.bytes","std.fmt","std.mcp.sandbox.task_store_any_v1","std.os.fs","std.os.fs.spec","std.test"],"kind":"module","module_id":"pbt","schema_version":"x07.x07ast@0.5.0"}
