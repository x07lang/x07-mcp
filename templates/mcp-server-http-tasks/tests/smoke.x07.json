{"decls":[{"kind":"export","names":["smoke.tasks_replay","smoke.tasks_sqlite_restart"]},{"body":["begin",["if",["<u",["view.len","pack"],12],["return",["bytes.alloc",0]],0],["if",["!=",["codec.read_u32_le","pack",0],1],["return",["bytes.alloc",0]],0],["let","ns_len",["codec.read_u32_le","pack",4]],["if",["<","ns_len",0],["return",["bytes.alloc",0]],0],["if",["<u",["view.len","pack"],["+",12,"ns_len"]],["return",["bytes.alloc",0]],0],["view.to_bytes",["view.slice","pack",8,"ns_len"]]],"kind":"defn","name":"smoke._dispatch_next_state_v1","params":[{"name":"pack","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["if",["<u",["view.len","pack"],12],["return",["bytes.alloc",0]],0],["if",["!=",["codec.read_u32_le","pack",0],1],["return",["bytes.alloc",0]],0],["let","ns_len",["codec.read_u32_le","pack",4]],["if",["<","ns_len",0],["return",["bytes.alloc",0]],0],["let","off2",["+",8,"ns_len"]],["if",["<u",["view.len","pack"],["+","off2",4]],["return",["bytes.alloc",0]],0],["let","out_len",["codec.read_u32_le","pack","off2"]],["if",["<","out_len",0],["return",["bytes.alloc",0]],0],["let","start",["+","off2",4]],["if",["<u",["view.len","pack"],["+","start","out_len"]],["return",["bytes.alloc",0]],0],["view.to_bytes",["view.slice","pack","start","out_len"]]],"kind":"defn","name":"smoke._dispatch_out_jsonl_v1","params":[{"name":"pack","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","n",["view.len","jsonl"]],["for","i",0,"n",["begin",["if",["=",["view.get_u8","jsonl","i"],10],["return",["view.to_bytes",["view.slice","jsonl",0,"i"]]],0],0]],["view.to_bytes","jsonl"]],"kind":"defn","name":"smoke._jsonl_first_line_v1","params":[{"name":"jsonl","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","id_dec",["std.fmt.s32_to_dec","want_id"]],["let","pfx",["bytes.lit","\"id\":"]],["let","needle",["std.bytes.concat",["bytes.view","pfx"],["bytes.view","id_dec"]]],["let","n",["view.len","jsonl"]],["let","line_start",0],["let","empty",["bytes.alloc",0]],["for","i",0,"n",["begin",["if",["=",["view.get_u8","jsonl","i"],10],["begin",["let","line",["view.slice","jsonl","line_start",["-","i","line_start"]]],["set","line_start",["+","i",1]],["if",["=",["view.len","line"],0],0,["if",["=",["smoke._view_contains_v1","line",["bytes.view","needle"]],1],["return",["view.to_bytes","line"]],0]],0],0],0]],["if",["<","line_start","n"],["begin",["let","tail",["view.slice","jsonl","line_start",["-","n","line_start"]]],["if",["=",["view.len","tail"],0],0,["if",["=",["smoke._view_contains_v1","tail",["bytes.view","needle"]],1],["return",["view.to_bytes","tail"]],0]],0],0],"empty"],"kind":"defn","name":"smoke._jsonl_response_line_by_id_v1","params":[{"name":"jsonl","ty":"bytes_view"},{"name":"want_id","ty":"i32"}],"result":"bytes"},{"body":["begin",["let","nh",["view.len","hay"]],["let","nn",["view.len","needle"]],["if",["=","nn",0],["return",1],0],["if",["<u","nh","nn"],["return",0],0],["let","limit",["-","nh","nn"]],["for","i",0,["+","limit",1],["begin",["if",["=",["view.cmp_range","hay","i","nn","needle",0,"nn"],0],["return",1],0],0]],0],"kind":"defn","name":"smoke._view_contains_v1","params":[{"name":"hay","ty":"bytes_view"},{"name":"needle","ty":"bytes_view"}],"result":"i32"},{"body":["begin",["try",["ext.mcp.rr.replay_from_fs_v1",["bytes.lit","../mcp.server.json"],["bytes.lit","fixtures/rr/hello_tasks.jsonl"]]],["std.test.pass"]],"kind":"defn","name":"smoke.tasks_replay","params":[],"result":"result_i32"},{"body":["begin",["let","cfg_path",["bytes.lit","../mcp.server.sqlite.json"]],["let","db_path",["bytes.lit","../target/x07test/tasks_restart.sqlite"]],["let","caps_fs",["std.os.fs.spec.caps_default_v1"]],["let","_rm",["std.os.fs.remove_file_v1","db_path","caps_fs"]],["let","router_res",["ext.mcp.server.make_router_from_fs_v1",["bytes.view","cfg_path"]]],["try",["std.test.assert_i32_eq",["result_bytes.err_code","router_res"],0,2001]],["let","router",["result_bytes.unwrap_or","router_res",["bytes.alloc",0]]],["let","router_b",["std.bytes.copy",["bytes.view","router"]]],["let","router_v",["bytes.view","router_b"]],["let","store_mode",["codec.read_u32_le","router_v",56]],["try",["std.test.assert_i32_eq","store_mode",1,1998]],["let","fixed",92],["let","name_len",["codec.read_u32_le","router_v",60]],["let","ver_len",["codec.read_u32_le","router_v",64]],["let","proto_len",["codec.read_u32_le","router_v",68]],["let","idp_len",["codec.read_u32_le","router_v",72]],["let","tools_len",["codec.read_u32_le","router_v",76]],["let","adv_len",["codec.read_u32_le","router_v",80]],["let","auth_len",["codec.read_u32_le","router_v",84]],["let","store_len",["codec.read_u32_le","router_v",88]],["let","store_start",["+","fixed",["+","name_len",["+","ver_len",["+","proto_len",["+","idp_len",["+","tools_len",["+","adv_len","auth_len"]]]]]]]],["let","store_v",["view.slice","router_v","store_start","store_len"]],["let","store_kind",["codec.read_u32_le","store_v",4]],["try",["std.test.assert_i32_eq","store_kind",1,1997]],["let","req_tool",["bytes.lit","{\"jsonrpc\":\"2.0\",\"id\":1,\"method\":\"tools/call\",\"params\":{\"name\":\"hello.wait\",\"arguments\":{\"steps\":2},\"task\":{\"ttl\":60000}}}"]],["let","dispatch_res",["ext.mcp.server.dispatch_jsonrpc_v1",["bytes.view","router"],["bytes.view","req_tool"]]],["try",["std.test.assert_i32_eq",["result_bytes.err_code","dispatch_res"],0,2002]],["let","dispatch_pack",["result_bytes.unwrap_or","dispatch_res",["bytes.alloc",0]]],["let","next_router",["smoke._dispatch_next_state_v1",["bytes.view","dispatch_pack"]]],["let","out_jsonl",["smoke._dispatch_out_jsonl_v1",["bytes.view","dispatch_pack"]]],["let","out_line",["smoke._jsonl_response_line_by_id_v1",["bytes.view","out_jsonl"],1]],["set","router","next_router"],["let","doc_b",["ext.json.data_model.parse",["bytes.view","out_line"]]],["let","doc",["bytes.view","doc_b"]],["try",["std.test.assert_i32_eq",["ext.data_model.doc_is_err","doc"],0,2003]],["let","root",["ext.data_model.root_offset","doc"]],["let","k_result",["bytes.lit","result"]],["let","result_off",["ext.data_model.map_find","doc","root",["bytes.view","k_result"]]],["try",["std.test.assert_i32_eq",[">=","result_off",0],1,2004]],["let","k_task",["bytes.lit","task"]],["let","task_off",["ext.data_model.map_find","doc","result_off",["bytes.view","k_task"]]],["try",["std.test.assert_i32_eq",[">=","task_off",0],1,2005]],["let","k_task_id",["bytes.lit","taskId"]],["let","task_id_off",["ext.data_model.map_find","doc","task_off",["bytes.view","k_task_id"]]],["try",["std.test.assert_i32_eq",[">=","task_id_off",0],1,2006]],["let","task_id",["ext.data_model.string_get","doc","task_id_off"]],["try",["std.test.assert_i32_eq",[">",["bytes.len",["bytes.view","task_id"]],0],1,2007]],["let","router2_res",["ext.mcp.server.make_router_from_fs_v1",["bytes.view","cfg_path"]]],["try",["std.test.assert_i32_eq",["result_bytes.err_code","router2_res"],0,2008]],["let","router2",["result_bytes.unwrap_or","router2_res",["bytes.alloc",0]]],["let","pfx",["bytes.lit","{\"jsonrpc\":\"2.0\",\"id\":2,\"method\":\"tasks/get\",\"params\":{\"taskId\":"]],["let","q",["bytes.lit","\""]],["let","t0",["std.bytes.concat",["bytes.view","pfx"],["bytes.view","q"]]],["let","t1",["std.bytes.concat",["bytes.view","t0"],["bytes.view","task_id"]]],["let","t2",["std.bytes.concat",["bytes.view","t1"],["bytes.view","q"]]],["let","sfx",["bytes.lit","}}"]],["let","req_get",["std.bytes.concat",["bytes.view","t2"],["bytes.view","sfx"]]],["let","dispatch2_res",["ext.mcp.server.dispatch_jsonrpc_v1",["bytes.view","router2"],["bytes.view","req_get"]]],["try",["std.test.assert_i32_eq",["result_bytes.err_code","dispatch2_res"],0,2009]],["let","dispatch2_pack",["result_bytes.unwrap_or","dispatch2_res",["bytes.alloc",0]]],["let","out2",["smoke._dispatch_out_jsonl_v1",["bytes.view","dispatch2_pack"]]],["let","out2_line",["smoke._jsonl_response_line_by_id_v1",["bytes.view","out2"],2]],["let","doc2_b",["ext.json.data_model.parse",["bytes.view","out2_line"]]],["let","doc2",["bytes.view","doc2_b"]],["try",["std.test.assert_i32_eq",["ext.data_model.doc_is_err","doc2"],0,2010]],["let","root2",["ext.data_model.root_offset","doc2"]],["let","result2_off",["ext.data_model.map_find","doc2","root2",["bytes.view","k_result"]]],["try",["std.test.assert_i32_eq",[">=","result2_off",0],1,2011]],["let","k_status",["bytes.lit","status"]],["let","status_off",["ext.data_model.map_find","doc2","result2_off",["bytes.view","k_status"]]],["try",["std.test.assert_i32_eq",[">=","status_off",0],1,2012]],["let","status_txt",["ext.data_model.string_get","doc2","status_off"]],["let","want_failed",["bytes.lit","failed"]],["try",["std.test.assert_i32_eq",["bytes.eq",["bytes.view","status_txt"],["bytes.view","want_failed"]],1,2013]],["let","k_status_msg",["bytes.lit","statusMessage"]],["let","msg_off",["ext.data_model.map_find","doc2","result2_off",["bytes.view","k_status_msg"]]],["try",["std.test.assert_i32_eq",[">=","msg_off",0],1,2014]],["let","msg_txt",["ext.data_model.string_get","doc2","msg_off"]],["let","want_msg",["bytes.lit","server restarted"]],["try",["std.test.assert_i32_eq",["bytes.eq",["bytes.view","msg_txt"],["bytes.view","want_msg"]],1,2015]],["std.test.pass"]],"kind":"defn","name":"smoke.tasks_sqlite_restart","params":[],"result":"result_i32"}],"imports":["ext.data_model","ext.json.data_model","ext.mcp.rr","ext.mcp.server","mcp.user","std.bytes","std.codec","std.fmt","std.os.fs","std.os.fs.spec","std.test"],"kind":"module","module_id":"smoke","schema_version":"x07.x07ast@0.5.0"}
