{
  "schema_version": "x07.x07ast@0.5.0",
  "kind": "module",
  "module_id": "std.mcp.sandbox.worker_proto",
  "imports": ["ext.data_model", "ext.json.data_model", "std.mcp.util.json"],
  "decls": [
    {
      "kind": "export",
      "names": [
        "std.mcp.sandbox.worker_proto.make_request_v1",
        "std.mcp.sandbox.worker_proto.parse_tool_result_v1"
      ]
    },
    {
      "kind": "defn",
      "name": "std.mcp.sandbox.worker_proto._err_invalid_worker_response_v1",
      "params": [],
      "result": "i32",
      "body": 7301
    },
    {
      "kind": "defn",
      "name": "std.mcp.sandbox.worker_proto._err_missing_tool_result_v1",
      "params": [],
      "result": "i32",
      "body": 7302
    },
    {
      "kind": "defn",
      "name": "std.mcp.sandbox.worker_proto.make_request_v1",
      "params": [
        { "name": "tool_name", "ty": "bytes_view" },
        { "name": "ctx_json", "ty": "bytes_view" },
        { "name": "args_json", "ty": "bytes_view" },
        { "name": "tools_registry_json", "ty": "bytes_view" }
      ],
      "result": "bytes",
      "body": [
        "begin",
        ["let", "k_proto", ["bytes.lit", "x07McpWorkerProtocol"]],
        ["let", "k_tool", ["bytes.lit", "tool"]],
        ["let", "k_ctx", ["bytes.lit", "ctx"]],
        ["let", "k_args", ["bytes.lit", "args"]],
        ["let", "k_tools", ["bytes.lit", "tools"]],
        ["let", "v_proto", ["ext.data_model.value_number", ["bytes.view", ["bytes.lit", "1"]]]],
        ["let", "v_tool", ["ext.data_model.value_string", "tool_name"]],
        ["let", "v_ctx", ["std.mcp.util.json.value_from_json_or_empty_map_v1", "ctx_json"]],
        ["let", "v_args", ["std.mcp.util.json.value_from_json_or_empty_map_v1", "args_json"]],
        ["let", "v_tools", ["std.mcp.util.json.value_from_json_or_empty_map_v1", "tools_registry_json"]],
        ["let", "entries", ["vec_u8.with_capacity", 512]],
        ["set", "entries", ["vec_u8.extend_bytes", "entries", ["codec.write_u32_le", 5]]],
        ["set", "entries", ["vec_u8.extend_bytes", "entries", ["codec.write_u32_le", ["bytes.len", "k_args"]]]],
        ["set", "entries", ["vec_u8.extend_bytes", "entries", "k_args"]],
        ["set", "entries", ["vec_u8.extend_bytes", "entries", ["codec.write_u32_le", ["bytes.len", "v_args"]]]],
        ["set", "entries", ["vec_u8.extend_bytes", "entries", "v_args"]],
        ["set", "entries", ["vec_u8.extend_bytes", "entries", ["codec.write_u32_le", ["bytes.len", "k_ctx"]]]],
        ["set", "entries", ["vec_u8.extend_bytes", "entries", "k_ctx"]],
        ["set", "entries", ["vec_u8.extend_bytes", "entries", ["codec.write_u32_le", ["bytes.len", "v_ctx"]]]],
        ["set", "entries", ["vec_u8.extend_bytes", "entries", "v_ctx"]],
        ["set", "entries", ["vec_u8.extend_bytes", "entries", ["codec.write_u32_le", ["bytes.len", "k_proto"]]]],
        ["set", "entries", ["vec_u8.extend_bytes", "entries", "k_proto"]],
        ["set", "entries", ["vec_u8.extend_bytes", "entries", ["codec.write_u32_le", ["bytes.len", "v_proto"]]]],
        ["set", "entries", ["vec_u8.extend_bytes", "entries", "v_proto"]],
        ["set", "entries", ["vec_u8.extend_bytes", "entries", ["codec.write_u32_le", ["bytes.len", "k_tool"]]]],
        ["set", "entries", ["vec_u8.extend_bytes", "entries", "k_tool"]],
        ["set", "entries", ["vec_u8.extend_bytes", "entries", ["codec.write_u32_le", ["bytes.len", "v_tool"]]]],
        ["set", "entries", ["vec_u8.extend_bytes", "entries", "v_tool"]],
        ["set", "entries", ["vec_u8.extend_bytes", "entries", ["codec.write_u32_le", ["bytes.len", "k_tools"]]]],
        ["set", "entries", ["vec_u8.extend_bytes", "entries", "k_tools"]],
        ["set", "entries", ["vec_u8.extend_bytes", "entries", ["codec.write_u32_le", ["bytes.len", "v_tools"]]]],
        ["set", "entries", ["vec_u8.extend_bytes", "entries", "v_tools"]],
        ["let", "entries_b", ["vec_u8.into_bytes", "entries"]],
        ["let", "req_val", ["ext.data_model.value_map_from_entries", ["bytes.view", "entries_b"]]],
        ["if", ["=", ["bytes.len", "req_val"], 0], ["return", ["bytes.alloc", 0]], 0],
        ["std.mcp.util.json.json_from_value_v1", ["bytes.view", "req_val"]]
      ]
    },
    {
      "kind": "defn",
      "name": "std.mcp.sandbox.worker_proto.parse_tool_result_v1",
      "params": [{ "name": "resp_json", "ty": "bytes_view" }],
      "result": "result_bytes",
      "body": [
        "begin",
        ["let", "doc_b", ["ext.json.data_model.parse", "resp_json"]],
        ["let", "doc", ["bytes.view", "doc_b"]],
        ["if", ["=", ["ext.data_model.doc_is_err", "doc"], 1], ["return", ["result_bytes.err", ["std.mcp.sandbox.worker_proto._err_invalid_worker_response_v1"]]], 0],
        ["if", ["!=", ["ext.data_model.root_kind", "doc"], 5], ["return", ["result_bytes.err", ["std.mcp.sandbox.worker_proto._err_invalid_worker_response_v1"]]], 0],
        ["let", "root", ["ext.data_model.root_offset", "doc"]],
        ["let", "k_tool_result", ["bytes.lit", "toolResult"]],
        ["let", "tr_off", ["ext.data_model.map_find", "doc", "root", ["bytes.view", "k_tool_result"]]],
        ["if", ["<", "tr_off", 0], ["return", ["result_bytes.err", ["std.mcp.sandbox.worker_proto._err_missing_tool_result_v1"]]], 0],
        ["let", "end", ["ext.data_model.skip_value", "doc", "tr_off"]],
        ["if", ["<", "end", 0], ["return", ["result_bytes.err", ["std.mcp.sandbox.worker_proto._err_invalid_worker_response_v1"]]], 0],
        ["let", "val", ["view.to_bytes", ["view.slice", "doc", "tr_off", ["-", "end", "tr_off"]]]],
        ["let", "json", ["std.mcp.util.json.json_from_value_v1", ["bytes.view", "val"]]],
        ["result_bytes.ok", "json"]
      ]
    }
  ]
}
