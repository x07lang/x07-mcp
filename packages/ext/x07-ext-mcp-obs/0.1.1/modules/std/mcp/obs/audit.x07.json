{"decls":[{"kind":"export","names":["std.mcp.obs.audit.emit_jsonl_v1","std.mcp.obs.audit.emit_v1","std.mcp.obs.audit.event_build_tool_invocation_v1","std.mcp.obs.audit.sink_jsonl_file_v1","std.mcp.obs.audit.sink_jsonl_stderr_v1"]},{"body":["begin",["let","sn",["view.len","s"]],["let","pn",["view.len","prefix"]],["if",["=","pn",0],["return",1],0],["if",["<","sn","pn"],["return",0],0],["for","i",0,"pn",["if",["!=",["view.get_u8","s","i"],["view.get_u8","prefix","i"]],["return",0],0]],1],"kind":"defn","name":"std.mcp.obs.audit._has_prefix_v1","params":[{"name":"s","ty":"bytes_view"},{"name":"prefix","ty":"bytes_view"}],"result":"i32"},{"body":["begin",["let","out",["vec_u8.with_capacity",["+",["view.len","event_json"],1]]],["set","out",["vec_u8.extend_bytes","out","event_json"]],["set","out",["vec_u8.push","out",10]],["let","line",["vec_u8.into_bytes","out"]],["let","caps",["std.os.stdio.spec.caps_default_v1"]],["let","sink_stderr",["bytes.lit","stderr_jsonl"]],["if",["=",["view.eq","sink",["bytes.view","sink_stderr"]],1],["begin",["let","w",["std.os.stdio.write_stderr_v1","line","caps"]],["result_i32.err_code","w"]],["begin",["let","w",["std.os.stdio.write_stdout_v1","line","caps"]],["result_i32.err_code","w"]]]],"kind":"defn","name":"std.mcp.obs.audit.emit_jsonl_v1","params":[{"name":"sink","ty":"bytes_view"},{"name":"event_json","ty":"bytes_view"}],"result":"i32"},{"body":["begin",["let","out",["vec_u8.with_capacity",["+",["view.len","event_json"],1]]],["set","out",["vec_u8.extend_bytes","out","event_json"]],["set","out",["vec_u8.push","out",10]],["let","line",["vec_u8.into_bytes","out"]],["let","caps_stdio",["std.os.stdio.spec.caps_default_v1"]],["let","sink_stderr_v1",["bytes.lit","stderr_jsonl_v1"]],["let","sink_stderr_legacy",["bytes.lit","stderr_jsonl"]],["if",["|",["=",["view.eq","sink_handle",["bytes.view","sink_stderr_v1"]],1],["=",["view.eq","sink_handle",["bytes.view","sink_stderr_legacy"]],1]],["std.os.stdio.write_stderr_v1","line","caps_stdio"],["begin",["let","pfx_file",["bytes.lit","file:"]],["let","is_file",["std.mcp.obs.audit._has_prefix_v1","sink_handle",["bytes.view","pfx_file"]]],["if",["=","is_file",1],["begin",["let","sn",["view.len","sink_handle"]],["let","pn",["view.len",["bytes.view","pfx_file"]]],["let","path",["view.to_bytes",["view.slice","sink_handle","pn",["-","sn","pn"]]]],["let","path_read",["std.bytes.copy",["bytes.view","path"]]],["let","caps_fs",["std.os.fs.spec.caps_default_v1"]],["let","caps_fs_read",["std.bytes.copy",["bytes.view","caps_fs"]]],["let","read_res",["std.os.fs.read_all_v1","path_read","caps_fs_read"]],["let","existing",["bytes.alloc",0]],["if",["=",["result_bytes.is_ok","read_res"],1],["begin",["set","existing",["result_bytes.unwrap_or","read_res",["bytes.alloc",0]]],0],["begin",["let","code",["result_bytes.err_code","read_res"]],["if",["!=","code",["std.os.fs.spec.err_not_found_v1"]],["return",["result_i32.err","code"]],0]]],["let","combined",["std.bytes.concat",["bytes.view","existing"],["bytes.view","line"]]],["std.os.fs.write_all_v1","path","combined","caps_fs"]],["result_i32.err",1]]]]],"kind":"defn","name":"std.mcp.obs.audit.emit_v1","params":[{"name":"sink_handle","ty":"bytes_view"},{"name":"event_json","ty":"bytes_view"}],"result":"result_i32"},{"body":["begin",["let","lit_prefix",["bytes.lit","{\"auth\":{\"mode\":\""]],["let","lit_auth_principal",["bytes.lit","\",\"principal\":"]],["let","lit_auth_scopes",["bytes.lit",",\"scopes\":"]],["let","lit_after_auth",["bytes.lit","},\"invocationId\":\""]],["let","lit_after_inv",["bytes.lit","\",\"kind\":\"tool.invocation\",\"mcp\":{\"requestId\":"]],["let","lit_after_mcp",["bytes.lit","},\"outcome\":{\"isError\":"]],["let","lit_after_outcome",["bytes.lit","},\"policy\":{\"budgets\":"]],["let","lit_after_budgets",["bytes.lit",",\"sandbox\":"]],["let","lit_after_policy",["bytes.lit","},\"schema_version\":\"x07.mcp.audit_event@0.1.0\",\"timing\":{\"durationMs\":"]],["let","lit_after_timing",["bytes.lit","},\"tool\":\""]],["let","lit_quote",["bytes.lit","\""]],["let","lit_tooltags_key",["bytes.lit",",\"toolTags\":"]],["let","lit_ts",["bytes.lit",",\"ts\":\""]],["let","lit_end",["bytes.lit","\"}"]],["let","lit_none",["bytes.lit","none"]],["let","lit_null",["bytes.lit","null"]],["let","lit_empty_arr",["bytes.lit","[]"]],["let","lit_empty_obj",["bytes.lit","{}"]],["let","auth_mode_b",["if",[">",["view.len","auth_mode_utf8"],0],["view.to_bytes","auth_mode_utf8"],"lit_none"]],["let","auth_mode_v",["bytes.view","auth_mode_b"]],["let","principal_b",["if",[">",["view.len","principal_json"],0],["view.to_bytes","principal_json"],["view.to_bytes",["bytes.view","lit_null"]]]],["let","principal_v",["bytes.view","principal_b"]],["let","scopes_b",["if",[">",["view.len","scopes_json"],0],["view.to_bytes","scopes_json"],"lit_empty_arr"]],["let","scopes_v",["bytes.view","scopes_b"]],["let","sandbox_b",["if",[">",["view.len","sandbox_json"],0],["view.to_bytes","sandbox_json"],["view.to_bytes",["bytes.view","lit_empty_obj"]]]],["let","sandbox_v",["bytes.view","sandbox_b"]],["let","budgets_b",["if",[">",["view.len","budgets_json"],0],["view.to_bytes","budgets_json"],["view.to_bytes",["bytes.view","lit_empty_obj"]]]],["let","budgets_v",["bytes.view","budgets_b"]],["let","request_id_b",["if",[">",["view.len","request_id_json"],0],["view.to_bytes","request_id_json"],["view.to_bytes",["bytes.view","lit_null"]]]],["let","request_id_v",["bytes.view","request_id_b"]],["let","lit_true",["bytes.lit","true"]],["let","lit_false",["bytes.lit","false"]],["let","is_error_b",["if",["=","is_error",1],"lit_true","lit_false"]],["let","is_error_v",["bytes.view","is_error_b"]],["let","duration_s",["std.fmt.s32_to_dec","duration_ms"]],["let","duration_v",["bytes.view","duration_s"]],["let","has_tags",[">",["view.len","tool_tags_json"],0]],["let","tags_len",["if",["=","has_tags",1],["view.len","tool_tags_json"],0]],["let","cap",["+",256,["+",["view.len","ts_utf8"],["+",["view.len","tool_utf8"],["+",["view.len","invocation_id_utf8"],["+",["view.len","auth_mode_v"],["+",["view.len","principal_v"],["+",["view.len","scopes_v"],["+",["view.len","request_id_v"],["+",["view.len","budgets_v"],["+",["view.len","sandbox_v"],["+",["view.len","is_error_v"],["+",["bytes.len",["bytes.view","duration_s"]],"tags_len"]]]]]]]]]]]]],["let","buf",["vec_u8.with_capacity","cap"]],["set","buf",["vec_u8.extend_bytes","buf",["bytes.view","lit_prefix"]]],["set","buf",["vec_u8.extend_bytes","buf","auth_mode_v"]],["set","buf",["vec_u8.extend_bytes","buf",["bytes.view","lit_auth_principal"]]],["set","buf",["vec_u8.extend_bytes","buf","principal_v"]],["set","buf",["vec_u8.extend_bytes","buf",["bytes.view","lit_auth_scopes"]]],["set","buf",["vec_u8.extend_bytes","buf","scopes_v"]],["set","buf",["vec_u8.extend_bytes","buf",["bytes.view","lit_after_auth"]]],["set","buf",["vec_u8.extend_bytes","buf","invocation_id_utf8"]],["set","buf",["vec_u8.extend_bytes","buf",["bytes.view","lit_after_inv"]]],["set","buf",["vec_u8.extend_bytes","buf","request_id_v"]],["set","buf",["vec_u8.extend_bytes","buf",["bytes.view","lit_after_mcp"]]],["set","buf",["vec_u8.extend_bytes","buf","is_error_v"]],["set","buf",["vec_u8.extend_bytes","buf",["bytes.view","lit_after_outcome"]]],["set","buf",["vec_u8.extend_bytes","buf","budgets_v"]],["set","buf",["vec_u8.extend_bytes","buf",["bytes.view","lit_after_budgets"]]],["set","buf",["vec_u8.extend_bytes","buf","sandbox_v"]],["set","buf",["vec_u8.extend_bytes","buf",["bytes.view","lit_after_policy"]]],["set","buf",["vec_u8.extend_bytes","buf","duration_v"]],["set","buf",["vec_u8.extend_bytes","buf",["bytes.view","lit_after_timing"]]],["set","buf",["vec_u8.extend_bytes","buf","tool_utf8"]],["set","buf",["vec_u8.extend_bytes","buf",["bytes.view","lit_quote"]]],["if",["=","has_tags",1],["begin",["set","buf",["vec_u8.extend_bytes","buf",["bytes.view","lit_tooltags_key"]]],["set","buf",["vec_u8.extend_bytes","buf","tool_tags_json"]],0],0],["set","buf",["vec_u8.extend_bytes","buf",["bytes.view","lit_ts"]]],["set","buf",["vec_u8.extend_bytes","buf","ts_utf8"]],["set","buf",["vec_u8.extend_bytes","buf",["bytes.view","lit_end"]]],["vec_u8.into_bytes","buf"]],"kind":"defn","name":"std.mcp.obs.audit.event_build_tool_invocation_v1","params":[{"name":"ts_utf8","ty":"bytes_view"},{"name":"tool_utf8","ty":"bytes_view"},{"name":"invocation_id_utf8","ty":"bytes_view"},{"name":"request_id_json","ty":"bytes_view"},{"name":"auth_mode_utf8","ty":"bytes_view"},{"name":"principal_json","ty":"bytes_view"},{"name":"scopes_json","ty":"bytes_view"},{"name":"sandbox_json","ty":"bytes_view"},{"name":"budgets_json","ty":"bytes_view"},{"name":"tool_tags_json","ty":"bytes_view"},{"name":"is_error","ty":"i32"},{"name":"duration_ms","ty":"i32"}],"result":"bytes"},{"body":["begin",["let","doc_b",["ext.json.data_model.parse","cfg_json"]],["let","doc",["bytes.view","doc_b"]],["if",["=",["ext.data_model.doc_is_err","doc"],1],["return",["bytes.alloc",0]],0],["if",["!=",["ext.data_model.root_kind","doc"],5],["return",["bytes.alloc",0]],0],["let","root",["ext.data_model.root_offset","doc"]],["let","k_path",["bytes.lit","path"]],["let","path_off",["ext.data_model.map_find","doc","root",["bytes.view","k_path"]]],["if",["<","path_off",0],["return",["bytes.alloc",0]],0],["if",["!=",["ext.data_model.kind_at","doc","path_off"],3],["return",["bytes.alloc",0]],0],["let","path",["ext.data_model.string_get","doc","path_off"]],["if",["=",["bytes.len","path"],0],["return",["bytes.alloc",0]],0],["let","pfx",["bytes.lit","file:"]],["std.bytes.concat",["bytes.view","pfx"],"path"]],"kind":"defn","name":"std.mcp.obs.audit.sink_jsonl_file_v1","params":[{"name":"cfg_json","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","_",["view.to_bytes","cfg_json"]],["bytes.lit","stderr_jsonl_v1"]],"kind":"defn","name":"std.mcp.obs.audit.sink_jsonl_stderr_v1","params":[{"name":"cfg_json","ty":"bytes_view"}],"result":"bytes"}],"imports":["ext.data_model","ext.json.data_model","std.bytes","std.fmt","std.os.fs","std.os.fs.spec","std.os.stdio","std.os.stdio.spec"],"kind":"module","module_id":"std.mcp.obs.audit","schema_version":"x07.x07ast@0.5.0"}
