{"decls":[{"kind":"export","names":["std.mcp.obs.metrics.counter_inc_v1","std.mcp.obs.metrics.export_openmetrics_v1","std.mcp.obs.metrics.export_otlp_v1","std.mcp.obs.metrics.hist_observe_ms_v1","std.mcp.obs.metrics.registry_defaults_v1","std.mcp.obs.metrics.snapshot_json_canon_v1","std.mcp.obs.metrics.snapshot_update_tool_call_v1"]},{"body":["begin",["let","k_k",["bytes.lit","k"]],["let","k_v",["bytes.lit","v"]],["let","v_k",["ext.data_model.value_string","k_utf8"]],["let","v_v",["ext.data_model.value_string","v_utf8"]],["let","entries",["vec_u8.with_capacity",64]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",2]]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",1]]],["set","entries",["vec_u8.push","entries",107]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",["std.bytes.len","v_k"]]]],["set","entries",["vec_u8.extend_bytes","entries",["bytes.view","v_k"]]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",1]]],["set","entries",["vec_u8.push","entries",118]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",["std.bytes.len","v_v"]]]],["set","entries",["vec_u8.extend_bytes","entries",["bytes.view","v_v"]]],["let","_x07_tmp_borrow_decls_1_body_15_1",["vec_u8.into_bytes","entries"]],["ext.data_model.value_map_from_entries",["bytes.view","_x07_tmp_borrow_decls_1_body_15_1"]]],"kind":"defn","name":"std.mcp.obs.metrics._build_label_kv_v1","params":[{"name":"k_utf8","ty":"bytes_view"},{"name":"v_utf8","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","k_labels",["bytes.lit","labels"]],["let","k_value",["bytes.lit","value"]],["let","num_s",["std.fmt.s32_to_dec","value_i32"]],["let","v_value",["ext.data_model.value_number",["bytes.view","num_s"]]],["let","entries",["vec_u8.with_capacity",128]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",2]]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",6]]],["let","_x07_tmp_borrow_decls_2_body_8_2_2",["bytes.lit","labels"]],["set","entries",["vec_u8.extend_bytes","entries",["bytes.view","_x07_tmp_borrow_decls_2_body_8_2_2"]]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",["view.len","labels_val"]]]],["set","entries",["vec_u8.extend_bytes","entries","labels_val"]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",5]]],["let","_x07_tmp_borrow_decls_2_body_12_2_2",["bytes.lit","value"]],["set","entries",["vec_u8.extend_bytes","entries",["bytes.view","_x07_tmp_borrow_decls_2_body_12_2_2"]]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",["std.bytes.len","v_value"]]]],["set","entries",["vec_u8.extend_bytes","entries",["bytes.view","v_value"]]],["let","_x07_tmp_borrow_decls_2_body_15_1",["vec_u8.into_bytes","entries"]],["ext.data_model.value_map_from_entries",["bytes.view","_x07_tmp_borrow_decls_2_body_15_1"]]],"kind":"defn","name":"std.mcp.obs.metrics._counter_series_val_v1","params":[{"name":"labels_val","ty":"bytes_view"},{"name":"value_i32","ty":"i32"}],"result":"bytes"},{"body":["begin",["let","num_s",["std.fmt.s32_to_dec","value"]],["let","out",["vec_u8.with_capacity",256]],["let","_x07_tmp_borrow_decls_3_body_3_2_2",["bytes.lit","{\"kind\":\""]],["set","out",["vec_u8.extend_bytes","out",["bytes.view","_x07_tmp_borrow_decls_3_body_3_2_2"]]],["set","out",["vec_u8.extend_bytes","out","kind_text"]],["let","_x07_tmp_borrow_decls_3_body_5_2_2",["bytes.lit","\",\"name\":\""]],["set","out",["vec_u8.extend_bytes","out",["bytes.view","_x07_tmp_borrow_decls_3_body_5_2_2"]]],["set","out",["vec_u8.extend_bytes","out","metric_name"]],["let","_x07_tmp_borrow_decls_3_body_7_2_2",["bytes.lit","\",\"label\":{"]],["set","out",["vec_u8.extend_bytes","out",["bytes.view","_x07_tmp_borrow_decls_3_body_7_2_2"]]],["if",[">",["view.len","label_key"],0],["begin",["let","_x07_tmp_quote_b",["bytes.lit","\""]],["let","_x07_tmp_quote_colon_b",["bytes.lit","\":\""]],["set","out",["vec_u8.extend_bytes","out",["bytes.view","_x07_tmp_quote_b"]]],["set","out",["vec_u8.extend_bytes","out","label_key"]],["set","out",["vec_u8.extend_bytes","out",["bytes.view","_x07_tmp_quote_colon_b"]]],["set","out",["vec_u8.extend_bytes","out","label_value"]],["set","out",["vec_u8.extend_bytes","out",["bytes.view","_x07_tmp_quote_b"]]],0],0],["let","_x07_tmp_borrow_decls_3_body_9_2_2",["bytes.lit","},\"value\":"]],["set","out",["vec_u8.extend_bytes","out",["bytes.view","_x07_tmp_borrow_decls_3_body_9_2_2"]]],["set","out",["vec_u8.extend_bytes","out",["bytes.view","num_s"]]],["let","_x07_tmp_borrow_decls_3_body_11_2_2",["bytes.lit","}"]],["set","out",["vec_u8.extend_bytes","out",["bytes.view","_x07_tmp_borrow_decls_3_body_11_2_2"]]],["let","_x07_tmp_borrow_decls_3_body_12_1",["bytes.lit","stderr_jsonl"]],["let","_x07_tmp_borrow_decls_3_body_12_2",["vec_u8.into_bytes","out"]],["std.mcp.obs.audit.emit_jsonl_v1",["bytes.view","_x07_tmp_borrow_decls_3_body_12_1"],["bytes.view","_x07_tmp_borrow_decls_3_body_12_2"]]],"kind":"defn","name":"std.mcp.obs.metrics._emit_metric_v1","params":[{"name":"kind_text","ty":"bytes_view"},{"name":"metric_name","ty":"bytes_view"},{"name":"label_key","ty":"bytes_view"},{"name":"label_value","ty":"bytes_view"},{"name":"value","ty":"i32"}],"result":"i32"},{"body":["begin",["let","k_labels",["bytes.lit","labels"]],["let","k_count",["bytes.lit","count"]],["let","k_sum",["bytes.lit","sum"]],["let","k_bc",["bytes.lit","bucket_counts"]],["let","count_s",["std.fmt.s32_to_dec","count_i32"]],["let","sum_s",["std.fmt.s32_to_dec","sum_i32"]],["let","v_count",["ext.data_model.value_number",["bytes.view","count_s"]]],["let","v_sum",["ext.data_model.value_number",["bytes.view","sum_s"]]],["let","entries",["vec_u8.with_capacity",256]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",4]]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",6]]],["let","_x07_tmp_borrow_decls_4_body_12_2_2",["bytes.lit","labels"]],["set","entries",["vec_u8.extend_bytes","entries",["bytes.view","_x07_tmp_borrow_decls_4_body_12_2_2"]]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",["view.len","labels_val"]]]],["set","entries",["vec_u8.extend_bytes","entries","labels_val"]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",5]]],["let","_x07_tmp_borrow_decls_4_body_16_2_2",["bytes.lit","count"]],["set","entries",["vec_u8.extend_bytes","entries",["bytes.view","_x07_tmp_borrow_decls_4_body_16_2_2"]]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",["std.bytes.len","v_count"]]]],["set","entries",["vec_u8.extend_bytes","entries",["bytes.view","v_count"]]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",3]]],["let","_x07_tmp_borrow_decls_4_body_20_2_2",["bytes.lit","sum"]],["set","entries",["vec_u8.extend_bytes","entries",["bytes.view","_x07_tmp_borrow_decls_4_body_20_2_2"]]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",["std.bytes.len","v_sum"]]]],["set","entries",["vec_u8.extend_bytes","entries",["bytes.view","v_sum"]]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",13]]],["let","_x07_tmp_borrow_decls_4_body_24_2_2",["bytes.lit","bucket_counts"]],["set","entries",["vec_u8.extend_bytes","entries",["bytes.view","_x07_tmp_borrow_decls_4_body_24_2_2"]]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",["view.len","bucket_counts_val"]]]],["set","entries",["vec_u8.extend_bytes","entries","bucket_counts_val"]],["let","_x07_tmp_borrow_decls_4_body_27_1",["vec_u8.into_bytes","entries"]],["ext.data_model.value_map_from_entries",["bytes.view","_x07_tmp_borrow_decls_4_body_27_1"]]],"kind":"defn","name":"std.mcp.obs.metrics._hist_series_val_v1","params":[{"name":"labels_val","ty":"bytes_view"},{"name":"count_i32","ty":"i32"},{"name":"sum_i32","ty":"i32"},{"name":"bucket_counts_val","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","doc",["ext.data_model.doc_ok","value"]],["let","canon_doc",["ext.data_model.json.emit_canon",["bytes.view","doc"]]],["let","cv",["bytes.view","canon_doc"]],["if",["=",["ext.data_model.doc_is_err","cv"],1],["return",["bytes.alloc",0]],0],["let","n",["view.len","cv"]],["if",["<u","n",1],["return",["bytes.alloc",0]],0],["view.to_bytes",["view.slice","cv",1,["-","n",1]]]],"kind":"defn","name":"std.mcp.obs.metrics._json_from_value_v1","params":[{"name":"value","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["if",["<","labels_off",0],["return",["bytes.alloc",0]],0],["if",["!=",["ext.data_model.kind_at","doc","labels_off"],4],["return",["bytes.alloc",0]],0],["let","n",["ext.data_model.seq_len","doc","labels_off"]],["if",["<","n",0],["return",["bytes.alloc",0]],0],["let","k_k",["bytes.lit","k"]],["let","k_v",["bytes.lit","v"]],["for","i",0,"n",["begin",["let","entry_off",["ext.data_model.seq_get","doc","labels_off","i"]],["if",["<","entry_off",0],0,["begin",["let","kk_off",["ext.data_model.map_find","doc","entry_off",["bytes.view","k_k"]]],["let","kv_off",["ext.data_model.map_find","doc","entry_off",["bytes.view","k_v"]]],["if",["if",["<","kk_off",0],1,["<","kv_off",0]],0,["begin",["let","kk",["ext.data_model.string_get","doc","kk_off"]],["if",["=",["bytes.eq",["bytes.view","kk"],"want_key_utf8"],1],["return",["ext.data_model.string_get","doc","kv_off"]],0],0]],0]]]],["bytes.alloc",0]],"kind":"defn","name":"std.mcp.obs.metrics._label_value_or_empty_v1","params":[{"name":"doc","ty":"bytes_view"},{"name":"labels_off","ty":"i32"},{"name":"want_key_utf8","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","k_tool",["bytes.lit","tool"]],["let","k_status",["bytes.lit","status"]],["let","l1",["std.mcp.obs.metrics._build_label_kv_v1",["bytes.view","k_tool"],"tool_utf8"]],["let","l2",["std.mcp.obs.metrics._build_label_kv_v1",["bytes.view","k_status"],"status_utf8"]],["let","payload",["vec_u8.with_capacity",256]],["set","payload",["vec_u8.extend_bytes","payload",["codec.write_u32_le",2]]],["set","payload",["vec_u8.extend_bytes","payload",["codec.write_u32_le",["std.bytes.len","l1"]]]],["set","payload",["vec_u8.extend_bytes","payload",["bytes.view","l1"]]],["set","payload",["vec_u8.extend_bytes","payload",["codec.write_u32_le",["std.bytes.len","l2"]]]],["set","payload",["vec_u8.extend_bytes","payload",["bytes.view","l2"]]],["let","_x07_tmp_borrow_decls_7_body_11_1",["vec_u8.into_bytes","payload"]],["ext.data_model.value_seq_from_elems",["bytes.view","_x07_tmp_borrow_decls_7_body_11_1"]]],"kind":"defn","name":"std.mcp.obs.metrics._labels_tool_status_v1","params":[{"name":"tool_utf8","ty":"bytes_view"},{"name":"status_utf8","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","k_tool",["bytes.lit","tool"]],["let","l1",["std.mcp.obs.metrics._build_label_kv_v1",["bytes.view","k_tool"],"tool_utf8"]],["let","payload",["vec_u8.with_capacity",128]],["set","payload",["vec_u8.extend_bytes","payload",["codec.write_u32_le",1]]],["set","payload",["vec_u8.extend_bytes","payload",["codec.write_u32_le",["std.bytes.len","l1"]]]],["set","payload",["vec_u8.extend_bytes","payload",["bytes.view","l1"]]],["let","_x07_tmp_borrow_decls_8_body_7_1",["vec_u8.into_bytes","payload"]],["ext.data_model.value_seq_from_elems",["bytes.view","_x07_tmp_borrow_decls_8_body_7_1"]]],"kind":"defn","name":"std.mcp.obs.metrics._labels_tool_v1","params":[{"name":"tool_utf8","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["if",["<=","duration_ms",1],["return",0],0],["if",["<=","duration_ms",5],["return",1],0],["if",["<=","duration_ms",10],["return",2],0],["if",["<=","duration_ms",25],["return",3],0],["if",["<=","duration_ms",50],["return",4],0],["if",["<=","duration_ms",100],["return",5],0],["if",["<=","duration_ms",250],["return",6],0],["if",["<=","duration_ms",500],["return",7],0],["if",["<=","duration_ms",1000],["return",8],0],["if",["<=","duration_ms",2500],["return",9],0],["if",["<=","duration_ms",5000],["return",10],0],11],"kind":"defn","name":"std.mcp.obs.metrics._latency_bucket_index_v1","params":[{"name":"duration_ms","ty":"i32"}],"result":"i32"},{"body":["begin",["let","payload",["vec_u8.with_capacity",256]],["set","payload",["vec_u8.extend_bytes","payload",["codec.write_u32_le",11]]],["for","i",0,11,["begin",["let","v",["bytes.lit","0"]],["if",["=","i",0],["begin",["set","v",["bytes.lit","1"]],0],0],["if",["=","i",1],["begin",["set","v",["bytes.lit","5"]],0],0],["if",["=","i",2],["begin",["set","v",["bytes.lit","10"]],0],0],["if",["=","i",3],["begin",["set","v",["bytes.lit","25"]],0],0],["if",["=","i",4],["begin",["set","v",["bytes.lit","50"]],0],0],["if",["=","i",5],["begin",["set","v",["bytes.lit","100"]],0],0],["if",["=","i",6],["begin",["set","v",["bytes.lit","250"]],0],0],["if",["=","i",7],["begin",["set","v",["bytes.lit","500"]],0],0],["if",["=","i",8],["begin",["set","v",["bytes.lit","1000"]],0],0],["if",["=","i",9],["begin",["set","v",["bytes.lit","2500"]],0],0],["if",["=","i",10],["begin",["set","v",["bytes.lit","5000"]],0],0],["let","num",["ext.data_model.value_number",["bytes.view","v"]]],["set","payload",["vec_u8.extend_bytes","payload",["codec.write_u32_le",["std.bytes.len","num"]]]],["set","payload",["vec_u8.extend_bytes","payload",["bytes.view","num"]]],0]],["let","_x07_tmp_borrow_decls_10_body_4_1",["vec_u8.into_bytes","payload"]],["ext.data_model.value_seq_from_elems",["bytes.view","_x07_tmp_borrow_decls_10_body_4_1"]]],"kind":"defn","name":"std.mcp.obs.metrics._latency_buckets_val_v1","params":[],"result":"bytes"},{"body":["begin",["let","k_id",["bytes.lit","id"]],["let","k_type",["bytes.lit","type"]],["let","k_help",["bytes.lit","help"]],["let","k_unit",["bytes.lit","unit"]],["let","k_series",["bytes.lit","series"]],["let","v_id",["ext.data_model.value_string","id_utf8"]],["let","v_type",["ext.data_model.value_string",["bytes.lit","counter_u64_v1"]]],["let","v_help",["ext.data_model.value_string","help_utf8"]],["let","v_unit",["ext.data_model.value_string","unit_utf8"]],["let","entries",["vec_u8.with_capacity",256]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",5]]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",2]]],["let","_x07_tmp_borrow_decls_11_body_13_2_2",["bytes.lit","id"]],["set","entries",["vec_u8.extend_bytes","entries",["bytes.view","_x07_tmp_borrow_decls_11_body_13_2_2"]]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",["std.bytes.len","v_id"]]]],["set","entries",["vec_u8.extend_bytes","entries",["bytes.view","v_id"]]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",4]]],["let","_x07_tmp_borrow_decls_11_body_17_2_2",["bytes.lit","type"]],["set","entries",["vec_u8.extend_bytes","entries",["bytes.view","_x07_tmp_borrow_decls_11_body_17_2_2"]]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",["std.bytes.len","v_type"]]]],["set","entries",["vec_u8.extend_bytes","entries",["bytes.view","v_type"]]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",4]]],["let","_x07_tmp_borrow_decls_11_body_21_2_2",["bytes.lit","help"]],["set","entries",["vec_u8.extend_bytes","entries",["bytes.view","_x07_tmp_borrow_decls_11_body_21_2_2"]]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",["std.bytes.len","v_help"]]]],["set","entries",["vec_u8.extend_bytes","entries",["bytes.view","v_help"]]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",4]]],["let","_x07_tmp_borrow_decls_11_body_25_2_2",["bytes.lit","unit"]],["set","entries",["vec_u8.extend_bytes","entries",["bytes.view","_x07_tmp_borrow_decls_11_body_25_2_2"]]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",["std.bytes.len","v_unit"]]]],["set","entries",["vec_u8.extend_bytes","entries",["bytes.view","v_unit"]]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",6]]],["let","_x07_tmp_borrow_decls_11_body_29_2_2",["bytes.lit","series"]],["set","entries",["vec_u8.extend_bytes","entries",["bytes.view","_x07_tmp_borrow_decls_11_body_29_2_2"]]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",["view.len","series_val"]]]],["set","entries",["vec_u8.extend_bytes","entries","series_val"]],["let","_x07_tmp_borrow_decls_11_body_32_1",["vec_u8.into_bytes","entries"]],["ext.data_model.value_map_from_entries",["bytes.view","_x07_tmp_borrow_decls_11_body_32_1"]]],"kind":"defn","name":"std.mcp.obs.metrics._metric_counter_v1","params":[{"name":"id_utf8","ty":"bytes_view"},{"name":"help_utf8","ty":"bytes_view"},{"name":"unit_utf8","ty":"bytes_view"},{"name":"series_val","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","v_id",["ext.data_model.value_string",["bytes.lit","mcp_sessions_active"]]],["let","v_type",["ext.data_model.value_string",["bytes.lit","gauge_f64_v1"]]],["let","v_help",["ext.data_model.value_string",["bytes.lit","Active MCP sessions."]]],["let","v_unit",["ext.data_model.value_string",["bytes.lit","1"]]],["let","entries",["vec_u8.with_capacity",256]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",5]]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",2]]],["let","_x07_tmp_borrow_decls_12_body_8_2_2",["bytes.lit","id"]],["set","entries",["vec_u8.extend_bytes","entries",["bytes.view","_x07_tmp_borrow_decls_12_body_8_2_2"]]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",["std.bytes.len","v_id"]]]],["set","entries",["vec_u8.extend_bytes","entries",["bytes.view","v_id"]]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",4]]],["let","_x07_tmp_borrow_decls_12_body_12_2_2",["bytes.lit","type"]],["set","entries",["vec_u8.extend_bytes","entries",["bytes.view","_x07_tmp_borrow_decls_12_body_12_2_2"]]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",["std.bytes.len","v_type"]]]],["set","entries",["vec_u8.extend_bytes","entries",["bytes.view","v_type"]]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",4]]],["let","_x07_tmp_borrow_decls_12_body_16_2_2",["bytes.lit","help"]],["set","entries",["vec_u8.extend_bytes","entries",["bytes.view","_x07_tmp_borrow_decls_12_body_16_2_2"]]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",["std.bytes.len","v_help"]]]],["set","entries",["vec_u8.extend_bytes","entries",["bytes.view","v_help"]]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",4]]],["let","_x07_tmp_borrow_decls_12_body_20_2_2",["bytes.lit","unit"]],["set","entries",["vec_u8.extend_bytes","entries",["bytes.view","_x07_tmp_borrow_decls_12_body_20_2_2"]]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",["std.bytes.len","v_unit"]]]],["set","entries",["vec_u8.extend_bytes","entries",["bytes.view","v_unit"]]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",6]]],["let","_x07_tmp_borrow_decls_12_body_24_2_2",["bytes.lit","series"]],["set","entries",["vec_u8.extend_bytes","entries",["bytes.view","_x07_tmp_borrow_decls_12_body_24_2_2"]]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",["view.len","series_val"]]]],["set","entries",["vec_u8.extend_bytes","entries","series_val"]],["let","_x07_tmp_borrow_decls_12_body_27_1",["vec_u8.into_bytes","entries"]],["ext.data_model.value_map_from_entries",["bytes.view","_x07_tmp_borrow_decls_12_body_27_1"]]],"kind":"defn","name":"std.mcp.obs.metrics._metric_gauge_sessions_active_v1","params":[{"name":"series_val","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","k_id",["bytes.lit","id"]],["let","k_type",["bytes.lit","type"]],["let","k_help",["bytes.lit","help"]],["let","k_unit",["bytes.lit","unit"]],["let","k_buckets",["bytes.lit","buckets"]],["let","k_series",["bytes.lit","series"]],["let","v_id",["ext.data_model.value_string",["bytes.lit","mcp_tool_latency_ms"]]],["let","v_type",["ext.data_model.value_string",["bytes.lit","histogram_f64_v1"]]],["let","v_help",["ext.data_model.value_string",["bytes.lit","Tool call latency in milliseconds."]]],["let","v_unit",["ext.data_model.value_string",["bytes.lit","ms"]]],["let","v_buckets",["std.mcp.obs.metrics._latency_buckets_val_v1"]],["let","entries",["vec_u8.with_capacity",512]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",6]]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",2]]],["let","_x07_tmp_borrow_decls_13_body_15_2_2",["bytes.lit","id"]],["set","entries",["vec_u8.extend_bytes","entries",["bytes.view","_x07_tmp_borrow_decls_13_body_15_2_2"]]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",["std.bytes.len","v_id"]]]],["set","entries",["vec_u8.extend_bytes","entries",["bytes.view","v_id"]]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",4]]],["let","_x07_tmp_borrow_decls_13_body_19_2_2",["bytes.lit","type"]],["set","entries",["vec_u8.extend_bytes","entries",["bytes.view","_x07_tmp_borrow_decls_13_body_19_2_2"]]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",["std.bytes.len","v_type"]]]],["set","entries",["vec_u8.extend_bytes","entries",["bytes.view","v_type"]]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",4]]],["let","_x07_tmp_borrow_decls_13_body_23_2_2",["bytes.lit","help"]],["set","entries",["vec_u8.extend_bytes","entries",["bytes.view","_x07_tmp_borrow_decls_13_body_23_2_2"]]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",["std.bytes.len","v_help"]]]],["set","entries",["vec_u8.extend_bytes","entries",["bytes.view","v_help"]]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",4]]],["let","_x07_tmp_borrow_decls_13_body_27_2_2",["bytes.lit","unit"]],["set","entries",["vec_u8.extend_bytes","entries",["bytes.view","_x07_tmp_borrow_decls_13_body_27_2_2"]]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",["std.bytes.len","v_unit"]]]],["set","entries",["vec_u8.extend_bytes","entries",["bytes.view","v_unit"]]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",7]]],["let","_x07_tmp_borrow_decls_13_body_31_2_2",["bytes.lit","buckets"]],["set","entries",["vec_u8.extend_bytes","entries",["bytes.view","_x07_tmp_borrow_decls_13_body_31_2_2"]]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",["std.bytes.len","v_buckets"]]]],["set","entries",["vec_u8.extend_bytes","entries",["bytes.view","v_buckets"]]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",6]]],["let","_x07_tmp_borrow_decls_13_body_35_2_2",["bytes.lit","series"]],["set","entries",["vec_u8.extend_bytes","entries",["bytes.view","_x07_tmp_borrow_decls_13_body_35_2_2"]]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",["view.len","series_val"]]]],["set","entries",["vec_u8.extend_bytes","entries","series_val"]],["let","_x07_tmp_borrow_decls_13_body_38_1",["vec_u8.into_bytes","entries"]],["ext.data_model.value_map_from_entries",["bytes.view","_x07_tmp_borrow_decls_13_body_38_1"]]],"kind":"defn","name":"std.mcp.obs.metrics._metric_hist_latency_ms_v1","params":[{"name":"series_val","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","st",["std.parse.i32_status_le","b"]],["if",["if",[">=u",["std.bytes.len","st"],5],["=",["bytes.get_u8","st",0],1],0],["codec.read_u32_le","st",1],0]],"kind":"defn","name":"std.mcp.obs.metrics._parse_i32_or_0_v1","params":[{"name":"b","ty":"bytes_view"}],"result":"i32"},{"body":["begin",["let","empty",["bytes.alloc",0]],["if",["<u",["view.len","snapshot_pack"],8],["return","empty"],0],["if",["!=",["codec.read_u32_le","snapshot_pack",0],1],["return","empty"],0],["let","tool_count0",["codec.read_u32_le","snapshot_pack",4]],["let","tool_count",["if",["<","tool_count0",0],0,"tool_count0"]],["let","off",8],["let","status_ok",["bytes.lit","ok"]],["let","status_error",["bytes.lit","error"]],["let","calls_n",0],["let","calls_entries",["vec_u8.with_capacity",512]],["let","lat_n",0],["let","lat_entries",["vec_u8.with_capacity",1024]],["let","over_n",0],["let","over_entries",["vec_u8.with_capacity",256]],["for","i",0,"tool_count",["begin",["if",["<u",["view.len","snapshot_pack"],["+","off",4]],["return","empty"],0],["let","name_len0",["codec.read_u32_le","snapshot_pack","off"]],["let","name_len",["if",["<","name_len0",0],0,"name_len0"]],["let","name_start",["+","off",4]],["let","counts_start",["+","name_start","name_len"]],["let","entry_end",["+","counts_start",68]],["if",["<u",["view.len","snapshot_pack"],"entry_end"],["return","empty"],0],["let","tool_utf8",["view.slice","snapshot_pack","name_start","name_len"]],["let","ok0",["codec.read_u32_le","snapshot_pack","counts_start"]],["let","ok",["if",["<","ok0",0],0,"ok0"]],["let","err0",["codec.read_u32_le","snapshot_pack",["+","counts_start",4]]],["let","err",["if",["<","err0",0],0,"err0"]],["let","cnt0",["codec.read_u32_le","snapshot_pack",["+","counts_start",8]]],["let","cnt",["if",["<","cnt0",0],0,"cnt0"]],["let","sum0",["codec.read_u32_le","snapshot_pack",["+","counts_start",12]]],["let","sum",["if",["<","sum0",0],0,"sum0"]],["let","over0",["codec.read_u32_le","snapshot_pack",["+","counts_start",16]]],["let","over",["if",["<","over0",0],0,"over0"]],["let","bc_start",["+","counts_start",20]],["if",[">","ok",0],["begin",["let","labels",["std.mcp.obs.metrics._labels_tool_status_v1","tool_utf8",["bytes.view","status_ok"]]],["let","series",["std.mcp.obs.metrics._counter_series_val_v1",["bytes.view","labels"],"ok"]],["set","calls_entries",["vec_u8.extend_bytes","calls_entries",["codec.write_u32_le",["std.bytes.len","series"]]]],["set","calls_entries",["vec_u8.extend_bytes","calls_entries",["bytes.view","series"]]],["set","calls_n",["+","calls_n",1]],0],0],["if",[">","err",0],["begin",["let","labels",["std.mcp.obs.metrics._labels_tool_status_v1","tool_utf8",["bytes.view","status_error"]]],["let","series",["std.mcp.obs.metrics._counter_series_val_v1",["bytes.view","labels"],"err"]],["set","calls_entries",["vec_u8.extend_bytes","calls_entries",["codec.write_u32_le",["std.bytes.len","series"]]]],["set","calls_entries",["vec_u8.extend_bytes","calls_entries",["bytes.view","series"]]],["set","calls_n",["+","calls_n",1]],0],0],["if",[">","cnt",0],["begin",["let","labels",["std.mcp.obs.metrics._labels_tool_v1","tool_utf8"]],["let","bc_entries",["vec_u8.with_capacity",256]],["for","b",0,12,["begin",["let","c0",["codec.read_u32_le","snapshot_pack",["+","bc_start",["*","b",4]]]],["let","c",["if",["<","c0",0],0,"c0"]],["let","c_s",["std.fmt.s32_to_dec","c"]],["let","v",["ext.data_model.value_number",["bytes.view","c_s"]]],["set","bc_entries",["vec_u8.extend_bytes","bc_entries",["codec.write_u32_le",["std.bytes.len","v"]]]],["set","bc_entries",["vec_u8.extend_bytes","bc_entries",["bytes.view","v"]]],0]],["let","bc_entries_b",["vec_u8.into_bytes","bc_entries"]],["let","bc_doc",["vec_u8.with_capacity",["+",4,["bytes.len",["bytes.view","bc_entries_b"]]]]],["set","bc_doc",["vec_u8.extend_bytes","bc_doc",["codec.write_u32_le",12]]],["set","bc_doc",["vec_u8.extend_bytes","bc_doc",["bytes.view","bc_entries_b"]]],["let","bc_doc_b",["vec_u8.into_bytes","bc_doc"]],["let","bc_val",["ext.data_model.value_seq_from_elems",["bytes.view","bc_doc_b"]]],["let","series",["std.mcp.obs.metrics._hist_series_val_v1",["bytes.view","labels"],"cnt","sum",["bytes.view","bc_val"]]],["set","lat_entries",["vec_u8.extend_bytes","lat_entries",["codec.write_u32_le",["std.bytes.len","series"]]]],["set","lat_entries",["vec_u8.extend_bytes","lat_entries",["bytes.view","series"]]],["set","lat_n",["+","lat_n",1]],0],0],["if",[">","over",0],["begin",["let","labels",["std.mcp.obs.metrics._labels_tool_v1","tool_utf8"]],["let","series",["std.mcp.obs.metrics._counter_series_val_v1",["bytes.view","labels"],"over"]],["set","over_entries",["vec_u8.extend_bytes","over_entries",["codec.write_u32_le",["std.bytes.len","series"]]]],["set","over_entries",["vec_u8.extend_bytes","over_entries",["bytes.view","series"]]],["set","over_n",["+","over_n",1]],0],0],["set","off","entry_end"],0]],["let","calls_entries_b",["vec_u8.into_bytes","calls_entries"]],["let","calls_doc",["vec_u8.with_capacity",["+",4,["bytes.len",["bytes.view","calls_entries_b"]]]]],["set","calls_doc",["vec_u8.extend_bytes","calls_doc",["codec.write_u32_le","calls_n"]]],["set","calls_doc",["vec_u8.extend_bytes","calls_doc",["bytes.view","calls_entries_b"]]],["let","calls_doc_b",["vec_u8.into_bytes","calls_doc"]],["let","series_calls",["ext.data_model.value_seq_from_elems",["bytes.view","calls_doc_b"]]],["let","lat_entries_b",["vec_u8.into_bytes","lat_entries"]],["let","lat_doc",["vec_u8.with_capacity",["+",4,["bytes.len",["bytes.view","lat_entries_b"]]]]],["set","lat_doc",["vec_u8.extend_bytes","lat_doc",["codec.write_u32_le","lat_n"]]],["set","lat_doc",["vec_u8.extend_bytes","lat_doc",["bytes.view","lat_entries_b"]]],["let","lat_doc_b",["vec_u8.into_bytes","lat_doc"]],["let","series_latency",["ext.data_model.value_seq_from_elems",["bytes.view","lat_doc_b"]]],["let","over_entries_b",["vec_u8.into_bytes","over_entries"]],["let","over_doc",["vec_u8.with_capacity",["+",4,["bytes.len",["bytes.view","over_entries_b"]]]]],["set","over_doc",["vec_u8.extend_bytes","over_doc",["codec.write_u32_le","over_n"]]],["set","over_doc",["vec_u8.extend_bytes","over_doc",["bytes.view","over_entries_b"]]],["let","over_doc_b",["vec_u8.into_bytes","over_doc"]],["let","series_over",["ext.data_model.value_seq_from_elems",["bytes.view","over_doc_b"]]],["let","_x07_tmp_empty_seq",["codec.write_u32_le",0]],["let","series_sessions",["ext.data_model.value_seq_from_elems",["bytes.view","_x07_tmp_empty_seq"]]],["let","id_calls",["bytes.lit","mcp_tool_calls_total"]],["let","help_calls",["bytes.lit","Total tool calls by outcome."]],["let","id_over",["bytes.lit","mcp_tool_budget_overrun_total"]],["let","help_over",["bytes.lit","Tool calls that overran budget."]],["let","unit_one",["bytes.lit","1"]],["let","m_calls",["std.mcp.obs.metrics._metric_counter_v1",["bytes.view","id_calls"],["bytes.view","help_calls"],["bytes.view","unit_one"],["bytes.view","series_calls"]]],["let","m_latency",["std.mcp.obs.metrics._metric_hist_latency_ms_v1",["bytes.view","series_latency"]]],["let","m_over",["std.mcp.obs.metrics._metric_counter_v1",["bytes.view","id_over"],["bytes.view","help_over"],["bytes.view","unit_one"],["bytes.view","series_over"]]],["let","m_sessions",["std.mcp.obs.metrics._metric_gauge_sessions_active_v1",["bytes.view","series_sessions"]]],["let","m_entries",["vec_u8.with_capacity",512]],["set","m_entries",["vec_u8.extend_bytes","m_entries",["codec.write_u32_le",4]]],["set","m_entries",["vec_u8.extend_bytes","m_entries",["codec.write_u32_le",["std.bytes.len","m_calls"]]]],["set","m_entries",["vec_u8.extend_bytes","m_entries",["bytes.view","m_calls"]]],["set","m_entries",["vec_u8.extend_bytes","m_entries",["codec.write_u32_le",["std.bytes.len","m_latency"]]]],["set","m_entries",["vec_u8.extend_bytes","m_entries",["bytes.view","m_latency"]]],["set","m_entries",["vec_u8.extend_bytes","m_entries",["codec.write_u32_le",["std.bytes.len","m_over"]]]],["set","m_entries",["vec_u8.extend_bytes","m_entries",["bytes.view","m_over"]]],["set","m_entries",["vec_u8.extend_bytes","m_entries",["codec.write_u32_le",["std.bytes.len","m_sessions"]]]],["set","m_entries",["vec_u8.extend_bytes","m_entries",["bytes.view","m_sessions"]]],["let","m_entries_b",["vec_u8.into_bytes","m_entries"]],["let","metrics_val",["ext.data_model.value_seq_from_elems",["bytes.view","m_entries_b"]]],["let","entries",["vec_u8.with_capacity",512]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",4]]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",14]]],["let","_x07_tmp_borrow_decls_15_body_60_2_2",["bytes.lit","schema_version"]],["set","entries",["vec_u8.extend_bytes","entries",["bytes.view","_x07_tmp_borrow_decls_15_body_60_2_2"]]],["let","v_schema",["ext.data_model.value_string",["bytes.lit","x07.obs.snapshot@0.1.0"]]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",["std.bytes.len","v_schema"]]]],["set","entries",["vec_u8.extend_bytes","entries",["bytes.view","v_schema"]]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",14]]],["let","_x07_tmp_borrow_decls_15_body_65_2_2",["bytes.lit","time_unix_nano"]],["set","entries",["vec_u8.extend_bytes","entries",["bytes.view","_x07_tmp_borrow_decls_15_body_65_2_2"]]],["let","one",["bytes.lit","1"]],["let","v_time",["ext.data_model.value_number",["bytes.view","one"]]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",["std.bytes.len","v_time"]]]],["set","entries",["vec_u8.extend_bytes","entries",["bytes.view","v_time"]]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",20]]],["let","_x07_tmp_borrow_decls_15_body_71_2_2",["bytes.lit","start_time_unix_nano"]],["set","entries",["vec_u8.extend_bytes","entries",["bytes.view","_x07_tmp_borrow_decls_15_body_71_2_2"]]],["let","v_start",["ext.data_model.value_number",["bytes.view","one"]]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",["std.bytes.len","v_start"]]]],["set","entries",["vec_u8.extend_bytes","entries",["bytes.view","v_start"]]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",7]]],["let","_x07_tmp_borrow_decls_15_body_76_2_2",["bytes.lit","metrics"]],["set","entries",["vec_u8.extend_bytes","entries",["bytes.view","_x07_tmp_borrow_decls_15_body_76_2_2"]]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",["std.bytes.len","metrics_val"]]]],["set","entries",["vec_u8.extend_bytes","entries",["bytes.view","metrics_val"]]],["let","entries_b",["vec_u8.into_bytes","entries"]],["let","root_val",["ext.data_model.value_map_from_entries",["bytes.view","entries_b"]]],["if",["=",["std.bytes.len","root_val"],0],["return","empty"],0],["std.mcp.obs.metrics._json_from_value_v1",["bytes.view","root_val"]]],"kind":"defn","name":"std.mcp.obs.metrics._snapshot_json_from_pack_v1","params":[{"name":"snapshot_pack","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","out",["vec_u8.with_capacity",8]],["set","out",["vec_u8.extend_bytes","out",["codec.write_u32_le",1]]],["set","out",["vec_u8.extend_bytes","out",["codec.write_u32_le",0]]],["vec_u8.into_bytes","out"]],"kind":"defn","name":"std.mcp.obs.metrics._snapshot_pack_empty_v1","params":[],"result":"bytes"},{"body":["begin",["if",["<u",["view.len","snapshot_any"],8],["return",0],0],["if",["=",["codec.read_u32_le","snapshot_any",0],1],1,0]],"kind":"defn","name":"std.mcp.obs.metrics._snapshot_pack_is_v1_v1","params":[{"name":"snapshot_any","ty":"bytes_view"}],"result":"i32"},{"body":["begin",["let","payload",["vec_u8.with_capacity",512]],["let","count",0],["let","found",0],["let","k_labels",["bytes.lit","labels"]],["let","k_value",["bytes.lit","value"]],["let","want_tool",["bytes.lit","tool"]],["let","want_status",["bytes.lit","status"]],["let","n",["if",["if",[">=","series_off",0],["=",["ext.data_model.kind_at","doc","series_off"],4],0],["ext.data_model.seq_len","doc","series_off"],0]],["if",["<","n",0],["begin",["set","n",0],0],0],["for","i",0,"n",["begin",["let","s_off",["ext.data_model.seq_get","doc","series_off","i"]],["if",["<","s_off",0],0,["begin",["let","labels_off",["ext.data_model.map_find","doc","s_off",["bytes.view","k_labels"]]],["let","tool0",["std.mcp.obs.metrics._label_value_or_empty_v1","doc","labels_off",["bytes.view","want_tool"]]],["let","status0",["std.mcp.obs.metrics._label_value_or_empty_v1","doc","labels_off",["bytes.view","want_status"]]],["if",["&",["=",["bytes.eq",["bytes.view","tool0"],"tool_utf8"],1],["=",["bytes.eq",["bytes.view","status0"],"status_utf8"],1]],["begin",["set","found",1],["let","v_off",["ext.data_model.map_find","doc","s_off",["bytes.view","k_value"]]],["let","old",["if",[">=","v_off",0],["ext.data_model.number_get","doc","v_off"],["bytes.alloc",0]]],["let","old_i32",["std.mcp.obs.metrics._parse_i32_or_0_v1",["bytes.view","old"]]],["let","new_val",["begin",["let","_x07_tmp_labels_val",["std.mcp.obs.metrics._labels_tool_status_v1","tool_utf8","status_utf8"]],["std.mcp.obs.metrics._counter_series_val_v1",["bytes.view","_x07_tmp_labels_val"],["+","old_i32",1]]]],["set","payload",["vec_u8.extend_bytes","payload",["codec.write_u32_le",["std.bytes.len","new_val"]]]],["set","payload",["vec_u8.extend_bytes","payload",["bytes.view","new_val"]]],["set","count",["+","count",1]],0],["begin",["let","end",["ext.data_model.skip_value","doc","s_off"]],["if",["<","end",0],0,["begin",["let","val",["view.to_bytes",["view.slice","doc","s_off",["-","end","s_off"]]]],["set","payload",["vec_u8.extend_bytes","payload",["codec.write_u32_le",["std.bytes.len","val"]]]],["set","payload",["vec_u8.extend_bytes","payload",["bytes.view","val"]]],["set","count",["+","count",1]],0]]]],0]]]],["if",["=","found",0],["begin",["let","new_val",["begin",["let","_x07_tmp_labels_val",["std.mcp.obs.metrics._labels_tool_status_v1","tool_utf8","status_utf8"]],["std.mcp.obs.metrics._counter_series_val_v1",["bytes.view","_x07_tmp_labels_val"],1]]],["set","payload",["vec_u8.extend_bytes","payload",["codec.write_u32_le",["std.bytes.len","new_val"]]]],["set","payload",["vec_u8.extend_bytes","payload",["bytes.view","new_val"]]],["set","count",["+","count",1]],0],0],["let","payload_b",["vec_u8.into_bytes","payload"]],["let","elems",["vec_u8.with_capacity",["+",4,["std.bytes.len","payload_b"]]]],["set","elems",["vec_u8.extend_bytes","elems",["codec.write_u32_le","count"]]],["set","elems",["vec_u8.extend_bytes","elems",["bytes.view","payload_b"]]],["let","_x07_tmp_borrow_decls_15_body_17_1",["vec_u8.into_bytes","elems"]],["ext.data_model.value_seq_from_elems",["bytes.view","_x07_tmp_borrow_decls_15_body_17_1"]]],"kind":"defn","name":"std.mcp.obs.metrics._update_counter_series_tool_status_v1","params":[{"name":"doc","ty":"bytes_view"},{"name":"series_off","ty":"i32"},{"name":"tool_utf8","ty":"bytes_view"},{"name":"status_utf8","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","payload",["vec_u8.with_capacity",512]],["let","count",0],["let","found",0],["let","k_labels",["bytes.lit","labels"]],["let","k_value",["bytes.lit","value"]],["let","want_tool",["bytes.lit","tool"]],["let","n",["if",["if",[">=","series_off",0],["=",["ext.data_model.kind_at","doc","series_off"],4],0],["ext.data_model.seq_len","doc","series_off"],0]],["if",["<","n",0],["begin",["set","n",0],0],0],["for","i",0,"n",["begin",["let","s_off",["ext.data_model.seq_get","doc","series_off","i"]],["if",["<","s_off",0],0,["begin",["let","labels_off",["ext.data_model.map_find","doc","s_off",["bytes.view","k_labels"]]],["let","tool0",["std.mcp.obs.metrics._label_value_or_empty_v1","doc","labels_off",["bytes.view","want_tool"]]],["if",["=",["bytes.eq",["bytes.view","tool0"],"tool_utf8"],1],["begin",["set","found",1],["let","v_off",["ext.data_model.map_find","doc","s_off",["bytes.view","k_value"]]],["let","old",["if",[">=","v_off",0],["ext.data_model.number_get","doc","v_off"],["bytes.alloc",0]]],["let","old_i32",["std.mcp.obs.metrics._parse_i32_or_0_v1",["bytes.view","old"]]],["let","new_val",["begin",["let","_x07_tmp_labels_val",["std.mcp.obs.metrics._labels_tool_v1","tool_utf8"]],["std.mcp.obs.metrics._counter_series_val_v1",["bytes.view","_x07_tmp_labels_val"],["+","old_i32",1]]]],["set","payload",["vec_u8.extend_bytes","payload",["codec.write_u32_le",["std.bytes.len","new_val"]]]],["set","payload",["vec_u8.extend_bytes","payload",["bytes.view","new_val"]]],["set","count",["+","count",1]],0],["begin",["let","end",["ext.data_model.skip_value","doc","s_off"]],["if",["<","end",0],0,["begin",["let","val",["view.to_bytes",["view.slice","doc","s_off",["-","end","s_off"]]]],["set","payload",["vec_u8.extend_bytes","payload",["codec.write_u32_le",["std.bytes.len","val"]]]],["set","payload",["vec_u8.extend_bytes","payload",["bytes.view","val"]]],["set","count",["+","count",1]],0]]]],0]]]],["if",["=","found",0],["begin",["let","new_val",["begin",["let","_x07_tmp_labels_val",["std.mcp.obs.metrics._labels_tool_v1","tool_utf8"]],["std.mcp.obs.metrics._counter_series_val_v1",["bytes.view","_x07_tmp_labels_val"],1]]],["set","payload",["vec_u8.extend_bytes","payload",["codec.write_u32_le",["std.bytes.len","new_val"]]]],["set","payload",["vec_u8.extend_bytes","payload",["bytes.view","new_val"]]],["set","count",["+","count",1]],0],0],["let","payload_b",["vec_u8.into_bytes","payload"]],["let","elems",["vec_u8.with_capacity",["+",4,["std.bytes.len","payload_b"]]]],["set","elems",["vec_u8.extend_bytes","elems",["codec.write_u32_le","count"]]],["set","elems",["vec_u8.extend_bytes","elems",["bytes.view","payload_b"]]],["let","_x07_tmp_borrow_decls_16_body_16_1",["vec_u8.into_bytes","elems"]],["ext.data_model.value_seq_from_elems",["bytes.view","_x07_tmp_borrow_decls_16_body_16_1"]]],"kind":"defn","name":"std.mcp.obs.metrics._update_counter_series_tool_v1","params":[{"name":"doc","ty":"bytes_view"},{"name":"series_off","ty":"i32"},{"name":"tool_utf8","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","payload",["vec_u8.with_capacity",768]],["let","count",0],["let","found",0],["let","k_labels",["bytes.lit","labels"]],["let","k_count",["bytes.lit","count"]],["let","k_sum",["bytes.lit","sum"]],["let","k_bc",["bytes.lit","bucket_counts"]],["let","want_tool",["bytes.lit","tool"]],["let","bucket_idx",["std.mcp.obs.metrics._latency_bucket_index_v1","duration_ms"]],["let","n",["if",["if",[">=","series_off",0],["=",["ext.data_model.kind_at","doc","series_off"],4],0],["ext.data_model.seq_len","doc","series_off"],0]],["if",["<","n",0],["begin",["set","n",0],0],0],["for","i",0,"n",["begin",["let","s_off",["ext.data_model.seq_get","doc","series_off","i"]],["if",["<","s_off",0],0,["begin",["let","labels_off",["ext.data_model.map_find","doc","s_off",["bytes.view","k_labels"]]],["let","tool0",["std.mcp.obs.metrics._label_value_or_empty_v1","doc","labels_off",["bytes.view","want_tool"]]],["if",["=",["bytes.eq",["bytes.view","tool0"],"tool_utf8"],1],["begin",["set","found",1],["let","count_off",["ext.data_model.map_find","doc","s_off",["bytes.view","k_count"]]],["let","sum_off",["ext.data_model.map_find","doc","s_off",["bytes.view","k_sum"]]],["let","bc_off",["ext.data_model.map_find","doc","s_off",["bytes.view","k_bc"]]],["let","old_count_b",["if",[">=","count_off",0],["ext.data_model.number_get","doc","count_off"],["bytes.alloc",0]]],["let","old_sum_b",["if",[">=","sum_off",0],["ext.data_model.number_get","doc","sum_off"],["bytes.alloc",0]]],["let","old_count",["std.mcp.obs.metrics._parse_i32_or_0_v1",["bytes.view","old_count_b"]]],["let","old_sum",["std.mcp.obs.metrics._parse_i32_or_0_v1",["bytes.view","old_sum_b"]]],["let","new_count",["+","old_count",1]],["let","new_sum",["+","old_sum","duration_ms"]],["let","bc_payload",["vec_u8.with_capacity",256]],["let","bc_count",0],["let","bc_len",["if",["if",[">=","bc_off",0],["=",["ext.data_model.kind_at","doc","bc_off"],4],0],["ext.data_model.seq_len","doc","bc_off"],0]],["if",["<","bc_len",0],["begin",["set","bc_len",0],0],0],["for","bi",0,12,["begin",["let","old_i",0],["if",["<","bi","bc_len"],["begin",["let","e_off",["ext.data_model.seq_get","doc","bc_off","bi"]],["let","nb",["if",[">=","e_off",0],["ext.data_model.number_get","doc","e_off"],["bytes.alloc",0]]],["set","old_i",["std.mcp.obs.metrics._parse_i32_or_0_v1",["bytes.view","nb"]]],0],0],["let","new_i",["if",[">=","bi","bucket_idx"],["+","old_i",1],"old_i"]],["let","new_s",["std.fmt.s32_to_dec","new_i"]],["let","v_num",["ext.data_model.value_number",["bytes.view","new_s"]]],["set","bc_payload",["vec_u8.extend_bytes","bc_payload",["codec.write_u32_le",["std.bytes.len","v_num"]]]],["set","bc_payload",["vec_u8.extend_bytes","bc_payload",["bytes.view","v_num"]]],["set","bc_count",["+","bc_count",1]],0]],["let","bc_payload_b",["vec_u8.into_bytes","bc_payload"]],["let","bc_elems",["vec_u8.with_capacity",["+",4,["std.bytes.len","bc_payload_b"]]]],["set","bc_elems",["vec_u8.extend_bytes","bc_elems",["codec.write_u32_le","bc_count"]]],["set","bc_elems",["vec_u8.extend_bytes","bc_elems",["bytes.view","bc_payload_b"]]],["let","bc_val",["ext.data_model.value_seq_from_elems",["vec_u8.into_bytes","bc_elems"]]],["let","labels_val",["std.mcp.obs.metrics._labels_tool_v1","tool_utf8"]],["let","new_val",["std.mcp.obs.metrics._hist_series_val_v1",["bytes.view","labels_val"],"new_count","new_sum",["bytes.view","bc_val"]]],["set","payload",["vec_u8.extend_bytes","payload",["codec.write_u32_le",["std.bytes.len","new_val"]]]],["set","payload",["vec_u8.extend_bytes","payload",["bytes.view","new_val"]]],["set","count",["+","count",1]],0],["begin",["let","end",["ext.data_model.skip_value","doc","s_off"]],["if",["<","end",0],0,["begin",["let","val",["view.to_bytes",["view.slice","doc","s_off",["-","end","s_off"]]]],["set","payload",["vec_u8.extend_bytes","payload",["codec.write_u32_le",["std.bytes.len","val"]]]],["set","payload",["vec_u8.extend_bytes","payload",["bytes.view","val"]]],["set","count",["+","count",1]],0]]]],0]]]],["if",["=","found",0],["begin",["let","labels_val",["std.mcp.obs.metrics._labels_tool_v1","tool_utf8"]],["let","bucket_idx2",["std.mcp.obs.metrics._latency_bucket_index_v1","duration_ms"]],["let","bc_payload",["vec_u8.with_capacity",256]],["let","bc_count",0],["for","bi",0,12,["begin",["let","x",["if",[">=","bi","bucket_idx2"],1,0]],["let","s",["std.fmt.s32_to_dec","x"]],["let","v_num",["ext.data_model.value_number",["bytes.view","s"]]],["set","bc_payload",["vec_u8.extend_bytes","bc_payload",["codec.write_u32_le",["std.bytes.len","v_num"]]]],["set","bc_payload",["vec_u8.extend_bytes","bc_payload",["bytes.view","v_num"]]],["set","bc_count",["+","bc_count",1]],0]],["let","bc_payload_b",["vec_u8.into_bytes","bc_payload"]],["let","bc_elems",["vec_u8.with_capacity",["+",4,["std.bytes.len","bc_payload_b"]]]],["set","bc_elems",["vec_u8.extend_bytes","bc_elems",["codec.write_u32_le","bc_count"]]],["set","bc_elems",["vec_u8.extend_bytes","bc_elems",["bytes.view","bc_payload_b"]]],["let","bc_val",["ext.data_model.value_seq_from_elems",["vec_u8.into_bytes","bc_elems"]]],["let","new_val",["std.mcp.obs.metrics._hist_series_val_v1",["bytes.view","labels_val"],1,"duration_ms",["bytes.view","bc_val"]]],["set","payload",["vec_u8.extend_bytes","payload",["codec.write_u32_le",["std.bytes.len","new_val"]]]],["set","payload",["vec_u8.extend_bytes","payload",["bytes.view","new_val"]]],["set","count",["+","count",1]],0],0],["let","payload_b",["vec_u8.into_bytes","payload"]],["let","elems",["vec_u8.with_capacity",["+",4,["std.bytes.len","payload_b"]]]],["set","elems",["vec_u8.extend_bytes","elems",["codec.write_u32_le","count"]]],["set","elems",["vec_u8.extend_bytes","elems",["bytes.view","payload_b"]]],["let","_x07_tmp_borrow_decls_17_body_19_1",["vec_u8.into_bytes","elems"]],["ext.data_model.value_seq_from_elems",["bytes.view","_x07_tmp_borrow_decls_17_body_19_1"]]],"kind":"defn","name":"std.mcp.obs.metrics._update_hist_series_tool_v1","params":[{"name":"doc","ty":"bytes_view"},{"name":"series_off","ty":"i32"},{"name":"tool_utf8","ty":"bytes_view"},{"name":"duration_ms","ty":"i32"}],"result":"bytes"},{"body":["begin",["if",["!=","enabled",1],["return",0],0],["let","_x07_tmp_borrow_decls_18_body_2_1",["bytes.lit","counter"]],["std.mcp.obs.metrics._emit_metric_v1",["bytes.view","_x07_tmp_borrow_decls_18_body_2_1"],"metric_name","label_key","label_value","delta"]],"kind":"defn","name":"std.mcp.obs.metrics.counter_inc_v1","params":[{"name":"enabled","ty":"i32"},{"name":"metric_name","ty":"bytes_view"},{"name":"label_key","ty":"bytes_view"},{"name":"label_value","ty":"bytes_view"},{"name":"delta","ty":"i32"}],"result":"i32"},{"body":["begin",["let","canon",["std.mcp.obs.metrics.snapshot_json_canon_v1","snapshot_json"]],["let","cv",["bytes.view","canon"]],["if",["<=",["view.len","cv"],0],["return",["bytes.alloc",0]],0],["let","doc_b",["ext.json.data_model.parse","cv"]],["let","doc",["bytes.view","doc_b"]],["if",["=",["ext.data_model.doc_is_err","doc"],1],["return",["bytes.alloc",0]],0],["let","out",["std.obs.openmetrics.render_v1","doc"]],["if",["!=",["result_bytes.err_code","out"],0],["return",["bytes.alloc",0]],0],["result_bytes.unwrap_or","out",["bytes.alloc",0]]],"kind":"defn","name":"std.mcp.obs.metrics.export_openmetrics_v1","params":[{"name":"snapshot_json","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","canon",["std.mcp.obs.metrics.snapshot_json_canon_v1","snapshot_json"]],["let","cv",["bytes.view","canon"]],["if",["<=",["view.len","cv"],0],["return",["result_i32.err",1]],0],["let","doc_b",["ext.json.data_model.parse","cv"]],["let","doc",["bytes.view","doc_b"]],["if",["=",["ext.data_model.doc_is_err","doc"],1],["return",["result_i32.err",1]],0],["std.obs.export.otlp_http_export_from_arch_v1","exporter_id_utf8","doc"]],"kind":"defn","name":"std.mcp.obs.metrics.export_otlp_v1","params":[{"name":"snapshot_json","ty":"bytes_view"},{"name":"exporter_id_utf8","ty":"bytes_view"}],"result":"result_i32"},{"body":["begin",["if",["!=","enabled",1],["return",0],0],["let","_x07_tmp_borrow_decls_21_body_2_1",["bytes.lit","hist_ms"]],["std.mcp.obs.metrics._emit_metric_v1",["bytes.view","_x07_tmp_borrow_decls_21_body_2_1"],"metric_name","label_key","label_value","value_ms"]],"kind":"defn","name":"std.mcp.obs.metrics.hist_observe_ms_v1","params":[{"name":"enabled","ty":"i32"},{"name":"metric_name","ty":"bytes_view"},{"name":"label_key","ty":"bytes_view"},{"name":"label_value","ty":"bytes_view"},{"name":"value_ms","ty":"i32"}],"result":"i32"},{"body":["std.mcp.obs.metrics._snapshot_pack_empty_v1"],"kind":"defn","name":"std.mcp.obs.metrics.registry_defaults_v1","params":[],"result":"bytes"},{"body":["begin",["if",["=",["std.mcp.obs.metrics._snapshot_pack_is_v1_v1","snapshot_any"],1],["std.mcp.obs.metrics._snapshot_json_from_pack_v1","snapshot_any"],["ext.json.canon.canonicalize","snapshot_any"]]],"kind":"defn","name":"std.mcp.obs.metrics.snapshot_json_canon_v1","params":[{"name":"snapshot_any","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","tool_utf8",["bytes.alloc",0]],["if",[">",["view.len","labels_json"],0],["begin",["if",["=",["view.get_u8","labels_json",0],123],["begin",["let","ldoc_b",["ext.json.data_model.parse","labels_json"]],["let","ldoc",["bytes.view","ldoc_b"]],["if",["=",["ext.data_model.doc_is_err","ldoc"],0],["begin",["if",["=",["ext.data_model.root_kind","ldoc"],5],["begin",["let","lroot",["ext.data_model.root_offset","ldoc"]],["let","k_tool",["bytes.lit","tool"]],["let","t_off",["ext.data_model.map_find","ldoc","lroot",["bytes.view","k_tool"]]],["if",["if",[">=","t_off",0],["=",["ext.data_model.kind_at","ldoc","t_off"],3],0],["begin",["set","tool_utf8",["ext.data_model.string_get","ldoc","t_off"]],0],0],0],0],0],0],0],["begin",["set","tool_utf8",["view.to_bytes","labels_json"]],0]],0],0],["if",["=",["std.bytes.len","tool_utf8"],0],["return",["view.to_bytes","snapshot_json"]],0],["let","outcome_error",["bytes.lit","error"]],["let","is_error",["if",["=",["bytes.eq","outcome_utf8",["bytes.view","outcome_error"]],1],1,0]],["let","ok_inc",["if",["=","is_error",1],0,1]],["let","err_inc",["if",["=","is_error",1],1,0]],["let","over_inc",["if",["=","budget_overrun_bool",1],1,0]],["let","dur",["if",["<","duration_ms",0],0,"duration_ms"]],["let","idx0",["std.mcp.obs.metrics._latency_bucket_index_v1","dur"]],["let","idx",["if",["<","idx0",0],0,["if",[">","idx0",11],11,"idx0"]]],["let","snap_v","snapshot_json"],["let","is_pack",["if",["&",[">=u",["view.len","snap_v"],8],["=",["codec.read_u32_le","snap_v",0],1]],1,0]],["let","tool_count0",["if",["=","is_pack",1],["codec.read_u32_le","snap_v",4],0]],["let","tool_count",["if",["<","tool_count0",0],0,"tool_count0"]],["let","entries",["vec_u8.with_capacity",["+",["view.len","snap_v"],128]]],["let","off",8],["let","found",0],["for","i",0,"tool_count",["begin",["if",["<u",["view.len","snap_v"],["+","off",4]],["return",["std.mcp.obs.metrics._snapshot_pack_empty_v1"]],0],["let","name_len0",["codec.read_u32_le","snap_v","off"]],["let","name_len",["if",["<","name_len0",0],0,"name_len0"]],["let","name_start",["+","off",4]],["let","counts_start",["+","name_start","name_len"]],["let","entry_end",["+","counts_start",68]],["if",["<u",["view.len","snap_v"],"entry_end"],["return",["std.mcp.obs.metrics._snapshot_pack_empty_v1"]],0],["let","tool_name",["view.slice","snap_v","name_start","name_len"]],["if",["&",["=","found",0],["=",["bytes.eq","tool_name",["bytes.view","tool_utf8"]],1]],["begin",["set","found",1],["let","ok0",["codec.read_u32_le","snap_v","counts_start"]],["let","ok",["if",["<","ok0",0],0,"ok0"]],["let","err0",["codec.read_u32_le","snap_v",["+","counts_start",4]]],["let","err",["if",["<","err0",0],0,"err0"]],["let","cnt0",["codec.read_u32_le","snap_v",["+","counts_start",8]]],["let","cnt",["if",["<","cnt0",0],0,"cnt0"]],["let","sum0",["codec.read_u32_le","snap_v",["+","counts_start",12]]],["let","sum",["if",["<","sum0",0],0,"sum0"]],["let","over0",["codec.read_u32_le","snap_v",["+","counts_start",16]]],["let","over",["if",["<","over0",0],0,"over0"]],["let","bc_start",["+","counts_start",20]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le","name_len"]]],["set","entries",["vec_u8.extend_bytes","entries","tool_name"]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",["+","ok","ok_inc"]]]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",["+","err","err_inc"]]]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",["+","cnt",1]]]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",["+","sum","dur"]]]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",["+","over","over_inc"]]]],["for","b",0,12,["begin",["let","c0",["codec.read_u32_le","snap_v",["+","bc_start",["*","b",4]]]],["let","c",["if",["<","c0",0],0,"c0"]],["let","inc",["if",[">=","b","idx"],1,0]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",["+","c","inc"]]]],0]],0],["begin",["set","entries",["vec_u8.extend_bytes","entries",["view.slice","snap_v","off",["-","entry_end","off"]]]],0]],["set","off","entry_end"],0]],["if",["=","found",0],["begin",["let","name_len",["std.bytes.len","tool_utf8"]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le","name_len"]]],["set","entries",["vec_u8.extend_bytes","entries",["bytes.view","tool_utf8"]]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le","ok_inc"]]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le","err_inc"]]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",1]]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le","dur"]]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le","over_inc"]]],["for","b",0,12,["begin",["let","inc",["if",[">=","b","idx"],1,0]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le","inc"]]],0]],0],0],["let","entries_b",["vec_u8.into_bytes","entries"]],["let","final_count",["+","tool_count",["if",["=","found",1],0,1]]],["let","out",["vec_u8.with_capacity",["+",8,["bytes.len",["bytes.view","entries_b"]]]]],["set","out",["vec_u8.extend_bytes","out",["codec.write_u32_le",1]]],["set","out",["vec_u8.extend_bytes","out",["codec.write_u32_le","final_count"]]],["set","out",["vec_u8.extend_bytes","out",["bytes.view","entries_b"]]],["vec_u8.into_bytes","out"]],"kind":"defn","name":"std.mcp.obs.metrics.snapshot_update_tool_call_v1","params":[{"name":"snapshot_json","ty":"bytes_view"},{"name":"labels_json","ty":"bytes_view"},{"name":"duration_ms","ty":"i32"},{"name":"outcome_utf8","ty":"bytes_view"},{"name":"budget_overrun_bool","ty":"i32"}],"result":"bytes"}],"imports":["ext.data_model","ext.data_model.json","ext.json.canon","ext.json.data_model","std.bytes","std.codec","std.fmt","std.mcp.obs.audit","std.obs.export","std.obs.openmetrics","std.parse"],"kind":"module","module_id":"std.mcp.obs.metrics","schema_version":"x07.x07ast@0.5.0"}
