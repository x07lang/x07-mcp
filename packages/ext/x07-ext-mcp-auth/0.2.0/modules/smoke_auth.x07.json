{"decls":[{"kind":"export","names":["smoke_auth.introspection_request_and_validate","smoke_auth.oauth2_authenticate_invalid_token","smoke_auth.oauth2_authenticate_missing_header","smoke_auth.oauth2_authenticate_ok_and_authorize_scopes","smoke_auth.rs_pack_build"]},{"body":["begin",["let","doc",["ext.data_model.doc_ok","value"]],["let","json_doc",["ext.data_model.json.emit_canon",["bytes.view","doc"]]],["let","jv",["bytes.view","json_doc"]],["if",["=",["ext.data_model.doc_is_err","jv"],1],["return",["bytes.alloc",0]],0],["let","n",["view.len","jv"]],["if",["<u","n",2],["return",["bytes.alloc",0]],0],["view.to_bytes",["view.slice","jv",1,["-","n",1]]]],"kind":"defn","name":"smoke_auth._json_from_value_v1","params":[{"name":"value","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["if",["<","map_off",0],["return","fallback"],0],["let","off",["ext.data_model.map_find","doc","map_off","key"]],["if",["<","off",0],["return","fallback"],0],["if",["!=",["ext.data_model.kind_at","doc","off"],1],["return","fallback"],0],["ext.data_model.bool_get","doc","off"]],"kind":"defn","name":"smoke_auth._map_bool_or_default_v1","params":[{"name":"doc","ty":"bytes_view"},{"name":"map_off","ty":"i32"},{"name":"key","ty":"bytes_view"},{"name":"fallback","ty":"i32"}],"result":"i32"},{"body":["begin",["if",["<","map_off",0],["return",["bytes.alloc",0]],0],["let","off",["ext.data_model.map_find","doc","map_off","key"]],["if",["<","off",0],["return",["bytes.alloc",0]],0],["if",["!=",["ext.data_model.kind_at","doc","off"],2],["return",["bytes.alloc",0]],0],["ext.data_model.number_get","doc","off"]],"kind":"defn","name":"smoke_auth._map_number_text_or_empty_v1","params":[{"name":"doc","ty":"bytes_view"},{"name":"map_off","ty":"i32"},{"name":"key","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["if",["<","map_off",0],["return",["bytes.alloc",0]],0],["let","off",["ext.data_model.map_find","doc","map_off","key"]],["if",["<","off",0],["return",["bytes.alloc",0]],0],["if",["!=",["ext.data_model.kind_at","doc","off"],3],["return",["bytes.alloc",0]],0],["ext.data_model.string_get","doc","off"]],"kind":"defn","name":"smoke_auth._map_string_or_empty_v1","params":[{"name":"doc","ty":"bytes_view"},{"name":"map_off","ty":"i32"},{"name":"key","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","oauth_cfg",["bytes.lit","{\"schema_version\":\"x07.mcp.oauth@0.2.0\",\"resource\":\"http://127.0.0.1:8314/mcp\",\"serve_root_alias\":true,\"authorization_servers\":[\"https://auth.example.com\"],\"scopes_supported\":[\"mcp:tools\",\"mcp:tasks\"],\"bearer_methods_supported\":[\"header\"],\"validation\":{\"kind\":\"test_static\",\"static_tokens\":[{\"token\":\"TOKEN_OK\",\"sub\":\"dev-user\",\"scope\":\"mcp:tools\"}]}}"]],["let","res",["std.mcp.auth.rs_v1.oauth2_rs_from_oauth_cfg_v1",["bytes.view","oauth_cfg"]]],["if",["!=",["result_bytes.err_code","res"],0],["return",["bytes.alloc",0]],0],["result_bytes.unwrap_or","res",["bytes.alloc",0]]],"kind":"defn","name":"smoke_auth._rs_pack_v1","params":[],"result":"bytes"},{"body":["begin",["if",["<","off",0],["return",["bytes.alloc",0]],0],["let","end",["ext.data_model.skip_value","doc","off"]],["if",["<","end",0],["return",["bytes.alloc",0]],0],["view.to_bytes",["view.slice","doc","off",["-","end","off"]]]],"kind":"defn","name":"smoke_auth._value_slice_v1","params":[{"name":"doc","ty":"bytes_view"},{"name":"off","ty":"i32"}],"result":"bytes"},{"body":["begin",["let","cfg_json",["bytes.lit","{\"schema_version\":\"x07.mcp.oauth@0.2.0\",\"resource\":\"http://127.0.0.1:8314/mcp\",\"serve_root_alias\":true,\"authorization_servers\":[\"https://auth.example.com\"],\"scopes_supported\":[],\"bearer_methods_supported\":[\"header\"],\"validation\":{\"kind\":\"introspection_v1\",\"introspection\":{\"url\":\"http://127.0.0.1:8799/oauth2/introspect\",\"auth\":{\"mode\":\"client_secret_basic\",\"client_id\":\"id\",\"client_secret\":\"secret\"}}}}"]],["let","token",["bytes.lit","t+v"]],["let","req",["std.mcp.auth.introspection_v1.introspection_request_v1",["bytes.view","cfg_json"],["bytes.view","token"]]],["let","doc_b",["ext.json.data_model.parse",["bytes.view","req"]]],["let","doc",["bytes.view","doc_b"]],["try",["std.test.assert_i32_eq",["ext.data_model.doc_is_err","doc"],0,["std.test.code_assert_i32_eq"]]],["try",["std.test.assert_i32_eq",["ext.data_model.root_kind","doc"],5,["std.test.code_assert_i32_eq"]]],["let","root",["ext.data_model.root_offset","doc"]],["let","k_url",["bytes.lit","url"]],["let","k_body",["bytes.lit","body"]],["let","k_headers",["bytes.lit","headers"]],["let","k_ct",["bytes.lit","Content-Type"]],["let","k_auth",["bytes.lit","Authorization"]],["try",["std.test.assert_bytes_eq",["smoke_auth._map_string_or_empty_v1","doc","root",["bytes.view","k_url"]],["bytes.lit","http://127.0.0.1:8799/oauth2/introspect"],["std.test.code_assert_bytes_eq"]]],["try",["std.test.assert_bytes_eq",["smoke_auth._map_string_or_empty_v1","doc","root",["bytes.view","k_body"]],["bytes.lit","token=t%2Bv"],["std.test.code_assert_bytes_eq"]]],["let","headers_off",["ext.data_model.map_find","doc","root",["bytes.view","k_headers"]]],["try",["std.test.assert_i32_eq",["ext.data_model.kind_at","doc","headers_off"],5,["std.test.code_assert_i32_eq"]]],["try",["std.test.assert_bytes_eq",["smoke_auth._map_string_or_empty_v1","doc","headers_off",["bytes.view","k_ct"]],["bytes.lit","application/x-www-form-urlencoded"],["std.test.code_assert_bytes_eq"]]],["try",["std.test.assert_bytes_eq",["smoke_auth._map_string_or_empty_v1","doc","headers_off",["bytes.view","k_auth"]],["bytes.lit","Basic aWQ6c2VjcmV0"],["std.test.code_assert_bytes_eq"]]],["let","resp",["bytes.lit","{\"active\":true,\"sub\":\"user-123\",\"scope\":\"b a a\",\"aud\":\"http://127.0.0.1:8314/mcp\"}"]],["let","out",["std.mcp.auth.introspection_v1.introspection_validate_v1",["bytes.view","cfg_json"],["bytes.view","resp"]]],["try",["std.test.assert_bytes_eq","out",["bytes.lit","{\"active\":true,\"aud_json\":\"[\\\"http://127.0.0.1:8314/mcp\\\"]\",\"scope_json\":\"[\\\"a\\\",\\\"b\\\"]\",\"sub\":\"user-123\"}"],["std.test.code_assert_bytes_eq"]]],["std.test.pass"]],"kind":"defn","name":"smoke_auth.introspection_request_and_validate","params":[],"result":"result_i32"},{"body":["begin",["let","rs_pack",["smoke_auth._rs_pack_v1"]],["try",["std.test.assert_i32_eq",[">",["bytes.len",["bytes.view","rs_pack"]],0],1,["std.test.code_assert_i32_eq"]]],["let","req_headers",["bytes.lit","{\"Authorization\":\"Bearer TOKEN_BAD\"}"]],["let","req_scopes",["bytes.lit","mcp:tools"]],["let","pack_json",["std.mcp.auth.rs_v1.oauth2_authenticate_http_v1",["bytes.view","rs_pack"],["bytes.view","req_headers"],["bytes.view","req_scopes"]]],["let","doc_b",["ext.json.data_model.parse",["bytes.view","pack_json"]]],["let","doc",["bytes.view","doc_b"]],["try",["std.test.assert_i32_eq",["ext.data_model.doc_is_err","doc"],0,["std.test.code_assert_i32_eq"]]],["try",["std.test.assert_i32_eq",["ext.data_model.root_kind","doc"],5,["std.test.code_assert_i32_eq"]]],["let","root",["ext.data_model.root_offset","doc"]],["let","k_ok",["bytes.lit","ok"]],["let","k_err_status",["bytes.lit","err_status"]],["let","k_err_www",["bytes.lit","err_www_authenticate"]],["try",["std.test.assert_i32_eq",["smoke_auth._map_bool_or_default_v1","doc","root",["bytes.view","k_ok"],1],0,["std.test.code_assert_i32_eq"]]],["try",["std.test.assert_bytes_eq",["smoke_auth._map_number_text_or_empty_v1","doc","root",["bytes.view","k_err_status"]],["bytes.lit","401"],["std.test.code_assert_bytes_eq"]]],["try",["std.test.assert_bytes_eq",["smoke_auth._map_string_or_empty_v1","doc","root",["bytes.view","k_err_www"]],["bytes.lit","Bearer resource_metadata=\"http://127.0.0.1:8314/.well-known/oauth-protected-resource/mcp\", scope=\"mcp:tools\", error=\"invalid_token\""],["std.test.code_assert_bytes_eq"]]],["std.test.pass"]],"kind":"defn","name":"smoke_auth.oauth2_authenticate_invalid_token","params":[],"result":"result_i32"},{"body":["begin",["let","rs_pack",["smoke_auth._rs_pack_v1"]],["try",["std.test.assert_i32_eq",[">",["bytes.len",["bytes.view","rs_pack"]],0],1,["std.test.code_assert_i32_eq"]]],["let","req_headers",["bytes.lit","{}"]],["let","req_scopes",["bytes.lit","mcp:tools"]],["let","pack_json",["std.mcp.auth.rs_v1.oauth2_authenticate_http_v1",["bytes.view","rs_pack"],["bytes.view","req_headers"],["bytes.view","req_scopes"]]],["let","doc_b",["ext.json.data_model.parse",["bytes.view","pack_json"]]],["let","doc",["bytes.view","doc_b"]],["try",["std.test.assert_i32_eq",["ext.data_model.doc_is_err","doc"],0,["std.test.code_assert_i32_eq"]]],["try",["std.test.assert_i32_eq",["ext.data_model.root_kind","doc"],5,["std.test.code_assert_i32_eq"]]],["let","root",["ext.data_model.root_offset","doc"]],["let","k_ok",["bytes.lit","ok"]],["let","k_err_status",["bytes.lit","err_status"]],["let","k_err_www",["bytes.lit","err_www_authenticate"]],["try",["std.test.assert_i32_eq",["smoke_auth._map_bool_or_default_v1","doc","root",["bytes.view","k_ok"],1],0,["std.test.code_assert_i32_eq"]]],["try",["std.test.assert_bytes_eq",["smoke_auth._map_number_text_or_empty_v1","doc","root",["bytes.view","k_err_status"]],["bytes.lit","401"],["std.test.code_assert_bytes_eq"]]],["try",["std.test.assert_bytes_eq",["smoke_auth._map_string_or_empty_v1","doc","root",["bytes.view","k_err_www"]],["bytes.lit","Bearer resource_metadata=\"http://127.0.0.1:8314/.well-known/oauth-protected-resource/mcp\", scope=\"mcp:tools\""],["std.test.code_assert_bytes_eq"]]],["std.test.pass"]],"kind":"defn","name":"smoke_auth.oauth2_authenticate_missing_header","params":[],"result":"result_i32"},{"body":["begin",["let","rs_pack",["smoke_auth._rs_pack_v1"]],["try",["std.test.assert_i32_eq",[">",["bytes.len",["bytes.view","rs_pack"]],0],1,["std.test.code_assert_i32_eq"]]],["let","req_headers",["bytes.lit","{\"Authorization\":\"Bearer TOKEN_OK\"}"]],["let","req_scopes",["bytes.lit","mcp:tools"]],["let","pack_json",["std.mcp.auth.rs_v1.oauth2_authenticate_http_v1",["bytes.view","rs_pack"],["bytes.view","req_headers"],["bytes.view","req_scopes"]]],["let","doc_b",["ext.json.data_model.parse",["bytes.view","pack_json"]]],["let","doc",["bytes.view","doc_b"]],["try",["std.test.assert_i32_eq",["ext.data_model.doc_is_err","doc"],0,["std.test.code_assert_i32_eq"]]],["try",["std.test.assert_i32_eq",["ext.data_model.root_kind","doc"],5,["std.test.code_assert_i32_eq"]]],["let","root",["ext.data_model.root_offset","doc"]],["let","k_ok",["bytes.lit","ok"]],["let","k_ctx",["bytes.lit","ctx"]],["try",["std.test.assert_i32_eq",["smoke_auth._map_bool_or_default_v1","doc","root",["bytes.view","k_ok"],0],1,["std.test.code_assert_i32_eq"]]],["let","ctx_off",["ext.data_model.map_find","doc","root",["bytes.view","k_ctx"]]],["let","ctx_val",["smoke_auth._value_slice_v1","doc","ctx_off"]],["let","ctx_json",["smoke_auth._json_from_value_v1",["bytes.view","ctx_val"]]],["let","s_tools",["bytes.lit","mcp:tools"]],["let","s_tasks",["bytes.lit","mcp:tasks"]],["try",["std.test.assert_i32_eq",["std.mcp.auth.rs_v1.oauth2_authorize_scopes_v1",["bytes.view","ctx_json"],["bytes.view","s_tools"]],1,["std.test.code_assert_i32_eq"]]],["try",["std.test.assert_i32_eq",["std.mcp.auth.rs_v1.oauth2_authorize_scopes_v1",["bytes.view","ctx_json"],["bytes.view","s_tasks"]],0,["std.test.code_assert_i32_eq"]]],["std.test.pass"]],"kind":"defn","name":"smoke_auth.oauth2_authenticate_ok_and_authorize_scopes","params":[],"result":"result_i32"},{"body":["begin",["let","rs_pack",["smoke_auth._rs_pack_v1"]],["try",["std.test.assert_i32_eq",[">",["bytes.len",["bytes.view","rs_pack"]],0],1,["std.test.code_assert_i32_eq"]]],["let","doc_b",["ext.json.data_model.parse",["bytes.view","rs_pack"]]],["let","doc",["bytes.view","doc_b"]],["try",["std.test.assert_i32_eq",["ext.data_model.doc_is_err","doc"],0,["std.test.code_assert_i32_eq"]]],["try",["std.test.assert_i32_eq",["ext.data_model.root_kind","doc"],5,["std.test.code_assert_i32_eq"]]],["let","root",["ext.data_model.root_offset","doc"]],["let","k_md",["bytes.lit","resource_metadata_url"]],["let","k_md_root",["bytes.lit","resource_metadata_root_url"]],["try",["std.test.assert_bytes_eq",["smoke_auth._map_string_or_empty_v1","doc","root",["bytes.view","k_md"]],["bytes.lit","http://127.0.0.1:8314/.well-known/oauth-protected-resource/mcp"],["std.test.code_assert_bytes_eq"]]],["try",["std.test.assert_bytes_eq",["smoke_auth._map_string_or_empty_v1","doc","root",["bytes.view","k_md_root"]],["bytes.lit","http://127.0.0.1:8314/.well-known/oauth-protected-resource"],["std.test.code_assert_bytes_eq"]]],["std.test.pass"]],"kind":"defn","name":"smoke_auth.rs_pack_build","params":[],"result":"result_i32"}],"imports":["ext.data_model","ext.data_model.json","ext.json.data_model","std.bytes","std.mcp.auth.introspection_v1","std.mcp.auth.rs_v1","std.test"],"kind":"module","module_id":"smoke_auth","schema_version":"x07.x07ast@0.3.0"}
