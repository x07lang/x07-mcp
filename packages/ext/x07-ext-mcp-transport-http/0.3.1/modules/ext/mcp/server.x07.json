{"decls":[{"kind":"export","names":["ext.mcp.server.dispatch_jsonrpc_v1","ext.mcp.server.make_router_from_fs_v1","ext.mcp.server.serve_http_from_fs_v1"]},{"body":["begin",["let","doc_b",["ext.json.data_model.parse","advance_on_json"]],["let","doc",["bytes.view","doc_b"]],["if",["=",["ext.data_model.doc_is_err","doc"],1],["return",0],0],["if",["!=",["ext.data_model.root_kind","doc"],4],["return",0],0],["let","root",["ext.data_model.root_offset","doc"]],["let","n",["ext.data_model.seq_len","doc","root"]],["for","i",0,"n",["begin",["let","off",["ext.data_model.seq_get","doc","root","i"]],["if",["<","off",0],0,["begin",["if",["=",["ext.data_model.kind_at","doc","off"],3],["begin",["let","s",["ext.data_model.string_get","doc","off"]],["if",["=",["view.eq",["bytes.view","s"],"method_utf8"],1],["return",1],0],0],0],0]],0]],0],"kind":"defn","name":"ext.mcp.server._advance_on_has_v1","params":[{"name":"advance_on_json","ty":"bytes_view"},{"name":"method_utf8","ty":"bytes_view"}],"result":"i32"},{"body":["begin",["let","fixed",["ext.mcp.server._state_fixed_bytes_v1"]],["let","name_len",["ext.mcp.server._u32_at_v1","st",15]],["let","ver_len",["ext.mcp.server._u32_at_v1","st",16]],["let","proto_len",["ext.mcp.server._u32_at_v1","st",17]],["let","idp_len",["ext.mcp.server._u32_at_v1","st",18]],["let","tools_len",["ext.mcp.server._u32_at_v1","st",19]],["let","seg_len",["ext.mcp.server._u32_at_v1","st",20]],["let","seg_start",["+",["+",["+",["+",["+","fixed","name_len"],"ver_len"],"proto_len"],"idp_len"],"tools_len"]],["ext.mcp.server._slice_seg_v1","st","seg_start","seg_len"]],"kind":"defn","name":"ext.mcp.server._advance_on_json_v1","params":[{"name":"st","ty":"bytes_view"}],"result":"bytes"},{"body":["std.mcp.sandbox.task_exec_deterministic_v1.advance_task_v1","tools_json","store","auth_context_id","task_id_utf8","clock_unix_lo","clock_unix_hi","clock_step_ms","complete_after"],"kind":"defn","name":"ext.mcp.server._advance_task_det_v1","params":[{"name":"tools_json","ty":"bytes_view"},{"name":"store","ty":"bytes"},{"name":"auth_context_id","ty":"bytes_view"},{"name":"task_id_utf8","ty":"bytes_view"},{"name":"clock_unix_lo","ty":"i32"},{"name":"clock_unix_hi","ty":"i32"},{"name":"clock_step_ms","ty":"i32"},{"name":"complete_after","ty":"i32"}],"result":"bytes"},{"body":["begin",["let","hdr_auth",["bytes.lit","Authorization"]],["let","hdr_sid",["bytes.lit","MCP-Session-Id"]],["let","authz",["std.net.http.server.req_header_get_v1","req_doc",["bytes.view","hdr_auth"]]],["begin",["let","authz_v",["bytes.view","authz"]],["if",[">",["bytes.len","authz_v"],0],["begin",["let","pfx",["bytes.lit","authz:"]],["let","raw",["std.bytes.concat",["bytes.view","pfx"],"authz_v"]],["let","digest",["ext.crypto.sha256",["bytes.view","raw"]]],["ext.hex.hex_encode",["bytes.view","digest"]]],["begin",["let","sid",["std.net.http.server.req_header_get_v1","req_doc",["bytes.view","hdr_sid"]]],["let","pfx",["bytes.lit","sess:"]],["let","raw",["std.bytes.concat",["bytes.view","pfx"],["bytes.view","sid"]]],["let","digest",["ext.crypto.sha256",["bytes.view","raw"]]],["ext.hex.hex_encode",["bytes.view","digest"]]]]]],"kind":"defn","name":"ext.mcp.server._auth_context_id_from_http_req_v1","params":[{"name":"req_doc","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","fixed",["ext.mcp.server._state_fixed_bytes_v1"]],["let","name_len",["ext.mcp.server._u32_at_v1","st",15]],["let","ver_len",["ext.mcp.server._u32_at_v1","st",16]],["let","proto_len",["ext.mcp.server._u32_at_v1","st",17]],["let","idp_len",["ext.mcp.server._u32_at_v1","st",18]],["let","tools_len",["ext.mcp.server._u32_at_v1","st",19]],["let","adv_len",["ext.mcp.server._u32_at_v1","st",20]],["let","seg_len",["ext.mcp.server._u32_at_v1","st",21]],["let","seg_start",["+",["+",["+",["+",["+",["+","fixed","name_len"],"ver_len"],"proto_len"],"idp_len"],"tools_len"],"adv_len"]],["ext.mcp.server._slice_seg_v1","st","seg_start","seg_len"]],"kind":"defn","name":"ext.mcp.server._auth_context_id_utf8_v1","params":[{"name":"st","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","doc_b",["ext.json.data_model.parse","tool_result_json"]],["let","doc",["bytes.view","doc_b"]],["if",["=",["ext.data_model.doc_is_err","doc"],1],["return",["bytes.alloc",0]],0],["if",["!=",["ext.data_model.root_kind","doc"],5],["return",["bytes.alloc",0]],0],["let","root",["ext.data_model.root_offset","doc"]],["let","n",["ext.data_model.map_len","doc","root"]],["let","k_meta",["bytes.lit","_meta"]],["let","keep",0],["for","i",0,"n",["begin",["let","k",["ext.data_model.map_key_at","doc","root","i"]],["if",["=",["bytes.eq",["bytes.view","k"],["bytes.view","k_meta"]],1],0,["set","keep",["+","keep",1]]]]],["let","meta_key",["bytes.lit","io.modelcontextprotocol/related-task"]],["let","taskid_key",["bytes.lit","taskId"]],["let","v_taskid",["ext.data_model.value_string","task_id_utf8"]],["let","meta_entries",["vec_u8.with_capacity",96]],["set","meta_entries",["vec_u8.extend_bytes","meta_entries",["codec.write_u32_le",1]]],["set","meta_entries",["vec_u8.extend_bytes","meta_entries",["codec.write_u32_le",["bytes.len",["bytes.view","taskid_key"]]]]],["set","meta_entries",["vec_u8.extend_bytes","meta_entries",["bytes.view","taskid_key"]]],["set","meta_entries",["vec_u8.extend_bytes","meta_entries",["codec.write_u32_le",["bytes.len","v_taskid"]]]],["set","meta_entries",["vec_u8.extend_bytes","meta_entries","v_taskid"]],["let","meta_entries_b",["vec_u8.into_bytes","meta_entries"]],["let","meta_task_val",["ext.data_model.value_map_from_entries",["bytes.view","meta_entries_b"]]],["let","outer_meta_entries",["vec_u8.with_capacity",128]],["set","outer_meta_entries",["vec_u8.extend_bytes","outer_meta_entries",["codec.write_u32_le",1]]],["set","outer_meta_entries",["vec_u8.extend_bytes","outer_meta_entries",["codec.write_u32_le",["bytes.len",["bytes.view","meta_key"]]]]],["set","outer_meta_entries",["vec_u8.extend_bytes","outer_meta_entries",["bytes.view","meta_key"]]],["set","outer_meta_entries",["vec_u8.extend_bytes","outer_meta_entries",["codec.write_u32_le",["bytes.len","meta_task_val"]]]],["set","outer_meta_entries",["vec_u8.extend_bytes","outer_meta_entries","meta_task_val"]],["let","outer_meta_entries_b",["vec_u8.into_bytes","outer_meta_entries"]],["let","outer_meta_val",["ext.data_model.value_map_from_entries",["bytes.view","outer_meta_entries_b"]]],["let","entries",["vec_u8.with_capacity",512]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",["+","keep",1]]]],["for","j",0,"n",["begin",["let","k2",["ext.data_model.map_key_at","doc","root","j"]],["begin",["let","_x07_tmp_copy",["bytes.view","k2"]],["if",["=",["bytes.eq","_x07_tmp_copy",["bytes.view","k_meta"]],1],0,["begin",["let","klen",["bytes.len",["bytes.view","k2"]]],["let","v_off",["ext.data_model.map_value_at","doc","root","j"]],["let","v_end",["ext.data_model.skip_value","doc","v_off"]],["if",["<","v_end",0],0,["begin",["let","v_dm",["view.to_bytes",["view.slice","doc","v_off",["-","v_end","v_off"]]]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le","klen"]]],["set","entries",["vec_u8.extend_bytes","entries",["bytes.view","k2"]]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",["bytes.len",["bytes.view","v_dm"]]]]],["set","entries",["vec_u8.extend_bytes","entries",["bytes.view","v_dm"]]],0]]]]]]],["let","meta_k",["bytes.lit","_meta"]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",["bytes.len",["bytes.view","meta_k"]]]]],["set","entries",["vec_u8.extend_bytes","entries",["bytes.view","meta_k"]]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",["bytes.len","outer_meta_val"]]]],["set","entries",["vec_u8.extend_bytes","entries","outer_meta_val"]],["let","entries_b",["vec_u8.into_bytes","entries"]],["let","val",["ext.data_model.value_map_from_entries",["bytes.view","entries_b"]]],["std.mcp.util.json.json_from_value_v1",["bytes.view","val"]]],"kind":"defn","name":"ext.mcp.server._call_tool_result_with_related_task_meta_v1","params":[{"name":"tool_result_json","ty":"bytes_view"},{"name":"task_id_utf8","ty":"bytes_view"}],"result":"bytes"},{"body":["ext.time.rfc3339.format_v1","unix_lo","unix_hi",0,0,["bytes.alloc",0]],"kind":"defn","name":"ext.mcp.server._clock_now_fixed_rfc3339_v1","params":[{"name":"unix_lo","ty":"i32"},{"name":"unix_hi","ty":"i32"}],"result":"bytes"},{"body":["if",["=","clock_step_ms",0],["ext.time.os.now_rfc3339_utc_v1"],["ext.mcp.server._clock_now_fixed_rfc3339_v1","unix_lo","unix_hi"]],"kind":"defn","name":"ext.mcp.server._clock_now_rfc3339_v1","params":[{"name":"unix_lo","ty":"i32"},{"name":"unix_hi","ty":"i32"},{"name":"clock_step_ms","ty":"i32"}],"result":"bytes"},{"body":["begin",["let","empty",["bytes.alloc",0]],["let","doc_b",["ext.json.data_model.parse","resp_json"]],["let","doc",["bytes.view","doc_b"]],["if",["=",["ext.data_model.doc_is_err","doc"],1],["return","empty"],0],["if",["!=",["ext.data_model.root_kind","doc"],5],["return","empty"],0],["let","root",["ext.data_model.root_offset","doc"]],["let","k_result",["bytes.lit","result"]],["let","result_off",["ext.data_model.map_find","doc","root",["bytes.view","k_result"]]],["if",["<","result_off",0],["return","empty"],0],["if",["!=",["ext.data_model.kind_at","doc","result_off"],5],["return","empty"],0],["let","k_task",["bytes.lit","task"]],["let","task_off",["ext.data_model.map_find","doc","result_off",["bytes.view","k_task"]]],["if",["<","task_off",0],["return","empty"],0],["if",["!=",["ext.data_model.kind_at","doc","task_off"],5],["return","empty"],0],["let","k_task_id",["bytes.lit","taskId"]],["ext.mcp.server._map_string_or_empty_v1","doc","task_off",["bytes.view","k_task_id"]]],"kind":"defn","name":"ext.mcp.server._create_task_task_id_from_response_v1","params":[{"name":"resp_json","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["if",["<",["view.len","dispatch_doc"],12],["return",["bytes.alloc",0]],0],["if",["!=",["codec.read_u32_le","dispatch_doc",0],1],["return",["bytes.alloc",0]],0],["let","ns_len",["codec.read_u32_le","dispatch_doc",4]],["let","start",8],["if",["<u",["view.len","dispatch_doc"],["+","start","ns_len"]],["return",["bytes.alloc",0]],0],["view.to_bytes",["view.slice","dispatch_doc","start","ns_len"]]],"kind":"defn","name":"ext.mcp.server._dispatch_next_state_v1","params":[{"name":"dispatch_doc","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["if",["<",["view.len","dispatch_doc"],12],["return",["bytes.alloc",0]],0],["if",["!=",["codec.read_u32_le","dispatch_doc",0],1],["return",["bytes.alloc",0]],0],["let","ns_len",["codec.read_u32_le","dispatch_doc",4]],["let","out_off",["+",8,["if",["<","ns_len",0],0,"ns_len"]]],["if",["<u",["view.len","dispatch_doc"],["+","out_off",4]],["return",["bytes.alloc",0]],0],["let","out_len",["codec.read_u32_le","dispatch_doc","out_off"]],["let","start",["+","out_off",4]],["if",["<u",["view.len","dispatch_doc"],["+","start","out_len"]],["return",["bytes.alloc",0]],0],["view.to_bytes",["view.slice","dispatch_doc","start","out_len"]]],"kind":"defn","name":"ext.mcp.server._dispatch_out_jsonl_v1","params":[{"name":"dispatch_doc","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","ns_len",["view.len","next_state"]],["let","out_len",["view.len","out_jsonl"]],["let","buf",["vec_u8.with_capacity",["+",12,["+","ns_len","out_len"]]]],["set","buf",["vec_u8.extend_bytes","buf",["codec.write_u32_le",1]]],["set","buf",["vec_u8.extend_bytes","buf",["codec.write_u32_le","ns_len"]]],["if",[">","ns_len",0],["begin",["set","buf",["vec_u8.extend_bytes","buf","next_state"]],0],0],["set","buf",["vec_u8.extend_bytes","buf",["codec.write_u32_le","out_len"]]],["if",[">","out_len",0],["begin",["set","buf",["vec_u8.extend_bytes","buf","out_jsonl"]],0],0],["vec_u8.into_bytes","buf"]],"kind":"defn","name":"ext.mcp.server._dispatch_pack_v1","params":[{"name":"next_state","ty":"bytes_view"},{"name":"out_jsonl","ty":"bytes_view"}],"result":"bytes"},{"body":7902,"kind":"defn","name":"ext.mcp.server._err_invalid_jsonrpc_v1","params":[],"result":"i32"},{"body":7901,"kind":"defn","name":"ext.mcp.server._err_invalid_router_state_v1","params":[],"result":"i32"},{"body":["begin",["let","proto_val",["ext.data_model.value_string","protocol_version_utf8"]],["let","name_val",["ext.data_model.value_string","server_name_utf8"]],["let","ver_val",["ext.data_model.value_string","server_version_utf8"]],["let","proto_json",["std.mcp.util.json.json_from_value_v1",["bytes.view","proto_val"]]],["let","name_json",["std.mcp.util.json.json_from_value_v1",["bytes.view","name_val"]]],["let","ver_json",["std.mcp.util.json.json_from_value_v1",["bytes.view","ver_val"]]],["let","lit0",["bytes.lit","{\"capabilities\":{"]],["let","lit_tools",["bytes.lit","\"tools\":{\"listChanged\":false}"]],["let","lit_tasks_full",["bytes.lit","\"tasks\":{\"cancel\":{},\"list\":{},\"requests\":{\"tools\":{\"call\":{}}}}"]],["let","lit_tasks_base",["bytes.lit","\"tasks\":{\"cancel\":{},\"list\":{}}"]],["let","lit_comma",["bytes.lit",","]],["let","lit1",["bytes.lit","},\"protocolVersion\":"]],["let","lit2",["bytes.lit",",\"serverInfo\":{\"name\":"]],["let","lit3",["bytes.lit",",\"version\":"]],["let","lit_end",["bytes.lit","}}"]],["let","out",["vec_u8.with_capacity",256]],["set","out",["vec_u8.extend_bytes","out",["bytes.view","lit0"]]],["if",["=","tasks_enabled",1],["begin",["if",["=","tasks_req_call",1],["set","out",["vec_u8.extend_bytes","out",["bytes.view","lit_tasks_full"]]],["set","out",["vec_u8.extend_bytes","out",["bytes.view","lit_tasks_base"]]]],0,["set","out",["vec_u8.extend_bytes","out",["bytes.view","lit_comma"]]],["set","out",["vec_u8.extend_bytes","out",["bytes.view","lit_tools"]]],0],["begin",["set","out",["vec_u8.extend_bytes","out",["bytes.view","lit_tools"]]],0]],["set","out",["vec_u8.extend_bytes","out",["bytes.view","lit1"]]],["set","out",["vec_u8.extend_bytes","out",["bytes.view","proto_json"]]],["set","out",["vec_u8.extend_bytes","out",["bytes.view","lit2"]]],["set","out",["vec_u8.extend_bytes","out",["bytes.view","name_json"]]],["set","out",["vec_u8.extend_bytes","out",["bytes.view","lit3"]]],["set","out",["vec_u8.extend_bytes","out",["bytes.view","ver_json"]]],["set","out",["vec_u8.extend_bytes","out",["bytes.view","lit_end"]]],["vec_u8.into_bytes","out"]],"kind":"defn","name":"ext.mcp.server._initialize_result_json_v1","params":[{"name":"protocol_version_utf8","ty":"bytes_view"},{"name":"server_name_utf8","ty":"bytes_view"},{"name":"server_version_utf8","ty":"bytes_view"},{"name":"tasks_enabled","ty":"i32"},{"name":"tasks_req_call","ty":"i32"}],"result":"bytes"},{"body":["begin",["let","n0",["view.len","jsonl"]],["if",["<=","n0",0],["return",["bytes.alloc",0]],0],["let","n","n0"],["for","j",0,"n0",["begin",["if",["<=","n",0],["set","j","n0"],["if",["=",["view.get_u8","jsonl",["-","n",1]],10],["set","n",["-","n",1]],["set","j","n0"]]],0]],["if",["<=","n",0],["return",["bytes.alloc",0]],0],["let","last_nl",-1],["for","i",0,"n",["begin",["if",["=",["view.get_u8","jsonl","i"],10],["set","last_nl","i"],0],0]],["let","start",["+","last_nl",1]],["view.to_bytes",["view.slice","jsonl","start",["-","n","start"]]]],"kind":"defn","name":"ext.mcp.server._jsonl_last_line_v1","params":[{"name":"jsonl","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","n",["view.len","jsonl"]],["let","out",["vec_u8.with_capacity",["+","n",64]]],["let","line_start",0],["let","seq",1],["for","i",0,"n",["begin",["if",["=",["view.get_u8","jsonl","i"],10],["begin",["let","line",["view.slice","jsonl","line_start",["-","i","line_start"]]],["set","line_start",["+","i",1]],["if",[">",["view.len","line"],0],["begin",["let","id_dec",["std.fmt.s32_to_dec","seq"]],["let","ev",["std.mcp.transport.http_sse.encode_event_v1",["bytes.view","id_dec"],"line"]],["set","out",["vec_u8.extend_bytes","out",["bytes.view","ev"]]],["set","seq",["+","seq",1]],0],0],0],0],0]],["if",["<","line_start","n"],["begin",["let","tail",["view.slice","jsonl","line_start",["-","n","line_start"]]],["if",[">",["view.len","tail"],0],["begin",["let","id_dec",["std.fmt.s32_to_dec","seq"]],["let","ev",["std.mcp.transport.http_sse.encode_event_v1",["bytes.view","id_dec"],"tail"]],["set","out",["vec_u8.extend_bytes","out",["bytes.view","ev"]]],0],0],0],0],["vec_u8.into_bytes","out"]],"kind":"defn","name":"ext.mcp.server._jsonl_to_sse_body_v1","params":[{"name":"jsonl","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","doc_b",["ext.json.data_model.parse","msg_json"]],["let","doc",["bytes.view","doc_b"]],["if",["=",["ext.data_model.doc_is_err","doc"],1],["return",["bytes.alloc",0]],0],["if",["!=",["ext.data_model.root_kind","doc"],5],["return",["bytes.alloc",0]],0],["let","root",["ext.data_model.root_offset","doc"]],["let","n",["ext.data_model.map_len","doc","root"]],["let","k_meta",["bytes.lit","_meta"]],["let","keep",0],["for","i",0,"n",["begin",["let","k",["ext.data_model.map_key_at","doc","root","i"]],["if",["=",["bytes.eq",["bytes.view","k"],["bytes.view","k_meta"]],1],0,["set","keep",["+","keep",1]]]]],["let","meta_key",["bytes.lit","io.modelcontextprotocol/related-task"]],["let","taskid_key",["bytes.lit","taskId"]],["let","v_taskid",["ext.data_model.value_string","task_id_utf8"]],["let","meta_entries",["vec_u8.with_capacity",96]],["set","meta_entries",["vec_u8.extend_bytes","meta_entries",["codec.write_u32_le",1]]],["set","meta_entries",["vec_u8.extend_bytes","meta_entries",["codec.write_u32_le",["bytes.len",["bytes.view","taskid_key"]]]]],["set","meta_entries",["vec_u8.extend_bytes","meta_entries",["bytes.view","taskid_key"]]],["set","meta_entries",["vec_u8.extend_bytes","meta_entries",["codec.write_u32_le",["bytes.len","v_taskid"]]]],["set","meta_entries",["vec_u8.extend_bytes","meta_entries","v_taskid"]],["let","meta_entries_b",["vec_u8.into_bytes","meta_entries"]],["let","meta_task_val",["ext.data_model.value_map_from_entries",["bytes.view","meta_entries_b"]]],["let","outer_meta_entries",["vec_u8.with_capacity",128]],["set","outer_meta_entries",["vec_u8.extend_bytes","outer_meta_entries",["codec.write_u32_le",1]]],["set","outer_meta_entries",["vec_u8.extend_bytes","outer_meta_entries",["codec.write_u32_le",["bytes.len",["bytes.view","meta_key"]]]]],["set","outer_meta_entries",["vec_u8.extend_bytes","outer_meta_entries",["bytes.view","meta_key"]]],["set","outer_meta_entries",["vec_u8.extend_bytes","outer_meta_entries",["codec.write_u32_le",["bytes.len","meta_task_val"]]]],["set","outer_meta_entries",["vec_u8.extend_bytes","outer_meta_entries","meta_task_val"]],["let","outer_meta_entries_b",["vec_u8.into_bytes","outer_meta_entries"]],["let","outer_meta_val",["ext.data_model.value_map_from_entries",["bytes.view","outer_meta_entries_b"]]],["let","entries",["vec_u8.with_capacity",768]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",["+","keep",1]]]],["for","j",0,"n",["begin",["let","k2",["ext.data_model.map_key_at","doc","root","j"]],["begin",["let","_x07_tmp_copy",["bytes.view","k2"]],["if",["=",["bytes.eq","_x07_tmp_copy",["bytes.view","k_meta"]],1],0,["begin",["let","klen",["bytes.len",["bytes.view","k2"]]],["let","v_off",["ext.data_model.map_value_at","doc","root","j"]],["let","v_end",["ext.data_model.skip_value","doc","v_off"]],["if",["<","v_end",0],0,["begin",["let","v_dm",["view.to_bytes",["view.slice","doc","v_off",["-","v_end","v_off"]]]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le","klen"]]],["set","entries",["vec_u8.extend_bytes","entries",["bytes.view","k2"]]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",["bytes.len",["bytes.view","v_dm"]]]]],["set","entries",["vec_u8.extend_bytes","entries",["bytes.view","v_dm"]]],0]]]]]]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",["bytes.len",["bytes.view","k_meta"]]]]],["set","entries",["vec_u8.extend_bytes","entries",["bytes.view","k_meta"]]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",["bytes.len","outer_meta_val"]]]],["set","entries",["vec_u8.extend_bytes","entries","outer_meta_val"]],["let","entries_b",["vec_u8.into_bytes","entries"]],["let","val",["ext.data_model.value_map_from_entries",["bytes.view","entries_b"]]],["std.mcp.util.json.json_from_value_v1",["bytes.view","val"]]],"kind":"defn","name":"ext.mcp.server._jsonrpc_msg_with_related_task_meta_v1","params":[{"name":"msg_json","ty":"bytes_view"},{"name":"task_id_utf8","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["if",["<","map_off",0],["return",["bytes.alloc",0]],0],["let","off",["ext.data_model.map_find","doc","map_off","key"]],["if",["<","off",0],["return",["bytes.alloc",0]],0],["if",["!=",["ext.data_model.kind_at","doc","off"],3],["return",["bytes.alloc",0]],0],["ext.data_model.string_get","doc","off"]],"kind":"defn","name":"ext.mcp.server._map_string_or_empty_v1","params":[{"name":"doc","ty":"bytes_view"},{"name":"map_off","ty":"i32"},{"name":"key","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["if",["<","map_off",0],["return",["bytes.alloc",0]],0],["let","off",["ext.data_model.map_find","doc","map_off","key"]],["if",["<","off",0],["return",["bytes.alloc",0]],0],["let","end",["ext.data_model.skip_value","doc","off"]],["if",["<","end",0],["return",["bytes.alloc",0]],0],["let","val",["view.to_bytes",["view.slice","doc","off",["-","end","off"]]]],["std.mcp.util.json.json_from_value_v1",["bytes.view","val"]]],"kind":"defn","name":"ext.mcp.server._map_value_json_or_empty_v1","params":[{"name":"doc","ty":"bytes_view"},{"name":"map_off","ty":"i32"},{"name":"key","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","st",["std.parse.i32_status_le","b"]],["if",["if",[">=u",["bytes.len","st"],5],["=",["bytes.get_u8","st",0],1],0],["codec.read_u32_le","st",1],0]],"kind":"defn","name":"ext.mcp.server._parse_i32_or_0_v1","params":[{"name":"b","ty":"bytes_view"}],"result":"i32"},{"body":["begin",["let","key",["std.mcp.progress_registry.token_key_v1","progress_token_json"]],["if",["=",["bytes.len",["bytes.view","key"]],0],["return",0],0],["let","cursor",["bytes.alloc",0]],["let","res",["std.mcp.sandbox.task_store_any_v1.list_tasks_json_v1","store","auth_context_id",["bytes.view","cursor"],"max_tasks"]],["if",["!=",["result_bytes.err_code","res"],0],["return",0],0],["let","list_json",["result_bytes.unwrap_or","res",["bytes.alloc",0]]],["let","doc_b",["ext.json.data_model.parse",["bytes.view","list_json"]]],["let","doc",["bytes.view","doc_b"]],["if",["=",["ext.data_model.doc_is_err","doc"],1],["return",0],0],["if",["!=",["ext.data_model.root_kind","doc"],5],["return",0],0],["let","root",["ext.data_model.root_offset","doc"]],["let","k_tasks",["bytes.lit","tasks"]],["let","tasks_off",["ext.data_model.map_find","doc","root",["bytes.view","k_tasks"]]],["if",["if",["<","tasks_off",0],1,["!=",["ext.data_model.kind_at","doc","tasks_off"],4]],["return",0],0],["let","n",["ext.data_model.seq_len","doc","tasks_off"]],["if",["<","n",0],["return",0],0],["let","k_taskId",["bytes.lit","taskId"]],["for","i",0,"n",["begin",["let","it",["ext.data_model.seq_get","doc","tasks_off","i"]],["if",["<","it",0],0,["begin",["if",["!=",["ext.data_model.kind_at","doc","it"],5],0,["begin",["let","tid_off",["ext.data_model.map_find","doc","it",["bytes.view","k_taskId"]]],["if",["if",["<","tid_off",0],1,["!=",["ext.data_model.kind_at","doc","tid_off"],3]],0,["begin",["let","tid",["ext.data_model.string_get","doc","tid_off"]],["let","st",["std.mcp.sandbox.task_store_any_v1.get_task_status_v1","store","auth_context_id",["bytes.view","tid"]]],["if",["&",[">=","st",0],["<","st",2]],["begin",["let","pt_res",["std.mcp.sandbox.task_store_any_v1.get_task_progress_token_json_v1","store","auth_context_id",["bytes.view","tid"]]],["let","pt",["result_bytes.unwrap_or","pt_res",["bytes.alloc",0]]],["let","key2",["std.mcp.progress_registry.token_key_v1",["bytes.view","pt"]]],["if",["=",["bytes.eq",["bytes.view","key2"],["bytes.view","key"]],1],["return",1],0],0],0],0]],0]],0]],0]],0,0,0],"kind":"defn","name":"ext.mcp.server._progress_token_is_active_v1","params":[{"name":"store","ty":"bytes_view"},{"name":"auth_context_id","ty":"bytes_view"},{"name":"progress_token_json","ty":"bytes_view"},{"name":"max_tasks","ty":"i32"}],"result":"i32"},{"body":["begin",["let","fixed",["ext.mcp.server._state_fixed_bytes_v1"]],["let","name_len",["ext.mcp.server._u32_at_v1","st",15]],["let","ver_len",["ext.mcp.server._u32_at_v1","st",16]],["let","seg_len",["ext.mcp.server._u32_at_v1","st",17]],["let","seg_start",["+",["+","fixed","name_len"],"ver_len"]],["ext.mcp.server._slice_seg_v1","st","seg_start","seg_len"]],"kind":"defn","name":"ext.mcp.server._protocol_version_utf8_v1","params":[{"name":"st","ty":"bytes_view"}],"result":"bytes"},{"body":["if",["=",["ext.mcp.server._state_ok_v1","st"],1],["result_i32.ok",0],["result_i32.err",["ext.mcp.server._err_invalid_router_state_v1"]]],"kind":"defn","name":"ext.mcp.server._router_state_validate_v1","params":[{"name":"st","ty":"bytes_view"}],"result":"result_i32"},{"body":["begin",["let","fixed",["ext.mcp.server._state_fixed_bytes_v1"]],["let","name_len",["ext.mcp.server._u32_at_v1","st",15]],["let","ver_len",["ext.mcp.server._u32_at_v1","st",16]],["let","proto_len",["ext.mcp.server._u32_at_v1","st",17]],["let","idp_len",["ext.mcp.server._u32_at_v1","st",18]],["let","tools_len",["ext.mcp.server._u32_at_v1","st",19]],["let","adv_len",["ext.mcp.server._u32_at_v1","st",20]],["let","auth_len",["ext.mcp.server._u32_at_v1","st",21]],["let","store_len",["ext.mcp.server._u32_at_v1","st",22]],["let","name_start","fixed"],["let","ver_start",["+","name_start","name_len"]],["let","proto_start",["+","ver_start","ver_len"]],["let","idp_start",["+","proto_start","proto_len"]],["let","tools_start",["+","idp_start","idp_len"]],["let","adv_start",["+","tools_start","tools_len"]],["let","auth_start",["+","adv_start","adv_len"]],["let","store_start",["+","auth_start","auth_len"]],["let","total",["+","store_start","store_len"]],["let","out",["vec_u8.with_capacity",36]],["set","out",["vec_u8.extend_bytes","out",["codec.write_u32_le","name_start"]]],["set","out",["vec_u8.extend_bytes","out",["codec.write_u32_le","ver_start"]]],["set","out",["vec_u8.extend_bytes","out",["codec.write_u32_le","proto_start"]]],["set","out",["vec_u8.extend_bytes","out",["codec.write_u32_le","idp_start"]]],["set","out",["vec_u8.extend_bytes","out",["codec.write_u32_le","tools_start"]]],["set","out",["vec_u8.extend_bytes","out",["codec.write_u32_le","adv_start"]]],["set","out",["vec_u8.extend_bytes","out",["codec.write_u32_le","auth_start"]]],["set","out",["vec_u8.extend_bytes","out",["codec.write_u32_le","store_start"]]],["set","out",["vec_u8.extend_bytes","out",["codec.write_u32_le","total"]]],["vec_u8.into_bytes","out"]],"kind":"defn","name":"ext.mcp.server._seg_starts_v1","params":[{"name":"st","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","fixed",["ext.mcp.server._state_fixed_bytes_v1"]],["let","seg_len",["ext.mcp.server._u32_at_v1","st",15]],["let","seg_start","fixed"],["ext.mcp.server._slice_seg_v1","st","seg_start","seg_len"]],"kind":"defn","name":"ext.mcp.server._server_name_utf8_v1","params":[{"name":"st","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","fixed",["ext.mcp.server._state_fixed_bytes_v1"]],["let","name_len",["ext.mcp.server._u32_at_v1","st",15]],["let","seg_len",["ext.mcp.server._u32_at_v1","st",16]],["let","seg_start",["+","fixed","name_len"]],["ext.mcp.server._slice_seg_v1","st","seg_start","seg_len"]],"kind":"defn","name":"ext.mcp.server._server_version_utf8_v1","params":[{"name":"st","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","off",["*","word_i",4]],["vec_u8.set_u32_le","st","off","v"]],"kind":"defn","name":"ext.mcp.server._set_u32_v1","params":[{"name":"st","ty":"vec_u8"},{"name":"word_i","ty":"i32"},{"name":"v","ty":"i32"}],"result":"vec_u8"},{"body":["begin",["if",["if",["<","start",0],1,["<","len",0]],["return",["bytes.alloc",0]],0],["if",["<u",["view.len","st"],["+","start","len"]],["return",["bytes.alloc",0]],0],["view.to_bytes",["view.slice","st","start","len"]]],"kind":"defn","name":"ext.mcp.server._slice_seg_v1","params":[{"name":"st","ty":"bytes_view"},{"name":"start","ty":"i32"},{"name":"len","ty":"i32"}],"result":"bytes"},{"body":["begin",["let","key_get",["std.bytes.copy","auth_context_id"]],["let","empty",["bytes.alloc",0]],["let","val0",["std.hash_map_value.get_bytes_bytes_or","chans","key_get","empty"]],["let","val0_v",["bytes.view","val0"]],["let","handle0",["if",[">=u",["bytes.len","val0_v"],4],["codec.read_u32_le","val0_v",0],-1]],["if",[">=","handle0",0],["return","handle0"],0],["let","ch",["chan.bytes.new","chan_cap"]],["let","key_set",["std.bytes.copy","auth_context_id"]],["let","cval",["codec.write_u32_le","ch"]],["let","_",["std.hash_map_value.set_bytes_bytes","chans","key_set","cval"]],["task.scope.start_soon_v1",["ext.mcp.server._sse_outbox_drain_task_v1","outboxes","auth_context_id","ch","max_events"],0],"ch"],"kind":"defn","name":"ext.mcp.server._sse_event_chan_handle_for_auth_context_v1","params":[{"name":"chans","ty":"bytes"},{"name":"outboxes","ty":"bytes"},{"name":"auth_context_id","ty":"bytes_view"},{"name":"chan_cap","ty":"i32"},{"name":"max_events","ty":"i32"}],"result":"i32"},{"body":["begin",["let","pref",["bytes.lit","id: "]],["let","n",["view.len","event_id"]],["let","out",["vec_u8.with_capacity",["+","n",8]]],["set","out",["vec_u8.extend_bytes","out",["bytes.view","pref"]]],["set","out",["vec_u8.extend_bytes","out","event_id"]],["set","out",["vec_u8.push","out",10]],["set","out",["vec_u8.push","out",10]],["vec_u8.into_bytes","out"]],"kind":"defn","name":"ext.mcp.server._sse_prime_event_v1","params":[{"name":"event_id","ty":"bytes_view"}],"result":"bytes"},{"body":["*",["ext.mcp.server._state_fixed_words_v1"],4],"kind":"defn","name":"ext.mcp.server._state_fixed_bytes_v1","params":[],"result":"i32"},{"body":23,"kind":"defn","name":"ext.mcp.server._state_fixed_words_v1","params":[],"result":"i32"},{"body":["begin",["if",["<",["view.len","st"],["ext.mcp.server._state_fixed_bytes_v1"]],["return",0],0],["if",["!=",["codec.read_u32_le","st",0],["ext.mcp.server._state_version_v1"]],["return",0],0],1],"kind":"defn","name":"ext.mcp.server._state_ok_v1","params":[{"name":"st","ty":"bytes_view"}],"result":"i32"},{"body":["begin",["let","fixed",["ext.mcp.server._state_fixed_bytes_v1"]],["let","name_len",["view.len","server_name_utf8"]],["let","ver_len",["view.len","server_version_utf8"]],["let","proto_len",["view.len","protocol_version_utf8"]],["let","idp_len",["view.len","tasks_id_prefix_utf8"]],["let","tools_len",["view.len","tools_path_utf8"]],["let","adv_len",["view.len","advance_on_json"]],["let","auth_len",["view.len","auth_context_id_utf8"]],["let","store_len",["view.len","store_bytes"]],["let","total",["+","fixed",["+","name_len",["+","ver_len",["+","proto_len",["+","idp_len",["+","tools_len",["+","adv_len",["+","auth_len","store_len"]]]]]]]]],["let","out",["vec_u8.with_capacity","total"]],["set","out",["vec_u8.extend_bytes","out",["codec.write_u32_le",["ext.mcp.server._state_version_v1"]]]],["set","out",["vec_u8.extend_bytes","out",["codec.write_u32_le","lifecycle"]]],["set","out",["vec_u8.extend_bytes","out",["codec.write_u32_le","next_task_i"]]],["set","out",["vec_u8.extend_bytes","out",["codec.write_u32_le","clock_unix_lo"]]],["set","out",["vec_u8.extend_bytes","out",["codec.write_u32_le","clock_unix_hi"]]],["set","out",["vec_u8.extend_bytes","out",["codec.write_u32_le","clock_step_ms"]]],["set","out",["vec_u8.extend_bytes","out",["codec.write_u32_le","tasks_enabled"]]],["set","out",["vec_u8.extend_bytes","out",["codec.write_u32_le","tasks_req_call"]]],["set","out",["vec_u8.extend_bytes","out",["codec.write_u32_le","ttl_ms"]]],["set","out",["vec_u8.extend_bytes","out",["codec.write_u32_le","poll_ms"]]],["set","out",["vec_u8.extend_bytes","out",["codec.write_u32_le","notif_status"]]],["set","out",["vec_u8.extend_bytes","out",["codec.write_u32_le","executor_mode"]]],["set","out",["vec_u8.extend_bytes","out",["codec.write_u32_le","complete_after_ticks"]]],["set","out",["vec_u8.extend_bytes","out",["codec.write_u32_le","max_tasks"]]],["set","out",["vec_u8.extend_bytes","out",["codec.write_u32_le","store_mode"]]],["set","out",["vec_u8.extend_bytes","out",["codec.write_u32_le","name_len"]]],["set","out",["vec_u8.extend_bytes","out",["codec.write_u32_le","ver_len"]]],["set","out",["vec_u8.extend_bytes","out",["codec.write_u32_le","proto_len"]]],["set","out",["vec_u8.extend_bytes","out",["codec.write_u32_le","idp_len"]]],["set","out",["vec_u8.extend_bytes","out",["codec.write_u32_le","tools_len"]]],["set","out",["vec_u8.extend_bytes","out",["codec.write_u32_le","adv_len"]]],["set","out",["vec_u8.extend_bytes","out",["codec.write_u32_le","auth_len"]]],["set","out",["vec_u8.extend_bytes","out",["codec.write_u32_le","store_len"]]],["if",[">","name_len",0],["begin",["set","out",["vec_u8.extend_bytes","out","server_name_utf8"]],0],0],["if",[">","ver_len",0],["begin",["set","out",["vec_u8.extend_bytes","out","server_version_utf8"]],0],0],["if",[">","proto_len",0],["begin",["set","out",["vec_u8.extend_bytes","out","protocol_version_utf8"]],0],0],["if",[">","idp_len",0],["begin",["set","out",["vec_u8.extend_bytes","out","tasks_id_prefix_utf8"]],0],0],["if",[">","tools_len",0],["begin",["set","out",["vec_u8.extend_bytes","out","tools_path_utf8"]],0],0],["if",[">","adv_len",0],["begin",["set","out",["vec_u8.extend_bytes","out","advance_on_json"]],0],0],["if",[">","auth_len",0],["begin",["set","out",["vec_u8.extend_bytes","out","auth_context_id_utf8"]],0],0],["if",[">","store_len",0],["begin",["set","out",["vec_u8.extend_bytes","out","store_bytes"]],0],0],["vec_u8.into_bytes","out"]],"kind":"defn","name":"ext.mcp.server._state_pack_v1","params":[{"name":"lifecycle","ty":"i32"},{"name":"next_task_i","ty":"i32"},{"name":"clock_unix_lo","ty":"i32"},{"name":"clock_unix_hi","ty":"i32"},{"name":"clock_step_ms","ty":"i32"},{"name":"tasks_enabled","ty":"i32"},{"name":"tasks_req_call","ty":"i32"},{"name":"ttl_ms","ty":"i32"},{"name":"poll_ms","ty":"i32"},{"name":"notif_status","ty":"i32"},{"name":"executor_mode","ty":"i32"},{"name":"complete_after_ticks","ty":"i32"},{"name":"max_tasks","ty":"i32"},{"name":"store_mode","ty":"i32"},{"name":"server_name_utf8","ty":"bytes_view"},{"name":"server_version_utf8","ty":"bytes_view"},{"name":"protocol_version_utf8","ty":"bytes_view"},{"name":"tasks_id_prefix_utf8","ty":"bytes_view"},{"name":"tools_path_utf8","ty":"bytes_view"},{"name":"advance_on_json","ty":"bytes_view"},{"name":"auth_context_id_utf8","ty":"bytes_view"},{"name":"store_bytes","ty":"bytes_view"}],"result":"bytes"},{"body":2,"kind":"defn","name":"ext.mcp.server._state_version_v1","params":[],"result":"i32"},{"body":["begin",["if",["=",["ext.mcp.server._state_ok_v1","base_state"],1],0,["return",["bytes.alloc",0]]],["let","lifecycle",["ext.mcp.server._u32_at_v1","base_state",1]],["let","next_task_i",["ext.mcp.server._u32_at_v1","base_state",2]],["let","clock_lo",["ext.mcp.server._u32_at_v1","base_state",3]],["let","clock_hi",["ext.mcp.server._u32_at_v1","base_state",4]],["let","clock_step_ms",["ext.mcp.server._u32_at_v1","base_state",5]],["let","tasks_enabled",["ext.mcp.server._u32_at_v1","base_state",6]],["let","tasks_req_call",["ext.mcp.server._u32_at_v1","base_state",7]],["let","ttl_ms",["ext.mcp.server._u32_at_v1","base_state",8]],["let","poll_ms",["ext.mcp.server._u32_at_v1","base_state",9]],["let","notif_status",["ext.mcp.server._u32_at_v1","base_state",10]],["let","executor_mode",["ext.mcp.server._u32_at_v1","base_state",11]],["let","complete_after",["ext.mcp.server._u32_at_v1","base_state",12]],["let","max_tasks",["ext.mcp.server._u32_at_v1","base_state",13]],["let","store_mode",["ext.mcp.server._u32_at_v1","base_state",14]],["let","server_name",["ext.mcp.server._server_name_utf8_v1","base_state"]],["let","server_version",["ext.mcp.server._server_version_utf8_v1","base_state"]],["let","protocol_v",["ext.mcp.server._protocol_version_utf8_v1","base_state"]],["let","id_prefix",["ext.mcp.server._tasks_id_prefix_utf8_v1","base_state"]],["let","tools_path",["ext.mcp.server._tools_path_utf8_v1","base_state"]],["let","advance_on_json",["ext.mcp.server._advance_on_json_v1","base_state"]],["let","store_any",["ext.mcp.server._store_bytes_v1","base_state"]],["ext.mcp.server._state_pack_v1","lifecycle","next_task_i","clock_lo","clock_hi","clock_step_ms","tasks_enabled","tasks_req_call","ttl_ms","poll_ms","notif_status","executor_mode","complete_after","max_tasks","store_mode",["bytes.view","server_name"],["bytes.view","server_version"],["bytes.view","protocol_v"],["bytes.view","id_prefix"],["bytes.view","tools_path"],["bytes.view","advance_on_json"],"auth_context_id_utf8",["bytes.view","store_any"]]],"kind":"defn","name":"ext.mcp.server._state_with_auth_context_id_v1","params":[{"name":"base_state","ty":"bytes_view"},{"name":"auth_context_id_utf8","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","fixed",["ext.mcp.server._state_fixed_bytes_v1"]],["let","name_len",["ext.mcp.server._u32_at_v1","st",15]],["let","ver_len",["ext.mcp.server._u32_at_v1","st",16]],["let","proto_len",["ext.mcp.server._u32_at_v1","st",17]],["let","idp_len",["ext.mcp.server._u32_at_v1","st",18]],["let","tools_len",["ext.mcp.server._u32_at_v1","st",19]],["let","adv_len",["ext.mcp.server._u32_at_v1","st",20]],["let","auth_len",["ext.mcp.server._u32_at_v1","st",21]],["let","seg_len",["ext.mcp.server._u32_at_v1","st",22]],["let","seg_start",["+",["+",["+",["+",["+",["+",["+","fixed","name_len"],"ver_len"],"proto_len"],"idp_len"],"tools_len"],"adv_len"],"auth_len"]],["ext.mcp.server._slice_seg_v1","st","seg_start","seg_len"]],"kind":"defn","name":"ext.mcp.server._store_bytes_v1","params":[{"name":"st","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","dec",["std.fmt.s32_to_dec","n"]],["let","dv",["bytes.view","dec"]],["let","dlen",["view.len","dv"]],["let","pad",["if",["<","dlen",4],["-",4,"dlen"],0]],["let","zeros",["vec_u8.with_capacity","pad"]],["for","_",0,"pad",["set","zeros",["vec_u8.push","zeros",48]]],["let","zb",["vec_u8.into_bytes","zeros"]],["let","tmp0",["std.bytes.concat","prefix",["bytes.view","zb"]]],["std.bytes.concat",["bytes.view","tmp0"],"dv"]],"kind":"defn","name":"ext.mcp.server._task_id_det_v1","params":[{"name":"prefix","ty":"bytes_view"},{"name":"n","ty":"i32"}],"result":"bytes"},{"body":["begin",["let","caps",["std.os.rand.spec.caps_default_v1"]],["let","doc",["std.os.rand.bytes_v1",8,"caps"]],["if",["!=",["result_bytes.err_code","doc"],0],["return",["ext.mcp.server._task_id_det_v1","prefix",0]],0],["let","rb",["result_bytes.unwrap_or","doc",["bytes.alloc",0]]],["let","hex",["ext.hex.hex_encode",["bytes.view","rb"]]],["std.bytes.concat","prefix",["bytes.view","hex"]]],"kind":"defn","name":"ext.mcp.server._task_id_rand_v1","params":[{"name":"prefix","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","sep",["bytes.alloc",1]],["set","sep",["bytes.set_u8","sep",0,0]],["let","p",["std.bytes.concat","auth_context_id",["bytes.view","sep"]]],["std.bytes.concat",["bytes.view","p"],"task_id"]],"kind":"defn","name":"ext.mcp.server._task_key_v1","params":[{"name":"auth_context_id","ty":"bytes_view"},{"name":"task_id","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["if",["=","code",0],["return",["bytes.lit","working"]],0],["if",["=","code",1],["return",["bytes.lit","input_required"]],0],["if",["=","code",2],["return",["bytes.lit","completed"]],0],["if",["=","code",3],["return",["bytes.lit","failed"]],0],["if",["=","code",4],["return",["bytes.lit","cancelled"]],0],["bytes.lit","failed"]],"kind":"defn","name":"ext.mcp.server._task_status_text_v1","params":[{"name":"code","ty":"i32"}],"result":"bytes"},{"body":["begin",["let","doc_b",["ext.json.data_model.parse","args_json"]],["let","doc",["bytes.view","doc_b"]],["if",["=",["ext.data_model.doc_is_err","doc"],1],["return",0],0],["if",["!=",["ext.data_model.root_kind","doc"],5],["return",0],0],["let","root",["ext.data_model.root_offset","doc"]],["let","k_steps",["bytes.lit","steps"]],["let","off",["ext.data_model.map_find","doc","root",["bytes.view","k_steps"]]],["if",["<","off",0],["return",0],0],["if",["!=",["ext.data_model.kind_at","doc","off"],2],["return",0],0],["let","num_b",["ext.data_model.number_get","doc","off"]],["ext.mcp.server._parse_i32_or_0_v1",["bytes.view","num_b"]]],"kind":"defn","name":"ext.mcp.server._task_steps_from_args_json_or_0_v1","params":[{"name":"args_json","ty":"bytes_view"}],"result":"i32"},{"body":["begin",["let","fallback",["if",["<","fallback_total",1],1,"fallback_total"]],["let","args_res",["std.mcp.sandbox.task_store_any_v1.get_task_args_json_v1","store","auth_context_id","task_id_utf8"]],["let","args_json_b",["result_bytes.unwrap_or","args_res",["bytes.lit","{}"]]],["let","steps",["ext.mcp.server._task_steps_from_args_json_or_0_v1",["bytes.view","args_json_b"]]],["if",[">=","steps",1],"steps","fallback"]],"kind":"defn","name":"ext.mcp.server._task_total_from_store_args_or_default_v1","params":[{"name":"store","ty":"bytes_view"},{"name":"auth_context_id","ty":"bytes_view"},{"name":"task_id_utf8","ty":"bytes_view"},{"name":"fallback_total","ty":"i32"}],"result":"i32"},{"body":["begin",["let","fixed",["ext.mcp.server._state_fixed_bytes_v1"]],["let","name_len",["ext.mcp.server._u32_at_v1","st",15]],["let","ver_len",["ext.mcp.server._u32_at_v1","st",16]],["let","proto_len",["ext.mcp.server._u32_at_v1","st",17]],["let","seg_len",["ext.mcp.server._u32_at_v1","st",18]],["let","seg_start",["+",["+",["+","fixed","name_len"],"ver_len"],"proto_len"]],["ext.mcp.server._slice_seg_v1","st","seg_start","seg_len"]],"kind":"defn","name":"ext.mcp.server._tasks_id_prefix_utf8_v1","params":[{"name":"st","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","doc_b",["ext.json.data_model.parse","tool_result_json"]],["let","doc",["bytes.view","doc_b"]],["if",["=",["ext.data_model.doc_is_err","doc"],1],["return",1],0],["if",["!=",["ext.data_model.root_kind","doc"],5],["return",1],0],["let","root",["ext.data_model.root_offset","doc"]],["let","k_is_error",["bytes.lit","isError"]],["let","off",["ext.data_model.map_find","doc","root",["bytes.view","k_is_error"]]],["if",["<","off",0],["return",0],0],["if",["!=",["ext.data_model.kind_at","doc","off"],1],["return",0],0],["ext.data_model.bool_get","doc","off"]],"kind":"defn","name":"ext.mcp.server._tool_result_is_error_v1","params":[{"name":"tool_result_json","ty":"bytes_view"}],"result":"i32"},{"body":["begin",["let","fixed",["ext.mcp.server._state_fixed_bytes_v1"]],["let","name_len",["ext.mcp.server._u32_at_v1","st",15]],["let","ver_len",["ext.mcp.server._u32_at_v1","st",16]],["let","proto_len",["ext.mcp.server._u32_at_v1","st",17]],["let","idp_len",["ext.mcp.server._u32_at_v1","st",18]],["let","seg_len",["ext.mcp.server._u32_at_v1","st",19]],["let","seg_start",["+",["+",["+",["+","fixed","name_len"],"ver_len"],"proto_len"],"idp_len"]],["ext.mcp.server._slice_seg_v1","st","seg_start","seg_len"]],"kind":"defn","name":"ext.mcp.server._tools_path_utf8_v1","params":[{"name":"st","ty":"bytes_view"}],"result":"bytes"},{"body":["codec.read_u32_le","st",["*","word_i",4]],"kind":"defn","name":"ext.mcp.server._u32_at_v1","params":[{"name":"st","ty":"bytes_view"},{"name":"word_i","ty":"i32"}],"result":"i32"},{"body":["begin",["let","st_validate",["ext.mcp.server._router_state_validate_v1","router_state"]],["if",["!=",["result_i32.err_code","st_validate"],0],["return",["result_bytes.err",["result_i32.err_code","st_validate"]]],0],["let","server_name",["ext.mcp.server._server_name_utf8_v1","router_state"]],["let","tools_path",["ext.mcp.server._tools_path_utf8_v1","router_state"]],["let","server_version",["ext.mcp.server._server_version_utf8_v1","router_state"]],["let","protocol_v",["ext.mcp.server._protocol_version_utf8_v1","router_state"]],["let","id_prefix",["ext.mcp.server._tasks_id_prefix_utf8_v1","router_state"]],["let","auth_context_id",["ext.mcp.server._auth_context_id_utf8_v1","router_state"]],["let","tools_json",["bytes.alloc",0]],["let","advance_on_json",["ext.mcp.server._advance_on_json_v1","router_state"]],["let","store_b",["ext.mcp.server._store_bytes_v1","router_state"]],["let","store","store_b"],["let","lifecycle",["ext.mcp.server._u32_at_v1","router_state",1]],["let","next_task_i",["ext.mcp.server._u32_at_v1","router_state",2]],["let","clock_lo",["ext.mcp.server._u32_at_v1","router_state",3]],["let","clock_hi",["ext.mcp.server._u32_at_v1","router_state",4]],["let","clock_step_ms",["ext.mcp.server._u32_at_v1","router_state",5]],["let","tasks_enabled",["ext.mcp.server._u32_at_v1","router_state",6]],["let","tasks_req_call",["ext.mcp.server._u32_at_v1","router_state",7]],["let","ttl_ms_default",["ext.mcp.server._u32_at_v1","router_state",8]],["let","poll_ms_default",["ext.mcp.server._u32_at_v1","router_state",9]],["let","notif_status",["ext.mcp.server._u32_at_v1","router_state",10]],["let","executor_mode",["ext.mcp.server._u32_at_v1","router_state",11]],["let","complete_after",["ext.mcp.server._u32_at_v1","router_state",12]],["let","max_tasks",["ext.mcp.server._u32_at_v1","router_state",13]],["let","store_mode",["ext.mcp.server._u32_at_v1","router_state",14]],["let","doc_b",["ext.json.data_model.parse","msg_json"]],0,0,["let","doc",["bytes.view","doc_b"]],["let","diag_internal",["std.mcp.diag.code_internal_v1"]],["let","empty_ctx_json",["bytes.lit","{}"]],["let","_x07_tmp_dispatch_lit_0",["bytes.lit","\n"]],["let","_x07_tmp_dispatch_lit_1",["bytes.lit","'"]],["let","_x07_tmp_dispatch_lit_2",["bytes.lit","Cannot cancel task: already in terminal status '"]],["let","_x07_tmp_dispatch_lit_3",["bytes.lit","Invalid cursor"]],["let","_x07_tmp_dispatch_lit_4",["bytes.lit","Invalid taskId"]],["let","_x07_tmp_dispatch_lit_5",["bytes.lit","Method not found"]],["let","_x07_tmp_dispatch_lit_6",["bytes.lit","Task cancelled"]],["let","_x07_tmp_dispatch_lit_7",["bytes.lit","Tasks are not supported"]],["let","_x07_tmp_dispatch_lit_8",["bytes.lit","Tool does not support task-augmented execution"]],["let","_x07_tmp_dispatch_lit_9",["bytes.lit","Tool requires task-augmented execution"]],["let","_x07_tmp_dispatch_lit_10",["bytes.lit","_meta"]],["let","_x07_tmp_dispatch_lit_11",["bytes.lit","arguments"]],["let","_x07_tmp_dispatch_lit_12",["bytes.lit","cancelled"]],["let","_x07_tmp_dispatch_lit_13",["bytes.lit","completed"]],["let","_x07_tmp_dispatch_lit_14",["bytes.lit","cursor"]],["let","_x07_tmp_dispatch_lit_15",["bytes.lit","failed"]],["let","_x07_tmp_dispatch_lit_16",["bytes.lit","forbidden"]],["let","_x07_tmp_dispatch_lit_17",["bytes.lit","id"]],["let","_x07_tmp_dispatch_lit_18",["bytes.lit","initialize"]],["let","_x07_tmp_dispatch_lit_19",["bytes.lit","limit"]],["let","_x07_tmp_dispatch_lit_20",["bytes.lit","method"]],["let","_x07_tmp_dispatch_lit_21",["bytes.lit","name"]],["let","_x07_tmp_dispatch_lit_22",["bytes.lit","notifications/initialized"]],["let","_x07_tmp_dispatch_lit_23",["bytes.lit","params"]],["let","_x07_tmp_dispatch_lit_24",["bytes.lit","progressToken"]],["let","_x07_tmp_dispatch_lit_25",["bytes.lit","required"]],["let","_x07_tmp_dispatch_lit_26",["bytes.lit","task"]],["let","_x07_tmp_dispatch_lit_27",["bytes.lit","taskId"]],["let","_x07_tmp_dispatch_lit_28",["bytes.lit","tasks/cancel"]],["let","_x07_tmp_dispatch_lit_29",["bytes.lit","tasks/get"]],["let","_x07_tmp_dispatch_lit_30",["bytes.lit","tasks/list"]],["let","_x07_tmp_dispatch_lit_31",["bytes.lit","tasks/result"]],["let","_x07_tmp_dispatch_lit_32",["bytes.lit","tool invocation failed"]],["let","_x07_tmp_dispatch_lit_33",["bytes.lit","tools/call"]],["let","_x07_tmp_dispatch_lit_34",["bytes.lit","tools/list"]],["let","_x07_tmp_dispatch_lit_35",["bytes.lit","ttl"]],["let","_x07_tmp_dispatch_lit_36",["bytes.lit","working"]],["let","_x07_tmp_dispatch_lit_37",["bytes.lit","{}"]],["let","_x07_tmp_dispatch_lit_38",["bytes.lit","Invalid progressToken"]],["let","_x07_tmp_dispatch_lit_39",["bytes.lit","progressToken is already active"]],["if",["=",["ext.data_model.doc_is_err","doc"],1],["return",["result_bytes.err",["ext.mcp.server._err_invalid_jsonrpc_v1"]]],0],["if",["!=",["ext.data_model.root_kind","doc"],5],["return",["result_bytes.err",["ext.mcp.server._err_invalid_jsonrpc_v1"]]],0],["let","root",["ext.data_model.root_offset","doc"]],["let","method",["ext.mcp.server._map_string_or_empty_v1","doc","root",["bytes.view","_x07_tmp_dispatch_lit_20"]]],["if",["=",["bytes.len",["bytes.view","tools_json"]],0],["begin",["if",["|",["=",["bytes.eq",["bytes.view","method"],["bytes.view","_x07_tmp_dispatch_lit_18"]],1],["=",["bytes.eq",["bytes.view","method"],["bytes.view","_x07_tmp_dispatch_lit_22"]],1]],0,["begin",["set","tools_json",["std.fs.read",["bytes.view","tools_path"]]],0]],0],0],["let","has_id",["if",[">=",["ext.data_model.map_find","doc","root",["bytes.view","_x07_tmp_dispatch_lit_17"]],0],1,0]],["let","id_json",["ext.mcp.server._map_value_json_or_empty_v1","doc","root",["bytes.view","_x07_tmp_dispatch_lit_17"]]],["let","params_off",["ext.data_model.map_find","doc","root",["bytes.view","_x07_tmp_dispatch_lit_23"]]],["let","params_map",["if",["if",[">=","params_off",0],["=",["ext.data_model.kind_at","doc","params_off"],5],0],"params_off",-1]],["let","out",["bytes.alloc",0]],0,["if",["=",["bytes.eq",["bytes.view","method"],["bytes.view","_x07_tmp_dispatch_lit_18"]],1],["begin",["let","init_json",["ext.mcp.server._initialize_result_json_v1",["bytes.view","protocol_v"],["bytes.view","server_name"],["bytes.view","server_version"],"tasks_enabled","tasks_req_call"]],["set","out",["std.mcp.jsonrpc.make_result_response_trusted_v1",["bytes.view","id_json"],["bytes.view","init_json"]]],["set","lifecycle",1],0],0],["if",["=",["bytes.eq",["bytes.view","method"],["bytes.view","_x07_tmp_dispatch_lit_22"]],1],["begin",["if",["=","lifecycle",1],["begin",["set","lifecycle",2],0],0],["set","out",["bytes.alloc",0]],0],0],["if",["=",["bytes.len",["bytes.view","out"]],0],["begin",["if",["=",["bytes.eq",["bytes.view","method"],["bytes.view","_x07_tmp_dispatch_lit_34"]],1],["begin",["let","res_json",["std.mcp.toolkit.tools_file.tools_list_result_v1",["bytes.view","tools_json"]]],["set","out",["std.mcp.jsonrpc.make_result_response_trusted_v1",["bytes.view","id_json"],["bytes.view","res_json"]]],0],0],0],0],["let","_x07_tmp_out_copy",["std.bytes.copy",["bytes.view","out"]]],["if",["=",["bytes.len",["bytes.view","_x07_tmp_out_copy"]],0],["begin",["if",["=",["bytes.eq",["bytes.view","method"],["bytes.view","_x07_tmp_dispatch_lit_33"]],1],["begin",["let","tool_name",["ext.mcp.server._map_string_or_empty_v1","doc","params_map",["bytes.view","_x07_tmp_dispatch_lit_21"]]],["let","args_json0",["ext.mcp.server._map_value_json_or_empty_v1","doc","params_map",["bytes.view","_x07_tmp_dispatch_lit_11"]]],["let","args_json",["if",[">",["bytes.len",["bytes.view","args_json0"]],0],"args_json0",["bytes.lit","{}"]]],["let","task_off",["ext.data_model.map_find","doc","params_map",["bytes.view","_x07_tmp_dispatch_lit_26"]]],["let","is_task",["if",[">=","task_off",0],1,0]],["let","task_support",["std.mcp.toolkit.tools_file.tool_task_support_v1",["bytes.view","tools_json"],["bytes.view","tool_name"]]],["if",["=","is_task",1],["begin",["if",["=","tasks_req_call",1],0,["begin",["set","out",["std.mcp.jsonrpc.make_error_response_v1",["bytes.view","id_json"],-32601,["bytes.view","_x07_tmp_dispatch_lit_7"],["option_bytes.none"]]],0]],["if",["=",["bytes.eq",["bytes.view","task_support"],["bytes.view","_x07_tmp_dispatch_lit_16"]],1],["begin",["set","out",["std.mcp.jsonrpc.make_error_response_v1",["bytes.view","id_json"],-32601,["bytes.view","_x07_tmp_dispatch_lit_8"],["option_bytes.none"]]],0],0],["begin",["let","out_len3",["bytes.len",["bytes.view","out"]]],["if",["=","out_len3",0],["begin",["let","pt_json",["bytes.alloc",0]],["let","meta_off",["ext.data_model.map_find","doc","params_map",["bytes.view","_x07_tmp_dispatch_lit_10"]]],["if",["if",[">=","meta_off",0],["=",["ext.data_model.kind_at","doc","meta_off"],5],0],["begin",["set","pt_json",["ext.mcp.server._map_value_json_or_empty_v1","doc","meta_off",["bytes.view","_x07_tmp_dispatch_lit_24"]]],0],0],["let","pt_valid",["std.mcp.progress_registry.token_validate_v1",["bytes.view","pt_json"]]],["if",["=","pt_valid",-1],["begin",["set","out",["std.mcp.jsonrpc.make_error_response_v1",["bytes.view","id_json"],-32602,["bytes.view","_x07_tmp_dispatch_lit_38"],["option_bytes.none"]]],0],0],["if",["&",["=","pt_valid",1],["=",["ext.mcp.server._progress_token_is_active_v1",["bytes.view","store"],"auth_context_id",["bytes.view","pt_json"],"max_tasks"],1]],["begin",["set","out",["std.mcp.jsonrpc.make_error_response_v1",["bytes.view","id_json"],-32602,["bytes.view","_x07_tmp_dispatch_lit_39"],["option_bytes.none"]]],0],0],["if",["=",["bytes.len","out"],0],["begin",["let","prefix",["std.bytes.copy","id_prefix"]],["let","task_id",["if",["=","next_task_i",0],["ext.mcp.server._task_id_rand_v1",["bytes.view","prefix"]],["ext.mcp.server._task_id_det_v1",["bytes.view","prefix"],"next_task_i"]]],["if",["!=","next_task_i",0],["set","next_task_i",["+","next_task_i",1]],0],["let","created_at",["ext.mcp.server._clock_now_rfc3339_v1","clock_lo","clock_hi","clock_step_ms"]],["let","ttl","ttl_ms_default"],["let","task_ttl_off",["ext.data_model.map_find","doc","task_off",["bytes.view","_x07_tmp_dispatch_lit_35"]]],["if",["if",[">=","task_ttl_off",0],["=",["ext.data_model.kind_at","doc","task_ttl_off"],2],0],["begin",["let","raw",["ext.data_model.number_get","doc","task_ttl_off"]],["set","ttl",["ext.mcp.server._parse_i32_or_0_v1",["bytes.view","raw"]]],0],0],["let","store0",["std.bytes.copy","store"]],["let","put_res",["std.mcp.sandbox.task_store_any_v1.put_tool_task_new_v1","store",["bytes.view","auth_context_id"],["bytes.view","task_id"],["bytes.view","created_at"],["bytes.view","created_at"],"ttl","poll_ms_default",["bytes.view","tool_name"],["bytes.view","args_json"],["bytes.view","id_json"],["bytes.view","pt_json"]]],["if",["=",["result_bytes.err_code","put_res"],0],["begin",["set","store",["result_bytes.unwrap_or","put_res","store0"]],0],["begin",["set","store","store0"],["set","out",["std.mcp.jsonrpc.make_error_response_v1",["bytes.view","id_json"],-32603,["bytes.view","_x07_tmp_dispatch_lit_32"],["option_bytes.none"]]],0]],["if",["=",["bytes.len","out"],0],["begin",["let","task_val_res",["std.mcp.sandbox.task_store_any_v1.get_task_value_v1",["bytes.view","store"],["bytes.view","auth_context_id"],["bytes.view","task_id"]]],["let","task_val",["result_bytes.unwrap_or","task_val_res",["bytes.alloc",0]]],["let","k_task",["bytes.lit","task"]],["let","entries",["vec_u8.with_capacity",128]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",1]]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",["bytes.len",["bytes.view","k_task"]]]]],["set","entries",["vec_u8.extend_bytes","entries",["bytes.view","k_task"]]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",["bytes.len",["bytes.view","task_val"]]]]],["set","entries",["vec_u8.extend_bytes","entries",["bytes.view","task_val"]]],["let","entries_b",["vec_u8.into_bytes","entries"]],["let","val",["ext.data_model.value_map_from_entries",["bytes.view","entries_b"]]],["let","create_json0",["std.mcp.util.json.json_from_value_v1",["bytes.view","val"]]],["let","create_json_meta",["ext.mcp.server._call_tool_result_with_related_task_meta_v1",["bytes.view","create_json0"],["bytes.view","task_id"]]],["let","create_json",["if",[">",["bytes.len",["bytes.view","create_json_meta"]],0],"create_json_meta","create_json0"]],["set","out",["std.mcp.jsonrpc.make_result_response_trusted_v1",["bytes.view","id_json"],["bytes.view","create_json"]]],["if",["=","executor_mode",0],["begin",["let","task_total",["ext.mcp.server._task_total_from_store_args_or_default_v1",["bytes.view","store"],"auth_context_id",["bytes.view","task_id"],"complete_after"]],["let","st_before",["std.mcp.sandbox.task_store_any_v1.get_task_status_v1",["bytes.view","store"],"auth_context_id",["bytes.view","task_id"]]],["let","ticks_before_res",["std.mcp.sandbox.task_store_any_v1.get_task_ticks_done_v1",["bytes.view","store"],"auth_context_id",["bytes.view","task_id"]]],["let","ticks_before",["if",["=",["result_i32.err_code","ticks_before_res"],0],["result_i32.unwrap_or","ticks_before_res",0],0]],["set","store",["ext.mcp.server._advance_task_det_v1",["bytes.view","tools_json"],"store",["bytes.view","auth_context_id"],["bytes.view","task_id"],"clock_lo","clock_hi","clock_step_ms","task_total"]],["let","st_after",["std.mcp.sandbox.task_store_any_v1.get_task_status_v1",["bytes.view","store"],"auth_context_id",["bytes.view","task_id"]]],["if",["=","pt_valid",1],["begin",["let","prog",["+","ticks_before",1]],["if",["&",[">=","prog",1],["<=","prog","task_total"]],["begin",["let","k1",["std.fmt.s32_to_dec","prog"]],["let","k2",["std.fmt.s32_to_dec","task_total"]],["let","pfx",["bytes.lit","step "]],["let","mid",["bytes.lit","/"]],["let","t1",["std.bytes.concat",["bytes.view","pfx"],["bytes.view","k1"]]],["let","t2",["std.bytes.concat",["bytes.view","t1"],["bytes.view","mid"]]],["let","msg",["std.bytes.concat",["bytes.view","t2"],["bytes.view","k2"]]],["let","notif",["std.mcp.notifications.progress_related_task_v1",["bytes.view","pt_json"],"prog","task_total",["bytes.view","msg"],["bytes.view","task_id"]]],["let","out_sep",["std.bytes.concat",["bytes.view","_x07_tmp_dispatch_lit_0"],["bytes.view","notif"]]],["set","out",["std.bytes.concat",["bytes.view","out"],["bytes.view","out_sep"]]],0],0],0],0],["if",["&",["=","notif_status",1],["!=","st_after","st_before"]],["begin",["let","after",["result_bytes.unwrap_or",["std.mcp.sandbox.task_store_any_v1.get_task_value_v1",["bytes.view","store"],"auth_context_id",["bytes.view","task_id"]],["bytes.alloc",0]]],["let","notif",["std.mcp.notifications.tasks_status_v1","after"]],["let","out_sep",["std.bytes.concat",["bytes.view","_x07_tmp_dispatch_lit_0"],["bytes.view","notif"]]],["set","out",["std.bytes.concat",["bytes.view","out"],["bytes.view","out_sep"]]],0],0],0],0],0],0],0],0],0],0]],0],["begin",["if",["=",["bytes.eq",["bytes.view","task_support"],["bytes.view","_x07_tmp_dispatch_lit_25"]],1],["begin",["set","out",["std.mcp.jsonrpc.make_error_response_v1",["bytes.view","id_json"],-32601,["bytes.view","_x07_tmp_dispatch_lit_9"],["option_bytes.none"]]],0],0],["if",["=",["bytes.len","out"],0],["begin",["let","pt_json2",["bytes.alloc",0]],["let","meta_off2",["ext.data_model.map_find","doc","params_map",["bytes.view","_x07_tmp_dispatch_lit_10"]]],["if",["if",[">=","meta_off2",0],["=",["ext.data_model.kind_at","doc","meta_off2"],5],0],["begin",["set","pt_json2",["ext.mcp.server._map_value_json_or_empty_v1","doc","meta_off2",["bytes.view","_x07_tmp_dispatch_lit_24"]]],0],0],["let","pt2_valid",["std.mcp.progress_registry.token_validate_v1",["bytes.view","pt_json2"]]],["if",["=","pt2_valid",-1],["begin",["set","out",["std.mcp.jsonrpc.make_error_response_v1",["bytes.view","id_json"],-32602,["bytes.view","_x07_tmp_dispatch_lit_38"],["option_bytes.none"]]],0],0],["if",["&",["=","pt2_valid",1],["=",["ext.mcp.server._progress_token_is_active_v1",["bytes.view","store"],"auth_context_id",["bytes.view","pt_json2"],"max_tasks"],1]],["begin",["set","out",["std.mcp.jsonrpc.make_error_response_v1",["bytes.view","id_json"],-32602,["bytes.view","_x07_tmp_dispatch_lit_39"],["option_bytes.none"]]],0],0],["if",["=",["bytes.len",["bytes.view","out"]],0],["begin",["let","ctx_json2",["std.mcp.ctx.with_meta_v1",["bytes.view","empty_ctx_json"],["bytes.view","id_json"],["bytes.view","pt_json2"],["bytes.alloc",0]]],["let","tool_res2",["std.mcp.sandbox.router_exec.call_tool_oneshot_v1",["bytes.view","tool_name"],["bytes.view","ctx_json2"],["bytes.view","args_json"],["bytes.view","tools_json"]]],["let","tr2",["if",["!=",["result_bytes.err_code","tool_res2"],0],["std.mcp.tool.result.err_v1",["bytes.view","diag_internal"],["bytes.view","_x07_tmp_dispatch_lit_32"],["bytes.view","_x07_tmp_dispatch_lit_37"]],["result_bytes.unwrap_or","tool_res2",["bytes.alloc",0]]]],["set","out",["std.mcp.jsonrpc.make_result_response_trusted_v1",["bytes.view","id_json"],["bytes.view","tr2"]]],0],0],0],0]]],0],0],0],0],["let","out_len2",["bytes.len",["bytes.view","out"]]],["if",["=","out_len2",0],["begin",["begin",["let","_x07_tmp_copy",["std.bytes.copy",["bytes.view","method"]]],["begin",["let","_x07_tmp_copy",["std.bytes.copy",["bytes.view","_x07_tmp_copy"]]],["begin",["let","_x07_tmp_copy",["std.bytes.copy",["bytes.view","_x07_tmp_copy"]]],["begin",["let","_x07_tmp_copy",["std.bytes.copy",["bytes.view","_x07_tmp_copy"]]],["if",["=",["bytes.eq",["bytes.view","_x07_tmp_copy"],["bytes.view","_x07_tmp_dispatch_lit_29"]],1],["begin",["let","task_id",["ext.mcp.server._map_string_or_empty_v1","doc","params_map",["bytes.view","_x07_tmp_dispatch_lit_27"]]],["let","advance",["ext.mcp.server._advance_on_has_v1",["bytes.view","advance_on_json"],["bytes.view","method"]]],["if",["!=","executor_mode",0],["set","advance",0],0],["let","task_total",["ext.mcp.server._task_total_from_store_args_or_default_v1",["bytes.view","store"],"auth_context_id",["bytes.view","task_id"],"complete_after"]],["let","task_json_res",["std.mcp.sandbox.task_store_any_v1.get_task_json_v1",["bytes.view","store"],"auth_context_id",["bytes.view","task_id"]]],["if",["!=",["result_bytes.err_code","task_json_res"],0],["begin",["set","out",["std.mcp.jsonrpc.make_error_response_v1",["bytes.view","id_json"],-32602,["bytes.view","_x07_tmp_dispatch_lit_4"],["option_bytes.none"]]],0],["begin",["let","task_json",["result_bytes.unwrap_or","task_json_res",["bytes.alloc",0]]],["set","out",["std.mcp.jsonrpc.make_result_response_trusted_v1",["bytes.view","id_json"],["bytes.view","task_json"]]],["let","pt_task_res",["std.mcp.sandbox.task_store_any_v1.get_task_progress_token_json_v1",["bytes.view","store"],"auth_context_id",["bytes.view","task_id"]]],["let","pt_task_json",["result_bytes.unwrap_or","pt_task_res",["bytes.alloc",0]]],["let","pt_task_valid",["std.mcp.progress_registry.token_validate_v1",["bytes.view","pt_task_json"]]],["if",["=","advance",1],["begin",["for","_",0,["+","task_total",2],["begin",["let","st_before",["std.mcp.sandbox.task_store_any_v1.get_task_status_v1",["bytes.view","store"],"auth_context_id",["bytes.view","task_id"]]],["if",["=","st_before",0],["begin",["let","ticks_before_res",["std.mcp.sandbox.task_store_any_v1.get_task_ticks_done_v1",["bytes.view","store"],"auth_context_id",["bytes.view","task_id"]]],["let","ticks_before",["if",["=",["result_i32.err_code","ticks_before_res"],0],["result_i32.unwrap_or","ticks_before_res",0],0]],["set","store",["ext.mcp.server._advance_task_det_v1",["bytes.view","tools_json"],"store",["bytes.view","auth_context_id"],["bytes.view","task_id"],"clock_lo","clock_hi","clock_step_ms","task_total"]],["if",[">","clock_step_ms",0],["begin",["let","step_s2",["/","clock_step_ms",1000]],["set","clock_lo",["+","clock_lo","step_s2"]],["set","clock_hi",["+","clock_hi",["if",["<u","clock_lo",["-","clock_lo","step_s2"]],1,0]]],0],0],["let","st_after",["std.mcp.sandbox.task_store_any_v1.get_task_status_v1",["bytes.view","store"],"auth_context_id",["bytes.view","task_id"]]],["if",["=","pt_task_valid",1],["begin",["let","prog",["+","ticks_before",1]],["if",["&",[">=","prog",1],["<=","prog","task_total"]],["begin",["let","k1",["std.fmt.s32_to_dec","prog"]],["let","k2",["std.fmt.s32_to_dec","task_total"]],["let","pfx",["bytes.lit","step "]],["let","mid",["bytes.lit","/"]],["let","t1",["std.bytes.concat",["bytes.view","pfx"],["bytes.view","k1"]]],["let","t2",["std.bytes.concat",["bytes.view","t1"],["bytes.view","mid"]]],["let","msg",["std.bytes.concat",["bytes.view","t2"],["bytes.view","k2"]]],["let","notif",["std.mcp.notifications.progress_related_task_v1",["bytes.view","pt_task_json"],"prog","task_total",["bytes.view","msg"],["bytes.view","task_id"]]],["let","out_sep",["std.bytes.concat",["bytes.view","_x07_tmp_dispatch_lit_0"],["bytes.view","notif"]]],["set","out",["std.bytes.concat",["bytes.view","out"],["bytes.view","out_sep"]]],0],0],0],0],["if",["&",["=","notif_status",1],["!=","st_after","st_before"]],["begin",["let","after",["result_bytes.unwrap_or",["std.mcp.sandbox.task_store_any_v1.get_task_value_v1",["bytes.view","store"],"auth_context_id",["bytes.view","task_id"]],["bytes.alloc",0]]],["let","notif",["std.mcp.notifications.tasks_status_v1","after"]],["let","out_sep",["std.bytes.concat",["bytes.view","_x07_tmp_dispatch_lit_0"],["bytes.view","notif"]]],["set","out",["std.bytes.concat",["bytes.view","out"],["bytes.view","out_sep"]]],0],0],["if",["!=","st_after",0],["begin",["set","_",2147483647],0],0],0],["begin",["set","_",2147483647],0]],0]],0],0],0]],0],0]]]]],0],0],["let","out_len3",["bytes.len",["bytes.view","out"]]],["if",["=","out_len3",0],["begin",["if",["=",["bytes.eq",["bytes.view","method"],["bytes.view","_x07_tmp_dispatch_lit_30"]],1],["begin",["let","cursor",["ext.mcp.server._map_string_or_empty_v1","doc","params_map",["bytes.view","_x07_tmp_dispatch_lit_14"]]],["let","limit_json",["ext.mcp.server._map_value_json_or_empty_v1","doc","params_map",["bytes.view","_x07_tmp_dispatch_lit_19"]]],["let","limit_len",["bytes.len",["bytes.view","limit_json"]]],["let","lim",["if",[">","limit_len",0],["ext.mcp.server._parse_i32_or_0_v1",["bytes.view","limit_json"]],100]],["let","res",["std.mcp.sandbox.task_store_any_v1.list_tasks_json_v1",["bytes.view","store"],"auth_context_id",["bytes.view","cursor"],"lim"]],["if",["!=",["result_bytes.err_code","res"],0],["begin",["set","out",["std.mcp.jsonrpc.make_error_response_v1",["bytes.view","id_json"],-32602,["bytes.view","_x07_tmp_dispatch_lit_3"],["option_bytes.none"]]],0],["begin",["let","list_json",["result_bytes.unwrap_or","res",["bytes.alloc",0]]],["set","out",["std.mcp.jsonrpc.make_result_response_trusted_v1",["bytes.view","id_json"],["bytes.view","list_json"]]],0]]],0]],0],["begin",["let","_x07_tmp_copy",["view.to_bytes",["bytes.view","out"]]],["if",["=",["bytes.len",["bytes.view","_x07_tmp_copy"]],0],["begin",["if",["=",["bytes.eq",["bytes.view","method"],["bytes.view","_x07_tmp_dispatch_lit_31"]],1],["begin",["let","task_id",["ext.mcp.server._map_string_or_empty_v1","doc","params_map",["bytes.view","_x07_tmp_dispatch_lit_27"]]],["let","task_total",["ext.mcp.server._task_total_from_store_args_or_default_v1",["bytes.view","store"],"auth_context_id",["bytes.view","task_id"],"complete_after"]],["let","st_init",["std.mcp.sandbox.task_store_any_v1.get_task_status_v1",["bytes.view","store"],"auth_context_id",["bytes.view","task_id"]]],["if",["<","st_init",0],["begin",["set","out",["std.mcp.jsonrpc.make_error_response_v1",["bytes.view","id_json"],-32602,["bytes.view","_x07_tmp_dispatch_lit_4"],["option_bytes.none"]]],0],["begin",["if",["=","executor_mode",0],["for","_",0,["+","complete_after",2],["begin",["let","st0",["std.mcp.sandbox.task_store_any_v1.get_task_status_v1",["bytes.view","store"],"auth_context_id",["bytes.view","task_id"]]],["if",["<","st0",0],["begin",["set","out",["std.mcp.jsonrpc.make_error_response_v1",["bytes.view","id_json"],-32602,["bytes.view","_x07_tmp_dispatch_lit_4"],["option_bytes.none"]]],["set","_",2147483647],0],0],["if",["|",["=","st0",0],["=","st0",1]],["begin",["if",["=","st0",0],["begin",["set","store",["ext.mcp.server._advance_task_det_v1",["bytes.view","tools_json"],"store",["bytes.view","auth_context_id"],["bytes.view","task_id"],"clock_lo","clock_hi","clock_step_ms","task_total"]],["if",[">","clock_step_ms",0],["begin",["let","step_s3",["/","clock_step_ms",1000]],["set","clock_lo",["+","clock_lo","step_s3"]],["set","clock_hi",["+","clock_hi",["if",["<u","clock_lo",["-","clock_lo","step_s3"]],1,0]]],0],0],0],0],["if",["=","st0",1],0,0],0],["begin",["set","_",2147483647],0]],0]],["for","_",0,2147483647,["begin",["let","st0",["std.mcp.sandbox.task_store_any_v1.get_task_status_v1",["bytes.view","store"],"auth_context_id",["bytes.view","task_id"]]],["if",["<","st0",0],["begin",["set","out",["std.mcp.jsonrpc.make_error_response_v1",["bytes.view","id_json"],-32602,["bytes.view","_x07_tmp_dispatch_lit_4"],["option_bytes.none"]]],["set","_",2147483647],0],0],["if",["|",["=","st0",0],["=","st0",1]],["begin",["let","_sleep",["ext.time.os.sleep_ms_v1","poll_ms_default"]],0],["begin",["set","_",2147483647],0]],0]]],["let","st",["std.mcp.sandbox.task_store_any_v1.get_task_status_v1",["bytes.view","store"],"auth_context_id",["bytes.view","task_id"]]],["if",["<","st",0],["begin",["set","out",["std.mcp.jsonrpc.make_error_response_v1",["bytes.view","id_json"],-32602,["bytes.view","_x07_tmp_dispatch_lit_4"],["option_bytes.none"]]],0],0],["if",["=",["bytes.len",["bytes.view","out"]],0],["begin",["let","res_json_res",["std.mcp.sandbox.task_store_any_v1.get_task_result_json_v1",["bytes.view","store"],"auth_context_id",["bytes.view","task_id"]]],["let","res_json",["result_bytes.unwrap_or","res_json_res",["bytes.alloc",0]]],["if",["=","st",4],["begin",["let","base_err",["std.mcp.jsonrpc.make_error_response_v1",["bytes.view","id_json"],-32000,["bytes.view","_x07_tmp_dispatch_lit_6"],["option_bytes.none"]]],["set","out","base_err"],0],["begin",["let","with_meta",["ext.mcp.server._call_tool_result_with_related_task_meta_v1",["bytes.view","res_json"],["bytes.view","task_id"]]],["set","out",["std.mcp.jsonrpc.make_result_response_trusted_v1",["bytes.view","id_json"],["bytes.view","with_meta"]]],0]]],0],0,0]]],0]],0]],["begin",["let","_x07_tmp_cancel_out_copy",["view.to_bytes",["bytes.view","out"]]],["if",["=",["bytes.len",["bytes.view","_x07_tmp_cancel_out_copy"]],0],["begin",["if",["=",["bytes.eq",["bytes.view","method"],["bytes.view","_x07_tmp_dispatch_lit_28"]],1],["begin",["let","task_id",["ext.mcp.server._map_string_or_empty_v1","doc","params_map",["bytes.view","_x07_tmp_dispatch_lit_27"]]],["let","st",["std.mcp.sandbox.task_store_any_v1.get_task_status_v1",["bytes.view","store"],"auth_context_id",["bytes.view","task_id"]]],["if",["|",["=","st",2],["|",["=","st",3],["=","st",4]]],["begin",["let","st_txt",["ext.mcp.server._task_status_text_v1","st"]],["let","msg0",["std.bytes.concat",["bytes.view","_x07_tmp_dispatch_lit_2"],["bytes.view","st_txt"]]],["let","msg",["std.bytes.concat",["bytes.view","msg0"],["bytes.view","_x07_tmp_dispatch_lit_1"]]],["set","out",["std.mcp.jsonrpc.make_error_response_v1",["bytes.view","id_json"],-32602,["bytes.view","msg"],["option_bytes.none"]]],0],["begin",["let","step_s4",["/","clock_step_ms",1000]],["set","clock_lo",["+","clock_lo","step_s4"]],["set","clock_hi",["+","clock_hi",["if",["<u","clock_lo",["-","clock_lo","step_s4"]],1,0]]],["let","last_updated_at",["ext.mcp.server._clock_now_rfc3339_v1","clock_lo","clock_hi","clock_step_ms"]],["let","cancel_obj",["bytes.lit","{\\\"code\\\":-32000,\\\"message\\\":\\\"Task cancelled\\\"}"]],["let","store0",["std.bytes.copy","store"]],["let","res",["std.mcp.sandbox.task_store_any_v1.set_task_cancelled_v1","store","auth_context_id",["bytes.view","task_id"],["bytes.view","last_updated_at"],["bytes.view","cancel_obj"]]],["let","store1",["if",["=",["result_bytes.err_code","res"],0],["result_bytes.unwrap_or","res","store0"],"store0"]],["set","store","store1"],["let","task_val_res",["std.mcp.sandbox.task_store_any_v1.get_task_value_v1",["bytes.view","store"],"auth_context_id",["bytes.view","task_id"]]],["let","task_val",["result_bytes.unwrap_or","task_val_res",["bytes.alloc",0]]],["let","k_task",["bytes.lit","task"]],["let","entries",["vec_u8.with_capacity",128]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",1]]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",["bytes.len",["bytes.view","k_task"]]]]],["set","entries",["vec_u8.extend_bytes","entries",["bytes.view","k_task"]]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",["bytes.len",["bytes.view","task_val"]]]]],["set","entries",["vec_u8.extend_bytes","entries",["bytes.view","task_val"]]],["let","entries_b",["vec_u8.into_bytes","entries"]],["let","val",["ext.data_model.value_map_from_entries",["bytes.view","entries_b"]]],["let","res_json",["std.mcp.util.json.json_from_value_v1",["bytes.view","val"]]],["set","out",["std.mcp.jsonrpc.make_result_response_trusted_v1",["bytes.view","id_json"],["bytes.view","res_json"]]],["if",["=","notif_status",1],["begin",["let","notif",["std.mcp.notifications.tasks_status_v1",["bytes.view","task_val"]]],["let","out_sep",["std.bytes.concat",["bytes.view","_x07_tmp_dispatch_lit_0"],["bytes.view","notif"]]],["set","out",["std.bytes.concat",["bytes.view","out"],["bytes.view","out_sep"]]],0],0],0]]],0]],0]],["if",["=",["bytes.len",["bytes.view","out"]],0],["begin",["if",["=","has_id",1],["begin",["set","out",["std.mcp.jsonrpc.make_error_response_v1",["bytes.view","id_json"],-32601,["bytes.view","_x07_tmp_dispatch_lit_5"],["option_bytes.none"]]],0],["begin",["set","out",["bytes.alloc",0]],0]],0],0],["let","next_state",["ext.mcp.server._state_pack_v1","lifecycle","next_task_i","clock_lo","clock_hi","clock_step_ms","tasks_enabled","tasks_req_call","ttl_ms_default","poll_ms_default","notif_status","executor_mode","complete_after","max_tasks","store_mode",["bytes.view","server_name"],["bytes.view","server_version"],["bytes.view","protocol_v"],["bytes.view","id_prefix"],["bytes.view","tools_path"],["bytes.view","advance_on_json"],["bytes.view","auth_context_id"],["bytes.view","store"]]],["let","dispatch",["ext.mcp.server._dispatch_pack_v1",["bytes.view","next_state"],["bytes.view","out"]]],["result_bytes.ok","dispatch"]],"kind":"defn","name":"ext.mcp.server.dispatch_jsonrpc_v1","params":[{"name":"router_state","ty":"bytes_view"},{"name":"msg_json","ty":"bytes_view"}],"result":"result_bytes"},{"body":["begin",["let","rc_res",["std.mcp.toolkit.server_cfg_file.router_cfg_from_fs_v1","cfg_path"]],["if",["!=",["result_bytes.err_code","rc_res"],0],["return","rc_res"],0],["let","rc_pack",["result_bytes.unwrap_or","rc_res",["bytes.alloc",0]]],["let","rcv",["bytes.view","rc_pack"]],["if",["<u",["view.len","rcv"],84],["return",["result_bytes.err",1]],0],["if",["!=",["codec.read_u32_le","rcv",0],2],["return",["result_bytes.err",1]],0],["let","tasks_enabled",["codec.read_u32_le","rcv",4]],["let","tasks_req_call",["codec.read_u32_le","rcv",8]],["let","ttl_ms",["codec.read_u32_le","rcv",12]],["let","poll_ms",["codec.read_u32_le","rcv",16]],["let","notif_status",["codec.read_u32_le","rcv",20]],["let","executor_mode",["codec.read_u32_le","rcv",24]],["let","complete_after",["codec.read_u32_le","rcv",28]],["let","max_tasks",["codec.read_u32_le","rcv",32]],["let","store_mode",["codec.read_u32_le","rcv",36]],["let","clock_mode",["codec.read_u32_le","rcv",40]],["let","step_ms",["codec.read_u32_le","rcv",44]],["let","next_task_i",["codec.read_u32_le","rcv",48]],["let","cfg_len",["codec.read_u32_le","rcv",52]],["let","tools_len",["codec.read_u32_le","rcv",56]],["let","adv_len",["codec.read_u32_le","rcv",60]],["let","iso_len",["codec.read_u32_le","rcv",64]],["let","idp_len",["codec.read_u32_le","rcv",68]],["let","name_len",["codec.read_u32_le","rcv",72]],["let","ver_len",["codec.read_u32_le","rcv",76]],["let","proto_len",["codec.read_u32_le","rcv",80]],["let","seg0",84],["if",["<u",["view.len","rcv"],["+","seg0",["+",["+",["+",["+",["+",["+",["+","cfg_len","tools_len"],"adv_len"],"iso_len"],"idp_len"],"name_len"],"ver_len"],"proto_len"]]],["return",["result_bytes.err",1]],0],["let","cfg_json_v",["view.slice","rcv","seg0","cfg_len"]],["let","seg1",["+","seg0","cfg_len"]],["let","tools_path",["view.to_bytes",["view.slice","rcv","seg1","tools_len"]]],["let","seg2",["+","seg1","tools_len"]],["let","advance_on_json",["view.to_bytes",["view.slice","rcv","seg2","adv_len"]]],["let","seg3",["+","seg2","adv_len"]],["let","start_iso_fixed",["view.to_bytes",["view.slice","rcv","seg3","iso_len"]]],["let","seg4",["+","seg3","iso_len"]],["let","id_prefix",["view.to_bytes",["view.slice","rcv","seg4","idp_len"]]],["let","seg5",["+","seg4","idp_len"]],["let","server_name",["view.to_bytes",["view.slice","rcv","seg5","name_len"]]],["let","seg6",["+","seg5","name_len"]],["let","server_version",["view.to_bytes",["view.slice","rcv","seg6","ver_len"]]],["let","seg7",["+","seg6","ver_len"]],["let","protocol_v",["view.to_bytes",["view.slice","rcv","seg7","proto_len"]]],["let","cfg_dir",["bytes.alloc",0]],["let","cfg_n",["view.len","cfg_path"]],["let","last_slash",-1],["for","i",0,"cfg_n",["begin",["if",["=",["bytes.get_u8","cfg_path","i"],47],["set","last_slash","i"],0],0]],["if",[">=","last_slash",0],["begin",["set","cfg_dir",["view.to_bytes",["view.slice","cfg_path",0,"last_slash"]]],0],0],["let","tools_is_abs",0],["begin",["let","_x07_tmp_copy",["std.bytes.copy",["bytes.view","tools_path"]]],["if",[">",["bytes.len",["bytes.view","_x07_tmp_copy"]],0],["if",["=",["bytes.get_u8",["bytes.view","tools_path"],0],47],["set","tools_is_abs",1],0],0]],["let","tools_path_resolved",["std.bytes.copy",["bytes.view","tools_path"]]],["if",["=","tools_is_abs",1],0,["begin",["let","_x07_tmp_copy",["std.bytes.copy",["bytes.view","cfg_dir"]]],["if",[">",["bytes.len",["bytes.view","_x07_tmp_copy"]],0],["begin",["let","slash",["bytes.lit","/"]],["let","tmp",["std.bytes.concat",["bytes.view","cfg_dir"],["bytes.view","slash"]]],["set","tools_path_resolved",["std.bytes.concat",["bytes.view","tmp"],["bytes.view","tools_path"]]],0],0]]],["let","id_mode",["std.mcp.toolkit.server_cfg_file.tasks_id_mode_v1","cfg_json_v"]],["let","lit_random",["bytes.lit","random"]],["let","is_random",["if",["=",["bytes.eq",["bytes.view","id_mode"],["bytes.view","lit_random"]],1],1,0]],["if",["=","is_random",1],["set","next_task_i",0],["if",["<","next_task_i",1],["set","next_task_i",1],0]],["if",["&",["=","executor_mode",1],["!=","store_mode",1]],["return",["result_bytes.err",1]],0],["let","store_any",["std.mcp.sandbox.task_store_any_v1.new_v1","max_tasks"]],["if",["=","store_mode",1],["begin",["let","sqlite_path",["std.mcp.toolkit.server_cfg_file.tasks_store_sqlite_path_v1","cfg_json_v"]],["if",["=",["bytes.len",["bytes.view","sqlite_path"]],0],["return",["result_bytes.err",1]],0],["let","sqlite_is_abs",0],["if",["=",["bytes.get_u8",["bytes.view","sqlite_path"],0],47],["set","sqlite_is_abs",1],0],["let","sqlite_path_resolved",["std.bytes.copy",["bytes.view","sqlite_path"]]],["if",["=","sqlite_is_abs",1],0,["begin",["let","_x07_tmp_copy",["std.bytes.copy",["bytes.view","cfg_dir"]]],["if",[">",["bytes.len",["bytes.view","_x07_tmp_copy"]],0],["begin",["let","slash",["bytes.lit","/"]],["let","tmp",["std.bytes.concat",["bytes.view","cfg_dir"],["bytes.view","slash"]]],["set","sqlite_path_resolved",["std.bytes.concat",["bytes.view","tmp"],["bytes.view","sqlite_path"]]],0],0]]],["let","store_res",["std.mcp.sandbox.task_store_any_v1.new_sqlite_v1",["bytes.view","sqlite_path_resolved"],"max_tasks"]],["if",["!=",["result_bytes.err_code","store_res"],0],["return","store_res"],0],["set","store_any",["result_bytes.unwrap_or","store_res","store_any"]],0],0],["let","start_iso",["if",["=","clock_mode",1],["ext.time.os.now_rfc3339_utc_v1"],"start_iso_fixed"]],["let","clock_doc",["ext.time.rfc3339.parse_v1",["bytes.view","start_iso"]]],["let","clockv",["bytes.view","clock_doc"]],["let","clock_lo",["ext.time.rfc3339.unix_s_u32","clockv"]],["let","clock_hi",["ext.time.rfc3339.unix_s_i64_hi","clockv"]],["let","step_ms2",["if",["=","clock_mode",1],0,["if",["<","step_ms",1],1000,"step_ms"]]],["let","auth_context_id",["begin",["let","raw",["bytes.lit","stdio"]],["let","digest",["ext.crypto.sha256",["bytes.view","raw"]]],["ext.hex.hex_encode",["bytes.view","digest"]]]],["std.brand.cast_bytes_v1","x07.mcp.router_state_v1","ext.mcp.server._router_state_validate_v1",["ext.mcp.server._state_pack_v1",0,"next_task_i","clock_lo","clock_hi","step_ms2","tasks_enabled","tasks_req_call","ttl_ms","poll_ms","notif_status","executor_mode","complete_after","max_tasks","store_mode",["bytes.view","server_name"],["bytes.view","server_version"],["bytes.view","protocol_v"],["bytes.view","id_prefix"],["bytes.view","tools_path_resolved"],["bytes.view","advance_on_json"],["bytes.view","auth_context_id"],["bytes.view","store_any"]]]],"kind":"defn","name":"ext.mcp.server.make_router_from_fs_v1","params":[{"name":"cfg_path","ty":"bytes_view"}],"result":"result_bytes","result_brand":"x07.mcp.router_state_v1"},{"body":["begin",["for","_",0,2147483647,["begin",["let","msg_res",["chan.bytes.try_recv","ch_handle"]],["let","code",["result_bytes.err_code","msg_res"]],["if",["=","code",0],0,["if",["=","code",1],["task.yield"],["return",["bytes.alloc",0]]]],0]],["bytes.alloc",0]],"kind":"defasync","name":"ext.mcp.server._drain_chan_v1","params":[{"name":"ch_handle","ty":"i32"}],"result":"bytes"},{"body":["begin",["let","key_get0",["std.bytes.copy","auth_context_id"]],["let","empty",["bytes.alloc",0]],["let","state0",["std.hash_map_value.get_bytes_bytes_or","outboxes","key_get0","empty"]],["let","state0_v",["bytes.view","state0"]],["let","next_seq0",["if",[">=u",["bytes.len","state0_v"],4],["codec.read_u32_le","state0_v",0],1]],["let","next_seq",["if",["<","next_seq0",1],1,"next_seq0"]],["let","rb0",["if",[">",["bytes.len","state0_v"],4],["view.to_bytes",["view.slice","state0_v",4,["-",["bytes.len","state0_v"],4]]],["std.mcp.transport.http_sse_outbox_v1.rb_empty_v1"]]],["let","rb",["if",[">=u",["bytes.len",["bytes.view","rb0"]],4],"rb0",["std.mcp.transport.http_sse_outbox_v1.rb_empty_v1"]]],["let","stream_kind",["bytes.lit","get"]],["let","stream_key",["bytes.lit","outbox"]],["for","_",0,2147483647,["begin",["let","line",["chan.bytes.recv","event_chan_handle"]],["if",["=",["bytes.len",["bytes.view","line"]],0],["return",["bytes.alloc",0]],0],["let","seq","next_seq"],["set","next_seq",["+","next_seq",1]],["let","event_id",["std.mcp.sse.event_id_make_v1","auth_context_id",["bytes.view","stream_kind"],["bytes.view","stream_key"],"seq"]],["let","ev",["std.mcp.sse.encode_event_v1",["bytes.view","event_id"],["bytes.view","line"]]],["set","rb",["std.mcp.transport.http_sse_outbox_v1.rb_append_v1",["bytes.view","rb"],"seq",["bytes.len",["bytes.view","ev"]],["bytes.view","ev"],"max_events"]],["let","head",["codec.write_u32_le","next_seq"]],["let","state",["std.bytes.concat",["bytes.view","head"],["bytes.view","rb"]]],["let","key_set0",["std.bytes.copy","auth_context_id"]],["let","_",["std.hash_map_value.set_bytes_bytes","outboxes","key_set0","state"]],0]],["bytes.alloc",0]],"kind":"defasync","name":"ext.mcp.server._sse_outbox_drain_task_v1","params":[{"name":"outboxes","ty":"bytes"},{"name":"auth_context_id","ty":"bytes_view"},{"name":"event_chan_handle","ty":"i32"},{"name":"max_events","ty":"i32"}],"result":"bytes"},{"body":["begin",["let","store_any",["ext.mcp.server._store_bytes_v1","router_state"]],["let","auth_context_id",["ext.mcp.server._auth_context_id_utf8_v1","router_state"]],["let","clock_lo",["ext.mcp.server._u32_at_v1","router_state",3]],["let","clock_hi",["ext.mcp.server._u32_at_v1","router_state",4]],["let","clock_step_ms",["ext.mcp.server._u32_at_v1","router_state",5]],["await",["std.mcp.sandbox.task_exec_async_pool_v1.worker_v1","cfg_json","tools_json","store_any","auth_context_id","clock_lo","clock_hi","clock_step_ms","task_id_utf8","cancel_chan_handle","event_chan_handle"]]],"kind":"defasync","name":"ext.mcp.server._task_async_pool_worker_v1","params":[{"name":"cfg_json","ty":"bytes_view"},{"name":"tools_json","ty":"bytes_view"},{"name":"router_state","ty":"bytes_view"},{"name":"task_id_utf8","ty":"bytes_view"},{"name":"cancel_chan_handle","ty":"i32"},{"name":"event_chan_handle","ty":"i32"}],"result":"bytes"},{"body":["begin",["let","cfg_res",["std.mcp.toolkit.server_cfg_file.load_server_cfg_from_fs_v1","cfg_path"]],["if",["!=",["result_bytes.err_code","cfg_res"],0],["return",["bytes.alloc",0]],0],["let","cfg_json",["result_bytes.unwrap_or","cfg_res",["bytes.alloc",0]]],["if",["=",["std.mcp.toolkit.server_cfg_file.transport_http_enabled_v1",["bytes.view","cfg_json"]],1],0,["return",["bytes.alloc",0]]],["let","bind",["std.mcp.toolkit.server_cfg_file.transport_http_bind_v1",["bytes.view","cfg_json"]]],["let","path",["std.mcp.toolkit.server_cfg_file.transport_http_path_v1",["bytes.view","cfg_json"]]],["let","sse_enabled",["std.mcp.toolkit.server_cfg_file.transport_http_sse_enabled_v1",["bytes.view","cfg_json"]]],["let","base_router_res",["ext.mcp.server.make_router_from_fs_v1","cfg_path"]],["if",["!=",["result_bytes.err_code","base_router_res"],0],["return",["bytes.alloc",0]],0],["let","base_router",["result_bytes.unwrap_or","base_router_res",["bytes.alloc",0]]],["let","tools_path",["ext.mcp.server._tools_path_utf8_v1",["bytes.view","base_router"]]],["let","tools_json",["std.fs.read",["bytes.view","tools_path"]]],["let","bind_v",["bytes.view","bind"]],["let","bind_n",["view.len","bind_v"]],["let","colon",-1],["for","i",0,"bind_n",["begin",["if",["&",["=","colon",-1],["=",["view.get_u8","bind_v","i"],58]],["set","colon","i"],0],0]],["let","host",["if",[">=","colon",0],["view.to_bytes",["view.slice","bind_v",0,"colon"]],["view.to_bytes","bind_v"]]],["let","port",8080],["if",[">=","colon",0],["begin",["let","port_v",["view.slice","bind_v",["+","colon",1],["-","bind_n",["+","colon",1]]]],["let","st",["std.parse.i32_status_le","port_v"]],["if",["if",[">=",["bytes.len","st"],5],["=",["bytes.get_u8","st",0],1],0],["set","port",["codec.read_u32_le","st",1]],0],0],0],["let","host0",["bytes.lit","0.0.0.0"]],["let","bind_addr",["if",["=",["bytes.eq",["bytes.view","host"],["bytes.view","host0"]],1],["std.net.codec.addr_ipv4_v1",0,0,0,0,"port"],["std.net.codec.addr_ipv4_v1",127,0,0,1,"port"]]],["let","caps",["std.net.codec.caps_default_v1"]],["let","listen_doc",["std.net.tcp.listen_v1",["bytes.view","bind_addr"],["bytes.view","caps"]]],["if",["=",["std.net.err.is_err_doc_v1",["bytes.view","listen_doc"]],1],["return",["bytes.alloc",0]],0],["let","listener",["std.net.tcp.listen_listener_handle_v1","listen_doc"]],["let","routers",["std.hash_map_value.with_capacity_bytes_bytes",64]],["let","cancels",["std.hash_map_value.with_capacity_bytes_bytes",256]],["let","sse_chans",["std.hash_map_value.with_capacity_bytes_bytes",64]],["let","sse_outboxes",["std.hash_map_value.with_capacity_bytes_bytes",64]],["let","sse_chan_cap",256],["let","sse_max_events",256],["let","hdr_accept",["bytes.lit","Accept"]],["let","hdr_content_type",["bytes.lit","Content-Type"]],["let","hdr_allow",["bytes.lit","Allow"]],["let","hdr_last_event_id",["bytes.lit","Last-Event-ID"]],["let","value_ct_json",["bytes.lit","application/json"]],["let","value_ct_sse",["bytes.lit","text/event-stream"]],["let","allow_post",["bytes.lit","POST"]],["let","method_post",["bytes.lit","POST"]],["let","method_get",["bytes.lit","GET"]],["let","method_tools_call",["bytes.lit","tools/call"]],["let","method_tasks_cancel",["bytes.lit","tasks/cancel"]],["task.scope_v1",["task.scope.cfg_v1",["max_children",1024]],["begin",["for","_",0,2147483647,["begin",["let","acc_doc",["std.net.tcp.accept_v1","listener",["bytes.view","caps"]]],["if",["=",["std.net.err.is_err_doc_v1",["bytes.view","acc_doc"]],1],["begin",["task.yield"],0],["begin",["let","stream",["std.net.tcp.accept_stream_handle_v1","acc_doc"]],["let","req_doc",["std.net.http.server.read_req_v1","stream",["bytes.view","caps"]]],["begin",["let","req_doc_v",["bytes.view","req_doc"]],["if",["=",["std.net.err.is_err_doc_v1","req_doc_v"],1],["begin",["let","_close_stream",["std.net.tcp.stream_close_v1","stream"]],0],["begin",["let","request_method",["std.net.http.server.req_method_v1","req_doc_v"]],["let","request_target",["std.net.http.server.req_target_v1","req_doc_v"]],["let","status",200],["let","headers",["std.net.http.spec.headers_empty_v1"]],["let","body",["bytes.alloc",0]],["let","skip_write",0],["if",["=",["bytes.eq",["bytes.view","request_target"],["bytes.view","path"]],0],["set","status",404],["begin",["let","request_method_v",["bytes.view","request_method"]],["if",["=",["bytes.eq","request_method_v",["bytes.view","method_get"]],1],["begin",["let","accept_hdr_get",["std.net.http.server.req_header_get_v1","req_doc_v",["bytes.view","hdr_accept"]]],["if",["&",["=","sse_enabled",1],["=",["std.mcp.transport.http_rules.accept_sse_v1",["bytes.view","accept_hdr_get"]],1]],["begin",["set","skip_write",1],["let","auth_context_id_get",["ext.mcp.server._auth_context_id_from_http_req_v1","req_doc_v"]],["let","key_get",["std.bytes.copy",["bytes.view","auth_context_id_get"]]],["let","empty",["bytes.alloc",0]],["let","state0",["std.hash_map_value.get_bytes_bytes_or","sse_outboxes","key_get","empty"]],["let","state0_v",["bytes.view","state0"]],["let","rb_empty",["std.mcp.transport.http_sse_outbox_v1.rb_empty_v1"]],["let","rb",["if",[">",["bytes.len","state0_v"],4],["view.slice","state0_v",4,["-",["bytes.len","state0_v"],4]],["bytes.view","rb_empty"]]],["let","last_event_id",["std.net.http.server.req_header_get_v1","req_doc_v",["bytes.view","hdr_last_event_id"]]],["let","last_event_id_v",["bytes.view","last_event_id"]],["let","stream_kind_get",["bytes.lit","get"]],["let","stream_key_get",["bytes.lit","outbox"]],["let","after_seq0",["if",[">",["bytes.len","last_event_id_v"],0],["std.mcp.sse.event_id_parse_seq_v1","last_event_id_v"],0]],["let","sid0",["std.mcp.sse.event_id_parse_session_id_v1","last_event_id_v"]],["let","kind0",["std.mcp.sse.event_id_parse_stream_kind_v1","last_event_id_v"]],["let","key0",["std.mcp.sse.event_id_parse_stream_key_v1","last_event_id_v"]],["let","after_seq",["if",["&",["&",["&",["=",["bytes.eq",["bytes.view","sid0"],["bytes.view","auth_context_id_get"]],1],["=",["bytes.eq",["bytes.view","kind0"],["bytes.view","stream_kind_get"]],1]],["=",["bytes.eq",["bytes.view","key0"],["bytes.view","stream_key_get"]],1]],[">=","after_seq0",0]],"after_seq0",0]],["let","ok_head",["std.mcp.transport.http_sse_outbox_v1.write_sse_head_v1","stream",["bytes.view","caps"]]],["if",["=","ok_head",1],["begin",["let","retry",["std.mcp.transport.http_sse.encode_retry_v1",1000]],["let","_",["std.mcp.transport.http_sse_outbox_v1.write_chunk_v1","stream",["bytes.view","retry"],["bytes.view","caps"]]],["let","prime_id",["std.mcp.sse.event_id_make_v1",["bytes.view","auth_context_id_get"],["bytes.view","stream_kind_get"],["bytes.view","stream_key_get"],"after_seq"]],["let","prime",["ext.mcp.server._sse_prime_event_v1",["bytes.view","prime_id"]]],["let","_",["std.mcp.transport.http_sse_outbox_v1.write_chunk_v1","stream",["bytes.view","prime"],["bytes.view","caps"]]],["let","_",["std.mcp.transport.http_sse_outbox_v1.rb_write_after_seq_v1","rb","after_seq","stream",["bytes.view","caps"]]],["let","_",["std.mcp.transport.http_sse_outbox_v1.write_chunk_end_v1","stream",["bytes.view","caps"]]],0],0],["let","_close_stream",["std.net.tcp.stream_close_v1","stream"]],0],["begin",["set","status",405],["set","headers",["std.net.http.spec.headers_set_v1",["bytes.view","headers"],["bytes.view","hdr_allow"],["bytes.view","allow_post"]]],0]]],["if",["=",["bytes.eq","request_method_v",["bytes.view","method_post"]],1],["begin",["let","msg_json",["std.net.http.server.req_body_v1","req_doc_v"]],["let","msg_doc_b",["ext.json.data_model.parse",["bytes.view","msg_json"]]],["let","msg_doc",["bytes.view","msg_doc_b"]],["let","jsonrpc_method",["bytes.alloc",0]],["let","jsonrpc_has_task",0],["let","jsonrpc_task_id",["bytes.alloc",0]],["if",["=",["ext.data_model.doc_is_err","msg_doc"],1],0,["begin",["if",["=",["ext.data_model.root_kind","msg_doc"],5],["begin",["let","root",["ext.data_model.root_offset","msg_doc"]],["let","k_method",["bytes.lit","method"]],["set","jsonrpc_method",["ext.mcp.server._map_string_or_empty_v1","msg_doc","root",["bytes.view","k_method"]]],["let","k_params",["bytes.lit","params"]],["let","params_off",["ext.data_model.map_find","msg_doc","root",["bytes.view","k_params"]]],["if",["&",[">=","params_off",0],["=",["ext.data_model.kind_at","msg_doc","params_off"],5]],["begin",["if",["=",["bytes.eq",["bytes.view","jsonrpc_method"],["bytes.view","method_tools_call"]],1],["begin",["let","k_task",["bytes.lit","task"]],["let","task_off",["ext.data_model.map_find","msg_doc","params_off",["bytes.view","k_task"]]],["if",["&",[">=","task_off",0],["=",["ext.data_model.kind_at","msg_doc","task_off"],5]],["set","jsonrpc_has_task",1],0],0],0],["if",["=",["bytes.eq",["bytes.view","jsonrpc_method"],["bytes.view","method_tasks_cancel"]],1],["begin",["let","k_task_id",["bytes.lit","taskId"]],["set","jsonrpc_task_id",["ext.mcp.server._map_string_or_empty_v1","msg_doc","params_off",["bytes.view","k_task_id"]]],0],0],0],0],0],0]]],["let","accept_hdr",["std.net.http.server.req_header_get_v1","req_doc_v",["bytes.view","hdr_accept"]]],["let","use_sse",["&",["=","sse_enabled",1],["=",["std.mcp.transport.http_rules.accept_sse_v1",["bytes.view","accept_hdr"]],1]]],["let","auth_context_id",["ext.mcp.server._auth_context_id_from_http_req_v1","req_doc_v"]],["let","key_get",["std.bytes.copy",["bytes.view","auth_context_id"]]],["let","key_set",["std.bytes.copy",["bytes.view","auth_context_id"]]],["let","empty",["bytes.alloc",0]],["let","router_state0",["std.hash_map_value.get_bytes_bytes_or","routers","key_get","empty"]],["let","router_state",["if",[">",["bytes.len",["bytes.view","router_state0"]],0],"router_state0",["ext.mcp.server._state_with_auth_context_id_v1",["bytes.view","base_router"],["bytes.view","auth_context_id"]]]],["let","dispatch_res",["ext.mcp.server.dispatch_jsonrpc_v1",["bytes.view","router_state"],["bytes.view","msg_json"]]],["if",["!=",["result_bytes.err_code","dispatch_res"],0],["begin",["set","status",500],0],["begin",["let","dispatch_pack",["result_bytes.unwrap_or","dispatch_res","empty"]],["let","next_state",["ext.mcp.server._dispatch_next_state_v1",["bytes.view","dispatch_pack"]]],["let","out_jsonl",["ext.mcp.server._dispatch_out_jsonl_v1",["bytes.view","dispatch_pack"]]],["let","next_state_copy",["std.bytes.copy",["bytes.view","next_state"]]],["let","_set_router",["std.hash_map_value.set_bytes_bytes","routers","key_set","next_state"]],["let","executor_mode",["ext.mcp.server._u32_at_v1",["bytes.view","next_state_copy"],11]],["if",["&",["&",["=","executor_mode",1],["=",["bytes.eq",["bytes.view","jsonrpc_method"],["bytes.view","method_tools_call"]],1]],["=","jsonrpc_has_task",1]],["begin",["let","resp_line",["ext.mcp.server._jsonl_last_line_v1",["bytes.view","out_jsonl"]]],["let","task_id_created",["ext.mcp.server._create_task_task_id_from_response_v1",["bytes.view","resp_line"]]],["begin",["let","task_id_created_v",["bytes.view","task_id_created"]],["if",[">",["bytes.len","task_id_created_v"],0],["begin",["let","cancel_chan",["chan.bytes.new",1]],["let","ckey_get",["ext.mcp.server._task_key_v1",["bytes.view","auth_context_id"],"task_id_created_v"]],["let","ckey_set",["std.bytes.copy",["bytes.view","ckey_get"]]],["let","cval",["codec.write_u32_le","cancel_chan"]],["let","_set_cancel",["std.hash_map_value.set_bytes_bytes","cancels","ckey_set","cval"]],["let","event_chan_handle",["ext.mcp.server._sse_event_chan_handle_for_auth_context_v1","sse_chans","sse_outboxes",["bytes.view","auth_context_id"],"sse_chan_cap","sse_max_events"]],["task.scope.start_soon_v1",["ext.mcp.server._task_async_pool_worker_v1",["bytes.view","cfg_json"],["bytes.view","tools_json"],["bytes.view","next_state_copy"],"task_id_created_v","cancel_chan","event_chan_handle"]],0],0]],0],0],["if",["&",["=","executor_mode",1],["=",["bytes.eq",["bytes.view","jsonrpc_method"],["bytes.view","method_tasks_cancel"]],1]],["begin",["begin",["let","jsonrpc_task_id_v",["bytes.view","jsonrpc_task_id"]],["if",[">",["bytes.len","jsonrpc_task_id_v"],0],["begin",["let","ckey",["ext.mcp.server._task_key_v1",["bytes.view","auth_context_id"],"jsonrpc_task_id_v"]],["let","cval2",["std.hash_map_value.get_bytes_bytes_or","cancels","ckey","empty"]],["begin",["let","cval2_v",["bytes.view","cval2"]],["if",[">=",["bytes.len","cval2_v"],4],["begin",["let","cancel_handle",["codec.read_u32_le","cval2_v",0]],["let","store_any2",["ext.mcp.server._store_bytes_v1",["bytes.view","next_state_copy"]]],["let","rid2_res",["std.mcp.sandbox.task_store_any_v1.get_task_request_id_json_v1",["bytes.view","store_any2"],["bytes.view","auth_context_id"],"jsonrpc_task_id_v"]],["let","rid2",["result_bytes.unwrap_or","rid2_res",["bytes.lit","null"]]],["let","empty_reason",["bytes.alloc",0]],["let","cancel_line",["std.mcp.notifications.cancelled_v1",["bytes.view","rid2"],["bytes.view","empty_reason"]]],["begin",["let","cancel_line_v",["bytes.view","cancel_line"]],["if",[">",["bytes.len","cancel_line_v"],0],["begin",["chan.bytes.try_send","cancel_handle","cancel_line_v"],0],0]],0],0]],0],0]],0],0],["if",["=","use_sse",1],["begin",["let","sse_body",["ext.mcp.server._jsonl_to_sse_body_v1",["bytes.view","out_jsonl"]]],["set","headers",["std.net.http.spec.headers_set_v1",["bytes.view","headers"],["bytes.view","hdr_content_type"],["bytes.view","value_ct_sse"]]],["set","body","sse_body"],0],["begin",["let","resp_line",["ext.mcp.server._jsonl_last_line_v1",["bytes.view","out_jsonl"]]],["if",[">",["bytes.len",["bytes.view","resp_line"]],0],["begin",["set","headers",["std.net.http.spec.headers_set_v1",["bytes.view","headers"],["bytes.view","hdr_content_type"],["bytes.view","value_ct_json"]]],["set","body","resp_line"],0],["set","status",202]],0]],0]],0],["set","status",405]]]]],["if",["=","skip_write",0],["begin",["let","_write",["std.net.http.server.write_response_v1","stream","status",["bytes.view","headers"],["bytes.view","body"],["bytes.view","caps"]]],["let","_close_stream",["std.net.tcp.stream_close_v1","stream"]],0],0],0]]],0]],0]],0]],["bytes.alloc",0]],"kind":"defasync","name":"ext.mcp.server.serve_http_from_fs_v1","params":[{"name":"cfg_path","ty":"bytes_view"}],"result":"bytes"}],"imports":["ext.crypto","ext.data_model","ext.hex","ext.json.data_model","ext.time.os","ext.time.rfc3339","mcp.user","std.bytes","std.codec","std.fmt","std.fs","std.hash_map_value","std.mcp.ctx","std.mcp.diag","std.mcp.jsonrpc","std.mcp.notifications","std.mcp.progress_registry","std.mcp.sandbox.router_exec","std.mcp.sandbox.task_exec_async_pool_v1","std.mcp.sandbox.task_exec_deterministic_v1","std.mcp.sandbox.task_store_any_v1","std.mcp.sandbox.worker_main","std.mcp.sandbox.worker_proto","std.mcp.sse","std.mcp.tool.errors","std.mcp.tool.result","std.mcp.toolkit.derive_hooks","std.mcp.toolkit.server_cfg_file","std.mcp.toolkit.tools_file","std.mcp.transport.http_rules","std.mcp.transport.http_sse","std.mcp.transport.http_sse_outbox_v1","std.mcp.util.json","std.net.codec","std.net.err","std.net.http.server","std.net.http.spec","std.net.tcp","std.os.rand","std.os.rand.spec","std.parse"],"kind":"module","module_id":"ext.mcp.server","schema_version":"x07.x07ast@0.3.0"}
