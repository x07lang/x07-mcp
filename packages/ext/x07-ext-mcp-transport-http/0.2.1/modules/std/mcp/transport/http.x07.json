{"decls":[{"kind":"export","names":["std.mcp.transport.http.serve_from_fs_v1"]},{"body":["begin",["if",["<","map_off",0],["return","fallback"],0],["let","off",["ext.data_model.map_find","doc","map_off","key"]],["if",["<","off",0],["return","fallback"],0],["if",["!=",["ext.data_model.kind_at","doc","off"],1],["return","fallback"],0],["ext.data_model.bool_get","doc","off"]],"kind":"defn","name":"std.mcp.transport.http._map_bool_or_default_v1","params":[{"name":"doc","ty":"bytes_view"},{"name":"map_off","ty":"i32"},{"name":"key","ty":"bytes_view"},{"name":"fallback","ty":"i32"}],"result":"i32"},{"body":["begin",["if",["<","map_off",0],["return","fallback"],0],["let","off",["ext.data_model.map_find","doc","map_off","key"]],["if",["<","off",0],["return","fallback"],0],["if",["!=",["ext.data_model.kind_at","doc","off"],2],["return","fallback"],0],["let","num_b",["ext.data_model.number_get","doc","off"]],["std.mcp.transport.http._parse_i32_or_default_v1",["bytes.view","num_b"],"fallback"]],"kind":"defn","name":"std.mcp.transport.http._map_i32_or_default_v1","params":[{"name":"doc","ty":"bytes_view"},{"name":"map_off","ty":"i32"},{"name":"key","ty":"bytes_view"},{"name":"fallback","ty":"i32"}],"result":"i32"},{"body":["begin",["if",["<","map_off",0],["return",["bytes.alloc",0]],0],["let","off",["ext.data_model.map_find","doc","map_off","key"]],["if",["<","off",0],["return",["bytes.alloc",0]],0],["std.mcp.transport.http._scope_text_from_seq_v1","doc","off"]],"kind":"defn","name":"std.mcp.transport.http._map_scopes_text_or_empty_v1","params":[{"name":"doc","ty":"bytes_view"},{"name":"map_off","ty":"i32"},{"name":"key","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["if",["<","map_off",0],["return",["bytes.alloc",0]],0],["let","off",["ext.data_model.map_find","doc","map_off","key"]],["if",["<","off",0],["return",["bytes.alloc",0]],0],["if",["!=",["ext.data_model.kind_at","doc","off"],3],["return",["bytes.alloc",0]],0],["ext.data_model.string_get","doc","off"]],"kind":"defn","name":"std.mcp.transport.http._map_string_or_empty_v1","params":[{"name":"doc","ty":"bytes_view"},{"name":"map_off","ty":"i32"},{"name":"key","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["if",["<","map_off",0],["return",["bytes.alloc",0]],0],["let","off",["ext.data_model.map_find","doc","map_off","key"]],["if",["<","off",0],["return",["bytes.alloc",0]],0],["let","end",["ext.data_model.skip_value","doc","off"]],["if",["<","end",0],["return",["bytes.alloc",0]],0],["let","val",["view.to_bytes",["view.slice","doc","off",["-","end","off"]]]],["std.mcp.util.json.json_from_value_v1",["bytes.view","val"]]],"kind":"defn","name":"std.mcp.transport.http._map_value_json_or_empty_v1","params":[{"name":"doc","ty":"bytes_view"},{"name":"map_off","ty":"i32"},{"name":"key","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","st",["std.parse.i32_status_le","b"]],["if",["if",[">=u",["bytes.len","st"],5],["=",["bytes.get_u8","st",0],1],0],["codec.read_u32_le","st",1],"fallback"]],"kind":"defn","name":"std.mcp.transport.http._parse_i32_or_default_v1","params":[{"name":"b","ty":"bytes_view"},{"name":"fallback","ty":"i32"}],"result":"i32"},{"body":["begin",["let","n",["bytes.len","rb"]],["if",["<","n",4],["begin",["let","v",["vec_u8.with_capacity",["+","payload_len",16]]],["set","v",["vec_u8.extend_bytes","v",["codec.write_u32_le",1]]],["set","v",["vec_u8.extend_bytes","v",["codec.write_u32_le","seq"]]],["set","v",["vec_u8.extend_bytes","v",["codec.write_u32_le","payload_len"]]],["set","v",["vec_u8.extend_bytes","v","payload"]],["return",["vec_u8.into_bytes","v"]]],0],["let","count0",["codec.read_u32_le","rb",0]],["let","count",["if",["<","count0",0],0,"count0"]],["let","off",4],["let","drop",["if",[">",["+","count",1],"max_events"],["-",["+","count",1],"max_events"],0]],["let","drop2",["if",["<","drop",0],0,"drop"]],["for","_",0,"drop2",["begin",["if",[">=u",["+","off",8],["+","n",1]],["begin",["set","off","n"],0],0],["let","plen",["codec.read_u32_le","rb",["+","off",4]]],["let","plen2",["if",["<","plen",0],0,"plen"]],["set","off",["+","off",["+","plen2",8]]],0]],0,["let","tail_len",["-","n","off"]],["let","new_count",["-",["+","count",1],"drop2"]],["let","v",["vec_u8.with_capacity",["+","tail_len",["+","payload_len",16]]]],["set","v",["vec_u8.extend_bytes","v",["codec.write_u32_le","new_count"]]],["if",[">","tail_len",0],["begin",["set","v",["vec_u8.extend_bytes","v",["view.slice","rb","off","tail_len"]]],0],0],["set","v",["vec_u8.extend_bytes","v",["codec.write_u32_le","seq"]]],["set","v",["vec_u8.extend_bytes","v",["codec.write_u32_le","payload_len"]]],["set","v",["vec_u8.extend_bytes","v","payload"]],["vec_u8.into_bytes","v"]],"kind":"defn","name":"std.mcp.transport.http._rb_append_v1","params":[{"name":"rb","ty":"bytes_view"},{"name":"seq","ty":"i32"},{"name":"payload_len","ty":"i32"},{"name":"payload","ty":"bytes_view"},{"name":"max_events","ty":"i32"}],"result":"bytes"},{"body":["codec.write_u32_le",0],"kind":"defn","name":"std.mcp.transport.http._rb_empty_v1","params":[],"result":"bytes"},{"body":["begin",["let","n",["bytes.len","rb"]],["if",["<","n",4],["return",0],0],["let","count0",["codec.read_u32_le","rb",0]],["let","count",["if",["<","count0",0],0,"count0"]],["let","off",4],["for","_",0,"count",["begin",["if",[">=u",["+","off",8],["+","n",1]],["return",0],0],["let","seq",["codec.read_u32_le","rb","off"]],["let","plen",["codec.read_u32_le","rb",["+","off",4]]],["let","plen2",["if",["<","plen",0],0,"plen"]],["let","start",["+","off",8]],["if",[">=u",["+","start","plen2"],["+","n",1]],["return",0],0],["if",[">","seq","after_seq"],["std.mcp.transport.http._write_chunk_v1","stream_handle",["view.slice","rb","start","plen2"],"caps"],0],["set","off",["+","start","plen2"]],0]],0],"kind":"defn","name":"std.mcp.transport.http._rb_write_after_seq_v1","params":[{"name":"rb","ty":"bytes_view"},{"name":"after_seq","ty":"i32"},{"name":"stream_handle","ty":"i32"},{"name":"caps","ty":"bytes_view"}],"result":"i32"},{"body":["begin",["let","k_method",["bytes.lit","method"]],["let","doc_b",["ext.json.data_model.parse","req_json"]],["let","doc",["bytes.view","doc_b"]],["if",["=",["ext.data_model.doc_is_err","doc"],1],["return",["bytes.alloc",0]],0],["if",["!=",["ext.data_model.root_kind","doc"],5],["return",["bytes.alloc",0]],0],["let","root",["ext.data_model.root_offset","doc"]],["std.mcp.transport.http._map_string_or_empty_v1","doc","root",["bytes.view","k_method"]]],"kind":"defn","name":"std.mcp.transport.http._request_method_v1","params":[{"name":"req_json","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","k_params",["bytes.lit","params"]],["let","k_name",["bytes.lit","name"]],["let","doc_b",["ext.json.data_model.parse","req_json"]],["let","doc",["bytes.view","doc_b"]],["if",["=",["ext.data_model.doc_is_err","doc"],1],["return",["bytes.alloc",0]],0],["if",["!=",["ext.data_model.root_kind","doc"],5],["return",["bytes.alloc",0]],0],["let","root",["ext.data_model.root_offset","doc"]],["let","params_off",["ext.data_model.map_find","doc","root",["bytes.view","k_params"]]],["if",["<","params_off",0],["return",["bytes.alloc",0]],0],["std.mcp.transport.http._map_string_or_empty_v1","doc","params_off",["bytes.view","k_name"]]],"kind":"defn","name":"std.mcp.transport.http._request_tool_name_v1","params":[{"name":"req_json","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","http",["bytes.lit","http://"]],["let","colon",["bytes.lit",":"]],["let","port_dec",["std.fmt.u32_to_dec","bind_port"]],["let","fallback",["std.bytes.concat",["bytes.view","http"],["std.bytes.concat","bind_host",["std.bytes.concat",["bytes.view","colon"],["bytes.view","port_dec"]]]]],["let","doc_b",["ext.json.data_model.parse","oauth_json"]],["let","doc",["bytes.view","doc_b"]],["if",["=",["ext.data_model.doc_is_err","doc"],1],["return","fallback"],0],["if",["!=",["ext.data_model.root_kind","doc"],5],["return","fallback"],0],["let","k_resource",["bytes.lit","resource"]],["let","root",["ext.data_model.root_offset","doc"]],["let","resource",["std.mcp.transport.http._map_string_or_empty_v1","doc","root",["bytes.view","k_resource"]]],["if",[">",["bytes.len",["bytes.view","resource"]],0],"resource","fallback"]],"kind":"defn","name":"std.mcp.transport.http._resource_from_oauth_or_default_v1","params":[{"name":"oauth_json","ty":"bytes_view"},{"name":"bind_host","ty":"bytes_view"},{"name":"bind_port","ty":"i32"}],"result":"bytes"},{"body":["begin",["let","k_method",["bytes.lit","method"]],["let","k_params",["bytes.lit","params"]],["let","k_uri",["bytes.lit","uri"]],["let","method_target",["bytes.lit","notifications/resources/updated"]],["let","doc_b",["ext.json.data_model.parse","notif_json"]],["let","doc",["bytes.view","doc_b"]],["if",["=",["ext.data_model.doc_is_err","doc"],1],["return",["bytes.alloc",0]],0],["if",["!=",["ext.data_model.root_kind","doc"],5],["return",["bytes.alloc",0]],0],["let","root",["ext.data_model.root_offset","doc"]],["let","m_off",["ext.data_model.map_find","doc","root",["bytes.view","k_method"]]],["if",["<","m_off",0],["return",["bytes.alloc",0]],0],["if",["!=",["ext.data_model.kind_at","doc","m_off"],3],["return",["bytes.alloc",0]],0],["let","m",["ext.data_model.string_get","doc","m_off"]],["if",["=",["bytes.eq",["bytes.view","m"],["bytes.view","method_target"]],0],["return",["bytes.alloc",0]],0],["let","p_off",["ext.data_model.map_find","doc","root",["bytes.view","k_params"]]],["if",["<","p_off",0],["return",["bytes.alloc",0]],0],["if",["!=",["ext.data_model.kind_at","doc","p_off"],5],["return",["bytes.alloc",0]],0],["let","u_off",["ext.data_model.map_find","doc","p_off",["bytes.view","k_uri"]]],["if",["<","u_off",0],["return",["bytes.alloc",0]],0],["if",["!=",["ext.data_model.kind_at","doc","u_off"],3],["return",["bytes.alloc",0]],0],["ext.data_model.string_get","doc","u_off"]],"kind":"defn","name":"std.mcp.transport.http._resources_updated_uri_or_empty_v1","params":[{"name":"notif_json","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["if",["<","seq_off",0],["return",["bytes.alloc",0]],0],["if",["!=",["ext.data_model.kind_at","doc","seq_off"],4],["return",["bytes.alloc",0]],0],["let","n",["ext.data_model.seq_len","doc","seq_off"]],["if",["<","n",0],["return",["bytes.alloc",0]],0],["let","out",["vec_u8.with_capacity",64]],["for","i",0,"n",["begin",["let","off",["ext.data_model.seq_get","doc","seq_off","i"]],["if",["<","off",0],["return",["bytes.alloc",0]],0],["if",["!=",["ext.data_model.kind_at","doc","off"],3],["return",["bytes.alloc",0]],0],["if",[">","i",0],["begin",["set","out",["vec_u8.push","out",32]],0],0],["let","part",["ext.data_model.string_get","doc","off"]],["set","out",["vec_u8.extend_bytes","out",["bytes.view","part"]]],0]],["vec_u8.into_bytes","out"]],"kind":"defn","name":"std.mcp.transport.http._scope_text_from_seq_v1","params":[{"name":"doc","ty":"bytes_view"},{"name":"seq_off","ty":"i32"}],"result":"bytes"},{"body":["begin",["let","a_len",["bytes.len","a"]],["let","b_len",["bytes.len","b"]],["if",["<=","a_len",0],["return",["std.bytes.copy","b"]],0],["if",["<=","b_len",0],["return",["std.bytes.copy","a"]],0],["let","_x07_tmp_borrow_decls_15_body_5_2_1",["bytes.lit"," "]],["std.bytes.concat","a",["std.bytes.concat",["bytes.view","_x07_tmp_borrow_decls_15_body_5_2_1"],"b"]]],"kind":"defn","name":"std.mcp.transport.http._scope_union_text_v1","params":[{"name":"a","ty":"bytes_view"},{"name":"b","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["if",["=",["std.mcp.transport.http._subs_has_v1","subs","uri"],1],["std.bytes.copy","subs"],["begin",["let","n",["std.bytes.len","subs"]],["let","m",["std.bytes.len","uri"]],["let","v",["vec_u8.with_capacity",["+",["+","n",4],"m"]]],["set","v",["vec_u8.extend_bytes","v","subs"]],["set","v",["vec_u8.extend_bytes","v",["codec.write_u32_le","m"]]],["set","v",["vec_u8.extend_bytes","v","uri"]],["vec_u8.into_bytes","v"]]]],"kind":"defn","name":"std.mcp.transport.http._subs_add_v1","params":[{"name":"subs","ty":"bytes_view"},{"name":"uri","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","n",["std.bytes.len","subs"]],["let","off",0],["for","_",0,2147483647,["begin",["if",[">=u","off","n"],["return",0],0],["if",[">=u",["+","off",4],["+","n",1]],["return",0],0],["let","len",["codec.read_u32_le","subs","off"]],["let","start",["+","off",4]],["if",[">=u",["+","start","len"],["+","n",1]],["return",0],0],["if",["&",["=","len",["std.bytes.len","uri"]],["=",["view.cmp_range","subs","start","len","uri",0,"len"],0]],["return",1],0],["set","off",["+","start","len"]],0]],0],"kind":"defn","name":"std.mcp.transport.http._subs_has_v1","params":[{"name":"subs","ty":"bytes_view"},{"name":"uri","ty":"bytes_view"}],"result":"i32"},{"body":["begin",["let","n",["std.bytes.len","subs"]],["let","out",["vec_u8.with_capacity","n"]],["let","off",0],["for","_",0,2147483647,["begin",["if",[">=u","off","n"],["return",["vec_u8.into_bytes","out"]],0],["if",[">=u",["+","off",4],["+","n",1]],["return",["vec_u8.into_bytes","out"]],0],["let","len",["codec.read_u32_le","subs","off"]],["let","start",["+","off",4]],["if",[">=u",["+","start","len"],["+","n",1]],["return",["vec_u8.into_bytes","out"]],0],["let","match",["&",["=","len",["std.bytes.len","uri"]],["=",["view.cmp_range","subs","start","len","uri",0,"len"],0]]],["if",["=","match",1],0,["begin",["set","out",["vec_u8.extend_bytes","out",["codec.write_u32_le","len"]]],["set","out",["vec_u8.extend_bytes","out",["view.slice","subs","start","len"]]],0]],["set","off",["+","start","len"]],0]],["vec_u8.into_bytes","out"]],"kind":"defn","name":"std.mcp.transport.http._subs_remove_v1","params":[{"name":"subs","ty":"bytes_view"},{"name":"uri","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","diag",["std.mcp.diag.code_internal_v1"]],["let","detail",["bytes.lit","{}"]],["std.mcp.tool.result.err_v1",["bytes.view","diag"],["bytes.view","message_utf8"],["bytes.view","detail"]]],"kind":"defn","name":"std.mcp.transport.http._tool_internal_error_result_v1","params":[{"name":"tool_name","ty":"bytes_view"},{"name":"err_code","ty":"i32"},{"name":"message_utf8","ty":"bytes"}],"result":"bytes"},{"body":["begin",["let","doc_b",["ext.json.data_model.parse","tools_json"]],["let","doc",["bytes.view","doc_b"]],["if",["=",["ext.data_model.doc_is_err","doc"],1],["return",["bytes.alloc",0]],0],["if",["!=",["ext.data_model.root_kind","doc"],5],["return",["bytes.alloc",0]],0],["let","root",["ext.data_model.root_offset","doc"]],["let","k_tools",["bytes.lit","tools"]],["let","tools_off",["ext.data_model.map_find","doc","root",["bytes.view","k_tools"]]],["if",["<","tools_off",0],["return",["bytes.alloc",0]],0],["if",["!=",["ext.data_model.kind_at","doc","tools_off"],4],["return",["bytes.alloc",0]],0],["let","n",["ext.data_model.seq_len","doc","tools_off"]],["if",["<","n",0],["return",["bytes.alloc",0]],0],["let","k_name",["bytes.lit","name"]],["let","k_auth",["bytes.lit","auth"]],["let","k_required",["bytes.lit","required_scopes"]],["for","i",0,"n",["begin",["begin",["let","it",["ext.data_model.seq_get","doc","tools_off","i"]],["if",["<","it",0],0,["begin",["let","name_off",["ext.data_model.map_find","doc","it",["bytes.view","k_name"]]],["if",["<","name_off",0],0,["begin",["let","nm",["ext.data_model.string_get","doc","name_off"]],["if",["=",["bytes.eq",["bytes.view","nm"],"tool_name"],1],["begin",["let","auth_off",["ext.data_model.map_find","doc","it",["bytes.view","k_auth"]]],["if",["<","auth_off",0],["return",["bytes.alloc",0]],0],["if",["!=",["ext.data_model.kind_at","doc","auth_off"],5],["return",["bytes.alloc",0]],0],["let","req_off",["ext.data_model.map_find","doc","auth_off",["bytes.view","k_required"]]],["if",["<","req_off",0],["return",["bytes.alloc",0]],0],["return",["std.mcp.transport.http._scope_text_from_seq_v1","doc","req_off"]]],0],0]]]]],0]],["bytes.alloc",0]],"kind":"defn","name":"std.mcp.transport.http._tool_required_scopes_text_v1","params":[{"name":"tools_json","ty":"bytes_view"},{"name":"tool_name","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","hex",["bytes.lit","0123456789abcdef"]],["let","x",["if",["<","n",0],0,"n"]],["let","out",["vec_u8.with_capacity",8]],["let","started",0],["for","i",0,8,["begin",["let","shift",["-",28,["*","i",4]]],["let","nib",["&",[">>u","x","shift"],15]],["if",["if",["=","started",0],["=","nib",0],0],0,["begin",["set","started",1],["set","out",["vec_u8.push","out",["bytes.get_u8",["bytes.view","hex"],"nib"]]],0]],0]],["if",["=","started",0],["begin",["set","out",["vec_u8.push","out",48]],0],0],["vec_u8.into_bytes","out"]],"kind":"defn","name":"std.mcp.transport.http._u32_to_hex_nz_v1","params":[{"name":"n","ty":"i32"}],"result":"bytes"},{"body":["begin",["let","end",["bytes.alloc",5]],["set","end",["bytes.set_u8","end",0,48]],["set","end",["bytes.set_u8","end",1,13]],["set","end",["bytes.set_u8","end",2,10]],["set","end",["bytes.set_u8","end",3,13]],["set","end",["bytes.set_u8","end",4,10]],["std.net.io.write_all_v1","stream_handle",["bytes.view","end"],"caps"],0],"kind":"defn","name":"std.mcp.transport.http._write_chunk_end_v1","params":[{"name":"stream_handle","ty":"i32"},{"name":"caps","ty":"bytes_view"}],"result":"i32"},{"body":["begin",["let","len",["view.len","payload"]],["let","hex",["std.mcp.transport.http._u32_to_hex_nz_v1","len"]],["let","crlf",["bytes.alloc",2]],["set","crlf",["bytes.set_u8","crlf",0,13]],["set","crlf",["bytes.set_u8","crlf",1,10]],["std.net.io.write_all_v1","stream_handle",["bytes.view","hex"],"caps"],["std.net.io.write_all_v1","stream_handle",["bytes.view","crlf"],"caps"],["std.net.io.write_all_v1","stream_handle","payload","caps"],["std.net.io.write_all_v1","stream_handle",["bytes.view","crlf"],"caps"],0],"kind":"defn","name":"std.mcp.transport.http._write_chunk_v1","params":[{"name":"stream_handle","ty":"i32"},{"name":"payload","ty":"bytes_view"},{"name":"caps","ty":"bytes_view"}],"result":"i32"},{"body":["begin",["let","s0",["bytes.lit","HTTP/1.1 200 OK"]],["let","s1",["bytes.lit","Content-Type: text/event-stream"]],["let","s2",["bytes.lit","Cache-Control: no-cache"]],["let","s3",["bytes.lit","Connection: keep-alive"]],["let","s4",["bytes.lit","Transfer-Encoding: chunked"]],["let","h2",["bytes.lit","MCP-Session-Id: "]],["let","crlf",["bytes.alloc",2]],["set","crlf",["bytes.set_u8","crlf",0,13]],["set","crlf",["bytes.set_u8","crlf",1,10]],["let","out",["vec_u8.with_capacity",256]],["set","out",["vec_u8.extend_bytes","out",["bytes.view","s0"]]],["set","out",["vec_u8.extend_bytes","out",["bytes.view","crlf"]]],["set","out",["vec_u8.extend_bytes","out",["bytes.view","s1"]]],["set","out",["vec_u8.extend_bytes","out",["bytes.view","crlf"]]],["set","out",["vec_u8.extend_bytes","out",["bytes.view","s2"]]],["set","out",["vec_u8.extend_bytes","out",["bytes.view","crlf"]]],["set","out",["vec_u8.extend_bytes","out",["bytes.view","s3"]]],["set","out",["vec_u8.extend_bytes","out",["bytes.view","crlf"]]],["set","out",["vec_u8.extend_bytes","out",["bytes.view","s4"]]],["set","out",["vec_u8.extend_bytes","out",["bytes.view","crlf"]]],["begin",["let","_x07_tmp_copy",["std.bytes.copy","session_id"]],["if",[">",["bytes.len",["bytes.view","_x07_tmp_copy"]],0],["begin",["set","out",["vec_u8.extend_bytes","out",["bytes.view","h2"]]],["set","out",["vec_u8.extend_bytes","out",["bytes.view","session_id"]]],["set","out",["vec_u8.extend_bytes","out",["bytes.view","crlf"]]],0],0]],["set","out",["vec_u8.extend_bytes","out",["bytes.view","crlf"]]],["let","b",["vec_u8.into_bytes","out"]],["std.net.io.write_all_v1","stream_handle",["bytes.view","b"],"caps"],0],"kind":"defn","name":"std.mcp.transport.http._write_sse_head_v1","params":[{"name":"stream_handle","ty":"i32"},{"name":"session_id","ty":"bytes"},{"name":"caps","ty":"bytes_view"}],"result":"i32"},{"body":["begin",["let","kind_res_updated",2],["for","_",0,2147483647,["begin",["let","nline",["chan.bytes.recv","notif_chan"]],["if",["=",["bytes.len","nline"],0],["return",["bytes.alloc",0]],0],["let","uri",["std.mcp.transport.http._resources_updated_uri_or_empty_v1","nline"]],["begin",["let","_x07_tmp_copy",["std.bytes.copy","uri"]],["if",[">",["bytes.len",["bytes.view","_x07_tmp_copy"]],0],["begin",["let","mru",["vec_u8.with_capacity",256]],["set","mru",["vec_u8.extend_bytes","mru",["codec.write_u32_le","kind_res_updated"]]],["set","mru",["vec_u8.extend_bytes","mru",["codec.write_u32_le",["bytes.len",["bytes.view","uri"]]]]],["set","mru",["vec_u8.extend_bytes","mru",["bytes.view","uri"]]],["set","mru",["vec_u8.extend_bytes","mru",["codec.write_u32_le",["bytes.len","nline"]]]],["set","mru",["vec_u8.extend_bytes","mru","nline"]],["chan.bytes.send","event_chan",["vec_u8.into_bytes","mru"]],0],0]],["task.yield"],0]],["bytes.alloc",0]],"kind":"defasync","name":"std.mcp.transport.http._sse_notif_drain_v1","params":[{"name":"notif_chan","ty":"i32"},{"name":"event_chan","ty":"i32"}],"result":"bytes"},{"body":["begin",["let","kind_append_post",1],["let","kind_done",3],["let","post_kind",["bytes.lit","post"]],["let","seq",0],["let","has_progress",[">",["bytes.len",["bytes.view","progress_token_json"]],0]],["std.mcp.transport.http._write_sse_head_v1","stream_handle",["std.bytes.copy","session_id"],"caps"],["let","event_id0",["std.mcp.sse.event_id_make_v1",["bytes.view","session_id"],["bytes.view","post_kind"],"stream_key","seq"]],["let","payload0",["begin",["let","empty_event0",["bytes.alloc",0]],["std.mcp.sse.encode_event_v1",["bytes.view","event_id0"],["bytes.view","empty_event0"]]]],["let","m0",["vec_u8.with_capacity",["+",12,["bytes.len",["bytes.view","payload0"]]]]],["set","m0",["vec_u8.extend_bytes","m0",["codec.write_u32_le","kind_append_post"]]],["set","m0",["vec_u8.extend_bytes","m0",["codec.write_u32_le","seq"]]],["set","m0",["vec_u8.extend_bytes","m0",["codec.write_u32_le",["bytes.len",["bytes.view","payload0"]]]]],["set","m0",["vec_u8.extend_bytes","m0",["bytes.view","payload0"]]],["chan.bytes.send","event_chan",["vec_u8.into_bytes","m0"]],["std.mcp.transport.http._write_chunk_v1","stream_handle",["bytes.view","payload0"],"caps"],["set","seq",["+","seq",1]],["if",["=","has_progress",1],["begin",["let","start",["begin",["let","msg_start_empty",["bytes.alloc",0]],["std.mcp.notifications.progress_v1",["bytes.view","progress_token_json"],0,100,["bytes.view","msg_start_empty"]]]],["let","eid",["std.mcp.sse.event_id_make_v1",["bytes.view","session_id"],["bytes.view","post_kind"],"stream_key","seq"]],["let","pl",["std.mcp.sse.encode_event_v1",["bytes.view","eid"],["bytes.view","start"]]],["let","m1",["vec_u8.with_capacity",["+",12,["bytes.len",["bytes.view","pl"]]]]],["set","m1",["vec_u8.extend_bytes","m1",["codec.write_u32_le","kind_append_post"]]],["set","m1",["vec_u8.extend_bytes","m1",["codec.write_u32_le","seq"]]],["set","m1",["vec_u8.extend_bytes","m1",["codec.write_u32_le",["bytes.len",["bytes.view","pl"]]]]],["set","m1",["vec_u8.extend_bytes","m1",["bytes.view","pl"]]],["chan.bytes.send","event_chan",["vec_u8.into_bytes","m1"]],["std.mcp.transport.http._write_chunk_v1","stream_handle",["bytes.view","pl"],"caps"],["set","seq",["+","seq",1]],["let","mid",["begin",["let","msg_mid_empty",["bytes.alloc",0]],["std.mcp.notifications.progress_v1",["bytes.view","progress_token_json"],50,100,["bytes.view","msg_mid_empty"]]]],["let","eid_mid",["std.mcp.sse.event_id_make_v1",["bytes.view","session_id"],["bytes.view","post_kind"],"stream_key","seq"]],["let","pl_mid",["std.mcp.sse.encode_event_v1",["bytes.view","eid_mid"],["bytes.view","mid"]]],["let","m1_mid",["vec_u8.with_capacity",["+",12,["bytes.len",["bytes.view","pl_mid"]]]]],["set","m1_mid",["vec_u8.extend_bytes","m1_mid",["codec.write_u32_le","kind_append_post"]]],["set","m1_mid",["vec_u8.extend_bytes","m1_mid",["codec.write_u32_le","seq"]]],["set","m1_mid",["vec_u8.extend_bytes","m1_mid",["codec.write_u32_le",["bytes.len",["bytes.view","pl_mid"]]]]],["set","m1_mid",["vec_u8.extend_bytes","m1_mid",["bytes.view","pl_mid"]]],["chan.bytes.send","event_chan",["vec_u8.into_bytes","m1_mid"]],["std.mcp.transport.http._write_chunk_v1","stream_handle",["bytes.view","pl_mid"],"caps"],["set","seq",["+","seq",1]],0],0],["let","notif_chan",["chan.bytes.new",64]],["let","tool_result",["task.scope_v1",["task.scope.cfg_v1",["max_children",4]],["begin",["let","slot",["task.scope.async_let_bytes_v1",["std.mcp.transport.http._tool_task_v1","tool_name","cfg_json","request_ctx_json","args_json","tools_json","notif_chan","cancel_chan"]]],["task.scope.start_soon_v1",["std.mcp.transport.http._sse_notif_drain_v1","notif_chan","event_chan"]],["let","tool_result_slot",["task.scope.await_slot_bytes_v1","slot"]],["task.scope.cancel_all_v1"],["task.scope.wait_all_v1"],"tool_result_slot"]]],["begin",["let","_x07_tmp_copy",["std.bytes.copy","tool_result"]],["if",[">",["bytes.len",["bytes.view","_x07_tmp_copy"]],0],["begin",["if",["=","has_progress",1],["begin",["let","done",["begin",["let","msg_done_empty",["bytes.alloc",0]],["std.mcp.notifications.progress_v1",["bytes.view","progress_token_json"],100,100,["bytes.view","msg_done_empty"]]]],["let","eid2",["std.mcp.sse.event_id_make_v1",["bytes.view","session_id"],["bytes.view","post_kind"],"stream_key","seq"]],["let","pl2",["std.mcp.sse.encode_event_v1",["bytes.view","eid2"],["bytes.view","done"]]],["let","m2",["vec_u8.with_capacity",["+",12,["bytes.len",["bytes.view","pl2"]]]]],["set","m2",["vec_u8.extend_bytes","m2",["codec.write_u32_le","kind_append_post"]]],["set","m2",["vec_u8.extend_bytes","m2",["codec.write_u32_le","seq"]]],["set","m2",["vec_u8.extend_bytes","m2",["codec.write_u32_le",["bytes.len",["bytes.view","pl2"]]]]],["set","m2",["vec_u8.extend_bytes","m2",["bytes.view","pl2"]]],["chan.bytes.send","event_chan",["vec_u8.into_bytes","m2"]],["std.mcp.transport.http._write_chunk_v1","stream_handle",["bytes.view","pl2"],"caps"],["set","seq",["+","seq",1]],0],0],["let","resp_json",["std.mcp.jsonrpc.make_result_response_v1","id_json","tool_result"]],["let","eid3",["std.mcp.sse.event_id_make_v1",["bytes.view","session_id"],["bytes.view","post_kind"],"stream_key","seq"]],["let","pl3",["std.mcp.sse.encode_event_v1",["bytes.view","eid3"],["bytes.view","resp_json"]]],["let","m3",["vec_u8.with_capacity",["+",12,["bytes.len",["bytes.view","pl3"]]]]],["set","m3",["vec_u8.extend_bytes","m3",["codec.write_u32_le","kind_append_post"]]],["set","m3",["vec_u8.extend_bytes","m3",["codec.write_u32_le","seq"]]],["set","m3",["vec_u8.extend_bytes","m3",["codec.write_u32_le",["bytes.len",["bytes.view","pl3"]]]]],["set","m3",["vec_u8.extend_bytes","m3",["bytes.view","pl3"]]],["chan.bytes.send","event_chan",["vec_u8.into_bytes","m3"]],["std.mcp.transport.http._write_chunk_v1","stream_handle",["bytes.view","pl3"],"caps"],["set","seq",["+","seq",1]],0],0]],["let","mdone",["vec_u8.with_capacity",4]],["set","mdone",["vec_u8.extend_bytes","mdone",["codec.write_u32_le","kind_done"]]],["chan.bytes.send","event_chan",["vec_u8.into_bytes","mdone"]],["std.mcp.transport.http._write_chunk_end_v1","stream_handle","caps"],["std.net.tcp.stream_close_v1","stream_handle"],["bytes.alloc",0]],"kind":"defasync","name":"std.mcp.transport.http._tool_sse_task_v1","params":[{"name":"stream_handle","ty":"i32"},{"name":"caps","ty":"bytes_view"},{"name":"session_id","ty":"bytes"},{"name":"stream_key","ty":"bytes_view"},{"name":"id_json","ty":"bytes_view"},{"name":"progress_token_json","ty":"bytes"},{"name":"tool_name","ty":"bytes_view"},{"name":"cfg_json","ty":"bytes_view"},{"name":"request_ctx_json","ty":"bytes_view"},{"name":"args_json","ty":"bytes_view"},{"name":"tools_json","ty":"bytes_view"},{"name":"cancel_chan","ty":"i32"},{"name":"event_chan","ty":"i32"}],"result":"bytes"},{"body":["begin",["let","t",["std.mcp.sandbox.router_exec.call_tool_stream_v1","tool_name","cfg_json","request_ctx_json","args_json","tools_json","out_chan","cancel_chan"]],["let","r",["task.join.result_bytes","t"]],["let","ec",["result_bytes.err_code","r"]],["if",["=","ec",["std.mcp.sandbox.router_exec._err_worker_cancelled_v1"]],["return",["bytes.alloc",0]],0],["if",["!=","ec",0],["return",["std.mcp.transport.http._tool_internal_error_result_v1","tool_name","ec",["bytes.lit","tool invocation failed"]]],0],["result_bytes.unwrap_or","r",["bytes.alloc",0]]],"kind":"defasync","name":"std.mcp.transport.http._tool_task_v1","params":[{"name":"tool_name","ty":"bytes_view"},{"name":"cfg_json","ty":"bytes_view"},{"name":"request_ctx_json","ty":"bytes_view"},{"name":"args_json","ty":"bytes_view"},{"name":"tools_json","ty":"bytes_view"},{"name":"out_chan","ty":"i32"},{"name":"cancel_chan","ty":"i32"}],"result":"bytes"},{"body":["begin",["let","k_auth",["bytes.lit","auth"]],["let","k_bind_host",["bytes.lit","bind_host"]],["let","k_bind_port",["bytes.lit","bind_port"]],["let","k_kind",["bytes.lit","kind"]],["let","k_mcp_path",["bytes.lit","mcp_path"]],["let","k_mode",["bytes.lit","mode"]],["let","k_oauth_cfg_path",["bytes.lit","oauth_config_path"]],["let","k_origin_allow_missing",["bytes.lit","origin_allow_missing"]],["let","k_origin_allowlist",["bytes.lit","origin_allowlist"]],["let","k_required_scopes",["bytes.lit","required_scopes"]],["let","k_schema",["bytes.lit","schema_version"]],["let","k_server",["bytes.lit","server"]],["let","k_name",["bytes.lit","name"]],["let","k_protocol_version",["bytes.lit","protocolVersion"]],["let","k_session_mode",["bytes.lit","session_mode"]],["let","k_tools_manifest_path",["bytes.lit","tools_manifest_path"]],["let","k_transport",["bytes.lit","transport"]],["let","k_version",["bytes.lit","version"]],["let","schema_want",["bytes.lit","x07.mcp.server_config@0.2.0"]],["let","kind_http",["bytes.lit","http"]],["let","auth_none",["bytes.lit","none"]],["let","auth_oauth2",["bytes.lit","oauth2"]],["let","session_required_text",["bytes.lit","required"]],["let","path_default_mcp",["bytes.lit","/mcp"]],["let","path_prm",["bytes.lit","/.well-known/oauth-protected-resource"]],["let","suffix_prm",["bytes.lit","/.well-known/oauth-protected-resource"]],["let","hdr_accept",["bytes.lit","Accept"]],["let","hdr_allow",["bytes.lit","Allow"]],["let","hdr_authz",["bytes.lit","Authorization"]],["let","hdr_content_type",["bytes.lit","Content-Type"]],["let","hdr_mcp_pv",["bytes.lit","MCP-Protocol-Version"]],["let","hdr_mcp_sid",["bytes.lit","MCP-Session-Id"]],["let","hdr_origin",["bytes.lit","Origin"]],["let","hdr_www_auth",["bytes.lit","WWW-Authenticate"]],["let","method_get",["bytes.lit","GET"]],["let","method_post",["bytes.lit","POST"]],["let","request_initialize",["bytes.lit","initialize"]],["let","request_tools_call",["bytes.lit","tools/call"]],["let","request_tools_list",["bytes.lit","tools/list"]],["let","request_resources_list",["bytes.lit","resources/list"]],["let","request_resources_read",["bytes.lit","resources/read"]],["let","request_prompts_list",["bytes.lit","prompts/list"]],["let","request_prompts_get",["bytes.lit","prompts/get"]],["let","value_allow_post",["bytes.lit","POST"]],["let","value_content_type_json",["bytes.lit","application/json"]],["let","default_allowlist_json",["bytes.lit","[\"http://localhost:*\",\"http://127.0.0.1:*\",\"https://mcp.example.com\"]"]],["let","cfg_json",["std.fs.read","cfg_path"]],["let","cfg_doc_b",["ext.json.data_model.parse",["bytes.view","cfg_json"]]],["let","cfg_doc",["bytes.view","cfg_doc_b"]],["if",["=",["ext.data_model.doc_is_err","cfg_doc"],1],["return",["bytes.alloc",0]],0],["if",["!=",["ext.data_model.root_kind","cfg_doc"],5],["return",["bytes.alloc",0]],0],["let","cfg_root",["ext.data_model.root_offset","cfg_doc"]],["let","schema_ver",["std.mcp.transport.http._map_string_or_empty_v1","cfg_doc","cfg_root",["bytes.view","k_schema"]]],["if",["=",["bytes.eq",["bytes.view","schema_ver"],["bytes.view","schema_want"]],0],["return",["bytes.alloc",0]],0],["let","transport_off",["ext.data_model.map_find","cfg_doc","cfg_root",["bytes.view","k_transport"]]],["if",["<","transport_off",0],["return",["bytes.alloc",0]],0],["let","transport_kind",["std.mcp.transport.http._map_string_or_empty_v1","cfg_doc","transport_off",["bytes.view","k_kind"]]],["if",["=",["bytes.eq",["bytes.view","transport_kind"],["bytes.view","kind_http"]],0],["return",["bytes.alloc",0]],0],["let","server_off",["ext.data_model.map_find","cfg_doc","cfg_root",["bytes.view","k_server"]]],["if",["<","server_off",0],["return",["bytes.alloc",0]],0],["let","server_name",["std.mcp.transport.http._map_string_or_empty_v1","cfg_doc","server_off",["bytes.view","k_name"]]],["let","server_version",["std.mcp.transport.http._map_string_or_empty_v1","cfg_doc","server_off",["bytes.view","k_version"]]],["let","cfg_pv",["std.mcp.transport.http._map_string_or_empty_v1","cfg_doc","server_off",["bytes.view","k_protocol_version"]]],["let","supported_pv",["std.mcp.protocol.mcp_protocol_version_v1"]],["if",["=",["bytes.eq",["bytes.view","cfg_pv"],["bytes.view","supported_pv"]],0],["return",["bytes.alloc",0]],0],["let","tools_path",["std.mcp.transport.http._map_string_or_empty_v1","cfg_doc","cfg_root",["bytes.view","k_tools_manifest_path"]]],["if",["<=",["bytes.len",["bytes.view","tools_path"]],0],["return",["bytes.alloc",0]],0],["let","tools_res",["std.mcp.toolkit.tools_file.load_tools_from_fs_v1",["bytes.view","tools_path"]]],["if",["!=",["result_bytes.err_code","tools_res"],0],["return",["bytes.alloc",0]],0],["let","tools_json",["result_bytes.unwrap_or","tools_res",["bytes.alloc",0]]],["let","fs_caps",["std.os.fs.spec.caps_default_v1"]],["let","resources_json",["bytes.alloc",0]],["let","resources_read",["std.os.fs.read_all_v1",["bytes.lit","config/mcp.resources.json"],["std.bytes.copy","fs_caps"]]],["let","resources_read_code",["result_bytes.err_code","resources_read"]],["if",["=","resources_read_code",0],["begin",["let","resources_raw",["result_bytes.unwrap_or","resources_read",["bytes.alloc",0]]],["let","resources_res",["std.mcp.toolkit.resources_file.load_resources_from_json_v1",["bytes.view","resources_raw"]]],["if",["!=",["result_bytes.err_code","resources_res"],0],["return",["bytes.alloc",0]],0],["set","resources_json",["result_bytes.unwrap_or","resources_res",["bytes.alloc",0]]],0],0],["if",["if",["!=","resources_read_code",0],["!=","resources_read_code",["std.os.fs.spec.err_not_found_v1"]],0],["return",["bytes.alloc",0]],0],["let","prompts_json",["bytes.alloc",0]],["let","prompts_read",["std.os.fs.read_all_v1",["bytes.lit","config/mcp.prompts.json"],["std.bytes.copy","fs_caps"]]],["let","prompts_read_code",["result_bytes.err_code","prompts_read"]],["if",["=","prompts_read_code",0],["begin",["let","prompts_raw",["result_bytes.unwrap_or","prompts_read",["bytes.alloc",0]]],["let","prompts_res",["std.mcp.toolkit.prompts_file.load_prompts_from_json_v1",["bytes.view","prompts_raw"]]],["if",["!=",["result_bytes.err_code","prompts_res"],0],["return",["bytes.alloc",0]],0],["set","prompts_json",["result_bytes.unwrap_or","prompts_res",["bytes.alloc",0]]],0],0],["if",["if",["!=","prompts_read_code",0],["!=","prompts_read_code",["std.os.fs.spec.err_not_found_v1"]],0],["return",["bytes.alloc",0]],0],["let","bind_host",["std.mcp.transport.http._map_string_or_empty_v1","cfg_doc","transport_off",["bytes.view","k_bind_host"]]],["let","bind_host_len",["bytes.len",["bytes.view","bind_host"]]],["if",["<=","bind_host_len",0],["begin",["set","bind_host",["bytes.lit","127.0.0.1"]],0],0],["let","bind_port",["std.mcp.transport.http._map_i32_or_default_v1","cfg_doc","transport_off",["bytes.view","k_bind_port"],8314]],["if",["<=","bind_port",0],["begin",["set","bind_port",8080],0],0],["let","mcp_path",["std.mcp.transport.http._map_string_or_empty_v1","cfg_doc","transport_off",["bytes.view","k_mcp_path"]]],["let","mcp_path_len",["bytes.len",["bytes.view","mcp_path"]]],["if",["<=","mcp_path_len",0],["begin",["set","mcp_path","path_default_mcp"],0],0],["let","origin_allow_missing",["std.mcp.transport.http._map_bool_or_default_v1","cfg_doc","transport_off",["bytes.view","k_origin_allow_missing"],1]],["let","origin_allowlist_json",["std.mcp.transport.http._map_value_json_or_empty_v1","cfg_doc","transport_off",["bytes.view","k_origin_allowlist"]]],["let","origin_allowlist_json_len",["bytes.len",["bytes.view","origin_allowlist_json"]]],["if",["<=","origin_allowlist_json_len",0],["begin",["set","origin_allowlist_json","default_allowlist_json"],0],0],["let","session_mode",["std.mcp.transport.http._map_string_or_empty_v1","cfg_doc","transport_off",["bytes.view","k_session_mode"]]],["let","session_mode_len",["bytes.len",["bytes.view","session_mode"]]],["if",["<=","session_mode_len",0],["begin",["set","session_mode",["std.bytes.copy",["bytes.view","session_required_text"]]],0],0],["let","session_required",["if",["=",["bytes.eq",["bytes.view","session_mode"],["bytes.view","session_required_text"]],1],1,0]],["let","auth_off",["ext.data_model.map_find","cfg_doc","cfg_root",["bytes.view","k_auth"]]],["let","auth_mode",["std.mcp.transport.http._map_string_or_empty_v1","cfg_doc","auth_off",["bytes.view","k_mode"]]],["let","auth_mode_len",["bytes.len",["bytes.view","auth_mode"]]],["if",["<=","auth_mode_len",0],["begin",["set","auth_mode","auth_none"],0],0],["let","auth_required_scopes",["std.mcp.transport.http._scope_text_from_seq_v1","cfg_doc",["ext.data_model.map_find","cfg_doc","auth_off",["bytes.view","k_required_scopes"]]]],["let","oauth_cfg_path",["std.mcp.transport.http._map_string_or_empty_v1","cfg_doc","auth_off",["bytes.view","k_oauth_cfg_path"]]],["let","oauth_cfg_path_len",["bytes.len",["bytes.view","oauth_cfg_path"]]],["if",["<=","oauth_cfg_path_len",0],["begin",["set","oauth_cfg_path",["bytes.lit","config/mcp.oauth.json"]],0],0],["let","oauth_json",["bytes.alloc",0]],["if",["=",["bytes.eq",["bytes.view","auth_mode"],["bytes.view","auth_oauth2"]],1],["begin",["set","oauth_json",["std.fs.read",["bytes.view","oauth_cfg_path"]]],0],0],["let","resource_base",["std.mcp.transport.http._resource_from_oauth_or_default_v1",["bytes.view","oauth_json"],["bytes.view","bind_host"],"bind_port"]],["let","resource_md_url",["bytes.alloc",0]],["let","rs_pack",["bytes.alloc",0]],["let","prm_json",["bytes.alloc",0]],["let","serve_root_alias",0],["let","prm_path_primary",["std.bytes.concat",["bytes.view","path_prm"],["bytes.view","mcp_path"]]],["if",["=",["bytes.eq",["bytes.view","auth_mode"],["bytes.view","auth_oauth2"]],1],["begin",["let","rs_res",["std.mcp.auth.rs_v1.oauth2_rs_from_oauth_cfg_v1",["bytes.view","oauth_json"]]],["if",["!=",["result_bytes.err_code","rs_res"],0],["return",["bytes.alloc",0]],0],["set","rs_pack",["result_bytes.unwrap_or","rs_res",["bytes.alloc",0]]],["let","rs_doc_b",["ext.json.data_model.parse",["bytes.view","rs_pack"]]],["let","rs_doc",["bytes.view","rs_doc_b"]],["if",["=",["ext.data_model.doc_is_err","rs_doc"],1],["return",["bytes.alloc",0]],0],["if",["!=",["ext.data_model.root_kind","rs_doc"],5],["return",["bytes.alloc",0]],0],["let","rs_root",["ext.data_model.root_offset","rs_doc"]],["let","k_md",["bytes.lit","resource_metadata_url"]],["let","k_prm",["bytes.lit","prm_json"]],["let","k_root_alias",["bytes.lit","serve_root_alias"]],["set","resource_md_url",["std.mcp.transport.http._map_string_or_empty_v1","rs_doc","rs_root",["bytes.view","k_md"]]],["set","prm_json",["std.mcp.transport.http._map_string_or_empty_v1","rs_doc","rs_root",["bytes.view","k_prm"]]],["set","serve_root_alias",["std.mcp.transport.http._map_bool_or_default_v1","rs_doc","rs_root",["bytes.view","k_root_alias"],1]],["if",["=",["bytes.len",["bytes.view","resource_md_url"]],0],["return",["bytes.alloc",0]],0],["if",["=",["bytes.len",["bytes.view","prm_json"]],0],["return",["bytes.alloc",0]],0],0],0],["let","_x07_tmp_borrow_decls_25_body_110_2_1_1_2",["bytes.lit","0.0.0.0"]],["let","bind_addr",["if",["=",["bytes.eq",["bytes.view","bind_host"],["bytes.view","_x07_tmp_borrow_decls_25_body_110_2_1_1_2"]],1],["std.net.codec.addr_ipv4_v1",0,0,0,0,"bind_port"],["std.net.codec.addr_ipv4_v1",127,0,0,1,"bind_port"]]],["let","caps",["std.net.codec.caps_default_v1"]],["let","listen_doc",["std.net.tcp.listen_v1",["bytes.view","bind_addr"],["bytes.view","caps"]]],["begin",["let","listen_doc_copy",["std.bytes.copy",["bytes.view","listen_doc"]]],["if",["=",["std.net.err.is_err_doc_v1",["bytes.view","listen_doc_copy"]],1],["return",["bytes.alloc",0]],0]],["let","listener",["std.net.tcp.listen_listener_handle_v1","listen_doc"]],["let","mcp_state",0],["let","subs",["bytes.alloc",0]],["let","session_id",["bytes.alloc",0]],["let","session_idx",1],["for","_",0,2147483647,["begin",["let","accept_doc",["std.net.tcp.accept_v1","listener",["bytes.view","caps"]]],["if",["=",["std.net.err.is_err_doc_v1",["bytes.view","accept_doc"]],1],["return",["bytes.alloc",0]],0],["let","stream",["std.net.tcp.accept_stream_handle_v1",["bytes.view","accept_doc"]]],["let","status",-1],["let","headers",["std.net.http.spec.headers_empty_v1"]],["let","body",["bytes.alloc",0]],["let","request_method",["bytes.alloc",0]],["let","req_doc",["std.net.http.server.read_req_v1","stream",["bytes.view","caps"]]],["begin",["let","req_doc_cond",["std.bytes.copy",["bytes.view","req_doc"]]],["if",["=",["std.net.err.is_err_doc_v1",["bytes.view","req_doc_cond"]],1],["set","status",400],["begin",["let","method",["std.net.http.server.req_method_v1",["bytes.view","req_doc"]]],["let","target",["begin",["let","raw_target",["std.net.http.server.req_target_v1",["bytes.view","req_doc"]]],["let","rtv",["bytes.view","raw_target"]],["let","qpos",["std.bytes.find_u8","rtv",63]],["if",["<","qpos",0],"raw_target",["std.bytes.take","rtv","qpos"]]]],["if",["if",["=",["bytes.eq",["bytes.view","method"],["bytes.view","method_get"]],1],["=",["bytes.eq",["bytes.view","target"],["bytes.view","mcp_path"]],1],0],["begin",["set","status",405],["set","headers",["std.net.http.spec.headers_set_v1",["bytes.view","headers"],["bytes.view","hdr_allow"],["bytes.view","value_allow_post"]]],0],0],["if",["if",["<","status",0],["if",["=",["bytes.eq",["bytes.view","method"],["bytes.view","method_get"]],1],["|",["=",["bytes.eq",["bytes.view","target"],["bytes.view","prm_path_primary"]],1],["&",["=","serve_root_alias",1],["=",["bytes.eq",["bytes.view","target"],["bytes.view","path_prm"]],1]]],0],0],["begin",["if",["=",["bytes.eq",["bytes.view","auth_mode"],["bytes.view","auth_oauth2"]],1],["begin",["set","status",200],["set","body",["std.bytes.copy",["bytes.view","prm_json"]]],["set","headers",["std.net.http.spec.headers_set_v1",["bytes.view","headers"],["bytes.view","hdr_content_type"],["bytes.view","value_content_type_json"]]],0],["set","status",404]],0],0],["if",["if",["<","status",0],["if",["=",["bytes.eq",["bytes.view","method"],["bytes.view","method_post"]],1],["=",["bytes.eq",["bytes.view","target"],["bytes.view","mcp_path"]],1],0],0],["begin",["let","origin",["std.net.http.server.req_header_get_v1",["bytes.view","req_doc"],["bytes.view","hdr_origin"]]],["if",["=",["std.mcp.transport.http_rules.origin_allowed_with_allowlist_v1",["bytes.view","origin"],"origin_allow_missing",["bytes.view","origin_allowlist_json"]],0],["begin",["set","status",403],0],0],["if",["<","status",0],["begin",["let","accept",["std.net.http.server.req_header_get_v1",["bytes.view","req_doc"],["bytes.view","hdr_accept"]]],["if",["=",["std.mcp.transport.http_rules.accept_valid_v1",["bytes.view","accept"]],0],["begin",["set","status",400],0],0],0],0],["if",["<","status",0],["begin",["let","ver",["std.net.http.server.req_header_get_v1",["bytes.view","req_doc"],["bytes.view","hdr_mcp_pv"]]],["if",["=",["std.mcp.transport.http_rules.protocol_valid_v1",["bytes.view","ver"]],0],["begin",["set","status",400],0],0],0],0],["let","session_id_len_has",["bytes.len",["bytes.view","session_id"]]],["if",0,["begin",["let","sid",["std.net.http.server.req_header_get_v1",["bytes.view","req_doc"],["bytes.view","hdr_mcp_sid"]]],["if",["<=",["bytes.len","sid"],0],["set","status",400],["if",["=",["bytes.eq","sid",["bytes.view","session_id"]],0],["begin",["set","status",404],0],0]],0],0],["if",["<","status",0],["begin",["let","raw_target",["std.net.http.server.req_target_v1",["bytes.view","req_doc"]]],["let","rtv",["bytes.view","raw_target"]],["let","qpos",["std.bytes.find_u8","rtv",63]],["if",[">=","qpos",0],["begin",["let","query_b",["std.bytes.drop","rtv",["+","qpos",1]]],["let","query",["bytes.view","query_b"]],["let","key",["bytes.lit","access_token"]],["let","klen",["view.len",["bytes.view","key"]]],["let","qlen",["view.len","query"]],["let","found",0],["if",[">=","qlen","klen"],["begin",["let","limit0",["-","qlen","klen"]],["let","limit",["if",["<","limit0",0],0,"limit0"]],["for","i",0,["+","limit",1],["begin",["begin",["if",["=","found",1],0,["begin",["if",["=",["std.bytes.cmp_range","query","i","klen",["bytes.view","key"],0,"klen"],0],["begin",["let","prev_ok",["if",["=","i",0],1,["if",["=",["view.get_u8","query",["-","i",1]],38],1,0]]],["if",["=","prev_ok",1],["begin",["let","next_i",["+","i","klen"]],["let","next_ok",["if",[">=","next_i","qlen"],1,["if",["=",["view.get_u8","query","next_i"],61],1,["if",["=",["view.get_u8","query","next_i"],38],1,0]]]],["if",["=","next_ok",1],["set","found",1],0],0],0],0],0],0]],0],0]],["if",["=","found",1],["begin",["set","status",400],0],0],0],0],0],0],0],0],["let","req_json",["bytes.alloc",0]],["if",["<","status",0],["begin",["let","req_body",["std.net.http.server.req_body_v1",["bytes.view","req_doc"]]],["set","req_json",["ext.json.canon.canonicalize",["bytes.view","req_body"]]],["if",["<=",["bytes.len",["bytes.view","req_json"]],0],["begin",["set","status",400],0],0],0],0],["if",["<","status",0],["begin",["set","request_method",["std.mcp.transport.http._request_method_v1",["bytes.view","req_json"]]],0],0],["if",["if",["<","status",0],["=",["bytes.eq",["bytes.view","auth_mode"],["bytes.view","auth_oauth2"]],1],0],["begin",["let","required_scopes",["bytes.alloc",0]],["if",["=",["bytes.eq",["bytes.view","request_method"],["bytes.view","request_tools_list"]],1],["begin",["set","required_scopes",["std.bytes.copy","auth_required_scopes"]],0],0],["if",["=",["bytes.eq",["bytes.view","request_method"],["bytes.view","request_resources_list"]],1],["begin",["set","required_scopes",["std.bytes.copy","auth_required_scopes"]],0],0],["if",["=",["bytes.eq",["bytes.view","request_method"],["bytes.view","request_resources_read"]],1],["begin",["set","required_scopes",["std.bytes.copy","auth_required_scopes"]],0],0],["if",["=",["bytes.eq",["bytes.view","request_method"],["bytes.view","request_prompts_list"]],1],["begin",["set","required_scopes",["std.bytes.copy","auth_required_scopes"]],0],0],["if",["=",["bytes.eq",["bytes.view","request_method"],["bytes.view","request_prompts_get"]],1],["begin",["set","required_scopes",["std.bytes.copy","auth_required_scopes"]],0],0],["if",["=",["bytes.eq",["bytes.view","request_method"],["bytes.view","request_tools_call"]],1],["begin",["let","tool_name_for_auth",["std.mcp.transport.http._request_tool_name_v1",["bytes.view","req_json"]]],["let","tool_scopes",["std.mcp.transport.http._tool_required_scopes_text_v1",["bytes.view","tools_json"],["bytes.view","tool_name_for_auth"]]],["set","required_scopes",["std.mcp.transport.http._scope_union_text_v1",["bytes.view","auth_required_scopes"],["bytes.view","tool_scopes"]]],0],0],["let","authz",["std.net.http.server.req_header_get_v1",["bytes.view","req_doc"],["bytes.view","hdr_authz"]]],["let","req_headers_json",["bytes.lit","{}"]],["begin",["let","_x07_tmp_copy",["view.to_bytes",["bytes.view","authz"]]],["if",[">",["bytes.len",["bytes.view","_x07_tmp_copy"]],0],["begin",["let","k_authz",["bytes.lit","Authorization"]],["let","v_authz",["ext.data_model.value_string",["bytes.view","authz"]]],["let","entries",["vec_u8.with_capacity",256]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",1]]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",["bytes.len",["bytes.view","k_authz"]]]]],["set","entries",["vec_u8.extend_bytes","entries",["bytes.view","k_authz"]]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",["bytes.len",["bytes.view","v_authz"]]]]],["set","entries",["vec_u8.extend_bytes","entries",["bytes.view","v_authz"]]],["let","entries_b",["vec_u8.into_bytes","entries"]],["let","map_val",["ext.data_model.value_map_from_entries",["bytes.view","entries_b"]]],["set","req_headers_json",["std.mcp.util.json.json_from_value_v1",["bytes.view","map_val"]]],0],0]],["let","auth_pack",["std.mcp.auth.rs_v1.oauth2_authenticate_http_v1",["bytes.view","rs_pack"],["bytes.view","req_headers_json"],["bytes.view","required_scopes"]]],["let","auth_pack_probe",["view.to_bytes",["bytes.view","auth_pack"]]],["if",["=",["bytes.len",["bytes.view","auth_pack_probe"]],0],["begin",["set","status",500],0],0],["if",["<","status",0],["begin",["let","adoc_b",["ext.json.data_model.parse",["bytes.view","auth_pack"]]],["let","adoc",["bytes.view","adoc_b"]],["if",["=",["ext.data_model.doc_is_err","adoc"],1],["begin",["set","status",500],0],0],["if",["if",["<","status",0],["!=",["ext.data_model.root_kind","adoc"],5],0],["begin",["set","status",500],0],0],["if",["<","status",0],["begin",["let","aroot",["ext.data_model.root_offset","adoc"]],["let","k_ok",["bytes.lit","ok"]],["let","ok",["std.mcp.transport.http._map_bool_or_default_v1","adoc","aroot",["bytes.view","k_ok"],0]],["if",["=","ok",0],["begin",["let","k_err_status",["bytes.lit","err_status"]],["let","k_err_www",["bytes.lit","err_www_authenticate"]],["let","err_status",["std.mcp.transport.http._map_i32_or_default_v1","adoc","aroot",["bytes.view","k_err_status"],401]],["let","www",["std.mcp.transport.http._map_string_or_empty_v1","adoc","aroot",["bytes.view","k_err_www"]]],["set","status","err_status"],["begin",["let","_x07_tmp_copy",["view.to_bytes",["bytes.view","www"]]],["if",[">",["bytes.len",["bytes.view","_x07_tmp_copy"]],0],["begin",["set","headers",["std.net.http.spec.headers_set_v1",["bytes.view","headers"],["bytes.view","hdr_www_auth"],["bytes.view","www"]]],0],0]],0],["begin",["let","k_ctx",["bytes.lit","ctx"]],["let","ctx_json",["std.mcp.transport.http._map_value_json_or_empty_v1","adoc","aroot",["bytes.view","k_ctx"]]],["begin",["let","_x07_tmp_copy",["view.to_bytes",["bytes.view","required_scopes"]]],["if",["=",["std.mcp.auth.rs_v1.oauth2_authorize_scopes_v1",["bytes.view","ctx_json"],["bytes.view","_x07_tmp_copy"]],0],["begin",["set","status",403],["let","challenge_403",["std.mcp.auth.bearer_v1.build_www_authenticate_bearer_v1",["bytes.view","resource_md_url"],["bytes.view","required_scopes"],3]],["set","headers",["std.net.http.spec.headers_set_v1",["bytes.view","headers"],["bytes.view","hdr_www_auth"],["bytes.view","challenge_403"]]],0],0]],0]],0],0],0],0],0],0],["if",["<","status",0],["begin",["let","dispatch",["std.mcp.toolkit.stdio_dispatch.dispatch_line_v1",["if",["=",["bytes.eq",["bytes.view","request_method"],["bytes.view","request_initialize"]],1],0,"mcp_state"],["bytes.view","cfg_pv"],["bytes.view","server_name"],["bytes.view","server_version"],["bytes.view","tools_json"],["bytes.view","resources_json"],["bytes.view","prompts_json"],["bytes.view","req_json"]]],["if",["!=",["result_bytes.err_code","dispatch"],0],["set","status",500],["begin",["let","step",["result_bytes.unwrap_or","dispatch",["bytes.alloc",0]]],["let","kind",["std.mcp.toolkit.stdio_dispatch.step_kind_v1",["bytes.view","step"]]],["let","next_state",["std.mcp.toolkit.stdio_dispatch.step_next_state_v1",["bytes.view","step"]]],["if",["=","kind",0],["begin",["set","status",202],["set","mcp_state","next_state"],0],0],["if",["=","kind",1],["begin",["set","status",200],["set","body",["std.mcp.toolkit.stdio_dispatch.step_resp_json_v1",["bytes.view","step"]]],["set","headers",["std.net.http.spec.headers_set_v1",["bytes.view","headers"],["bytes.view","hdr_content_type"],["bytes.view","value_content_type_json"]]],["let","session_id_len_init",["bytes.len",["bytes.view","session_id"]]],["if",["if",["=","session_required",1],["=",["bytes.eq",["bytes.view","request_method"],["bytes.view","request_initialize"]],1],0],["begin",["set","session_id",["std.mcp.transport.http_session.next_test_session_id_v1","session_idx"]],["set","session_idx",["+","session_idx",1]],["set","headers",["std.net.http.spec.headers_set_v1",["bytes.view","headers"],["bytes.view","hdr_mcp_sid"],["bytes.view","session_id"]]],0],0],["set","mcp_state","next_state"],0],0],["if",["=","kind",2],["begin",["let","id_json",["std.mcp.toolkit.stdio_dispatch.step_tool_call_id_json_v1",["bytes.view","step"]]],["let","tool_name",["std.mcp.toolkit.stdio_dispatch.step_tool_call_tool_name_v1",["bytes.view","step"]]],["let","args_json",["std.mcp.toolkit.stdio_dispatch.step_tool_call_args_json_v1",["bytes.view","step"]]],["let","progress_token_json",["std.mcp.toolkit.stdio_dispatch.step_tool_call_progress_token_v1",["bytes.view","step"]]],["let","request_ctx_json",["std.mcp.ctx.with_meta_v1","cfg_json","id_json","progress_token_json",["bytes.view","session_id"]]],["let","use_sse",["&",["=",["std.mcp.transport.http_rules.accept_sse_v1",["begin",["let","accept_hdr_sse",["std.net.http.server.req_header_get_v1",["bytes.view","req_doc"],["bytes.view","hdr_accept"]]],["bytes.view","accept_hdr_sse"]]],1],[">",["bytes.len",["bytes.view","progress_token_json"]],0]]],["if",["=","use_sse",1],["begin",["let","stream_key",["std.mcp.sse.stream_key_from_id_json_v1",["bytes.view","id_json"]]],["let","event_chan",["chan.bytes.new",128]],["let","cancel_chan",["chan.bytes.new",1]],["let","sse_task",["std.mcp.transport.http._tool_sse_task_v1","stream",["bytes.view","caps"],["std.bytes.copy","session_id"],["bytes.view","stream_key"],["bytes.view","id_json"],"progress_token_json",["bytes.view","tool_name"],["bytes.view","cfg_json"],["bytes.view","request_ctx_json"],["bytes.view","args_json"],["bytes.view","tools_json"],"cancel_chan","event_chan"]],["let","_sse_done",["await","sse_task"]],["set","status",777],["set","mcp_state","next_state"],0],["begin",["let","tool_res",["std.mcp.sandbox.router_exec.call_tool_oneshot_v1",["bytes.view","tool_name"],["bytes.view","request_ctx_json"],["bytes.view","args_json"],["bytes.view","tools_json"]]],["let","tr",["if",["!=",["result_bytes.err_code","tool_res"],0],["std.mcp.transport.http._tool_internal_error_result_v1",["bytes.view","tool_name"],["result_bytes.err_code","tool_res"],["bytes.lit","tool invocation failed"]],["result_bytes.unwrap_or","tool_res",["bytes.alloc",0]]]],["set","status",200],["set","body",["std.mcp.jsonrpc.make_result_response_v1",["bytes.view","id_json"],["bytes.view","tr"]]],["set","headers",["std.net.http.spec.headers_set_v1",["bytes.view","headers"],["bytes.view","hdr_content_type"],["bytes.view","value_content_type_json"]]],["set","mcp_state","next_state"],0]]],0],["if",["=","kind",3],["begin",["let","id_json",["std.mcp.toolkit.stdio_dispatch.step_subscribe_id_json_v1",["bytes.view","step"]]],["let","uri",["std.mcp.toolkit.stdio_dispatch.step_subscribe_uri_v1",["bytes.view","step"]]],["set","subs",["std.mcp.transport.http._subs_add_v1",["bytes.view","subs"],"uri"]],["set","status",200],["set","body",["std.mcp.jsonrpc.make_result_response_v1","id_json",["begin",["let","_x07_empty_obj",["bytes.lit","{}"]],["bytes.view","_x07_empty_obj"]]]],["set","headers",["std.net.http.spec.headers_set_v1",["bytes.view","headers"],["bytes.view","hdr_content_type"],["bytes.view","value_content_type_json"]]],["set","mcp_state","next_state"],0],0],["if",["=","kind",4],["begin",["let","id_json",["std.mcp.toolkit.stdio_dispatch.step_unsubscribe_id_json_v1",["bytes.view","step"]]],["let","uri",["std.mcp.toolkit.stdio_dispatch.step_unsubscribe_uri_v1",["bytes.view","step"]]],["set","subs",["std.mcp.transport.http._subs_remove_v1",["bytes.view","subs"],"uri"]],["set","status",200],["set","body",["std.mcp.jsonrpc.make_result_response_v1","id_json",["begin",["let","_x07_empty_obj",["bytes.lit","{}"]],["bytes.view","_x07_empty_obj"]]]],["set","headers",["std.net.http.spec.headers_set_v1",["bytes.view","headers"],["bytes.view","hdr_content_type"],["bytes.view","value_content_type_json"]]],["set","mcp_state","next_state"],0],0],["if",["<","status",0],["begin",["set","status",500],0],0],0]],0],0],0],0],0]]],["if",["<","status",0],["begin",["set","status",404],0],0],["if",["=","status",777],0,["begin",["let","_write",["std.net.http.server.write_response_v1","stream","status",["bytes.view","headers"],["bytes.view","body"],["bytes.view","caps"]]],["let","_close_stream",["std.net.tcp.stream_close_v1","stream"]],0]],0,0]],["bytes.alloc",0]],"kind":"defasync","name":"std.mcp.transport.http.serve_from_fs_v1","params":[{"name":"cfg_path","ty":"bytes_view"}],"result":"bytes"}],"imports":["ext.data_model","ext.json.canon","ext.json.data_model","std.bytes","std.fmt","std.fs","std.mcp.auth.bearer_v1","std.mcp.auth.rs_v1","std.mcp.ctx","std.mcp.diag","std.mcp.jsonrpc","std.mcp.notifications","std.mcp.protocol","std.mcp.sandbox.router_exec","std.mcp.sse","std.mcp.tool.result","std.mcp.toolkit.prompts_file","std.mcp.toolkit.resources_file","std.mcp.toolkit.stdio_dispatch","std.mcp.toolkit.tools_file","std.mcp.transport.http_rules","std.mcp.transport.http_session","std.mcp.util.json","std.net.codec","std.net.err","std.net.http.server","std.net.http.spec","std.net.io","std.net.tcp","std.os.fs","std.os.fs.spec","std.parse"],"kind":"module","module_id":"std.mcp.transport.http","schema_version":"x07.x07ast@0.5.0"}
