{"decls":[{"kind":"export","names":["std.mcp.transport.http.serve_from_fs_v1"]},{"body":["begin",["if",["<","map_off",0],["return","fallback"],0],["let","off",["ext.data_model.map_find","doc","map_off","key"]],["if",["<","off",0],["return","fallback"],0],["if",["!=",["ext.data_model.kind_at","doc","off"],1],["return","fallback"],0],["ext.data_model.bool_get","doc","off"]],"kind":"defn","name":"std.mcp.transport.http._map_bool_or_default_v1","params":[{"name":"doc","ty":"bytes_view"},{"name":"map_off","ty":"i32"},{"name":"key","ty":"bytes_view"},{"name":"fallback","ty":"i32"}],"result":"i32"},{"body":["begin",["if",["<","map_off",0],["return","fallback"],0],["let","off",["ext.data_model.map_find","doc","map_off","key"]],["if",["<","off",0],["return","fallback"],0],["if",["!=",["ext.data_model.kind_at","doc","off"],2],["return","fallback"],0],["let","num_b",["ext.data_model.number_get","doc","off"]],["std.mcp.transport.http._parse_i32_or_default_v1",["bytes.view","num_b"],"fallback"]],"kind":"defn","name":"std.mcp.transport.http._map_i32_or_default_v1","params":[{"name":"doc","ty":"bytes_view"},{"name":"map_off","ty":"i32"},{"name":"key","ty":"bytes_view"},{"name":"fallback","ty":"i32"}],"result":"i32"},{"body":["begin",["if",["<","map_off",0],["return",["bytes.alloc",0]],0],["let","off",["ext.data_model.map_find","doc","map_off","key"]],["if",["<","off",0],["return",["bytes.alloc",0]],0],["if",["!=",["ext.data_model.kind_at","doc","off"],3],["return",["bytes.alloc",0]],0],["ext.data_model.string_get","doc","off"]],"kind":"defn","name":"std.mcp.transport.http._map_string_or_empty_v1","params":[{"name":"doc","ty":"bytes_view"},{"name":"map_off","ty":"i32"},{"name":"key","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["if",["<","map_off",0],["return",["bytes.alloc",0]],0],["let","off",["ext.data_model.map_find","doc","map_off","key"]],["if",["<","off",0],["return",["bytes.alloc",0]],0],["let","end",["ext.data_model.skip_value","doc","off"]],["if",["<","end",0],["return",["bytes.alloc",0]],0],["let","val",["view.to_bytes",["view.slice","doc","off",["-","end","off"]]]],["std.mcp.util.json.json_from_value_v1",["bytes.view","val"]]],"kind":"defn","name":"std.mcp.transport.http._map_value_json_or_empty_v1","params":[{"name":"doc","ty":"bytes_view"},{"name":"map_off","ty":"i32"},{"name":"key","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","st",["std.parse.i32_status_le","b"]],["if",["if",[">=u",["bytes.len","st"],5],["=",["bytes.get_u8","st",0],1],0],["codec.read_u32_le","st",1],"fallback"]],"kind":"defn","name":"std.mcp.transport.http._parse_i32_or_default_v1","params":[{"name":"b","ty":"bytes_view"},{"name":"fallback","ty":"i32"}],"result":"i32"},{"body":["begin",["let","k_method",["bytes.lit","method"]],["let","doc_b",["ext.json.data_model.parse","req_json"]],["let","doc",["bytes.view","doc_b"]],["if",["=",["ext.data_model.doc_is_err","doc"],1],["return",["bytes.alloc",0]],0],["if",["!=",["ext.data_model.root_kind","doc"],5],["return",["bytes.alloc",0]],0],["let","root",["ext.data_model.root_offset","doc"]],["std.mcp.transport.http._map_string_or_empty_v1","doc","root",["bytes.view","k_method"]]],"kind":"defn","name":"std.mcp.transport.http._request_method_v1","params":[{"name":"req_json","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","k_params",["bytes.lit","params"]],["let","k_name",["bytes.lit","name"]],["let","doc_b",["ext.json.data_model.parse","req_json"]],["let","doc",["bytes.view","doc_b"]],["if",["=",["ext.data_model.doc_is_err","doc"],1],["return",["bytes.alloc",0]],0],["if",["!=",["ext.data_model.root_kind","doc"],5],["return",["bytes.alloc",0]],0],["let","root",["ext.data_model.root_offset","doc"]],["let","params_off",["ext.data_model.map_find","doc","root",["bytes.view","k_params"]]],["if",["<","params_off",0],["return",["bytes.alloc",0]],0],["std.mcp.transport.http._map_string_or_empty_v1","doc","params_off",["bytes.view","k_name"]]],"kind":"defn","name":"std.mcp.transport.http._request_tool_name_v1","params":[{"name":"req_json","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","http",["bytes.lit","http://"]],["let","colon",["bytes.lit",":"]],["let","port_dec",["std.fmt.u32_to_dec","bind_port"]],["let","fallback",["std.bytes.concat",["bytes.view","http"],["std.bytes.concat","bind_host",["std.bytes.concat",["bytes.view","colon"],["bytes.view","port_dec"]]]]],["let","doc_b",["ext.json.data_model.parse","oauth_json"]],["let","doc",["bytes.view","doc_b"]],["if",["=",["ext.data_model.doc_is_err","doc"],1],["return","fallback"],0],["if",["!=",["ext.data_model.root_kind","doc"],5],["return","fallback"],0],["let","k_resource",["bytes.lit","resource"]],["let","root",["ext.data_model.root_offset","doc"]],["let","resource",["std.mcp.transport.http._map_string_or_empty_v1","doc","root",["bytes.view","k_resource"]]],["if",[">",["bytes.len",["bytes.view","resource"]],0],"resource","fallback"]],"kind":"defn","name":"std.mcp.transport.http._resource_from_oauth_or_default_v1","params":[{"name":"oauth_json","ty":"bytes_view"},{"name":"bind_host","ty":"bytes_view"},{"name":"bind_port","ty":"i32"}],"result":"bytes"},{"body":["begin",["if",["<","seq_off",0],["return",["bytes.alloc",0]],0],["if",["!=",["ext.data_model.kind_at","doc","seq_off"],4],["return",["bytes.alloc",0]],0],["let","n",["ext.data_model.seq_len","doc","seq_off"]],["if",["<","n",0],["return",["bytes.alloc",0]],0],["let","out",["vec_u8.with_capacity",64]],["for","i",0,"n",["begin",["let","off",["ext.data_model.seq_get","doc","seq_off","i"]],["if",["<","off",0],["return",["bytes.alloc",0]],0],["if",["!=",["ext.data_model.kind_at","doc","off"],3],["return",["bytes.alloc",0]],0],["if",[">","i",0],["set","out",["vec_u8.push","out",32]],0],["let","part",["ext.data_model.string_get","doc","off"]],["set","out",["vec_u8.extend_bytes","out",["bytes.view","part"]]],0]],["vec_u8.into_bytes","out"]],"kind":"defn","name":"std.mcp.transport.http._scope_text_from_seq_v1","params":[{"name":"doc","ty":"bytes_view"},{"name":"seq_off","ty":"i32"}],"result":"bytes"},{"body":["begin",["if",["<=",["view.len","base_scopes"],0],["return",["view.to_bytes","extra_scopes"]],0],["if",["<=",["view.len","extra_scopes"],0],["return",["view.to_bytes","base_scopes"]],0],["let","sp",["bytes.lit"," "]],["std.bytes.concat","base_scopes",["std.bytes.concat",["bytes.view","sp"],"extra_scopes"]]],"kind":"defn","name":"std.mcp.transport.http._scope_union_text_v1","params":[{"name":"base_scopes","ty":"bytes_view"},{"name":"extra_scopes","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","diag",["std.mcp.diag.code_internal_v1"]],["let","detail",["bytes.lit","{}"]],["std.mcp.tool.result.err_v1",["bytes.view","diag"],["bytes.view","message_utf8"],["bytes.view","detail"]]],"kind":"defn","name":"std.mcp.transport.http._tool_internal_error_result_v1","params":[{"name":"tool_name","ty":"bytes_view"},{"name":"err_code","ty":"i32"},{"name":"message_utf8","ty":"bytes"}],"result":"bytes"},{"body":["begin",["let","k_tools",["bytes.lit","tools"]],["let","k_name",["bytes.lit","name"]],["let","k_auth",["bytes.lit","auth"]],["let","k_required_scopes",["bytes.lit","required_scopes"]],["let","doc_b",["ext.json.data_model.parse","tools_json"]],["let","doc",["bytes.view","doc_b"]],["if",["=",["ext.data_model.doc_is_err","doc"],1],["return",["bytes.alloc",0]],0],["if",["!=",["ext.data_model.root_kind","doc"],5],["return",["bytes.alloc",0]],0],["let","root",["ext.data_model.root_offset","doc"]],["let","tools_off",["ext.data_model.map_find","doc","root",["bytes.view","k_tools"]]],["if",["<","tools_off",0],["return",["bytes.alloc",0]],0],["if",["!=",["ext.data_model.kind_at","doc","tools_off"],4],["return",["bytes.alloc",0]],0],["let","n",["ext.data_model.seq_len","doc","tools_off"]],["if",["<","n",0],["return",["bytes.alloc",0]],0],["for","i",0,"n",["begin",["let","tool_off",["ext.data_model.seq_get","doc","tools_off","i"]],["if",["<","tool_off",0],0,["begin",["let","name",["std.mcp.transport.http._map_string_or_empty_v1","doc","tool_off",["bytes.view","k_name"]]],["if",["=",["view.eq",["bytes.view","name"],"tool_name"],1],["begin",["let","auth_off",["ext.data_model.map_find","doc","tool_off",["bytes.view","k_auth"]]],["if",["<","auth_off",0],["return",["bytes.alloc",0]],0],["if",["!=",["ext.data_model.kind_at","doc","auth_off"],5],["return",["bytes.alloc",0]],0],["let","seq_off",["ext.data_model.map_find","doc","auth_off",["bytes.view","k_required_scopes"]]],["return",["std.mcp.transport.http._scope_text_from_seq_v1","doc","seq_off"]],0],0],0]],0]],["bytes.alloc",0]],"kind":"defn","name":"std.mcp.transport.http._tool_required_scopes_text_v1","params":[{"name":"tools_json","ty":"bytes_view"},{"name":"tool_name","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","k_auth",["bytes.lit","auth"]],["let","k_bind_host",["bytes.lit","bind_host"]],["let","k_bind_port",["bytes.lit","bind_port"]],["let","k_kind",["bytes.lit","kind"]],["let","k_mcp_path",["bytes.lit","mcp_path"]],["let","k_mode",["bytes.lit","mode"]],["let","k_oauth_cfg_path",["bytes.lit","oauth_config_path"]],["let","k_origin_allow_missing",["bytes.lit","origin_allow_missing"]],["let","k_origin_allowlist",["bytes.lit","origin_allowlist"]],["let","k_required_scopes",["bytes.lit","required_scopes"]],["let","k_schema",["bytes.lit","schema_version"]],["let","k_server",["bytes.lit","server"]],["let","k_name",["bytes.lit","name"]],["let","k_protocol_version",["bytes.lit","protocolVersion"]],["let","k_session_mode",["bytes.lit","session_mode"]],["let","k_tools_manifest_path",["bytes.lit","tools_manifest_path"]],["let","k_transport",["bytes.lit","transport"]],["let","k_version",["bytes.lit","version"]],["let","schema_want",["bytes.lit","x07.mcp.server_config@0.2.0"]],["let","kind_http",["bytes.lit","http"]],["let","auth_none",["bytes.lit","none"]],["let","auth_oauth2",["bytes.lit","oauth2"]],["let","session_required_text",["bytes.lit","required"]],["let","path_default_mcp",["bytes.lit","/mcp"]],["let","path_prm",["bytes.lit","/.well-known/oauth-protected-resource"]],["let","suffix_prm",["bytes.lit","/.well-known/oauth-protected-resource"]],["let","hdr_accept",["bytes.lit","Accept"]],["let","hdr_allow",["bytes.lit","Allow"]],["let","hdr_authz",["bytes.lit","Authorization"]],["let","hdr_content_type",["bytes.lit","Content-Type"]],["let","hdr_mcp_pv",["bytes.lit","MCP-Protocol-Version"]],["let","hdr_mcp_sid",["bytes.lit","MCP-Session-Id"]],["let","hdr_origin",["bytes.lit","Origin"]],["let","hdr_www_auth",["bytes.lit","WWW-Authenticate"]],["let","method_get",["bytes.lit","GET"]],["let","method_post",["bytes.lit","POST"]],["let","request_initialize",["bytes.lit","initialize"]],["let","request_tools_call",["bytes.lit","tools/call"]],["let","request_tools_list",["bytes.lit","tools/list"]],["let","request_resources_list",["bytes.lit","resources/list"]],["let","request_resources_read",["bytes.lit","resources/read"]],["let","request_prompts_list",["bytes.lit","prompts/list"]],["let","request_prompts_get",["bytes.lit","prompts/get"]],["let","value_allow_post",["bytes.lit","POST"]],["let","value_content_type_json",["bytes.lit","application/json"]],["let","default_allowlist_json",["bytes.lit","[\"http://localhost:*\",\"http://127.0.0.1:*\",\"https://mcp.example.com\"]"]],["let","cfg_json",["std.fs.read","cfg_path"]],["let","cfg_doc_b",["ext.json.data_model.parse",["bytes.view","cfg_json"]]],["let","cfg_doc",["bytes.view","cfg_doc_b"]],["if",["=",["ext.data_model.doc_is_err","cfg_doc"],1],["return",2],0],["if",["!=",["ext.data_model.root_kind","cfg_doc"],5],["return",2],0],["let","cfg_root",["ext.data_model.root_offset","cfg_doc"]],["let","schema_ver",["std.mcp.transport.http._map_string_or_empty_v1","cfg_doc","cfg_root",["bytes.view","k_schema"]]],["if",["=",["view.eq",["bytes.view","schema_ver"],["bytes.view","schema_want"]],0],["return",2],0],["let","transport_off",["ext.data_model.map_find","cfg_doc","cfg_root",["bytes.view","k_transport"]]],["if",["<","transport_off",0],["return",2],0],["let","transport_kind",["std.mcp.transport.http._map_string_or_empty_v1","cfg_doc","transport_off",["bytes.view","k_kind"]]],["if",["=",["view.eq",["bytes.view","transport_kind"],["bytes.view","kind_http"]],0],["return",2],0],["let","server_off",["ext.data_model.map_find","cfg_doc","cfg_root",["bytes.view","k_server"]]],["if",["<","server_off",0],["return",2],0],["let","server_name",["std.mcp.transport.http._map_string_or_empty_v1","cfg_doc","server_off",["bytes.view","k_name"]]],["let","server_version",["std.mcp.transport.http._map_string_or_empty_v1","cfg_doc","server_off",["bytes.view","k_version"]]],["let","cfg_pv",["std.mcp.transport.http._map_string_or_empty_v1","cfg_doc","server_off",["bytes.view","k_protocol_version"]]],["let","supported_pv",["std.mcp.protocol.mcp_protocol_version_v1"]],["if",["=",["view.eq",["bytes.view","cfg_pv"],["bytes.view","supported_pv"]],0],["return",2],0],["let","tools_path",["std.mcp.transport.http._map_string_or_empty_v1","cfg_doc","cfg_root",["bytes.view","k_tools_manifest_path"]]],["if",["<=",["bytes.len",["bytes.view","tools_path"]],0],["return",2],0],["let","tools_res",["std.mcp.toolkit.tools_file.load_tools_from_fs_v1",["bytes.view","tools_path"]]],["if",["!=",["result_bytes.err_code","tools_res"],0],["return",2],0],["let","tools_json",["result_bytes.unwrap_or","tools_res",["bytes.alloc",0]]],["let","fs_caps",["std.os.fs.spec.caps_default_v1"]],["let","resources_json",["bytes.alloc",0]],["let","resources_read",["std.os.fs.read_all_v1",["bytes.lit","config/mcp.resources.json"],["std.bytes.copy","fs_caps"]]],["let","resources_read_code",["result_bytes.err_code","resources_read"]],["if",["=","resources_read_code",0],["begin",["let","resources_raw",["result_bytes.unwrap_or","resources_read",["bytes.alloc",0]]],["let","resources_res",["std.mcp.toolkit.resources_file.load_resources_from_json_v1",["bytes.view","resources_raw"]]],["if",["!=",["result_bytes.err_code","resources_res"],0],["return",2],0],["set","resources_json",["result_bytes.unwrap_or","resources_res",["bytes.alloc",0]]],0],0],["if",["if",["!=","resources_read_code",0],["!=","resources_read_code",["std.os.fs.spec.err_not_found_v1"]],0],["return",2],0],["let","prompts_json",["bytes.alloc",0]],["let","prompts_read",["std.os.fs.read_all_v1",["bytes.lit","config/mcp.prompts.json"],["std.bytes.copy","fs_caps"]]],["let","prompts_read_code",["result_bytes.err_code","prompts_read"]],["if",["=","prompts_read_code",0],["begin",["let","prompts_raw",["result_bytes.unwrap_or","prompts_read",["bytes.alloc",0]]],["let","prompts_res",["std.mcp.toolkit.prompts_file.load_prompts_from_json_v1",["bytes.view","prompts_raw"]]],["if",["!=",["result_bytes.err_code","prompts_res"],0],["return",2],0],["set","prompts_json",["result_bytes.unwrap_or","prompts_res",["bytes.alloc",0]]],0],0],["if",["if",["!=","prompts_read_code",0],["!=","prompts_read_code",["std.os.fs.spec.err_not_found_v1"]],0],["return",2],0],["let","bind_host",["std.mcp.transport.http._map_string_or_empty_v1","cfg_doc","transport_off",["bytes.view","k_bind_host"]]],["let","bind_host_len",["bytes.len",["bytes.view","bind_host"]]],["if",["<=","bind_host_len",0],["set","bind_host",["bytes.lit","127.0.0.1"]],0],["let","bind_port",["std.mcp.transport.http._map_i32_or_default_v1","cfg_doc","transport_off",["bytes.view","k_bind_port"],8314]],["let","mcp_path",["std.mcp.transport.http._map_string_or_empty_v1","cfg_doc","transport_off",["bytes.view","k_mcp_path"]]],["let","mcp_path_len",["bytes.len",["bytes.view","mcp_path"]]],["if",["<=","mcp_path_len",0],["set","mcp_path","path_default_mcp"],0],["let","origin_allow_missing",["std.mcp.transport.http._map_bool_or_default_v1","cfg_doc","transport_off",["bytes.view","k_origin_allow_missing"],1]],["let","origin_allowlist_json",["std.mcp.transport.http._map_value_json_or_empty_v1","cfg_doc","transport_off",["bytes.view","k_origin_allowlist"]]],["let","origin_allowlist_json_len",["bytes.len",["bytes.view","origin_allowlist_json"]]],["if",["<=","origin_allowlist_json_len",0],["set","origin_allowlist_json","default_allowlist_json"],0],["let","session_mode",["std.mcp.transport.http._map_string_or_empty_v1","cfg_doc","transport_off",["bytes.view","k_session_mode"]]],["let","session_mode_len",["bytes.len",["bytes.view","session_mode"]]],["if",["<=","session_mode_len",0],["set","session_mode",["std.bytes.copy",["bytes.view","session_required_text"]]],0],["let","session_required",["if",["=",["view.eq",["bytes.view","session_mode"],["bytes.view","session_required_text"]],1],1,0]],["let","auth_off",["ext.data_model.map_find","cfg_doc","cfg_root",["bytes.view","k_auth"]]],["let","auth_mode",["std.mcp.transport.http._map_string_or_empty_v1","cfg_doc","auth_off",["bytes.view","k_mode"]]],["let","auth_mode_len",["bytes.len",["bytes.view","auth_mode"]]],["if",["<=","auth_mode_len",0],["set","auth_mode","auth_none"],0],["let","auth_required_scopes",["std.mcp.transport.http._scope_text_from_seq_v1","cfg_doc",["ext.data_model.map_find","cfg_doc","auth_off",["bytes.view","k_required_scopes"]]]],["let","oauth_cfg_path",["std.mcp.transport.http._map_string_or_empty_v1","cfg_doc","auth_off",["bytes.view","k_oauth_cfg_path"]]],["let","oauth_cfg_path_len",["bytes.len",["bytes.view","oauth_cfg_path"]]],["if",["<=","oauth_cfg_path_len",0],["set","oauth_cfg_path",["bytes.lit","config/mcp.oauth.json"]],0],["let","oauth_json",["bytes.alloc",0]],["if",["=",["view.eq",["bytes.view","auth_mode"],["bytes.view","auth_oauth2"]],1],["set","oauth_json",["std.fs.read",["bytes.view","oauth_cfg_path"]]],0],["let","resource_base",["std.mcp.transport.http._resource_from_oauth_or_default_v1",["bytes.view","oauth_json"],["bytes.view","bind_host"],"bind_port"]],["let","resource_md_url",["std.bytes.concat",["bytes.view","resource_base"],["bytes.view","suffix_prm"]]],["let","bind_addr",["std.bytes.concat",["bytes.view","bind_host"],["std.bytes.concat",["bytes.lit",":"],["std.fmt.u32_to_dec","bind_port"]]]],["let","caps",["std.net.http.spec.caps_default_v1"]],["let","listen_doc",["std.net.tcp.listen_v1",["bytes.view","bind_addr"],["bytes.view","caps"]]],["if",["=",["std.net.err.is_err_doc_v1",["bytes.view","listen_doc"]],1],["return",2],0],["let","listener",["std.net.tcp.listen_listener_handle_v1",["bytes.view","listen_doc"]]],["let","mcp_state",0],["let","session_id",["bytes.alloc",0]],["let","session_idx",1],["for","_",0,2147483647,["begin",["let","accept_doc",["std.net.tcp.accept_v1","listener",["bytes.view","caps"]]],["if",["=",["std.net.err.is_err_doc_v1",["bytes.view","accept_doc"]],1],["return",2],0],["let","stream",["std.net.tcp.accept_stream_handle_v1",["bytes.view","accept_doc"]]],["let","status",-1],["let","headers",["std.net.http.spec.headers_empty_v1"]],["let","body",["bytes.alloc",0]],["let","request_method",["bytes.alloc",0]],["let","req_doc",["std.net.http.server.read_req_v1","stream",["bytes.view","caps"]]],["begin",["let","req_doc_cond",["std.bytes.copy",["bytes.view","req_doc"]]],["if",["=",["std.net.err.is_err_doc_v1",["bytes.view","req_doc_cond"]],1],["set","status",400],["begin",["let","method",["std.net.http.server.req_method_v1",["bytes.view","req_doc"]]],["let","target",["std.net.http.server.req_target_v1",["bytes.view","req_doc"]]],["if",["if",["=",["view.eq",["bytes.view","method"],["bytes.view","method_get"]],1],["=",["view.eq",["bytes.view","target"],["bytes.view","mcp_path"]],1],0],["begin",["set","status",405],["set","headers",["std.net.http.spec.headers_set_v1",["bytes.view","headers"],["bytes.view","hdr_allow"],["bytes.view","value_allow_post"]]],0],0],["if",["if",["<","status",0],["if",["=",["view.eq",["bytes.view","method"],["bytes.view","method_get"]],1],["=",["view.eq",["bytes.view","target"],["bytes.view","path_prm"]],1],0],0],["begin",["if",["=",["view.eq",["bytes.view","auth_mode"],["bytes.view","auth_oauth2"]],1],["begin",["set","status",200],["set","body",["std.mcp.auth.prm.build_doc_v1",["bytes.view","oauth_json"],["bytes.view","resource_base"]]],["set","headers",["std.net.http.spec.headers_set_v1",["bytes.view","headers"],["bytes.view","hdr_content_type"],["bytes.view","value_content_type_json"]]],0],["set","status",404]],0],0],["if",["if",["<","status",0],["if",["=",["view.eq",["bytes.view","method"],["bytes.view","method_post"]],1],["=",["view.eq",["bytes.view","target"],["bytes.view","mcp_path"]],1],0],0],["begin",["let","origin",["std.net.http.server.req_header_get_v1",["bytes.view","req_doc"],["bytes.view","hdr_origin"]]],["if",["=",["std.mcp.transport.http_rules.origin_allowed_with_allowlist_v1",["bytes.view","origin"],"origin_allow_missing",["bytes.view","origin_allowlist_json"]],0],["set","status",403],0],["if",["<","status",0],["begin",["let","accept",["std.net.http.server.req_header_get_v1",["bytes.view","req_doc"],["bytes.view","hdr_accept"]]],["if",["=",["std.mcp.transport.http_rules.accept_valid_v1",["bytes.view","accept"]],0],["set","status",400],0],0],0],["if",["<","status",0],["begin",["let","ver",["std.net.http.server.req_header_get_v1",["bytes.view","req_doc"],["bytes.view","hdr_mcp_pv"]]],["if",["=",["std.mcp.transport.http_rules.protocol_valid_v1",["bytes.view","ver"]],0],["set","status",400],0],0],0],["let","session_id_len_has",["bytes.len",["bytes.view","session_id"]]],["if",["if",["<","status",0],["if",["=","session_required",1],[">","session_id_len_has",0],0],0],["begin",["let","sid",["std.net.http.server.req_header_get_v1",["bytes.view","req_doc"],["bytes.view","hdr_mcp_sid"]]],["if",["<=",["bytes.len","sid"],0],["set","status",400],["if",["=",["view.eq",["bytes.view","sid"],["bytes.view","session_id"]],0],["set","status",404],0]],0],0],["let","req_json",["bytes.alloc",0]],["if",["<","status",0],["begin",["let","req_body",["std.net.http.server.req_body_v1",["bytes.view","req_doc"]]],["set","req_json",["ext.json.canon.canonicalize",["bytes.view","req_body"]]],["if",["<=",["bytes.len",["bytes.view","req_json"]],0],["set","status",400],0],0],0],["if",["<","status",0],["set","request_method",["std.mcp.transport.http._request_method_v1",["bytes.view","req_json"]]],0],["if",["if",["<","status",0],["=",["view.eq",["bytes.view","auth_mode"],["bytes.view","auth_oauth2"]],1],0],["begin",["let","required_scopes",["bytes.alloc",0]],["if",["=",["view.eq",["bytes.view","request_method"],["bytes.view","request_tools_list"]],1],["set","required_scopes",["std.bytes.copy","auth_required_scopes"]],0],["if",["=",["view.eq",["bytes.view","request_method"],["bytes.view","request_resources_list"]],1],["set","required_scopes",["std.bytes.copy","auth_required_scopes"]],0],["if",["=",["view.eq",["bytes.view","request_method"],["bytes.view","request_resources_read"]],1],["set","required_scopes",["std.bytes.copy","auth_required_scopes"]],0],["if",["=",["view.eq",["bytes.view","request_method"],["bytes.view","request_prompts_list"]],1],["set","required_scopes",["std.bytes.copy","auth_required_scopes"]],0],["if",["=",["view.eq",["bytes.view","request_method"],["bytes.view","request_prompts_get"]],1],["set","required_scopes",["std.bytes.copy","auth_required_scopes"]],0],["if",["=",["view.eq",["bytes.view","request_method"],["bytes.view","request_tools_call"]],1],["begin",["let","tool_name_for_auth",["std.mcp.transport.http._request_tool_name_v1",["bytes.view","req_json"]]],["let","tool_scopes",["std.mcp.transport.http._tool_required_scopes_text_v1",["bytes.view","tools_json"],["bytes.view","tool_name_for_auth"]]],["set","required_scopes",["std.mcp.transport.http._scope_union_text_v1",["bytes.view","auth_required_scopes"],["bytes.view","tool_scopes"]]],0],0],["let","authz",["std.net.http.server.req_header_get_v1",["bytes.view","req_doc"],["bytes.view","hdr_authz"]]],["let","auth_status",["std.mcp.auth.oauth_test_static.verify_status_v1",["bytes.view","oauth_json"],["bytes.view","authz"],["bytes.view","required_scopes"]]],["if",["=","auth_status",401],["begin",["set","status",401],["let","challenge_401",["std.mcp.auth.challenge.www_authenticate_401_v1",["bytes.view","resource_md_url"],["bytes.view","required_scopes"]]],["set","headers",["std.net.http.spec.headers_set_v1",["bytes.view","headers"],["bytes.view","hdr_www_auth"],["bytes.view","challenge_401"]]],0],0],["if",["=","auth_status",403],["begin",["set","status",403],["let","challenge_403",["std.mcp.auth.challenge.www_authenticate_403_insufficient_scope_v1",["bytes.view","resource_md_url"],["bytes.view","required_scopes"]]],["set","headers",["std.net.http.spec.headers_set_v1",["bytes.view","headers"],["bytes.view","hdr_www_auth"],["bytes.view","challenge_403"]]],0],0],0],0],["if",["<","status",0],["begin",["let","dispatch",["std.mcp.toolkit.stdio_dispatch.dispatch_line_v1","mcp_state",["bytes.view","cfg_pv"],["bytes.view","server_name"],["bytes.view","server_version"],["bytes.view","tools_json"],["bytes.view","resources_json"],["bytes.view","prompts_json"],["bytes.view","req_json"]]],["if",["!=",["result_bytes.err_code","dispatch"],0],["set","status",500],["begin",["let","step",["result_bytes.unwrap_or","dispatch",["bytes.alloc",0]]],["let","kind",["std.mcp.toolkit.stdio_dispatch.step_kind_v1",["bytes.view","step"]]],["let","next_state",["std.mcp.toolkit.stdio_dispatch.step_next_state_v1",["bytes.view","step"]]],["if",["=","kind",0],["begin",["set","status",202],["set","mcp_state","next_state"],0],0],["if",["=","kind",1],["begin",["set","status",200],["set","body",["std.mcp.toolkit.stdio_dispatch.step_resp_json_v1",["bytes.view","step"]]],["set","headers",["std.net.http.spec.headers_set_v1",["bytes.view","headers"],["bytes.view","hdr_content_type"],["bytes.view","value_content_type_json"]]],["let","session_id_len_init",["bytes.len",["bytes.view","session_id"]]],["if",["if",["=","session_required",1],["if",["<=","session_id_len_init",0],["=",["view.eq",["bytes.view","request_method"],["bytes.view","request_initialize"]],1],0],0],["begin",["set","session_id",["std.mcp.transport.http_session.next_test_session_id_v1","session_idx"]],["set","session_idx",["+","session_idx",1]],["set","headers",["std.net.http.spec.headers_set_v1",["bytes.view","headers"],["bytes.view","hdr_mcp_sid"],["bytes.view","session_id"]]],0],0],["set","mcp_state","next_state"],0],0],["if",["=","kind",2],["begin",["let","id_json",["std.mcp.toolkit.stdio_dispatch.step_tool_call_id_json_v1",["bytes.view","step"]]],["let","tool_name",["std.mcp.toolkit.stdio_dispatch.step_tool_call_tool_name_v1",["bytes.view","step"]]],["let","args_json",["std.mcp.toolkit.stdio_dispatch.step_tool_call_args_json_v1",["bytes.view","step"]]],["let","tool_res",["std.mcp.sandbox.router_exec.call_tool_oneshot_v1",["bytes.view","tool_name"],["bytes.view","cfg_json"],["bytes.view","args_json"],["bytes.view","tools_json"]]],["let","tr",["if",["!=",["result_bytes.err_code","tool_res"],0],["std.mcp.transport.http._tool_internal_error_result_v1",["bytes.view","tool_name"],["result_bytes.err_code","tool_res"],["bytes.lit","tool invocation failed"]],["result_bytes.unwrap_or","tool_res",["bytes.alloc",0]]]],["set","status",200],["set","body",["std.mcp.jsonrpc.make_result_response_v1",["bytes.view","id_json"],["bytes.view","tr"]]],["set","headers",["std.net.http.spec.headers_set_v1",["bytes.view","headers"],["bytes.view","hdr_content_type"],["bytes.view","value_content_type_json"]]],["set","mcp_state","next_state"],0],0],["if",["<","status",0],["set","status",500],0],0]],0],0],0],0],0]]],["if",["<","status",0],["set","status",404],0],["let","_write",["std.net.http.server.write_response_v1","stream","status",["bytes.view","headers"],["bytes.view","body"],["bytes.view","caps"]]],["let","_close_stream",["std.net.tcp.stream_close_v1","stream"]],0]],0],"kind":"defn","name":"std.mcp.transport.http.serve_from_fs_v1","params":[{"name":"cfg_path","ty":"bytes_view"}],"result":"i32"}],"imports":["ext.data_model","ext.json.canon","ext.json.data_model","std.bytes","std.fmt","std.fs","std.mcp.auth.challenge","std.mcp.auth.oauth_test_static","std.mcp.auth.prm","std.mcp.diag","std.mcp.jsonrpc","std.mcp.protocol","std.mcp.sandbox.router_exec","std.mcp.tool.result","std.mcp.toolkit.prompts_file","std.mcp.toolkit.resources_file","std.mcp.toolkit.stdio_dispatch","std.mcp.toolkit.tools_file","std.mcp.transport.http_rules","std.mcp.transport.http_session","std.mcp.util.json","std.net.err","std.net.http.server","std.net.http.spec","std.net.tcp","std.os.fs","std.os.fs.spec","std.parse"],"kind":"module","module_id":"std.mcp.transport.http","schema_version":"x07.x07ast@0.5.0"}
