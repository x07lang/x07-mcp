{"decls":[{"kind":"export","names":["std.mcp.ctx.with_meta_v1"]},{"body":["begin",["let","k_req_id",["bytes.lit","x07McpRequestId"]],["let","k_progress_token",["bytes.lit","x07McpProgressToken"]],["let","k_session_id",["bytes.lit","x07McpSessionId"]],["let","want_req_id",["if",[">",["std.bytes.len","request_id_json"],0],1,0]],["let","want_progress_token",["if",[">",["std.bytes.len","progress_token_json"],0],1,0]],["let","want_session_id",["if",[">",["std.bytes.len","session_id_utf8"],0],1,0]],["let","doc_b",["ext.json.data_model.parse","base_ctx_json"]],["let","doc",["bytes.view","doc_b"]],["let","base_ok",["&",["=",["ext.data_model.doc_is_err","doc"],0],["=",["ext.data_model.root_kind","doc"],5]]],["let","base_root",["if",["=","base_ok",1],["ext.data_model.root_offset","doc"],0]],["let","base_n0",["if",["=","base_ok",1],["ext.data_model.map_len","doc","base_root"],0]],["let","base_n",["if",[">","base_n0",0],"base_n0",0]],["let","keep",0],["for","i",0,"base_n",["begin",["let","k",["ext.data_model.map_key_at","doc","base_root","i"]],["let","skip",["|",["&",["=","want_req_id",1],["=",["bytes.eq",["bytes.view","k"],["bytes.view","k_req_id"]],1]],["|",["&",["=","want_progress_token",1],["=",["bytes.eq",["bytes.view","k"],["bytes.view","k_progress_token"]],1]],["&",["=","want_session_id",1],["=",["bytes.eq",["bytes.view","k"],["bytes.view","k_session_id"]],1]]]]],["if",["=","skip",1],0,["set","keep",["+","keep",1]]]]],["let","extra",["+",["+",["if",["=","want_req_id",1],1,0],["if",["=","want_progress_token",1],1,0]],["if",["=","want_session_id",1],1,0]]],["let","count",["+","keep","extra"]],["let","entries",["vec_u8.with_capacity",512]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le","count"]]],["if",["&",["=","base_ok",1],[">","base_n",0]],["for","i2",0,"base_n",["begin",["let","k2",["ext.data_model.map_key_at","doc","base_root","i2"]],["let","skip2",["|",["&",["=","want_req_id",1],["=",["bytes.eq",["bytes.view","k2"],["bytes.view","k_req_id"]],1]],["|",["&",["=","want_progress_token",1],["=",["bytes.eq",["bytes.view","k2"],["bytes.view","k_progress_token"]],1]],["&",["=","want_session_id",1],["=",["bytes.eq",["bytes.view","k2"],["bytes.view","k_session_id"]],1]]]]],["if",["=","skip2",1],0,["begin",["let","v_off",["ext.data_model.map_value_at","doc","base_root","i2"]],["let","v_end",["ext.data_model.skip_value","doc","v_off"]],["if",["<","v_end",0],0,["begin",["let","v_dm",["view.to_bytes",["view.slice","doc","v_off",["-","v_end","v_off"]]]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",["std.bytes.len","k2"]]]],["set","entries",["vec_u8.extend_bytes","entries",["bytes.view","k2"]]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",["std.bytes.len","v_dm"]]]],["set","entries",["vec_u8.extend_bytes","entries",["bytes.view","v_dm"]]],0]]]]]],0],["if",["=","want_req_id",1],["begin",["let","v_req_id",["std.mcp.util.json.value_from_json_or_null_v1","request_id_json"]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",["std.bytes.len","k_req_id"]]]],["set","entries",["vec_u8.extend_bytes","entries",["bytes.view","k_req_id"]]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",["std.bytes.len","v_req_id"]]]],["set","entries",["vec_u8.extend_bytes","entries",["bytes.view","v_req_id"]]]],0],["if",["=","want_progress_token",1],["begin",["let","v_progress",["std.mcp.util.json.value_from_json_or_null_v1","progress_token_json"]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",["std.bytes.len","k_progress_token"]]]],["set","entries",["vec_u8.extend_bytes","entries",["bytes.view","k_progress_token"]]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",["std.bytes.len","v_progress"]]]],["set","entries",["vec_u8.extend_bytes","entries",["bytes.view","v_progress"]]]],0],["if",["=","want_session_id",1],["begin",["let","v_session",["ext.data_model.value_string","session_id_utf8"]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",["std.bytes.len","k_session_id"]]]],["set","entries",["vec_u8.extend_bytes","entries",["bytes.view","k_session_id"]]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",["std.bytes.len","v_session"]]]],["set","entries",["vec_u8.extend_bytes","entries",["bytes.view","v_session"]]]],0],["let","entries_b",["vec_u8.into_bytes","entries"]],["let","val",["ext.data_model.value_map_from_entries",["bytes.view","entries_b"]]],["if",["=",["std.bytes.len","val"],0],["bytes.lit","{}"],["std.mcp.util.json.json_from_value_v1",["bytes.view","val"]]]],"kind":"defn","name":"std.mcp.ctx.with_meta_v1","params":[{"name":"base_ctx_json","ty":"bytes_view"},{"name":"request_id_json","ty":"bytes_view"},{"name":"progress_token_json","ty":"bytes_view"},{"name":"session_id_utf8","ty":"bytes_view"}],"result":"bytes"}],"imports":["ext.data_model","ext.json.data_model","std.bytes","std.mcp.util.json"],"kind":"module","module_id":"std.mcp.ctx","schema_version":"x07.x07ast@0.5.0"}
