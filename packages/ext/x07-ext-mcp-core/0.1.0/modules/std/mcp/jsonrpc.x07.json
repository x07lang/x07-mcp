{
  "schema_version": "x07.x07ast@0.5.0",
  "kind": "module",
  "module_id": "std.mcp.jsonrpc",
  "imports": [
    "ext.data_model",
    "ext.json.canon",
    "ext.json.data_model",
    "std.bytes",
    "std.fmt",
    "std.mcp.util.json"
  ],
  "decls": [
    {
      "kind": "export",
      "names": [
        "std.mcp.jsonrpc.make_error_response_v1",
        "std.mcp.jsonrpc.make_result_response_v1",
        "std.mcp.jsonrpc.parse_line_v1"
      ]
    },
    {
      "kind": "defn",
      "name": "std.mcp.jsonrpc._has_byte_v1",
      "params": [
        { "name": "b", "ty": "bytes_view" },
        { "name": "target", "ty": "i32" }
      ],
      "result": "i32",
      "body": [
        "begin",
        ["let", "n", ["view.len", "b"]],
        [
          "for",
          "i",
          0,
          "n",
          ["if", ["=", ["view.get_u8", "b", "i"], "target"], ["return", 1], 0]
        ],
        0
      ]
    },
    {
      "kind": "defn",
      "name": "std.mcp.jsonrpc.parse_line_v1",
      "params": [{ "name": "line_utf8", "ty": "bytes_view" }],
      "result": "result_bytes",
      "body": [
        "begin",
        [
          "if",
          ["=", ["std.mcp.jsonrpc._has_byte_v1", "line_utf8", 10], 1],
          ["return", ["result_bytes.err", -32700]],
          0
        ],
        [
          "if",
          ["=", ["std.mcp.jsonrpc._has_byte_v1", "line_utf8", 13], 1],
          ["return", ["result_bytes.err", -32700]],
          0
        ],
        ["let", "canon", ["ext.json.canon.canonicalize", "line_utf8"]],
        ["if", ["=", ["bytes.len", "canon"], 0], ["return", ["result_bytes.err", -32700]], 0],
        ["let", "canon_v", ["bytes.view", "canon"]],
        ["let", "doc", ["ext.json.data_model.parse", "canon_v"]],
        ["let", "dv", ["bytes.view", "doc"]],
        ["if", ["=", ["ext.data_model.doc_is_err", "dv"], 1], ["return", ["result_bytes.err", -32700]], 0],
        ["if", ["!=", ["ext.data_model.root_kind", "dv"], 5], ["return", ["result_bytes.err", -32600]], 0],
        ["let", "root", ["ext.data_model.root_offset", "dv"]],
        ["let", "k_jsonrpc", ["bytes.lit", "jsonrpc"]],
        ["let", "jsonrpc_off", ["ext.data_model.map_find", "dv", "root", ["bytes.view", "k_jsonrpc"]]],
        ["if", ["<", "jsonrpc_off", 0], ["return", ["result_bytes.err", -32600]], 0],
        ["let", "ver", ["ext.data_model.string_get", "dv", "jsonrpc_off"]],
        ["if", ["=", ["bytes.len", "ver"], 0], ["return", ["result_bytes.err", -32600]], 0],
        ["let", "v2", ["bytes.lit", "2.0"]],
        ["if", ["=", ["bytes.eq", ["bytes.view", "ver"], ["bytes.view", "v2"]], 0], ["return", ["result_bytes.err", -32600]], 0],
        ["result_bytes.ok", "canon"]
      ]
    },
    {
      "kind": "defn",
      "name": "std.mcp.jsonrpc.make_result_response_v1",
      "params": [
        { "name": "id_json", "ty": "bytes_view" },
        { "name": "result_json", "ty": "bytes_view" }
      ],
      "result": "bytes",
      "body": [
        "begin",
        ["let", "k_id", ["bytes.lit", "id"]],
        ["let", "k_jsonrpc", ["bytes.lit", "jsonrpc"]],
        ["let", "k_result", ["bytes.lit", "result"]],
        ["let", "id_val", ["std.mcp.util.json.value_from_json_or_null_v1", "id_json"]],
        ["let", "result_val", ["std.mcp.util.json.value_from_json_or_null_v1", "result_json"]],
        ["let", "v_jsonrpc", ["ext.data_model.value_string", ["bytes.view", ["bytes.lit", "2.0"]]]],
        ["let", "entries", ["vec_u8.with_capacity", 256]],
        ["set", "entries", ["vec_u8.extend_bytes", "entries", ["codec.write_u32_le", 3]]],
        ["set", "entries", ["vec_u8.extend_bytes", "entries", ["codec.write_u32_le", ["bytes.len", "k_id"]]]],
        ["set", "entries", ["vec_u8.extend_bytes", "entries", "k_id"]],
        ["set", "entries", ["vec_u8.extend_bytes", "entries", ["codec.write_u32_le", ["bytes.len", "id_val"]]]],
        ["set", "entries", ["vec_u8.extend_bytes", "entries", "id_val"]],
        ["set", "entries", ["vec_u8.extend_bytes", "entries", ["codec.write_u32_le", ["bytes.len", "k_jsonrpc"]]]],
        ["set", "entries", ["vec_u8.extend_bytes", "entries", "k_jsonrpc"]],
        ["set", "entries", ["vec_u8.extend_bytes", "entries", ["codec.write_u32_le", ["bytes.len", "v_jsonrpc"]]]],
        ["set", "entries", ["vec_u8.extend_bytes", "entries", "v_jsonrpc"]],
        ["set", "entries", ["vec_u8.extend_bytes", "entries", ["codec.write_u32_le", ["bytes.len", "k_result"]]]],
        ["set", "entries", ["vec_u8.extend_bytes", "entries", "k_result"]],
        ["set", "entries", ["vec_u8.extend_bytes", "entries", ["codec.write_u32_le", ["bytes.len", "result_val"]]]],
        ["set", "entries", ["vec_u8.extend_bytes", "entries", "result_val"]],
        ["let", "entries_b", ["vec_u8.into_bytes", "entries"]],
        ["let", "resp_val", ["ext.data_model.value_map_from_entries", ["bytes.view", "entries_b"]]],
        ["if", ["=", ["bytes.len", "resp_val"], 0], ["return", ["bytes.alloc", 0]], 0],
        ["std.mcp.util.json.json_from_value_v1", ["bytes.view", "resp_val"]]
      ]
    },
    {
      "kind": "defn",
      "name": "std.mcp.jsonrpc.make_error_response_v1",
      "params": [
        { "name": "id_json", "ty": "bytes_view" },
        { "name": "code_i32", "ty": "i32" },
        { "name": "message_utf8", "ty": "bytes_view" },
        { "name": "data_json_opt", "ty": "option_bytes" }
      ],
      "result": "bytes",
      "body": [
        "begin",
        ["let", "k_code", ["bytes.lit", "code"]],
        ["let", "k_data", ["bytes.lit", "data"]],
        ["let", "k_message", ["bytes.lit", "message"]],
        ["let", "k_error", ["bytes.lit", "error"]],
        ["let", "k_id", ["bytes.lit", "id"]],
        ["let", "k_jsonrpc", ["bytes.lit", "jsonrpc"]],
        ["let", "id_val", ["std.mcp.util.json.value_from_json_or_null_v1", "id_json"]],
        ["let", "code_s", ["std.fmt.s32_to_dec", "code_i32"]],
        ["let", "code_val", ["ext.data_model.value_number", ["bytes.view", "code_s"]]],
        ["let", "msg_val", ["ext.data_model.value_string", "message_utf8"]],
        ["let", "err_entries", ["vec_u8.with_capacity", 256]],
        ["let", "has_data", ["option_bytes.is_some", "data_json_opt"]],
        ["let", "err_count", ["if", ["=", "has_data", 1], 3, 2]],
        ["set", "err_entries", ["vec_u8.extend_bytes", "err_entries", ["codec.write_u32_le", "err_count"]]],
        ["set", "err_entries", ["vec_u8.extend_bytes", "err_entries", ["codec.write_u32_le", ["bytes.len", "k_code"]]]],
        ["set", "err_entries", ["vec_u8.extend_bytes", "err_entries", "k_code"]],
        ["set", "err_entries", ["vec_u8.extend_bytes", "err_entries", ["codec.write_u32_le", ["bytes.len", "code_val"]]]],
        ["set", "err_entries", ["vec_u8.extend_bytes", "err_entries", "code_val"]],
        ["set", "err_entries", ["vec_u8.extend_bytes", "err_entries", ["codec.write_u32_le", ["bytes.len", "k_message"]]]],
        ["set", "err_entries", ["vec_u8.extend_bytes", "err_entries", "k_message"]],
        ["set", "err_entries", ["vec_u8.extend_bytes", "err_entries", ["codec.write_u32_le", ["bytes.len", "msg_val"]]]],
        ["set", "err_entries", ["vec_u8.extend_bytes", "err_entries", "msg_val"]],
        [
          "if",
          ["=", "has_data", 1],
          [
            "begin",
            ["let", "data_json", ["option_bytes.unwrap_or", "data_json_opt", ["bytes.alloc", 0]]],
            ["let", "data_val", ["std.mcp.util.json.value_from_json_or_null_v1", ["bytes.view", "data_json"]]],
            ["set", "err_entries", ["vec_u8.extend_bytes", "err_entries", ["codec.write_u32_le", ["bytes.len", "k_data"]]]],
            ["set", "err_entries", ["vec_u8.extend_bytes", "err_entries", "k_data"]],
            ["set", "err_entries", ["vec_u8.extend_bytes", "err_entries", ["codec.write_u32_le", ["bytes.len", "data_val"]]]],
            ["set", "err_entries", ["vec_u8.extend_bytes", "err_entries", "data_val"]]
          ],
          0
        ],
        ["let", "err_entries_b", ["vec_u8.into_bytes", "err_entries"]],
        ["let", "error_val", ["ext.data_model.value_map_from_entries", ["bytes.view", "err_entries_b"]]],
        ["if", ["=", ["bytes.len", "error_val"], 0], ["return", ["bytes.alloc", 0]], 0],
        ["let", "v_jsonrpc", ["ext.data_model.value_string", ["bytes.view", ["bytes.lit", "2.0"]]]],
        ["let", "resp_entries", ["vec_u8.with_capacity", 256]],
        ["set", "resp_entries", ["vec_u8.extend_bytes", "resp_entries", ["codec.write_u32_le", 3]]],
        ["set", "resp_entries", ["vec_u8.extend_bytes", "resp_entries", ["codec.write_u32_le", ["bytes.len", "k_error"]]]],
        ["set", "resp_entries", ["vec_u8.extend_bytes", "resp_entries", "k_error"]],
        ["set", "resp_entries", ["vec_u8.extend_bytes", "resp_entries", ["codec.write_u32_le", ["bytes.len", "error_val"]]]],
        ["set", "resp_entries", ["vec_u8.extend_bytes", "resp_entries", "error_val"]],
        ["set", "resp_entries", ["vec_u8.extend_bytes", "resp_entries", ["codec.write_u32_le", ["bytes.len", "k_id"]]]],
        ["set", "resp_entries", ["vec_u8.extend_bytes", "resp_entries", "k_id"]],
        ["set", "resp_entries", ["vec_u8.extend_bytes", "resp_entries", ["codec.write_u32_le", ["bytes.len", "id_val"]]]],
        ["set", "resp_entries", ["vec_u8.extend_bytes", "resp_entries", "id_val"]],
        ["set", "resp_entries", ["vec_u8.extend_bytes", "resp_entries", ["codec.write_u32_le", ["bytes.len", "k_jsonrpc"]]]],
        ["set", "resp_entries", ["vec_u8.extend_bytes", "resp_entries", "k_jsonrpc"]],
        ["set", "resp_entries", ["vec_u8.extend_bytes", "resp_entries", ["codec.write_u32_le", ["bytes.len", "v_jsonrpc"]]]],
        ["set", "resp_entries", ["vec_u8.extend_bytes", "resp_entries", "v_jsonrpc"]],
        ["let", "resp_entries_b", ["vec_u8.into_bytes", "resp_entries"]],
        ["let", "resp_val", ["ext.data_model.value_map_from_entries", ["bytes.view", "resp_entries_b"]]],
        ["if", ["=", ["bytes.len", "resp_val"], 0], ["return", ["bytes.alloc", 0]], 0],
        ["std.mcp.util.json.json_from_value_v1", ["bytes.view", "resp_val"]]
      ]
    }
  ]
}
