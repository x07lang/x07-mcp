{"decls":[{"kind":"export","names":["std.mcp.redact.apply_json_v1","std.mcp.redact.apply_json_with_compiled_patterns_pack_v1","std.mcp.redact.compile_patterns_pack_from_json_v1"]},{"body":["begin",["let","out","text_utf8"],["let","builtin_bearer",["bytes.lit","x07.redact.builtin.bearer_token_v1"]],["if",["<",["bytes.len","compiled_patterns_pack"],4],["return","out"],0],["let","n",["codec.read_u32_le","compiled_patterns_pack",0]],["if",["<","n",0],["return","out"],0],["let","off",4],["for","i",0,"n",["begin",["let","len",["codec.read_u32_le","compiled_patterns_pack","off"]],["set","off",["+","off",4]],["let","compiled",["view.slice","compiled_patterns_pack","off","len"]],["set","off",["+","off","len"]],["if",["=",["std.bytes.eq","compiled",["bytes.view","builtin_bearer"]],1],["set","out",["std.mcp.redact._redact_bearer_token_bytes_utf8_v1","out","redacted_value_utf8"]],["begin",["let","doc_b",["ext.regex.exec","compiled",["bytes.view","out"]]],["let","doc",["bytes.view","doc_b"]],["if",["&",["=",["ext.regex.is_err","doc"],0],["=",["ext.regex.is_match","doc"],1]],["set","out",["ext.regex.replace_all_v1","compiled",["bytes.view","out"],"redacted_value_utf8",2147483647]],0],0]],0]],"out"],"kind":"defn","name":"std.mcp.redact._apply_compiled_patterns_bytes_utf8_v1","params":[{"name":"text_utf8","ty":"bytes"},{"name":"compiled_patterns_pack","ty":"bytes_view"},{"name":"redacted_value_utf8","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","n",["view.len","b"]],["let","out",["vec_u8.with_capacity","n"]],["for","i",0,"n",["begin",["let","c",["view.get_u8","b","i"]],["set","out",["vec_u8.push","out",["std.text.ascii.to_lower_u8","c"]]],0]],["vec_u8.into_bytes","out"]],"kind":"defn","name":"std.mcp.redact._ascii_lower_bytes_v1","params":[{"name":"b","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","pfx",["bytes.lit","(?i)"]],["let","n",["view.len","pat_utf8"]],["if",["&",[">=","n",4],["=",["std.bytes.eq",["view.slice","pat_utf8",0,4],["bytes.view","pfx"]],1]],["begin",["let","rest",["view.slice","pat_utf8",4,["-","n",4]]],["ext.regex.compile_opts_v1","rest",["ext.regex.opts_casei_v1"]]],["ext.regex.compile","pat_utf8"]]],"kind":"defn","name":"std.mcp.redact._compile_pattern_v1","params":[{"name":"pat_utf8","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["if",["<","patterns_root",0],["return",["bytes.alloc",0]],0],["let","n",["ext.data_model.seq_len","patterns_doc","patterns_root"]],["if",["<","n",0],["return",["bytes.alloc",0]],0],["let","builtin_bearer",["bytes.lit","x07.redact.builtin.bearer_token_v1"]],["let","bearer_rest",["bytes.lit","bearer\\s+[A-Za-z0-9._-]+"]],["let","pfx_casei",["bytes.lit","(?i)"]],["let","body",["vec_u8.with_capacity",256]],["let","count",0],["for","i",0,"n",["begin",["let","it",["ext.data_model.seq_get","patterns_doc","patterns_root","i"]],["if",["<","it",0],0,["begin",["if",["=",["ext.data_model.kind_at","patterns_doc","it"],3],["begin",["let","pat",["ext.data_model.string_get","patterns_doc","it"]],["let","pat_v",["bytes.view","pat"]],["let","pn",["view.len","pat_v"]],["let","has_pfx",0],["if",["&",[">=","pn",4],["=",["std.bytes.eq",["view.slice","pat_v",0,4],["bytes.view","pfx_casei"]],1]],["set","has_pfx",1],0],["let","rest",["if",["=","has_pfx",1],["view.slice","pat_v",4,["-","pn",4]],"pat_v"]],["let","is_builtin",["if",["=",["std.bytes.eq","rest",["bytes.view","bearer_rest"]],1],1,0]],["let","compiled",["if",["=","is_builtin",1],"builtin_bearer",["std.mcp.redact._compile_pattern_v1","pat_v"]]],["if",["|",["=","is_builtin",1],["=",["ext.regex.is_err",["bytes.view","compiled"]],0]],["begin",["set","body",["vec_u8.extend_bytes","body",["codec.write_u32_le",["bytes.len",["bytes.view","compiled"]]]]],["set","body",["vec_u8.extend_bytes","body",["bytes.view","compiled"]]],["set","count",["+","count",1]],0],0],0],0],0]],0]],["if",["=","count",0],["bytes.alloc",0],["begin",["let","body_b",["vec_u8.into_bytes","body"]],["let","out",["vec_u8.with_capacity",["+",4,["bytes.len",["bytes.view","body_b"]]]]],["set","out",["vec_u8.extend_bytes","out",["codec.write_u32_le","count"]]],["set","out",["vec_u8.extend_bytes","out",["bytes.view","body_b"]]],["vec_u8.into_bytes","out"]]]],"kind":"defn","name":"std.mcp.redact._compile_patterns_pack_v1","params":[{"name":"patterns_doc","ty":"bytes_view"},{"name":"patterns_root","ty":"i32"}],"result":"bytes"},{"body":["begin",["let","hn",["view.len","hay"]],["let","nn",["view.len","needle"]],["if",["<=","nn",0],["return",0],0],["if",["<u","hn","nn"],["return",0],0],["let","limit",["-","hn","nn"]],["for","i",0,["+","limit",1],["begin",["let","ok",1],["for","j",0,"nn",["begin",["let","hc",["view.get_u8","hay",["+","i","j"]]],["let","nc",["view.get_u8","needle","j"]],["let","hc2",["std.text.ascii.to_lower_u8","hc"]],["let","nc2",["std.text.ascii.to_lower_u8","nc"]],["if",["=","hc2","nc2"],0,["set","ok",0]],0]],["if",["=","ok",1],["return",1],0],0]],0],"kind":"defn","name":"std.mcp.redact._contains_ascii_casei_v1","params":[{"name":"hay","ty":"bytes_view"},{"name":"needle","ty":"bytes_view"}],"result":"i32"},{"body":["begin",["let","n",["view.len","keys_json"]],["let","in_str",0],["let","start",0],["let","q",["bytes.lit","\""]],["for","i",0,"n",["begin",["let","c",["view.get_u8","keys_json","i"]],["if",["=","in_str",0],["begin",["if",["=","c",34],["begin",["set","in_str",1],["set","start",["+","i",1]],0],0],0],["begin",["if",["=","c",92],["return",1],0],["if",["=","c",34],["begin",["let","len",["-","i","start"]],["if",[">","len",0],["begin",["let","needle",["view.slice","keys_json","start","len"]],["let","t0",["std.bytes.concat",["bytes.view","q"],"needle"]],["let","t1",["std.bytes.concat",["bytes.view","t0"],["bytes.view","q"]]],["if",["=",["std.mcp.redact._contains_ascii_casei_v1","hay",["bytes.view","t1"]],1],["return",1],0],0],0],["set","in_str",0],0],0],0]]]],0],"kind":"defn","name":"std.mcp.redact._json_strings_any_sub_in_hay_casei_v1","params":[{"name":"hay","ty":"bytes_view"},{"name":"keys_json","ty":"bytes_view"}],"result":"i32"},{"body":["begin",["if",["<","keys_root",0],["return",0],0],["let","key_l",["std.mcp.redact._ascii_lower_bytes_v1","key_utf8"]],["let","n",["ext.data_model.seq_len","keys_doc","keys_root"]],["if",["<","n",0],["return",0],0],["for","i",0,"n",["begin",["let","it",["ext.data_model.seq_get","keys_doc","keys_root","i"]],["if",["<","it",0],0,["begin",["if",["=",["ext.data_model.kind_at","keys_doc","it"],3],["begin",["let","s",["ext.data_model.string_get","keys_doc","it"]],["let","s_l",["std.mcp.redact._ascii_lower_bytes_v1",["bytes.view","s"]]],["if",["=",["std.bytes.eq",["bytes.view","key_l"],["bytes.view","s_l"]],1],["return",1],0],0],0],0]],0]],0],"kind":"defn","name":"std.mcp.redact._key_matches_any_casei_v1","params":[{"name":"key_utf8","ty":"bytes_view"},{"name":"keys_doc","ty":"bytes_view"},{"name":"keys_root","ty":"i32"}],"result":"i32"},{"body":["begin",["let","tv",["bytes.view","text_utf8"]],["let","n",["view.len","tv"]],["let","out",["vec_u8.with_capacity","n"]],["let","pos",0],["for","_",0,2147483647,["begin",["if",[">=","pos","n"],["begin",["let","tail",["view.slice","tv","pos",["-","n","pos"]]],["set","out",["vec_u8.extend_bytes","out","tail"]],["return",["vec_u8.into_bytes","out"]]],0],["let","match_start",-1],["let","match_end",-1],["for","i","pos","n",["begin",["if",["!=","match_start",-1],0,["begin",["if",["<=",["+","i",6],"n"],["begin",["let","c0",["std.text.ascii.to_lower_u8",["view.get_u8","tv","i"]]],["let","c1",["std.text.ascii.to_lower_u8",["view.get_u8","tv",["+","i",1]]]],["let","c2",["std.text.ascii.to_lower_u8",["view.get_u8","tv",["+","i",2]]]],["let","c3",["std.text.ascii.to_lower_u8",["view.get_u8","tv",["+","i",3]]]],["let","c4",["std.text.ascii.to_lower_u8",["view.get_u8","tv",["+","i",4]]]],["let","c5",["std.text.ascii.to_lower_u8",["view.get_u8","tv",["+","i",5]]]],["if",["&",["=","c0",98],["&",["=","c1",101],["&",["=","c2",97],["&",["=","c3",114],["&",["=","c4",101],["=","c5",114]]]]]],["begin",["let","j",["+","i",6]],["if",[">=","j","n"],0,["begin",["let","cws",["view.get_u8","tv","j"]],["if",["=",["|",["=","cws",32],["|",["=","cws",9],["|",["=","cws",10],["=","cws",13]]]],1],["begin",["let","j2","j"],["let","done_ws",0],["for","k","j","n",["begin",["if",["=","done_ws",1],0,["begin",["let","c",["view.get_u8","tv","k"]],["if",["=",["|",["=","c",32],["|",["=","c",9],["|",["=","c",10],["=","c",13]]]],1],["set","j2",["+","k",1]],["set","done_ws",1]]]],0]],["if",["<","j2","n"],["begin",["let","ct0",["view.get_u8","tv","j2"]],["if",["=",["if",["if",[">=u","ct0",48],["<u","ct0",58],0],1,["if",["if",[">=u","ct0",65],["<u","ct0",91],0],1,["if",["if",[">=u","ct0",97],["<u","ct0",123],0],1,["if",["if",["=","ct0",46],1,["=","ct0",95]],1,["=","ct0",45]]]]],1],["begin",["let","end","j2"],["let","done_tok",0],["for","k2","j2","n",["begin",["if",["=","done_tok",1],0,["begin",["let","c2",["view.get_u8","tv","k2"]],["if",["=",["if",["if",[">=u","c2",48],["<u","c2",58],0],1,["if",["if",[">=u","c2",65],["<u","c2",91],0],1,["if",["if",[">=u","c2",97],["<u","c2",123],0],1,["if",["if",["=","c2",46],1,["=","c2",95]],1,["=","c2",45]]]]],1],["set","end",["+","k2",1]],["set","done_tok",1]]]],0]],["if",[">","end","j2"],["begin",["set","match_start","i"],["set","match_end","end"],0],0]],0]],0],0],0]]]],0]],0]]]]],["if",["<","match_start",0],["begin",["let","tail",["view.slice","tv","pos",["-","n","pos"]]],["set","out",["vec_u8.extend_bytes","out","tail"]],["return",["vec_u8.into_bytes","out"]]],["begin",["let","prefix",["view.slice","tv","pos",["-","match_start","pos"]]],["set","out",["vec_u8.extend_bytes","out","prefix"]],["set","out",["vec_u8.extend_bytes","out","redacted_value_utf8"]],["set","pos","match_end"],0]],0]],["vec_u8.into_bytes","out"]],"kind":"defn","name":"std.mcp.redact._redact_bearer_token_bytes_utf8_v1","params":[{"name":"text_utf8","ty":"bytes"},{"name":"redacted_value_utf8","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["if",["<","off",0],["return",["ext.data_model.value_null"]],0],["if",["<=","depth",0],["begin",["let","end",["ext.data_model.skip_value","doc","off"]],["if",["<","end",0],["return",["ext.data_model.value_null"]],0],["return",["view.to_bytes",["view.slice","doc","off",["-","end","off"]]]]],0],["let","kind",["ext.data_model.kind_at","doc","off"]],["if",["=","kind",5],["begin",["let","n",["ext.data_model.map_len","doc","off"]],["if",["<","n",0],["return",["ext.data_model.value_null"]],0],["let","entries",["vec_u8.with_capacity",256]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le","n"]]],["for","i",0,"n",["begin",["let","k",["ext.data_model.map_key_at","doc","off","i"]],["let","v_off",["ext.data_model.map_value_at","doc","off","i"]],["let","redact_key",["std.mcp.redact._key_matches_any_casei_v1",["bytes.view","k"],"keys_doc","keys_root"]],["let","v",["if",["=","redact_key",1],["ext.data_model.value_string","redacted_value_utf8"],["std.mcp.redact._redact_value_v1","doc","v_off","keys_doc","keys_root","compiled_patterns_pack","redacted_value_utf8",["-","depth",1]]]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",["bytes.len",["bytes.view","k"]]]]],["set","entries",["vec_u8.extend_bytes","entries",["bytes.view","k"]]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",["bytes.len",["bytes.view","v"]]]]],["set","entries",["vec_u8.extend_bytes","entries",["bytes.view","v"]]],0]],["let","entries_b",["vec_u8.into_bytes","entries"]],["let","val",["ext.data_model.value_map_from_entries",["bytes.view","entries_b"]]],["if",["=",["bytes.len","val"],0],["ext.data_model.value_null"],"val"]],["if",["=","kind",4],["begin",["let","n",["ext.data_model.seq_len","doc","off"]],["if",["<","n",0],["return",["ext.data_model.value_null"]],0],["let","elems",["vec_u8.with_capacity",256]],["set","elems",["vec_u8.extend_bytes","elems",["codec.write_u32_le","n"]]],["for","i",0,"n",["begin",["let","it",["ext.data_model.seq_get","doc","off","i"]],["let","v",["std.mcp.redact._redact_value_v1","doc","it","keys_doc","keys_root","compiled_patterns_pack","redacted_value_utf8",["-","depth",1]]],["set","elems",["vec_u8.extend_bytes","elems",["codec.write_u32_le",["bytes.len",["bytes.view","v"]]]]],["set","elems",["vec_u8.extend_bytes","elems",["bytes.view","v"]]],0]],["let","elems_b",["vec_u8.into_bytes","elems"]],["let","val",["ext.data_model.value_seq_from_elems",["bytes.view","elems_b"]]],["if",["=",["bytes.len","val"],0],["ext.data_model.value_null"],"val"]],["if",["=","kind",3],["begin",["let","s",["ext.data_model.string_get","doc","off"]],["let","s2",["std.mcp.redact._apply_compiled_patterns_bytes_utf8_v1","s","compiled_patterns_pack","redacted_value_utf8"]],["ext.data_model.value_string",["bytes.view","s2"]]],["begin",["let","end",["ext.data_model.skip_value","doc","off"]],["if",["<","end",0],["ext.data_model.value_null"],["view.to_bytes",["view.slice","doc","off",["-","end","off"]]]]]]]]],"kind":"defn","name":"std.mcp.redact._redact_value_v1","params":[{"name":"doc","ty":"bytes_view"},{"name":"off","ty":"i32"},{"name":"keys_doc","ty":"bytes_view"},{"name":"keys_root","ty":"i32"},{"name":"compiled_patterns_pack","ty":"bytes_view"},{"name":"redacted_value_utf8","ty":"bytes_view"},{"name":"depth","ty":"i32"}],"result":"bytes"},{"body":["begin",["let","null_json",["bytes.lit","null"]],["let","data_doc_b",["ext.json.data_model.parse","data_json"]],["let","data_doc",["bytes.view","data_doc_b"]],["if",["=",["ext.data_model.doc_is_err","data_doc"],1],["return","null_json"],0],["let","data_root",["ext.data_model.root_offset","data_doc"]],["let","keys_doc_b",["ext.json.data_model.parse","redact_keys_json"]],["let","keys_doc",["bytes.view","keys_doc_b"]],["let","keys_root",["if",["&",["=",["ext.data_model.doc_is_err","keys_doc"],0],["=",["ext.data_model.root_kind","keys_doc"],4]],["ext.data_model.root_offset","keys_doc"],-1]],["let","pats_doc_b",["ext.json.data_model.parse","redact_patterns_json"]],["let","pats_doc",["bytes.view","pats_doc_b"]],["let","pats_root",["if",["&",["=",["ext.data_model.doc_is_err","pats_doc"],0],["=",["ext.data_model.root_kind","pats_doc"],4]],["ext.data_model.root_offset","pats_doc"],-1]],["let","pats_pack_b",["std.mcp.redact._compile_patterns_pack_v1","pats_doc","pats_root"]],["let","pats_pack",["bytes.view","pats_pack_b"]],["let","val",["std.mcp.redact._redact_value_v1","data_doc","data_root","keys_doc","keys_root","pats_pack","redacted_value_utf8",32]],["let","json",["std.mcp.util.json.json_from_value_v1",["bytes.view","val"]]],["if",[">",["bytes.len",["bytes.view","json"]],0],"json","null_json"]],"kind":"defn","name":"std.mcp.redact.apply_json_v1","params":[{"name":"data_json","ty":"bytes_view"},{"name":"redact_keys_json","ty":"bytes_view"},{"name":"redact_patterns_json","ty":"bytes_view"},{"name":"redacted_value_utf8","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","builtin_only",1],["let","builtin_bearer",["bytes.lit","x07.redact.builtin.bearer_token_v1"]],["if",["<",["bytes.len","compiled_patterns_pack"],4],0,["begin",["let","npat",["codec.read_u32_le","compiled_patterns_pack",0]],["if",["<","npat",0],["set","builtin_only",0],0],["let","off",4],["for","pi",0,"npat",["begin",["let","len",["codec.read_u32_le","compiled_patterns_pack","off"]],["set","off",["+","off",4]],["let","compiled",["view.slice","compiled_patterns_pack","off","len"]],["set","off",["+","off","len"]],["if",["=","builtin_only",1],["if",["=",["std.bytes.eq","compiled",["bytes.view","builtin_bearer"]],1],0,["set","builtin_only",0]],0],0]],0]],["if",["=","builtin_only",1],["begin",["let","has_key",["std.mcp.redact._json_strings_any_sub_in_hay_casei_v1","data_json","redact_keys_json"]],["let","bearer",["bytes.lit","bearer"]],["let","has_bearer",["std.mcp.redact._contains_ascii_casei_v1","data_json",["bytes.view","bearer"]]],["if",["&",["=","has_key",0],["=","has_bearer",0]],["return",["view.to_bytes","data_json"]],0],0],0],["let","null_json",["bytes.lit","null"]],["let","data_doc_b",["ext.json.data_model.parse","data_json"]],["let","data_doc",["bytes.view","data_doc_b"]],["if",["=",["ext.data_model.doc_is_err","data_doc"],1],["return","null_json"],0],["let","data_root",["ext.data_model.root_offset","data_doc"]],["let","keys_doc_b",["ext.json.data_model.parse","redact_keys_json"]],["let","keys_doc",["bytes.view","keys_doc_b"]],["let","keys_root",["if",["&",["=",["ext.data_model.doc_is_err","keys_doc"],0],["=",["ext.data_model.root_kind","keys_doc"],4]],["ext.data_model.root_offset","keys_doc"],-1]],["let","val",["std.mcp.redact._redact_value_v1","data_doc","data_root","keys_doc","keys_root","compiled_patterns_pack","redacted_value_utf8",32]],["let","json",["std.mcp.util.json.json_from_value_v1",["bytes.view","val"]]],["if",[">",["bytes.len",["bytes.view","json"]],0],"json","null_json"]],"kind":"defn","name":"std.mcp.redact.apply_json_with_compiled_patterns_pack_v1","params":[{"name":"data_json","ty":"bytes_view"},{"name":"redact_keys_json","ty":"bytes_view"},{"name":"compiled_patterns_pack","ty":"bytes_view"},{"name":"redacted_value_utf8","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","doc_b",["ext.json.data_model.parse","patterns_json"]],["let","doc",["bytes.view","doc_b"]],["if",["&",["=",["ext.data_model.doc_is_err","doc"],0],["=",["ext.data_model.root_kind","doc"],4]],0,["return",["bytes.alloc",0]]],["let","root",["ext.data_model.root_offset","doc"]],["std.mcp.redact._compile_patterns_pack_v1","doc","root"]],"kind":"defn","name":"std.mcp.redact.compile_patterns_pack_from_json_v1","params":[{"name":"patterns_json","ty":"bytes_view"}],"result":"bytes"}],"imports":["ext.data_model","ext.json.data_model","ext.regex","std.bytes","std.mcp.util.json","std.text.ascii"],"kind":"module","module_id":"std.mcp.redact","schema_version":"x07.x07ast@0.5.0"}
