{"decls":[{"kind":"export","names":["std.mcp.transport.stdio.serve_from_fs_v1"]},{"body":["begin",["let","k_method",["bytes.lit","method"]],["let","k_params",["bytes.lit","params"]],["let","k_uri",["bytes.lit","uri"]],["let","method_target",["bytes.lit","notifications/resources/updated"]],["let","doc_b",["ext.json.data_model.parse","notif_json"]],["let","doc",["bytes.view","doc_b"]],["if",["=",["ext.data_model.doc_is_err","doc"],1],["return",1],0],["if",["!=",["ext.data_model.root_kind","doc"],5],["return",1],0],["let","root",["ext.data_model.root_offset","doc"]],["let","m_off",["ext.data_model.map_find","doc","root",["bytes.view","k_method"]]],["if",["<","m_off",0],["return",1],0],["if",["!=",["ext.data_model.kind_at","doc","m_off"],3],["return",1],0],["let","m",["ext.data_model.string_get","doc","m_off"]],["if",["=",["bytes.eq",["bytes.view","m"],["bytes.view","method_target"]],0],["return",1],0],["let","p_off",["ext.data_model.map_find","doc","root",["bytes.view","k_params"]]],["if",["<","p_off",0],["return",0],0],["if",["!=",["ext.data_model.kind_at","doc","p_off"],5],["return",0],0],["let","u_off",["ext.data_model.map_find","doc","p_off",["bytes.view","k_uri"]]],["if",["<","u_off",0],["return",0],0],["if",["!=",["ext.data_model.kind_at","doc","u_off"],3],["return",0],0],["let","uri",["ext.data_model.string_get","doc","u_off"]],["std.mcp.transport.stdio._subs_has_v1","subs",["bytes.view","uri"]]],"kind":"defn","name":"std.mcp.transport.stdio._notif_should_forward_v1","params":[{"name":"subs","ty":"bytes_view"},{"name":"notif_json","ty":"bytes_view"}],"result":"i32"},{"body":["begin",["if",["=",["std.mcp.transport.stdio._subs_has_v1","subs","uri"],1],["std.bytes.copy","subs"],["begin",["let","n",["std.bytes.len","subs"]],["let","m",["std.bytes.len","uri"]],["let","v",["vec_u8.with_capacity",["+",["+","n",4],"m"]]],["set","v",["vec_u8.extend_bytes","v","subs"]],["set","v",["vec_u8.extend_bytes","v",["codec.write_u32_le","m"]]],["set","v",["vec_u8.extend_bytes","v","uri"]],["vec_u8.into_bytes","v"]]]],"kind":"defn","name":"std.mcp.transport.stdio._subs_add_v1","params":[{"name":"subs","ty":"bytes_view"},{"name":"uri","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","n",["std.bytes.len","subs"]],["let","off",0],["for","_",0,2147483647,["begin",["if",[">=u","off","n"],["return",0],0],["if",[">=u",["+","off",4],["+","n",1]],["return",0],0],["let","len",["codec.read_u32_le","subs","off"]],["let","start",["+","off",4]],["if",[">=u",["+","start","len"],["+","n",1]],["return",0],0],["if",["&",["=","len",["std.bytes.len","uri"]],["=",["view.cmp_range","subs","start","len","uri",0,"len"],0]],["return",1],0],["set","off",["+","start","len"]],0]],0],"kind":"defn","name":"std.mcp.transport.stdio._subs_has_v1","params":[{"name":"subs","ty":"bytes_view"},{"name":"uri","ty":"bytes_view"}],"result":"i32"},{"body":["begin",["let","n",["std.bytes.len","subs"]],["let","out",["vec_u8.with_capacity","n"]],["let","off",0],["for","_",0,2147483647,["begin",["if",[">=u","off","n"],["return",["vec_u8.into_bytes","out"]],0],["if",[">=u",["+","off",4],["+","n",1]],["return",["vec_u8.into_bytes","out"]],0],["let","len",["codec.read_u32_le","subs","off"]],["let","start",["+","off",4]],["if",[">=u",["+","start","len"],["+","n",1]],["return",["vec_u8.into_bytes","out"]],0],["let","match",["&",["=","len",["std.bytes.len","uri"]],["=",["view.cmp_range","subs","start","len","uri",0,"len"],0]]],["if",["=","match",1],0,["begin",["set","out",["vec_u8.extend_bytes","out",["codec.write_u32_le","len"]]],["set","out",["vec_u8.extend_bytes","out",["view.slice","subs","start","len"]]],0]],["set","off",["+","start","len"]],0]],["vec_u8.into_bytes","out"]],"kind":"defn","name":"std.mcp.transport.stdio._subs_remove_v1","params":[{"name":"subs","ty":"bytes_view"},{"name":"uri","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","diag",["std.mcp.diag.code_internal_v1"]],["let","detail",["bytes.lit","{}"]],["std.mcp.tool.result.err_v1",["bytes.view","diag"],["bytes.view","message_utf8"],["bytes.view","detail"]]],"kind":"defn","name":"std.mcp.transport.stdio._tool_internal_error_result_v1","params":[{"name":"tool_name","ty":"bytes_view"},{"name":"err_code","ty":"i32"},{"name":"message_utf8","ty":"bytes"}],"result":"bytes"},{"body":["begin",["let","id_null",["bytes.lit","null"]],["let","msg",["bytes.lit","Parse error"]],["let","resp",["std.mcp.jsonrpc.make_error_response_v1",["bytes.view","id_null"],-32700,["bytes.view","msg"],["option_bytes.none"]]],["let","caps_w",["std.bytes.copy","caps0"]],["std.mcp.transport.stdio_loop.write_stdout_json_line_v1",["bytes.view","resp"],"caps_w"],0],"kind":"defn","name":"std.mcp.transport.stdio._write_parse_error_v1","params":[{"name":"caps0","ty":"bytes_view"}],"result":"i32"},{"body":["begin",["let","k_method",["bytes.lit","method"]],["let","k_params",["bytes.lit","params"]],["let","k_request_id",["bytes.lit","requestId"]],["let","method_target",["bytes.lit","notifications/cancelled"]],["for","_",0,2147483647,["begin",["let","caps_r",["std.bytes.copy","caps0"]],["let","line_res",["std.mcp.transport.stdio_loop.read_line_v1","caps_r"]],["let","read_err",["result_bytes.err_code","line_res"]],["if",["!=","read_err",0],["begin",["if",["=","read_err",["std.os.stdio.spec.err_eof_v1"]],["return",["bytes.alloc",0]],0],["task.yield"],0],0],["let","line",["result_bytes.unwrap_or","line_res",["bytes.alloc",0]]],["let","doc_b",["ext.json.data_model.parse",["bytes.view","line"]]],["let","doc",["bytes.view","doc_b"]],["if",["=",["ext.data_model.doc_is_err","doc"],1],0,["begin",["if",["!=",["ext.data_model.root_kind","doc"],5],0,["begin",["let","root",["ext.data_model.root_offset","doc"]],["let","m_off",["ext.data_model.map_find","doc","root",["bytes.view","k_method"]]],["if",["<","m_off",0],0,["begin",["if",["!=",["ext.data_model.kind_at","doc","m_off"],3],0,["begin",["let","m",["ext.data_model.string_get","doc","m_off"]],["if",["=",["bytes.eq",["bytes.view","m"],["bytes.view","method_target"]],1],["begin",["let","p_off",["ext.data_model.map_find","doc","root",["bytes.view","k_params"]]],["if",["<","p_off",0],0,["begin",["if",["!=",["ext.data_model.kind_at","doc","p_off"],5],0,["begin",["let","rid_off",["ext.data_model.map_find","doc","p_off",["bytes.view","k_request_id"]]],["if",["<","rid_off",0],0,["begin",["let","end",["ext.data_model.skip_value","doc","rid_off"]],["if",["<","end",0],0,["begin",["let","val",["view.to_bytes",["view.slice","doc","rid_off",["-","end","rid_off"]]]],["let","rid_json",["std.mcp.util.json.json_from_value_v1",["bytes.view","val"]]],["if",["=",["bytes.eq",["bytes.view","rid_json"],"target_id_json"],1],["begin",["let","cancel_line",["std.mcp.sandbox.worker_proto.make_cancel_v1","target_id_json",["begin",["let","_x07_empty_reason",["bytes.alloc",0]],["bytes.view","_x07_empty_reason"]]]],["if",[">",["std.bytes.len","cancel_line"],0],["chan.bytes.send","cancel_chan","cancel_line"],0],["return",["bytes.alloc",0]]],0]]]]]]]]]],0]]]]]]],0]],["task.yield"],0]],["bytes.alloc",0]],"kind":"defasync","name":"std.mcp.transport.stdio._cancel_reader_v1","params":[{"name":"target_id_json","ty":"bytes_view"},{"name":"cancel_chan","ty":"i32"},{"name":"caps0","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","notif_chan",["chan.bytes.new",64]],["let","cancel_chan",["chan.bytes.new",1]],["if",[">",["std.bytes.len","progress_token_json"],0],["begin",["let","start",["std.mcp.notifications.progress_v1","progress_token_json",0,-1,["begin",["let","_x07_empty_progress_message",["bytes.alloc",0]],["bytes.view","_x07_empty_progress_message"]]]],["let","caps_w0",["std.bytes.copy","caps0"]],["std.mcp.transport.stdio_loop.write_stdout_json_line_v1",["bytes.view","start"],"caps_w0"],0],0],["task.scope_v1",["task.scope.cfg_v1",["max_children",4]],["begin",["let","slot",["task.scope.async_let_bytes_v1",["std.mcp.transport.stdio._tool_task_v1","tool_name","cfg_json","request_ctx_json","args_json","tools_json","notif_chan","cancel_chan"]]],["task.scope.start_soon_v1",["std.mcp.transport.stdio._notif_forwarder_v1","notif_chan","subs","caps0"]],["task.scope.start_soon_v1",["std.mcp.transport.stdio._cancel_reader_v1","id_json","cancel_chan","caps0"]],["let","tool_result",["task.scope.await_slot_bytes_v1","slot"]],["task.scope.cancel_all_v1"],["task.scope.wait_all_v1"],"tool_result"]]],"kind":"defasync","name":"std.mcp.transport.stdio._handle_tool_call_streaming_v1","params":[{"name":"tool_name","ty":"bytes_view"},{"name":"cfg_json","ty":"bytes_view"},{"name":"request_ctx_json","ty":"bytes_view"},{"name":"args_json","ty":"bytes_view"},{"name":"tools_json","ty":"bytes_view"},{"name":"id_json","ty":"bytes_view"},{"name":"progress_token_json","ty":"bytes_view"},{"name":"subs","ty":"bytes_view"},{"name":"caps0","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["for","_",0,2147483647,["begin",["let","nline",["chan.bytes.recv","notif_chan"]],["if",["=",["std.bytes.len","nline"],0],["return",["bytes.alloc",0]],0],["let","_x07_tmp_copy",["std.bytes.copy","nline"]],["if",["=",["std.mcp.transport.stdio._notif_should_forward_v1","subs",["bytes.view","_x07_tmp_copy"]],1],["begin",["let","caps_w",["std.bytes.copy","caps0"]],["std.mcp.transport.stdio_loop.write_stdout_json_line_v1",["bytes.view","nline"],"caps_w"],0],0],["task.yield"],0]],["bytes.alloc",0]],"kind":"defasync","name":"std.mcp.transport.stdio._notif_forwarder_v1","params":[{"name":"notif_chan","ty":"i32"},{"name":"subs","ty":"bytes_view"},{"name":"caps0","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","t",["std.mcp.sandbox.router_exec.call_tool_stream_v1","tool_name","cfg_json","request_ctx_json","args_json","tools_json","out_chan","cancel_chan"]],["let","r",["task.join.result_bytes","t"]],["let","ec",["result_bytes.err_code","r"]],["if",["=","ec",["std.mcp.sandbox.router_exec._err_worker_cancelled_v1"]],["return",["bytes.alloc",0]],0],["if",["!=","ec",0],["return",["std.mcp.transport.stdio._tool_internal_error_result_v1","tool_name","ec",["bytes.lit","tool invocation failed"]]],0],["result_bytes.unwrap_or","r",["bytes.alloc",0]]],"kind":"defasync","name":"std.mcp.transport.stdio._tool_task_v1","params":[{"name":"tool_name","ty":"bytes_view"},{"name":"cfg_json","ty":"bytes_view"},{"name":"request_ctx_json","ty":"bytes_view"},{"name":"args_json","ty":"bytes_view"},{"name":"tools_json","ty":"bytes_view"},{"name":"out_chan","ty":"i32"},{"name":"cancel_chan","ty":"i32"}],"result":"bytes"},{"body":["begin",["let","cfg_res",["std.mcp.toolkit.server_cfg_file.load_server_cfg_from_fs_v1","cfg_path"]],["if",["!=",["result_bytes.err_code","cfg_res"],0],["return",["bytes.lit","err_cfg"]],0],["let","cfg_json",["result_bytes.unwrap_or","cfg_res",["bytes.alloc",0]]],["let","server_name",["std.mcp.toolkit.server_cfg_file.server_name_v1",["bytes.view","cfg_json"]]],["let","server_version",["std.mcp.toolkit.server_cfg_file.server_version_v1",["bytes.view","cfg_json"]]],["let","cfg_pv",["std.mcp.toolkit.server_cfg_file.server_protocol_version_v1",["bytes.view","cfg_json"]]],["let","supported_pv",["std.mcp.protocol.mcp_protocol_version_v1"]],["if",["=",["bytes.eq",["bytes.view","cfg_pv"],["bytes.view","supported_pv"]],0],["return",["bytes.lit","err_pv"]],0],["let","tools_path",["std.mcp.toolkit.server_cfg_file.tools_manifest_path_v1",["bytes.view","cfg_json"]]],["let","tools_res",["std.mcp.toolkit.tools_file.load_tools_from_fs_v1",["bytes.view","tools_path"]]],["if",["!=",["result_bytes.err_code","tools_res"],0],["return",["bytes.lit","err_tools"]],0],["let","tools_json",["result_bytes.unwrap_or","tools_res",["bytes.alloc",0]]],["let","fs_caps",["std.os.fs.spec.caps_default_v1"]],["let","resources_json",["bytes.alloc",0]],["let","resources_read",["std.os.fs.read_all_v1",["bytes.lit","config/mcp.resources.json"],["std.bytes.copy","fs_caps"]]],["let","resources_read_code",["result_bytes.err_code","resources_read"]],["if",["=","resources_read_code",0],["begin",["let","resources_raw",["result_bytes.unwrap_or","resources_read",["bytes.alloc",0]]],["let","resources_res",["std.mcp.toolkit.resources_file.load_resources_from_json_v1",["bytes.view","resources_raw"]]],["if",["!=",["result_bytes.err_code","resources_res"],0],["return",["bytes.lit","err_resources"]],0],["set","resources_json",["result_bytes.unwrap_or","resources_res",["bytes.alloc",0]]],0],0],["if",["if",["!=","resources_read_code",0],["!=","resources_read_code",["std.os.fs.spec.err_not_found_v1"]],0],["return",["bytes.lit","err_resources_read"]],0],["let","prompts_json",["bytes.alloc",0]],["let","prompts_read",["std.os.fs.read_all_v1",["bytes.lit","config/mcp.prompts.json"],["std.bytes.copy","fs_caps"]]],["let","prompts_read_code",["result_bytes.err_code","prompts_read"]],["if",["=","prompts_read_code",0],["begin",["let","prompts_raw",["result_bytes.unwrap_or","prompts_read",["bytes.alloc",0]]],["let","prompts_res",["std.mcp.toolkit.prompts_file.load_prompts_from_json_v1",["bytes.view","prompts_raw"]]],["if",["!=",["result_bytes.err_code","prompts_res"],0],["return",["bytes.lit","err_prompts"]],0],["set","prompts_json",["result_bytes.unwrap_or","prompts_res",["bytes.alloc",0]]],0],0],["if",["if",["!=","prompts_read_code",0],["!=","prompts_read_code",["std.os.fs.spec.err_not_found_v1"]],0],["return",["bytes.lit","err_prompts_read"]],0],["let","max_line_bytes",["std.mcp.toolkit.server_cfg_file.transport_max_line_bytes_v1",["bytes.view","cfg_json"]]],["let","default_max",1048576],["let","max_line_bytes2",["if",[">","max_line_bytes",0],"max_line_bytes","default_max"]],["let","caps0",["std.os.stdio.spec.caps_pack_v1","max_line_bytes2","max_line_bytes2",0]],["let","state",0],["let","subs",["bytes.alloc",0]],["for","_",0,2147483647,["begin",["let","line_ok",1],["let","caps_r",["std.bytes.copy","caps0"]],["let","line_res",["std.mcp.transport.stdio_loop.read_line_v1","caps_r"]],["let","read_err",["result_bytes.err_code","line_res"]],["if",["!=","read_err",0],["begin",["if",["=","read_err",["std.os.stdio.spec.err_eof_v1"]],["return",["bytes.lit","eof"]],0],["if",["=","read_err",["std.os.stdio.spec.err_too_large_v1"]],["begin",["std.mcp.transport.stdio._write_parse_error_v1",["bytes.view","caps0"]],["set","line_ok",0],0],0],["if",["=","line_ok",1],["return",["bytes.lit","err_read"]],0],0],0],["if",["=","line_ok",0],0,["begin",["let","line",["result_bytes.unwrap_or","line_res",["bytes.alloc",0]]],["let","step_res",["std.mcp.toolkit.stdio_dispatch.dispatch_line_v1","state","cfg_pv","server_name","server_version","tools_json","resources_json","prompts_json",["bytes.view","line"]]],["if",["!=",["result_bytes.err_code","step_res"],0],["return",["bytes.lit","err_dispatch"]],0],["let","step",["result_bytes.unwrap_or","step_res",["bytes.alloc",0]]],["let","kind",["std.mcp.toolkit.stdio_dispatch.step_kind_v1",["bytes.view","step"]]],["let","next_state",["std.mcp.toolkit.stdio_dispatch.step_next_state_v1",["bytes.view","step"]]],["if",["<","next_state",0],["return",["bytes.lit","err_state"]],0],["if",["=","kind",1],["begin",["let","resp_json",["std.mcp.toolkit.stdio_dispatch.step_resp_json_v1",["bytes.view","step"]]],["let","caps_w",["std.bytes.copy","caps0"]],["std.mcp.transport.stdio_loop.write_stdout_json_line_v1","resp_json","caps_w"],0],0],["if",["=","kind",3],["begin",["let","id_json",["std.mcp.toolkit.stdio_dispatch.step_subscribe_id_json_v1",["bytes.view","step"]]],["let","uri",["std.mcp.toolkit.stdio_dispatch.step_subscribe_uri_v1",["bytes.view","step"]]],["set","subs",["std.mcp.transport.stdio._subs_add_v1",["bytes.view","subs"],"uri"]],["let","resp",["std.mcp.jsonrpc.make_result_response_v1","id_json",["begin",["let","_x07_empty_obj",["bytes.lit","{}"]],["bytes.view","_x07_empty_obj"]]]],["let","caps_w",["std.bytes.copy","caps0"]],["std.mcp.transport.stdio_loop.write_stdout_json_line_v1",["bytes.view","resp"],"caps_w"],0],0],["if",["=","kind",4],["begin",["let","id_json",["std.mcp.toolkit.stdio_dispatch.step_unsubscribe_id_json_v1",["bytes.view","step"]]],["let","uri",["std.mcp.toolkit.stdio_dispatch.step_unsubscribe_uri_v1",["bytes.view","step"]]],["set","subs",["std.mcp.transport.stdio._subs_remove_v1",["bytes.view","subs"],"uri"]],["let","resp",["std.mcp.jsonrpc.make_result_response_v1","id_json",["begin",["let","_x07_empty_obj",["bytes.lit","{}"]],["bytes.view","_x07_empty_obj"]]]],["let","caps_w",["std.bytes.copy","caps0"]],["std.mcp.transport.stdio_loop.write_stdout_json_line_v1",["bytes.view","resp"],"caps_w"],0],0],["if",["=","kind",2],["begin",["let","id_json",["std.mcp.toolkit.stdio_dispatch.step_tool_call_id_json_v1",["bytes.view","step"]]],["let","tool_name",["std.mcp.toolkit.stdio_dispatch.step_tool_call_tool_name_v1",["bytes.view","step"]]],["let","args_json",["std.mcp.toolkit.stdio_dispatch.step_tool_call_args_json_v1",["bytes.view","step"]]],["let","progress_token_json",["std.mcp.toolkit.stdio_dispatch.step_tool_call_progress_token_v1",["bytes.view","step"]]],["let","request_ctx_json",["std.mcp.ctx.with_meta_v1","cfg_json","id_json","progress_token_json",["begin",["let","_x07_empty_session_id",["bytes.alloc",0]],["bytes.view","_x07_empty_session_id"]]]],["let","tr_task",["std.mcp.transport.stdio._handle_tool_call_streaming_v1","tool_name",["bytes.view","cfg_json"],["bytes.view","request_ctx_json"],"args_json","tools_json","id_json","progress_token_json",["bytes.view","subs"],["bytes.view","caps0"]]],["let","tr",["await","tr_task"]],["if",[">",["std.bytes.len","progress_token_json"],0],["if",[">",["std.bytes.len","tr"],0],["begin",["let","done",["std.mcp.notifications.progress_v1","progress_token_json",1,1,["begin",["let","_x07_empty_progress_done_message",["bytes.alloc",0]],["bytes.view","_x07_empty_progress_done_message"]]]],["let","caps_wd",["std.bytes.copy","caps0"]],["std.mcp.transport.stdio_loop.write_stdout_json_line_v1",["bytes.view","done"],"caps_wd"],0],0],0],["if",[">",["std.bytes.len","tr"],0],["begin",["let","resp",["std.mcp.jsonrpc.make_result_response_v1","id_json",["bytes.view","tr"]]],["let","caps_w",["std.bytes.copy","caps0"]],["std.mcp.transport.stdio_loop.write_stdout_json_line_v1",["bytes.view","resp"],"caps_w"],0],0],0],0],["set","state","next_state"],0]],0]],["bytes.lit","done"]],"kind":"defasync","name":"std.mcp.transport.stdio.serve_from_fs_v1","params":[{"name":"cfg_path","ty":"bytes_view"}],"result":"bytes"}],"imports":["ext.data_model","ext.json.data_model","std.bytes","std.mcp.ctx","std.mcp.diag","std.mcp.jsonrpc","std.mcp.notifications","std.mcp.protocol","std.mcp.sandbox.router_exec","std.mcp.sandbox.worker_proto","std.mcp.tool.result","std.mcp.toolkit.prompts_file","std.mcp.toolkit.resources_file","std.mcp.toolkit.server_cfg_file","std.mcp.toolkit.stdio_dispatch","std.mcp.toolkit.tools_file","std.mcp.transport.stdio_loop","std.mcp.util.json","std.os.fs","std.os.fs.spec","std.os.stdio.spec"],"kind":"module","module_id":"std.mcp.transport.stdio","schema_version":"x07.x07ast@0.5.0"}
