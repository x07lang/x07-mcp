{"decls":[{"kind":"export","names":["std.mcp.transport.stdio.serve_from_fs_v1"]},{"body":["begin",["let","caps_r",["std.bytes.copy","caps0"]],["let","line_res",["std.mcp.transport.stdio_loop.read_line_v1","caps_r"]],["let","read_err",["result_bytes.err_code","line_res"]],["if",["!=","read_err",0],["begin",["if",["=","read_err",["std.os.stdio.spec.err_eof_v1"]],["return",["result_i32.ok",["-",0,1]]],0],["if",["=","read_err",["std.os.stdio.spec.err_too_large_v1"]],["begin",["let","id_null",["bytes.lit","null"]],["let","msg",["bytes.lit","Parse error"]],["let","resp",["std.mcp.jsonrpc.make_error_response_v1",["bytes.view","id_null"],-32700,["bytes.view","msg"],["option_bytes.none"]]],["let","caps_w",["std.bytes.copy","caps0"]],["std.mcp.transport.stdio_loop.write_stdout_json_line_v1",["bytes.view","resp"],"caps_w"],["return",["result_i32.ok","state"]]],0],["return",["result_i32.err",2]]],0],["let","line",["result_bytes.unwrap_or","line_res",["bytes.alloc",0]]],["let","step_res",["std.mcp.toolkit.stdio_dispatch.dispatch_line_v1","state","cfg_pv","server_name","server_version","tools_json",["bytes.view","line"]]],["if",["!=",["result_bytes.err_code","step_res"],0],["return",["result_i32.err",["result_bytes.err_code","step_res"]]],0],["let","step",["result_bytes.unwrap_or","step_res",["bytes.alloc",0]]],["let","kind",["std.mcp.toolkit.stdio_dispatch.step_kind_v1",["bytes.view","step"]]],["let","next_state",["std.mcp.toolkit.stdio_dispatch.step_next_state_v1",["bytes.view","step"]]],["if",["<","next_state",0],["return",["result_i32.err",7222]],0],["if",["=","kind",0],["return",["result_i32.ok","next_state"]],0],["if",["=","kind",1],["begin",["let","resp_json",["std.mcp.toolkit.stdio_dispatch.step_resp_json_v1",["bytes.view","step"]]],["if",["=",["bytes.len","resp_json"],0],["return",["result_i32.err",7223]],0],["let","caps_w",["std.bytes.copy","caps0"]],["std.mcp.transport.stdio_loop.write_stdout_json_line_v1","resp_json","caps_w"],["return",["result_i32.ok","next_state"]]],0],["if",["=","kind",2],["begin",["let","id_json",["std.mcp.toolkit.stdio_dispatch.step_tool_call_id_json_v1",["bytes.view","step"]]],["let","tool_name",["std.mcp.toolkit.stdio_dispatch.step_tool_call_tool_name_v1",["bytes.view","step"]]],["let","args_json",["std.mcp.toolkit.stdio_dispatch.step_tool_call_args_json_v1",["bytes.view","step"]]],["if",["=",["bytes.len","id_json"],0],["return",["result_i32.err",7224]],0],["if",["=",["bytes.len","tool_name"],0],["return",["result_i32.err",7224]],0],["if",["=",["bytes.len","args_json"],0],["return",["result_i32.err",7224]],0],["let","tool_res",["std.mcp.sandbox.router_exec.call_tool_oneshot_v1","tool_name","cfg_json","args_json","tools_json"]],["let","tr",["if",["!=",["result_bytes.err_code","tool_res"],0],["std.mcp.transport.stdio._tool_internal_error_result_v1","tool_name",["result_bytes.err_code","tool_res"],["bytes.lit","tool invocation failed"]],["result_bytes.unwrap_or","tool_res",["bytes.alloc",0]]]],["let","resp",["std.mcp.jsonrpc.make_result_response_v1","id_json",["bytes.view","tr"]]],["let","caps_w",["std.bytes.copy","caps0"]],["std.mcp.transport.stdio_loop.write_stdout_json_line_v1",["bytes.view","resp"],"caps_w"],["return",["result_i32.ok","next_state"]]],0],["result_i32.err",7225]],"kind":"defn","name":"std.mcp.transport.stdio._serve_step_v1","params":[{"name":"state","ty":"i32"},{"name":"cfg_json","ty":"bytes_view"},{"name":"server_name","ty":"bytes_view"},{"name":"server_version","ty":"bytes_view"},{"name":"cfg_pv","ty":"bytes_view"},{"name":"tools_json","ty":"bytes_view"},{"name":"caps0","ty":"bytes_view"}],"result":"result_i32"},{"body":["begin",["let","diag",["std.mcp.diag.code_internal_v1"]],["let","detail",["bytes.lit","{}"]],["std.mcp.tool.result.err_v1",["bytes.view","diag"],["bytes.view","message_utf8"],["bytes.view","detail"]]],"kind":"defn","name":"std.mcp.transport.stdio._tool_internal_error_result_v1","params":[{"name":"tool_name","ty":"bytes_view"},{"name":"err_code","ty":"i32"},{"name":"message_utf8","ty":"bytes"}],"result":"bytes"},{"body":["begin",["let","cfg_res",["std.mcp.toolkit.server_cfg_file.load_server_cfg_from_fs_v1","cfg_path"]],["if",["!=",["result_bytes.err_code","cfg_res"],0],["return",2],0],["let","cfg_json",["result_bytes.unwrap_or","cfg_res",["bytes.alloc",0]]],["let","server_name",["std.mcp.toolkit.server_cfg_file.server_name_v1",["bytes.view","cfg_json"]]],["let","server_version",["std.mcp.toolkit.server_cfg_file.server_version_v1",["bytes.view","cfg_json"]]],["let","cfg_pv",["std.mcp.toolkit.server_cfg_file.server_protocol_version_v1",["bytes.view","cfg_json"]]],["let","supported_pv",["std.mcp.protocol.mcp_protocol_version_v1"]],["if",["=",["bytes.eq",["bytes.view","cfg_pv"],["bytes.view","supported_pv"]],0],["return",2],0],["let","tools_path",["std.mcp.toolkit.server_cfg_file.tools_manifest_path_v1",["bytes.view","cfg_json"]]],["let","tools_res",["std.mcp.toolkit.tools_file.load_tools_from_fs_v1",["bytes.view","tools_path"]]],["if",["!=",["result_bytes.err_code","tools_res"],0],["return",2],0],["let","tools_json",["result_bytes.unwrap_or","tools_res",["bytes.alloc",0]]],["let","max_line_bytes",["std.mcp.toolkit.server_cfg_file.transport_max_line_bytes_v1",["bytes.view","cfg_json"]]],["let","default_max",1048576],["let","max_line_bytes2",["if",[">","max_line_bytes",0],"max_line_bytes","default_max"]],["let","caps0",["std.os.stdio.spec.caps_pack_v1","max_line_bytes2","max_line_bytes2",0]],["let","state",0],["for","_",0,2147483647,["begin",["let","step",["std.mcp.transport.stdio._serve_step_v1","state",["bytes.view","cfg_json"],["bytes.view","server_name"],["bytes.view","server_version"],["bytes.view","cfg_pv"],["bytes.view","tools_json"],["bytes.view","caps0"]]],["if",["!=",["result_i32.err_code","step"],0],["return",["result_i32.err_code","step"]],0],["let","next_state",["result_i32.unwrap_or","step",0]],["if",["<","next_state",0],["return",0],0],["set","state","next_state"],0]],0],"kind":"defn","name":"std.mcp.transport.stdio.serve_from_fs_v1","params":[{"name":"cfg_path","ty":"bytes_view"}],"result":"i32"}],"imports":["std.bytes","std.mcp.diag","std.mcp.jsonrpc","std.mcp.protocol","std.mcp.sandbox.router_exec","std.mcp.tool.result","std.mcp.toolkit.server_cfg_file","std.mcp.toolkit.stdio_dispatch","std.mcp.toolkit.tools_file","std.mcp.transport.stdio_loop","std.os.stdio.spec"],"kind":"module","module_id":"std.mcp.transport.stdio","schema_version":"x07.x07ast@0.5.0"}
