{"decls":[{"kind":"export","names":["std.mcp.sandbox.task_exec_async_pool_v1.worker_v1"]},{"body":["ext.time.rfc3339.format_v1","unix_lo","unix_hi",0,0,["bytes.alloc",0]],"kind":"defn","name":"std.mcp.sandbox.task_exec_async_pool_v1._clock_now_fixed_rfc3339_v1","params":[{"name":"unix_lo","ty":"i32"},{"name":"unix_hi","ty":"i32"}],"result":"bytes"},{"body":["if",["=","clock_step_ms",0],["ext.time.os.now_rfc3339_utc_v1"],["std.mcp.sandbox.task_exec_async_pool_v1._clock_now_fixed_rfc3339_v1","unix_lo","unix_hi"]],"kind":"defn","name":"std.mcp.sandbox.task_exec_async_pool_v1._clock_now_rfc3339_v1","params":[{"name":"unix_lo","ty":"i32"},{"name":"unix_hi","ty":"i32"},{"name":"clock_step_ms","ty":"i32"}],"result":"bytes"},{"body":["begin",["let","st",["std.parse.i32_status_le","b"]],["if",["if",[">=u",["bytes.len","st"],5],["=",["bytes.get_u8","st",0],1],0],["codec.read_u32_le","st",1],-1]],"kind":"defn","name":"std.mcp.sandbox.task_exec_async_pool_v1._parse_i32_or_neg1_v1","params":[{"name":"b","ty":"bytes_view"}],"result":"i32"},{"body":["begin",["let","doc_b",["ext.json.data_model.parse","tool_result_json"]],["let","doc",["bytes.view","doc_b"]],["if",["=",["ext.data_model.doc_is_err","doc"],1],["return",1],0],["if",["!=",["ext.data_model.root_kind","doc"],5],["return",1],0],["let","root",["ext.data_model.root_offset","doc"]],["let","k_is_error",["bytes.lit","isError"]],["let","off",["ext.data_model.map_find","doc","root",["bytes.view","k_is_error"]]],["if",["<","off",0],["return",0],0],["if",["!=",["ext.data_model.kind_at","doc","off"],1],["return",0],0],["ext.data_model.bool_get","doc","off"]],"kind":"defn","name":"std.mcp.sandbox.task_exec_async_pool_v1._tool_result_is_error_v1","params":[{"name":"tool_result_json","ty":"bytes_view"}],"result":"i32"},{"body":["begin",["let","k_method",["bytes.lit","method"]],["let","k_params",["bytes.lit","params"]],["let","k_progress",["bytes.lit","progress"]],["let","k_total",["bytes.lit","total"]],["let","k_message",["bytes.lit","message"]],["let","want_method",["bytes.lit","notifications/progress"]],["let","want_method_set_status",["bytes.lit","x07.mcp/internal/task/set_status_message"]],["for","_",0,2147483647,["begin",["let","line",["chan.bytes.recv","worker_out_chan_handle"]],["if",["=",["bytes.len",["bytes.view","line"]],0],["return",["bytes.alloc",0]],0],["begin",["let","doc_b",["ext.json.data_model.parse",["bytes.view","line"]]],["let","doc",["bytes.view","doc_b"]],["let","doc_ok",["&",["=",["ext.data_model.doc_is_err","doc"],0],["=",["ext.data_model.root_kind","doc"],5]]],["if",["=","doc_ok",1],["begin",["let","root",["ext.data_model.root_offset","doc"]],["let","m_off",["ext.data_model.map_find","doc","root",["bytes.view","k_method"]]],["if",["&",[">=","m_off",0],["=",["ext.data_model.kind_at","doc","m_off"],3]],["begin",["let","m",["ext.data_model.string_get","doc","m_off"]],["if",["=",["bytes.eq",["bytes.view","m"],["bytes.view","want_method_set_status"]],1],["begin",["let","st",["std.mcp.sandbox.task_store_any_v1.get_task_status_v1",["bytes.view","store_any"],"auth_context_id","task_id_utf8"]],["if",["&",[">=","st",0],["<","st",2]],["begin",["let","params_off",["ext.data_model.map_find","doc","root",["bytes.view","k_params"]]],["if",["&",[">=","params_off",0],["=",["ext.data_model.kind_at","doc","params_off"],5]],["begin",["let","msg_off",["ext.data_model.map_find","doc","params_off",["bytes.view","k_message"]]],["if",["&",[">=","msg_off",0],["=",["ext.data_model.kind_at","doc","msg_off"],3]],["begin",["let","msg_utf8",["ext.data_model.string_get","doc","msg_off"]],["let","last_updated_at",["std.mcp.sandbox.task_exec_async_pool_v1._clock_now_rfc3339_v1","clock_lo","clock_hi","clock_step_ms"]],["let","_",["std.mcp.sandbox.task_store_any_v1.set_task_status_message_v1",["std.bytes.copy",["bytes.view","store_any"]],"auth_context_id","task_id_utf8",["bytes.view","last_updated_at"],["bytes.view","msg_utf8"]]],0],0],0],0],0],0],0],0],["if",["&",["=",["bytes.eq",["bytes.view","m"],["bytes.view","want_method"]],1],[">",["view.len","progress_token_json"],0]],["begin",["let","st",["std.mcp.sandbox.task_store_any_v1.get_task_status_v1",["bytes.view","store_any"],"auth_context_id","task_id_utf8"]],["if",["&",[">=","st",0],["<","st",2]],["begin",["let","params_off",["ext.data_model.map_find","doc","root",["bytes.view","k_params"]]],["if",["&",[">=","params_off",0],["=",["ext.data_model.kind_at","doc","params_off"],5]],["begin",["let","p_off",["ext.data_model.map_find","doc","params_off",["bytes.view","k_progress"]]],["if",["&",[">=","p_off",0],["=",["ext.data_model.kind_at","doc","p_off"],2]],["begin",["let","p_raw",["ext.data_model.number_get","doc","p_off"]],["let","progress_i32",["std.mcp.sandbox.task_exec_async_pool_v1._parse_i32_or_neg1_v1",["bytes.view","p_raw"]]],["if",[">=","progress_i32",0],["begin",["let","total_i32",-1],["let","t_off",["ext.data_model.map_find","doc","params_off",["bytes.view","k_total"]]],["if",["&",[">=","t_off",0],["=",["ext.data_model.kind_at","doc","t_off"],2]],["begin",["let","t_raw",["ext.data_model.number_get","doc","t_off"]],["set","total_i32",["std.mcp.sandbox.task_exec_async_pool_v1._parse_i32_or_neg1_v1",["bytes.view","t_raw"]]],0],0],["let","msg_utf8",["bytes.alloc",0]],["let","msg_off",["ext.data_model.map_find","doc","params_off",["bytes.view","k_message"]]],["if",["&",[">=","msg_off",0],["=",["ext.data_model.kind_at","doc","msg_off"],3]],["begin",["set","msg_utf8",["ext.data_model.string_get","doc","msg_off"]],0],0],["if",["&",["=",["bytes.len",["bytes.view","msg_utf8"]],0],[">=","total_i32",1]],["begin",["let","k1",["std.fmt.s32_to_dec","progress_i32"]],["let","k2",["std.fmt.s32_to_dec","total_i32"]],["let","pfx",["bytes.lit","step "]],["let","mid",["bytes.lit","/"]],["let","t1",["std.bytes.concat",["bytes.view","pfx"],["bytes.view","k1"]]],["let","t2",["std.bytes.concat",["bytes.view","t1"],["bytes.view","mid"]]],["set","msg_utf8",["std.bytes.concat",["bytes.view","t2"],["bytes.view","k2"]]],0],0],["if",["&",[">=","progress_i32",1],[">=","total_i32",1]],["begin",["let","last_updated_at",["std.mcp.sandbox.task_exec_async_pool_v1._clock_now_rfc3339_v1","clock_lo","clock_hi","clock_step_ms"]],["let","_",["std.mcp.sandbox.task_store_any_v1.set_task_working_step_v1",["std.bytes.copy",["bytes.view","store_any"]],"auth_context_id","task_id_utf8",["bytes.view","last_updated_at"],"progress_i32","total_i32"]],0],0],["let","notif",["std.mcp.notifications.progress_related_task_v1","progress_token_json","progress_i32","total_i32",["bytes.view","msg_utf8"],"task_id_utf8"]],["begin",["let","_notif_v",["bytes.view","notif"]],["if",[">",["bytes.len","_notif_v"],0],["begin",["chan.bytes.send","event_chan_handle","notif"],0],0]],0],0],0],0],0],0],0],0],0],0],["if",["&",["=",["bytes.eq",["bytes.view","m"],["bytes.view","want_method_set_status"]],0],["=",["bytes.eq",["bytes.view","m"],["bytes.view","want_method"]],0]],["begin",["let","line_v",["bytes.view","line"]],["if",[">",["bytes.len","line_v"],0],["begin",["chan.bytes.send","event_chan_handle","line"],0],0],0],0],0],0],0],0],["task.yield"],0],0]],["bytes.alloc",0]],"kind":"defasync","name":"std.mcp.sandbox.task_exec_async_pool_v1._forward_progress_notifs_v1","params":[{"name":"store_any","ty":"bytes"},{"name":"auth_context_id","ty":"bytes_view"},{"name":"task_id_utf8","ty":"bytes_view"},{"name":"clock_lo","ty":"i32"},{"name":"clock_hi","ty":"i32"},{"name":"clock_step_ms","ty":"i32"},{"name":"progress_token_json","ty":"bytes_view"},{"name":"worker_out_chan_handle","ty":"i32"},{"name":"event_chan_handle","ty":"i32"}],"result":"bytes"},{"body":["begin",["let","tool_name_res",["std.mcp.sandbox.task_store_any_v1.get_task_tool_name_v1",["bytes.view","store_any"],["bytes.view","auth_context_id"],"task_id_utf8"]],["let","args_res",["std.mcp.sandbox.task_store_any_v1.get_task_args_json_v1",["bytes.view","store_any"],["bytes.view","auth_context_id"],"task_id_utf8"]],["let","rid_res",["std.mcp.sandbox.task_store_any_v1.get_task_request_id_json_v1",["bytes.view","store_any"],["bytes.view","auth_context_id"],"task_id_utf8"]],["let","pt_res",["std.mcp.sandbox.task_store_any_v1.get_task_progress_token_json_v1",["bytes.view","store_any"],["bytes.view","auth_context_id"],"task_id_utf8"]],["let","tool_name",["result_bytes.unwrap_or","tool_name_res",["bytes.alloc",0]]],["let","args_json",["result_bytes.unwrap_or","args_res",["bytes.lit","{}"]]],["let","rid_json",["result_bytes.unwrap_or","rid_res",["bytes.lit","null"]]],["let","pt_json",["result_bytes.unwrap_or","pt_res",["bytes.alloc",0]]],["let","empty_session",["bytes.alloc",0]],["let","ctx_json",["std.mcp.ctx.with_meta_v1","cfg_json",["bytes.view","rid_json"],["bytes.view","pt_json"],["bytes.view","empty_session"]]],["let","out_chan",["chan.bytes.new",256]],["let","store_any_fwd",["std.bytes.copy",["bytes.view","store_any"]]],["let","tool_res",["task.scope_v1",["task.scope.cfg_v1",["max_children",3]],["begin",["let","fwd_slot",["task.scope.async_let_bytes_v1",["std.mcp.sandbox.task_exec_async_pool_v1._forward_progress_notifs_v1","store_any_fwd",["bytes.view","auth_context_id"],"task_id_utf8","clock_lo","clock_hi","clock_step_ms",["bytes.view","pt_json"],"out_chan","event_chan_handle"]]],["let","slot",["task.scope.async_let_result_bytes_v1",["std.mcp.sandbox.router_exec.call_tool_stream_v1",["bytes.view","tool_name"],"cfg_json",["bytes.view","ctx_json"],["bytes.view","args_json"],"tools_json","out_chan","cancel_chan_handle"]]],["let","res",["task.scope.await_slot_result_bytes_v1","slot"]],["chan.bytes.close","out_chan"],["let","_",["task.scope.await_slot_bytes_v1","fwd_slot"]],["task.scope.cancel_all_v1"],["task.scope.wait_all_v1"],"res"]]],["if",["!=",["result_bytes.err_code","tool_res"],0],["return",["bytes.alloc",0]],0],["let","st",["std.mcp.sandbox.task_store_any_v1.get_task_status_v1",["bytes.view","store_any"],["bytes.view","auth_context_id"],"task_id_utf8"]],["if",["=","st",4],["return",["bytes.alloc",0]],0],["let","tr",["result_bytes.unwrap_or","tool_res",["bytes.alloc",0]]],["let","is_err",["std.mcp.sandbox.task_exec_async_pool_v1._tool_result_is_error_v1",["bytes.view","tr"]]],["let","last_updated_at",["std.mcp.sandbox.task_exec_async_pool_v1._clock_now_rfc3339_v1","clock_lo","clock_hi","clock_step_ms"]],["if",["=","is_err",0],["begin",["let","res_store0",["std.bytes.copy",["bytes.view","store_any"]]],["let","res",["std.mcp.sandbox.task_store_any_v1.set_task_completed_v1","store_any",["bytes.view","auth_context_id"],"task_id_utf8",["bytes.view","last_updated_at"],["bytes.view","tr"]]],["let","store2",["if",["=",["result_bytes.err_code","res"],0],["result_bytes.unwrap_or","res","res_store0"],"res_store0"]],["set","store_any","store2"],["bytes.alloc",0]],["begin",["let","empty_status_message",["bytes.alloc",0]],["let","res_store0",["std.bytes.copy",["bytes.view","store_any"]]],["let","res",["std.mcp.sandbox.task_store_any_v1.set_task_failed_with_result_v1","store_any",["bytes.view","auth_context_id"],"task_id_utf8",["bytes.view","last_updated_at"],["bytes.view","empty_status_message"],["bytes.view","tr"]]],["let","store2",["if",["=",["result_bytes.err_code","res"],0],["result_bytes.unwrap_or","res","res_store0"],"res_store0"]],["set","store_any","store2"],["bytes.alloc",0]]],["if",["=",["std.mcp.toolkit.server_cfg_file.tasks_notif_status_enabled_v1","cfg_json"],1],["begin",["let","task_json_res",["std.mcp.sandbox.task_store_any_v1.get_task_json_v1",["bytes.view","store_any"],["bytes.view","auth_context_id"],"task_id_utf8"]],["let","task_json",["result_bytes.unwrap_or","task_json_res",["bytes.alloc",0]]],["let","task_json_v",["bytes.view","task_json"]],["if",[">",["bytes.len","task_json_v"],0],["begin",["let","notif",["std.mcp.notifications.tasks_status_v1","task_json_v"]],["let","notif_v",["bytes.view","notif"]],["if",[">",["bytes.len","notif_v"],0],["begin",["chan.bytes.send","event_chan_handle","notif"],0],0],0],0],["bytes.alloc",0]],["bytes.alloc",0]]],"kind":"defasync","name":"std.mcp.sandbox.task_exec_async_pool_v1.worker_v1","params":[{"name":"cfg_json","ty":"bytes_view"},{"name":"tools_json","ty":"bytes_view"},{"name":"store_any","ty":"bytes"},{"name":"auth_context_id","ty":"bytes"},{"name":"clock_lo","ty":"i32"},{"name":"clock_hi","ty":"i32"},{"name":"clock_step_ms","ty":"i32"},{"name":"task_id_utf8","ty":"bytes_view"},{"name":"cancel_chan_handle","ty":"i32"},{"name":"event_chan_handle","ty":"i32"}],"result":"bytes"}],"imports":["ext.data_model","ext.json.data_model","ext.time.os","ext.time.rfc3339","std.bytes","std.codec","std.fmt","std.mcp.ctx","std.mcp.notifications","std.mcp.sandbox.router_exec","std.mcp.sandbox.task_store_any_v1","std.mcp.toolkit.server_cfg_file","std.parse"],"kind":"module","module_id":"std.mcp.sandbox.task_exec_async_pool_v1","schema_version":"x07.x07ast@0.5.0"}
