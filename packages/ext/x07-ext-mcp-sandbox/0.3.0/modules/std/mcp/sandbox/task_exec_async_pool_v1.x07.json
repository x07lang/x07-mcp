{"decls":[{"kind":"export","names":["std.mcp.sandbox.task_exec_async_pool_v1.worker_v1"]},{"body":["ext.time.rfc3339.format_v1","unix_lo","unix_hi",0,0,["bytes.alloc",0]],"kind":"defn","name":"std.mcp.sandbox.task_exec_async_pool_v1._clock_now_fixed_rfc3339_v1","params":[{"name":"unix_lo","ty":"i32"},{"name":"unix_hi","ty":"i32"}],"result":"bytes"},{"body":["if",["=","clock_step_ms",0],["ext.time.os.now_rfc3339_utc_v1"],["std.mcp.sandbox.task_exec_async_pool_v1._clock_now_fixed_rfc3339_v1","unix_lo","unix_hi"]],"kind":"defn","name":"std.mcp.sandbox.task_exec_async_pool_v1._clock_now_rfc3339_v1","params":[{"name":"unix_lo","ty":"i32"},{"name":"unix_hi","ty":"i32"},{"name":"clock_step_ms","ty":"i32"}],"result":"bytes"},{"body":["begin",["let","doc_b",["ext.json.data_model.parse","tool_result_json"]],["let","doc",["bytes.view","doc_b"]],["if",["=",["ext.data_model.doc_is_err","doc"],1],["return",1],0],["if",["!=",["ext.data_model.root_kind","doc"],5],["return",1],0],["let","root",["ext.data_model.root_offset","doc"]],["let","k_is_error",["bytes.lit","isError"]],["let","off",["ext.data_model.map_find","doc","root",["bytes.view","k_is_error"]]],["if",["<","off",0],["return",0],0],["if",["!=",["ext.data_model.kind_at","doc","off"],1],["return",0],0],["ext.data_model.bool_get","doc","off"]],"kind":"defn","name":"std.mcp.sandbox.task_exec_async_pool_v1._tool_result_is_error_v1","params":[{"name":"tool_result_json","ty":"bytes_view"}],"result":"i32"},{"body":["begin",["for","_",0,2147483647,["begin",["let","msg_res",["chan.bytes.try_recv","ch_handle"]],["let","code",["result_bytes.err_code","msg_res"]],["if",["=","code",0],0,["if",["=","code",1],["task.yield"],["return",["bytes.alloc",0]]]],0]],["bytes.alloc",0]],"kind":"defasync","name":"std.mcp.sandbox.task_exec_async_pool_v1._drain_chan_v1","params":[{"name":"ch_handle","ty":"i32"}],"result":"bytes"},{"body":["begin",["let","tool_name_res",["std.mcp.sandbox.task_store_any_v1.get_task_tool_name_v1",["bytes.view","store_any"],["bytes.view","auth_context_id"],"task_id_utf8"]],["let","args_res",["std.mcp.sandbox.task_store_any_v1.get_task_args_json_v1",["bytes.view","store_any"],["bytes.view","auth_context_id"],"task_id_utf8"]],["let","rid_res",["std.mcp.sandbox.task_store_any_v1.get_task_request_id_json_v1",["bytes.view","store_any"],["bytes.view","auth_context_id"],"task_id_utf8"]],["let","pt_res",["std.mcp.sandbox.task_store_any_v1.get_task_progress_token_json_v1",["bytes.view","store_any"],["bytes.view","auth_context_id"],"task_id_utf8"]],["let","tool_name",["result_bytes.unwrap_or","tool_name_res",["bytes.alloc",0]]],["let","args_json",["result_bytes.unwrap_or","args_res",["bytes.lit","{}"]]],["let","rid_json",["result_bytes.unwrap_or","rid_res",["bytes.lit","null"]]],["let","pt_json",["result_bytes.unwrap_or","pt_res",["bytes.alloc",0]]],["let","empty_session",["bytes.alloc",0]],["let","ctx_json",["std.mcp.ctx.with_meta_v1","cfg_json",["bytes.view","rid_json"],["bytes.view","pt_json"],["bytes.view","empty_session"]]],["let","out_chan",["chan.bytes.new",256]],["let","tool_res",["task.scope_v1",["task.scope.cfg_v1",["max_children",2]],["begin",["task.scope.start_soon_v1",["std.mcp.sandbox.task_exec_async_pool_v1._drain_chan_v1","out_chan"]],["let","slot",["task.scope.async_let_result_bytes_v1",["std.mcp.sandbox.router_exec.call_tool_stream_v1",["bytes.view","tool_name"],"cfg_json",["bytes.view","ctx_json"],["bytes.view","args_json"],"tools_json","out_chan","cancel_chan_handle"]]],["let","res",["task.scope.await_slot_result_bytes_v1","slot"]],["chan.bytes.close","out_chan"],["task.scope.cancel_all_v1"],["task.scope.wait_all_v1"],"res"]]],["if",["!=",["result_bytes.err_code","tool_res"],0],["return",["bytes.alloc",0]],0],["let","st",["std.mcp.sandbox.task_store_any_v1.get_task_status_v1",["bytes.view","store_any"],["bytes.view","auth_context_id"],"task_id_utf8"]],["if",["=","st",4],["return",["bytes.alloc",0]],0],["let","tr",["result_bytes.unwrap_or","tool_res",["bytes.alloc",0]]],["let","is_err",["std.mcp.sandbox.task_exec_async_pool_v1._tool_result_is_error_v1",["bytes.view","tr"]]],["let","last_updated_at",["std.mcp.sandbox.task_exec_async_pool_v1._clock_now_rfc3339_v1","clock_lo","clock_hi","clock_step_ms"]],["if",["=","is_err",0],["begin",["let","_",["std.mcp.sandbox.task_store_any_v1.set_task_completed_v1","store_any",["bytes.view","auth_context_id"],"task_id_utf8",["bytes.view","last_updated_at"],["bytes.view","tr"]]],["bytes.alloc",0]],["begin",["let","_",["std.mcp.sandbox.task_store_any_v1.set_task_failed_with_result_v1","store_any",["bytes.view","auth_context_id"],"task_id_utf8",["bytes.view","last_updated_at"],["bytes.alloc",0],["bytes.view","tr"]]],["bytes.alloc",0]]]],"kind":"defasync","name":"std.mcp.sandbox.task_exec_async_pool_v1.worker_v1","params":[{"name":"cfg_json","ty":"bytes_view"},{"name":"tools_json","ty":"bytes_view"},{"name":"store_any","ty":"bytes"},{"name":"auth_context_id","ty":"bytes"},{"name":"clock_lo","ty":"i32"},{"name":"clock_hi","ty":"i32"},{"name":"clock_step_ms","ty":"i32"},{"name":"task_id_utf8","ty":"bytes_view"},{"name":"cancel_chan_handle","ty":"i32"}],"result":"bytes"}],"imports":["ext.data_model","ext.json.data_model","ext.time.os","ext.time.rfc3339","std.bytes","std.mcp.ctx","std.mcp.sandbox.router_exec","std.mcp.sandbox.task_store_any_v1"],"kind":"module","module_id":"std.mcp.sandbox.task_exec_async_pool_v1","schema_version":"x07.x07ast@0.5.0"}
