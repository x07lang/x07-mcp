{"decls":[{"kind":"export","names":["std.mcp.sandbox.task_exec_deterministic_v1.advance_task_v1"]},{"body":["ext.time.rfc3339.format_v1","unix_lo","unix_hi",0,0,["bytes.alloc",0]],"kind":"defn","name":"std.mcp.sandbox.task_exec_deterministic_v1._clock_now_fixed_rfc3339_v1","params":[{"name":"unix_lo","ty":"i32"},{"name":"unix_hi","ty":"i32"}],"result":"bytes"},{"body":["begin",["let","doc_b",["ext.json.data_model.parse","tool_result_json"]],["let","doc",["bytes.view","doc_b"]],["if",["=",["ext.data_model.doc_is_err","doc"],1],["return",1],0],["if",["!=",["ext.data_model.root_kind","doc"],5],["return",1],0],["let","root",["ext.data_model.root_offset","doc"]],["let","k_is_error",["bytes.lit","isError"]],["let","off",["ext.data_model.map_find","doc","root",["bytes.view","k_is_error"]]],["if",["<","off",0],["return",0],0],["if",["!=",["ext.data_model.kind_at","doc","off"],1],["return",0],0],["ext.data_model.bool_get","doc","off"]],"kind":"defn","name":"std.mcp.sandbox.task_exec_deterministic_v1._tool_result_is_error_v1","params":[{"name":"tool_result_json","ty":"bytes_view"}],"result":"i32"},{"body":["begin",["let","status_code",["std.mcp.sandbox.task_store_any_v1.get_task_status_v1",["bytes.view","store"],"auth_context_id","task_id_utf8"]],["if",["!=","status_code",0],["return","store"],0],["let","ticks_res",["std.mcp.sandbox.task_store_any_v1.get_task_ticks_done_v1",["bytes.view","store"],"auth_context_id","task_id_utf8"]],["let","ticks",["if",["=",["result_i32.err_code","ticks_res"],0],["result_i32.unwrap_or","ticks_res",0],0]],["let","next_ticks",["+","ticks",1]],["let","step_s",["/","clock_step_ms",1000]],["let","unix_lo2",["+","clock_unix_lo","step_s"]],["let","unix_hi2",["+","clock_unix_hi",["if",["<u","unix_lo2","clock_unix_lo"],1,0]]],["let","last_updated_at",["std.mcp.sandbox.task_exec_deterministic_v1._clock_now_fixed_rfc3339_v1","unix_lo2","unix_hi2"]],["if",["<","complete_after",1],["set","complete_after",1],0],["if",["<","next_ticks","complete_after"],["begin",["let","res_store0",["std.bytes.copy","store"]],["let","res",["std.mcp.sandbox.task_store_any_v1.set_task_working_step_v1","store","auth_context_id","task_id_utf8",["bytes.view","last_updated_at"],"next_ticks","complete_after"]],["if",["=",["result_bytes.err_code","res"],0],["result_bytes.unwrap_or","res","res_store0"],"res_store0"]],["begin",["let","tool_name_res",["std.mcp.sandbox.task_store_any_v1.get_task_tool_name_v1",["bytes.view","store"],"auth_context_id","task_id_utf8"]],["let","args_res",["std.mcp.sandbox.task_store_any_v1.get_task_args_json_v1",["bytes.view","store"],"auth_context_id","task_id_utf8"]],["let","rid_res",["std.mcp.sandbox.task_store_any_v1.get_task_request_id_json_v1",["bytes.view","store"],"auth_context_id","task_id_utf8"]],["let","pt_res",["std.mcp.sandbox.task_store_any_v1.get_task_progress_token_json_v1",["bytes.view","store"],"auth_context_id","task_id_utf8"]],["let","tool_name",["result_bytes.unwrap_or","tool_name_res",["bytes.alloc",0]]],["let","args_json",["result_bytes.unwrap_or","args_res",["bytes.lit","{}"]]],["let","rid_json",["result_bytes.unwrap_or","rid_res",["bytes.lit","null"]]],["let","pt_json",["result_bytes.unwrap_or","pt_res",["bytes.alloc",0]]],["let","tool_name_b",["std.bytes.copy","tool_name"]],["let","tool_name_v",["bytes.view","tool_name_b"]],["let","args_b",["std.bytes.copy","args_json"]],["let","args_v",["bytes.view","args_b"]],["let","rid_b",["std.bytes.copy","rid_json"]],["let","rid_v",["bytes.view","rid_b"]],["let","pt_b",["std.bytes.copy","pt_json"]],["let","pt_v",["bytes.view","pt_b"]],["let","empty_ctx",["bytes.lit","{}"]],["let","ctx_json",["std.mcp.ctx.with_meta_v1",["bytes.view","empty_ctx"],"rid_v","pt_v",["bytes.alloc",0]]],["let","val_res",["std.mcp.toolkit.derive_hooks.validate_tool_args_v1","tools_json","tool_name_v","args_v"]],["let","errors_json",["if",["=",["result_bytes.err_code","val_res"],0],["result_bytes.unwrap_or","val_res",["bytes.alloc",0]],["bytes.alloc",0]]],["let","tr",["begin",["let","_x07_tmp_copy",["view.to_bytes",["bytes.view","errors_json"]]],["if",[">",["bytes.len",["bytes.view","_x07_tmp_copy"]],0],["begin",["let","diag_json",["std.mcp.tool.errors.diag_schema_validation_v1","tool_name_v",["bytes.view","errors_json"]]],["let","pfx",["bytes.lit","Invalid tool arguments for "]],["let","sfx",["bytes.lit","."]],["let","t1",["std.bytes.concat",["bytes.view","pfx"],"tool_name_v"]],["let","t2",["std.bytes.concat",["bytes.view","t1"],["bytes.view","sfx"]]],["std.mcp.tool.result.err_text_structured_v1",["bytes.view","t2"],["bytes.view","diag_json"]]],["begin",["let","tr0",["mcp.user.call_tool_v1","tool_name_v",["bytes.view","ctx_json"],"args_v"]],["if",["=",["std.bytes.len","tr0"],0],["begin",["let","diag_b",["std.mcp.diag.code_internal_v1"]],["let","msg_b",["bytes.lit","tool returned empty result"]],["let","detail_b",["bytes.lit","{}"]],["std.mcp.tool.result.err_v1",["bytes.view","diag_b"],["bytes.view","msg_b"],["bytes.view","detail_b"]]],"tr0"]]]]],["let","is_err",["std.mcp.sandbox.task_exec_deterministic_v1._tool_result_is_error_v1",["bytes.view","tr"]]],["if",["=","is_err",0],["begin",["let","res2_store0",["std.bytes.copy","store"]],["let","res2",["std.mcp.sandbox.task_store_any_v1.set_task_completed_v1","store","auth_context_id","task_id_utf8",["bytes.view","last_updated_at"],["bytes.view","tr"]]],["if",["=",["result_bytes.err_code","res2"],0],["result_bytes.unwrap_or","res2","res2_store0"],"res2_store0"]],["begin",["let","res3_store0",["std.bytes.copy","store"]],["let","res3",["std.mcp.sandbox.task_store_any_v1.set_task_failed_with_result_v1","store","auth_context_id","task_id_utf8",["bytes.view","last_updated_at"],["bytes.alloc",0],["bytes.view","tr"]]],["if",["=",["result_bytes.err_code","res3"],0],["result_bytes.unwrap_or","res3","res3_store0"],"res3_store0"]]]]]],"kind":"defn","name":"std.mcp.sandbox.task_exec_deterministic_v1.advance_task_v1","params":[{"name":"tools_json","ty":"bytes_view"},{"name":"store","ty":"bytes"},{"name":"auth_context_id","ty":"bytes_view"},{"name":"task_id_utf8","ty":"bytes_view"},{"name":"clock_unix_lo","ty":"i32"},{"name":"clock_unix_hi","ty":"i32"},{"name":"clock_step_ms","ty":"i32"},{"name":"complete_after","ty":"i32"}],"result":"bytes"}],"imports":["ext.data_model","ext.json.data_model","ext.time.rfc3339","mcp.user","std.bytes","std.mcp.ctx","std.mcp.diag","std.mcp.sandbox.task_store_any_v1","std.mcp.tool.errors","std.mcp.tool.result","std.mcp.toolkit.derive_hooks"],"kind":"module","module_id":"std.mcp.sandbox.task_exec_deterministic_v1","schema_version":"x07.x07ast@0.5.0"}
