{"decls":[{"kind":"export","names":["std.mcp.rr.sanitize_profile.sanitize_err_report_json_v1","std.mcp.rr.sanitize_profile.sanitize_jsonl_v1"]},{"body":["begin",["let","out2","out"],["if",["<","pos","n"],["set","out2",["vec_u8.extend_bytes","out2",["view.slice","text","pos",["-","n","pos"]]]],0],["vec_u8.into_bytes","out2"]],"kind":"defn","name":"std.mcp.rr.sanitize_profile._append_tail_v1","params":[{"name":"out","ty":"vec_u8"},{"name":"text","ty":"bytes_view"},{"name":"pos","ty":"i32"},{"name":"n","ty":"i32"}],"result":"bytes"},{"body":["begin",["let","out",["view.to_bytes","text_utf8"]],["if",["<","str_repls_off",0],["return","out"],0],["let","n",["ext.data_model.seq_len","profile_doc","str_repls_off"]],["if",["<","n",0],["return","out"],0],["for","i",0,"n",["begin",["let","it",["ext.data_model.seq_get","profile_doc","str_repls_off","i"]],["if",["<","it",0],0,["begin",["if",["!=",["ext.data_model.kind_at","profile_doc","it"],5],0,["begin",["let","pat",["std.mcp.rr.sanitize_profile._map_string_or_empty_v1","profile_doc","it",["bytes.lit","pattern"]]],["if",["=",["bytes.len","pat"],0],0,["begin",["let","repl",["std.mcp.rr.sanitize_profile._map_string_or_empty_v1","profile_doc","it",["bytes.lit","replace"]]],["set","out",["std.mcp.rr.sanitize_profile._regex_replace_template_v1",["bytes.view","pat"],["bytes.view","repl"],["bytes.view","out"]]],0]],0]],0]],0]],"out"],"kind":"defn","name":"std.mcp.rr.sanitize_profile._apply_string_replacements_v1","params":[{"name":"text_utf8","ty":"bytes_view"},{"name":"profile_doc","ty":"bytes_view"},{"name":"str_repls_off","ty":"i32"}],"result":"bytes"},{"body":["begin",["let","n",["view.len","key_utf8"]],["let","out",["vec_u8.with_capacity",["+","n",0]]],["for","i",0,"n",["begin",["let","c",["view.get_u8","key_utf8","i"]],["let","c2",["if",["&",[">=u","c",65],["<=u","c",90]],["+","c",32],["if",["=","c",45],95,"c"]]],["set","out",["vec_u8.push","out","c2"]],0]],["vec_u8.into_bytes","out"]],"kind":"defn","name":"std.mcp.rr.sanitize_profile._canon_key_v1","params":[{"name":"key_utf8","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","k_assertion_id",["bytes.lit","assertion_id"]],["let","k_code",["bytes.lit","code"]],["let","k_ok",["bytes.lit","ok"]],["let","k_target_id",["bytes.lit","target_id"]],["let","v_assertion_id",["ext.data_model.value_string","assertion_id_utf8"]],["let","code",["bytes.lit","MCP_RR_SANITIZER_ASSERTION_FAILED"]],["let","v_code",["ext.data_model.value_string",["bytes.view","code"]]],["let","v_ok",["ext.data_model.value_bool",0]],["let","v_target_id",["ext.data_model.value_string","target_id_utf8"]],["let","entries",["vec_u8.with_capacity",128]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",4]]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",["bytes.len",["bytes.view","k_assertion_id"]]]]],["set","entries",["vec_u8.extend_bytes","entries",["bytes.view","k_assertion_id"]]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",["bytes.len","v_assertion_id"]]]],["set","entries",["vec_u8.extend_bytes","entries","v_assertion_id"]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",["bytes.len",["bytes.view","k_code"]]]]],["set","entries",["vec_u8.extend_bytes","entries",["bytes.view","k_code"]]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",["bytes.len","v_code"]]]],["set","entries",["vec_u8.extend_bytes","entries","v_code"]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",["bytes.len",["bytes.view","k_ok"]]]]],["set","entries",["vec_u8.extend_bytes","entries",["bytes.view","k_ok"]]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",["bytes.len","v_ok"]]]],["set","entries",["vec_u8.extend_bytes","entries","v_ok"]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",["bytes.len",["bytes.view","k_target_id"]]]]],["set","entries",["vec_u8.extend_bytes","entries",["bytes.view","k_target_id"]]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",["bytes.len","v_target_id"]]]],["set","entries",["vec_u8.extend_bytes","entries","v_target_id"]],["let","entries_b",["vec_u8.into_bytes","entries"]],["let","map_val",["ext.data_model.value_map_from_entries",["bytes.view","entries_b"]]],["std.mcp.util.json.json_from_value_v1",["bytes.view","map_val"]]],"kind":"defn","name":"std.mcp.rr.sanitize_profile._err_report_json_v1","params":[{"name":"assertion_id_utf8","ty":"bytes_view"},{"name":"target_id_utf8","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","tn",["view.len","template_utf8"]],["let","out",["vec_u8.with_capacity",["+","tn",16]]],["let","i",0],["for","_",0,"tn",["begin",["if",[">=u","i","tn"],["return",["vec_u8.into_bytes","out"]],0],["let","c",["view.get_u8","template_utf8","i"]],["if",["&",["=","c",36],["<u",["+","i",1],"tn"]],["begin",["let","j",["+","i",1]],["let","num",0],["let","seen",0],["for","_d",0,8,["begin",["if",[">=u","j","tn"],0,["begin",["let","d",["view.get_u8","template_utf8","j"]],["if",["&",[">=u","d",48],["<=u","d",57]],["begin",["set","seen",1],["set","num",["+",["*","num",10],["-","d",48]]],["set","j",["+","j",1]],0],0],0]],0]],["if",["=","seen",1],["begin",["if",["=","num",0],["begin",["let","ms",["ext.regex.match_start","m"]],["let","me",["ext.regex.match_end","m"]],["if",["&",[">=","ms",0],[">=","me","ms"]],["set","out",["vec_u8.extend_bytes","out",["view.slice","text_utf8","ms",["-","me","ms"]]]],0],0],["begin",["let","caps_n",["ext.regex.caps_count_v1","m"]],["if",["&",[">=","num",1],["<=","num","caps_n"]],["begin",["let","cap_v",["ext.regex.cap_view_v1","text_utf8","m","num"]],["set","out",["vec_u8.extend_bytes","out","cap_v"]],0],0],0]],["set","i","j"],0],["begin",["set","out",["vec_u8.push","out","c"]],["set","i",["+","i",1]],0]],0],["begin",["set","out",["vec_u8.push","out","c"]],["set","i",["+","i",1]],0]],0]],["vec_u8.into_bytes","out"]],"kind":"defn","name":"std.mcp.rr.sanitize_profile._expand_template_v1","params":[{"name":"template_utf8","ty":"bytes_view"},{"name":"text_utf8","ty":"bytes_view"},{"name":"m","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["if",["<u",["view.len","path_pack"],4],["return",-1],0],["let","count",["codec.read_u32_le","path_pack",0]],["let","off","root_off"],["let","pos",4],["for","i",0,"count",["begin",["if",["<","off",0],["return",-1],0],["if",["!=",["ext.data_model.kind_at","doc","off"],5],["return",-1],0],["if",["<u",["view.len","path_pack"],["+","pos",4]],["return",-1],0],["let","seg_len",["codec.read_u32_le","path_pack","pos"]],["let","seg_start",["+","pos",4]],["if",["<u",["view.len","path_pack"],["+","seg_start","seg_len"]],["return",-1],0],["let","seg",["view.slice","path_pack","seg_start","seg_len"]],["set","off",["ext.data_model.map_find","doc","off","seg"]],["set","pos",["+","seg_start","seg_len"]],0]],"off"],"kind":"defn","name":"std.mcp.rr.sanitize_profile._find_path_off_v1","params":[{"name":"doc","ty":"bytes_view"},{"name":"root_off","ty":"i32"},{"name":"path_pack","ty":"bytes_view"}],"result":"i32"},{"body":["begin",["if",["<","asserts_off",0],["return",["bytes.alloc",0]],0],["let","n",["ext.data_model.seq_len","profile_doc","asserts_off"]],["for","i",0,"n",["begin",["let","it",["ext.data_model.seq_get","profile_doc","asserts_off","i"]],["if",["<","it",0],0,["begin",["if",["!=",["ext.data_model.kind_at","profile_doc","it"],5],0,["begin",["let","pat",["std.mcp.rr.sanitize_profile._map_string_or_empty_v1","profile_doc","it",["bytes.lit","pattern"]]],["if",["=",["bytes.len","pat"],0],0,["begin",["let","m",["ext.regex.exec_pat",["bytes.view","pat"],"json_utf8"]],["let","mv",["bytes.view","m"]],["if",["&",["=",["ext.regex.is_err","mv"],0],["=",["ext.regex.is_match","mv"],1]],["return",["std.mcp.rr.sanitize_profile._map_string_or_empty_v1","profile_doc","it",["bytes.lit","id"]]],0],0]],0]],0]],0]],["bytes.alloc",0]],"kind":"defn","name":"std.mcp.rr.sanitize_profile._first_assertion_hit_id_v1","params":[{"name":"profile_doc","ty":"bytes_view"},{"name":"asserts_off","ty":"i32"},{"name":"json_utf8","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","n",["view.len","v"]],["for","i",0,"n",["begin",["let","c",["view.get_u8","v","i"]],["if",["|",["=","c",32],["|",["=","c",9],["=","c",13]]],0,["return",0]],0]],1],"kind":"defn","name":"std.mcp.rr.sanitize_profile._is_ws_only_v1","params":[{"name":"v","ty":"bytes_view"}],"result":"i32"},{"body":["begin",["let","canon",["std.mcp.rr.sanitize_profile._canon_key_v1","key_utf8"]],["let","canon_v",["bytes.view","canon"]],["if",[">=","deny_exact_off",0],["begin",["let","n",["ext.data_model.seq_len","profile_doc","deny_exact_off"]],["for","i",0,"n",["begin",["let","it",["ext.data_model.seq_get","profile_doc","deny_exact_off","i"]],["if",["<","it",0],0,["begin",["if",["=",["ext.data_model.kind_at","profile_doc","it"],3],["begin",["let","s",["ext.data_model.string_get","profile_doc","it"]],["if",["=",["bytes.eq",["bytes.view","s"],"canon_v"],1],["return",1],0],0],0],0]],0]],0],0],["if",[">=","deny_re_off",0],["begin",["let","n",["ext.data_model.seq_len","profile_doc","deny_re_off"]],["for","i",0,"n",["begin",["let","it",["ext.data_model.seq_get","profile_doc","deny_re_off","i"]],["if",["<","it",0],0,["begin",["if",["=",["ext.data_model.kind_at","profile_doc","it"],3],["begin",["let","pat",["ext.data_model.string_get","profile_doc","it"]],["let","m",["ext.regex.exec_pat",["bytes.view","pat"],"canon_v"]],["let","mv",["bytes.view","m"]],["if",["&",["=",["ext.regex.is_err","mv"],0],["=",["ext.regex.is_match","mv"],1]],["return",1],0],0],0],0]],0]],0],0],0],"kind":"defn","name":"std.mcp.rr.sanitize_profile._key_matches_deny_v1","params":[{"name":"key_utf8","ty":"bytes_view"},{"name":"profile_doc","ty":"bytes_view"},{"name":"deny_exact_off","ty":"i32"},{"name":"deny_re_off","ty":"i32"}],"result":"i32"},{"body":["begin",["if",["<","map_off",0],["return",-1],0],["let","off",["ext.data_model.map_find","doc","map_off",["bytes.view","key_utf8"]]],["if",["<","off",0],["return",-1],0],["if",["!=",["ext.data_model.kind_at","doc","off"],5],["return",-1],0],"off"],"kind":"defn","name":"std.mcp.rr.sanitize_profile._map_map_off_or_neg1_v1","params":[{"name":"doc","ty":"bytes_view"},{"name":"map_off","ty":"i32"},{"name":"key_utf8","ty":"bytes"}],"result":"i32"},{"body":["begin",["if",["<","map_off",0],["return",-1],0],["let","off",["ext.data_model.map_find","doc","map_off",["bytes.view","key_utf8"]]],["if",["<","off",0],["return",-1],0],["if",["!=",["ext.data_model.kind_at","doc","off"],4],["return",-1],0],"off"],"kind":"defn","name":"std.mcp.rr.sanitize_profile._map_seq_off_or_neg1_v1","params":[{"name":"doc","ty":"bytes_view"},{"name":"map_off","ty":"i32"},{"name":"key_utf8","ty":"bytes"}],"result":"i32"},{"body":["begin",["if",["<","map_off",0],["return",["bytes.alloc",0]],0],["let","off",["ext.data_model.map_find","doc","map_off","key"]],["if",["<","off",0],["return",["bytes.alloc",0]],0],["if",["!=",["ext.data_model.kind_at","doc","off"],3],["return",["bytes.alloc",0]],0],["ext.data_model.string_get","doc","off"]],"kind":"defn","name":"std.mcp.rr.sanitize_profile._map_string_or_empty_v1","params":[{"name":"doc","ty":"bytes_view"},{"name":"map_off","ty":"i32"},{"name":"key","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","out",["vec_u8.with_capacity",["+",["+",8,["bytes.len","assertion_id"]],["+",4,["bytes.len","target_id"]]]]],["set","out",["vec_u8.extend_bytes","out",["codec.write_u32_le",["bytes.len","assertion_id"]]]],["set","out",["vec_u8.extend_bytes","out","assertion_id"]],["set","out",["vec_u8.extend_bytes","out",["codec.write_u32_le",["bytes.len","target_id"]]]],["set","out",["vec_u8.extend_bytes","out","target_id"]],["let","payload",["vec_u8.into_bytes","out"]],["std.mcp.rr.sanitize_profile._pack_v1",1,"payload"]],"kind":"defn","name":"std.mcp.rr.sanitize_profile._pack_assert_fail_v1","params":[{"name":"assertion_id","ty":"bytes"},{"name":"target_id","ty":"bytes"}],"result":"bytes"},{"body":["std.mcp.rr.sanitize_profile._pack_v1","code",["bytes.alloc",0]],"kind":"defn","name":"std.mcp.rr.sanitize_profile._pack_err_v1","params":[{"name":"code","ty":"i32"}],"result":"bytes"},{"body":["std.mcp.rr.sanitize_profile._pack_v1",0,"payload"],"kind":"defn","name":"std.mcp.rr.sanitize_profile._pack_ok_v1","params":[{"name":"payload","ty":"bytes"}],"result":"bytes"},{"body":["begin",["let","n",["bytes.len","payload"]],["let","out",["vec_u8.with_capacity",["+",8,"n"]]],["set","out",["vec_u8.extend_bytes","out",["codec.write_u32_le","kind"]]],["set","out",["vec_u8.extend_bytes","out",["codec.write_u32_le","n"]]],["set","out",["vec_u8.extend_bytes","out","payload"]],["vec_u8.into_bytes","out"]],"kind":"defn","name":"std.mcp.rr.sanitize_profile._pack_v1","params":[{"name":"kind","ty":"i32"},{"name":"payload","ty":"bytes"}],"result":"bytes"},{"body":["begin",["if",["=",["bytes.eq",["view.to_bytes","path_utf8"],["bytes.lit","$"]],1],["return",["codec.write_u32_le",0]],0],["let","n",["view.len","path_utf8"]],["if",["<u","n",3],["return",["bytes.alloc",0]],0],["if",["&",["=",["view.get_u8","path_utf8",0],36],["=",["view.get_u8","path_utf8",1],46]],0,["return",["bytes.alloc",0]]],["let","payload",["vec_u8.with_capacity",["+","n",16]]],["let","count",0],["let","start",2],["for","i",2,["+","n",1],["begin",["let","at_end",["if",[">=u","i","n"],1,0]],["let","is_dot",["if",["=","at_end",0],["if",["=",["view.get_u8","path_utf8","i"],46],1,0],0]],["if",["|",["=","at_end",1],["=","is_dot",1]],["begin",["let","seg_len",["-","i","start"]],["if",["<=","seg_len",0],["return",["bytes.alloc",0]],0],["set","payload",["vec_u8.extend_bytes","payload",["codec.write_u32_le","seg_len"]]],["set","payload",["vec_u8.extend_bytes","payload",["view.slice","path_utf8","start","seg_len"]]],["set","count",["+","count",1]],["set","start",["+","i",1]],0],0],0]],["let","payload_b",["vec_u8.into_bytes","payload"]],["let","out",["vec_u8.with_capacity",["+",4,["bytes.len","payload_b"]]]],["set","out",["vec_u8.extend_bytes","out",["codec.write_u32_le","count"]]],["set","out",["vec_u8.extend_bytes","out",["bytes.view","payload_b"]]],["vec_u8.into_bytes","out"]],"kind":"defn","name":"std.mcp.rr.sanitize_profile._path_pack_v1","params":[{"name":"path_utf8","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["if",["<u",["view.len","path_pack"],4],["return",["view.slice","path_pack",0,0]],0],["let","count",["codec.read_u32_le","path_pack",0]],["if",["|",["<","idx",0],[">=","idx","count"]],["return",["view.slice","path_pack",0,0]],0],["let","pos",4],["for","i",0,"count",["begin",["if",["<u",["view.len","path_pack"],["+","pos",4]],["return",["view.slice","path_pack",0,0]],0],["let","seg_len",["codec.read_u32_le","path_pack","pos"]],["let","seg_start",["+","pos",4]],["if",["<u",["view.len","path_pack"],["+","seg_start","seg_len"]],["return",["view.slice","path_pack",0,0]],0],["if",["=","i","idx"],["return",["view.slice","path_pack","seg_start","seg_len"]],0],["set","pos",["+","seg_start","seg_len"]],0]],["view.slice","path_pack",0,0]],"kind":"defn","name":"std.mcp.rr.sanitize_profile._path_seg_view_v1","params":[{"name":"path_pack","ty":"bytes_view"},{"name":"idx","ty":"i32"}],"result":"bytes_view"},{"body":["begin",["let","msg_off",["ext.data_model.map_find","doc","root_off",["bytes.lit","msg"]]],["if",["<","msg_off",0],["return",0],0],["if",["!=",["ext.data_model.kind_at","doc","msg_off"],5],["return",0],0],["let","m_off",["ext.data_model.map_find","doc","msg_off",["bytes.lit","method"]]],["if",["<","m_off",0],["return",0],0],["if",["!=",["ext.data_model.kind_at","doc","m_off"],3],["return",0],0],["bytes.eq",["ext.data_model.string_get","doc","m_off"],"need_utf8"]],"kind":"defn","name":"std.mcp.rr.sanitize_profile._protocol_method_eq_v1","params":[{"name":"doc","ty":"bytes_view"},{"name":"root_off","ty":"i32"},{"name":"need_utf8","ty":"bytes_view"}],"result":"i32"},{"body":["begin",["let","compiled_b",["ext.regex.compile","pattern_utf8"]],["let","compiled",["bytes.view","compiled_b"]],["if",["=",["ext.regex.is_err","compiled"],1],["return",["view.to_bytes","text_utf8"]],0],["let","n",["view.len","text_utf8"]],["let","out",["vec_u8.with_capacity",["+","n",16]]],["let","pos",0],["for","_",0,4096,["begin",["if",[">=","pos","n"],["return",["vec_u8.into_bytes","out"]],0],["let","m_b",["ext.regex.exec_caps_from_v1","compiled","text_utf8","pos"]],["let","m",["bytes.view","m_b"]],["if",["=",["ext.regex.is_err","m"],1],["return",["view.to_bytes","text_utf8"]],0],["if",["=",["ext.regex.is_match","m"],0],["return",["std.mcp.rr.sanitize_profile._append_tail_v1","out","text_utf8","pos","n"]],0],["let","m_start",["ext.regex.match_start","m"]],["let","m_end",["ext.regex.match_end","m"]],["if",["|",["<","m_start",0],["<","m_end",0]],["return",["view.to_bytes","text_utf8"]],0],["if",[">","m_start","pos"],["set","out",["vec_u8.extend_bytes","out",["view.slice","text_utf8","pos",["-","m_start","pos"]]]],0],["let","rep",["std.mcp.rr.sanitize_profile._expand_template_v1","template_utf8","text_utf8","m"]],["set","out",["vec_u8.extend_bytes","out",["bytes.view","rep"]]],["set","pos",["if",["<=","m_end","m_start"],["+","m_end",1],"m_end"]],0]],["std.mcp.rr.sanitize_profile._append_tail_v1","out","text_utf8","pos","n"]],"kind":"defn","name":"std.mcp.rr.sanitize_profile._regex_replace_template_v1","params":[{"name":"pattern_utf8","ty":"bytes_view"},{"name":"template_utf8","ty":"bytes_view"},{"name":"text_utf8","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["if",["<u",["view.len","path_pack"],4],["return",["bytes.alloc",0]],0],["let","count",["codec.read_u32_le","path_pack",0]],["if",[">=","idx","count"],["return",["view.to_bytes","new_val"]],0],["if",["!=",["ext.data_model.kind_at","doc","off"],5],["return",["std.mcp.rr.sanitize_profile._value_copy_v1","doc","off"]],0],["let","seg",["std.mcp.rr.sanitize_profile._path_seg_view_v1","path_pack","idx"]],["let","n",["ext.data_model.map_len","doc","off"]],["if",["<","n",0],["return",["bytes.alloc",0]],0],["let","entries",["vec_u8.with_capacity",256]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le","n"]]],["for","i",0,"n",["begin",["let","k",["ext.data_model.map_key_at","doc","off","i"]],["let","v_off",["ext.data_model.map_value_at","doc","off","i"]],["let","v_bytes",["if",["=",["bytes.eq",["bytes.view","k"],"seg"],1],["std.mcp.rr.sanitize_profile._rewrite_set_path_v1","doc","v_off","path_pack",["+","idx",1],"new_val"],["std.mcp.rr.sanitize_profile._value_copy_v1","doc","v_off"]]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",["bytes.len",["bytes.view","k"]]]]],["set","entries",["vec_u8.extend_bytes","entries",["bytes.view","k"]]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",["bytes.len",["bytes.view","v_bytes"]]]]],["set","entries",["vec_u8.extend_bytes","entries",["bytes.view","v_bytes"]]],0]],["let","entries_b",["vec_u8.into_bytes","entries"]],["ext.data_model.value_map_from_entries",["bytes.view","entries_b"]]],"kind":"defn","name":"std.mcp.rr.sanitize_profile._rewrite_set_path_v1","params":[{"name":"doc","ty":"bytes_view"},{"name":"off","ty":"i32"},{"name":"path_pack","ty":"bytes_view"},{"name":"idx","ty":"i32"},{"name":"new_val","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","profile_doc_b",["ext.json.data_model.parse","profile_json"]],["let","profile_doc",["bytes.view","profile_doc_b"]],["if",["=",["ext.data_model.doc_is_err","profile_doc"],1],["return",["std.mcp.rr.sanitize_profile._pack_err_v1",2]],0],["if",["!=",["ext.data_model.root_kind","profile_doc"],5],["return",["std.mcp.rr.sanitize_profile._pack_err_v1",2]],0],["let","profile_root",["ext.data_model.root_offset","profile_doc"]],["let","k_replace",["bytes.lit","replace"]],["let","replace_utf8",["std.mcp.rr.sanitize_profile._map_string_or_empty_v1","profile_doc","profile_root",["bytes.view","k_replace"]]],["let","replace_len",["view.len",["bytes.view","replace_utf8"]]],["if",["=","replace_len",0],["set","replace_utf8",["bytes.lit","<redacted>"]],0],["let","targets_off",["std.mcp.rr.sanitize_profile._map_seq_off_or_neg1_v1","profile_doc","profile_root",["bytes.lit","targets"]]],["let","rules_off",["std.mcp.rr.sanitize_profile._map_map_off_or_neg1_v1","profile_doc","profile_root",["bytes.lit","rules"]]],["let","obj_key_off",["std.mcp.rr.sanitize_profile._map_map_off_or_neg1_v1","profile_doc","rules_off",["bytes.lit","object_key"]]],["let","redact_if_off",["std.mcp.rr.sanitize_profile._map_map_off_or_neg1_v1","profile_doc","obj_key_off",["bytes.lit","redact_if"]]],["let","deny_exact_off",["std.mcp.rr.sanitize_profile._map_seq_off_or_neg1_v1","profile_doc","redact_if_off",["bytes.lit","exact"]]],["let","deny_re_off",["std.mcp.rr.sanitize_profile._map_seq_off_or_neg1_v1","profile_doc","redact_if_off",["bytes.lit","regex_ci"]]],["let","str_repls_off",["std.mcp.rr.sanitize_profile._map_seq_off_or_neg1_v1","profile_doc","rules_off",["bytes.lit","string_regex_replacements"]]],["let","asserts_off",["std.mcp.rr.sanitize_profile._map_seq_off_or_neg1_v1","profile_doc","rules_off",["bytes.lit","assert_no_match"]]],["let","n",["view.len","input_jsonl"]],["if",["=","n",0],["return",["std.mcp.rr.sanitize_profile._pack_ok_v1",["bytes.alloc",0]]],0],["let","had_trailing_nl",["if",["=",["view.get_u8","input_jsonl",["-","n",1]],10],1,0]],["let","out",["vec_u8.with_capacity",["+","n",16]]],["let","start",0],["for","i",0,"n",["if",["=",["view.get_u8","input_jsonl","i"],10],["begin",["let","line_v",["view.slice","input_jsonl","start",["-","i","start"]]],["let","line_pack",["std.mcp.rr.sanitize_profile._sanitize_line_v1","profile_doc","targets_off","deny_exact_off","deny_re_off","str_repls_off","asserts_off",["bytes.view","replace_utf8"],"line_v"]],["let","lpv",["bytes.view","line_pack"]],["if",["<u",["view.len","lpv"],8],["return",["std.mcp.rr.sanitize_profile._pack_err_v1",2]],0],["let","kind",["codec.read_u32_le","lpv",0]],["let","plen",["codec.read_u32_le","lpv",4]],["if",["<u",["view.len","lpv"],["+",8,"plen"]],["return",["std.mcp.rr.sanitize_profile._pack_err_v1",2]],0],["if",["=","kind",0],["begin",["set","out",["vec_u8.extend_bytes","out",["view.slice","lpv",8,"plen"]]],0],["return",["view.to_bytes","lpv"]]],["set","out",["vec_u8.push","out",10]],["set","start",["+","i",1]],0],0]],["if",["<","start","n"],["begin",["let","line_v",["view.slice","input_jsonl","start",["-","n","start"]]],["let","line_pack",["std.mcp.rr.sanitize_profile._sanitize_line_v1","profile_doc","targets_off","deny_exact_off","deny_re_off","str_repls_off","asserts_off",["bytes.view","replace_utf8"],"line_v"]],["let","lpv",["bytes.view","line_pack"]],["if",["<u",["view.len","lpv"],8],["return",["std.mcp.rr.sanitize_profile._pack_err_v1",2]],0],["let","kind",["codec.read_u32_le","lpv",0]],["let","plen",["codec.read_u32_le","lpv",4]],["if",["<u",["view.len","lpv"],["+",8,"plen"]],["return",["std.mcp.rr.sanitize_profile._pack_err_v1",2]],0],["if",["=","kind",0],["begin",["set","out",["vec_u8.extend_bytes","out",["view.slice","lpv",8,"plen"]]],["if",["=","had_trailing_nl",1],["set","out",["vec_u8.push","out",10]],0],0],["return",["view.to_bytes","lpv"]]],0],0],["std.mcp.rr.sanitize_profile._pack_ok_v1",["vec_u8.into_bytes","out"]]],"kind":"defn","name":"std.mcp.rr.sanitize_profile._sanitize_jsonl_run_v1","params":[{"name":"profile_json","ty":"bytes_view"},{"name":"input_jsonl","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","line_n",["view.len","line_json"]],["if",["=","line_n",0],["return",["std.mcp.rr.sanitize_profile._pack_ok_v1",["bytes.alloc",0]]],0],["if",["=",["std.mcp.rr.sanitize_profile._is_ws_only_v1","line_json"],1],["return",["std.mcp.rr.sanitize_profile._pack_ok_v1",["bytes.alloc",0]]],0],["let","doc_b",["ext.json.data_model.parse","line_json"]],["let","doc",["bytes.view","doc_b"]],["if",["=",["ext.data_model.doc_is_err","doc"],1],["return",["std.mcp.rr.sanitize_profile._pack_err_v1",2]],0],["if",["!=",["ext.data_model.root_kind","doc"],5],["return",["std.mcp.rr.sanitize_profile._pack_err_v1",2]],0],["let","root_off",["ext.data_model.root_offset","doc"]],["let","root_val",["std.mcp.rr.sanitize_profile._value_copy_v1","doc","root_off"]],["let","k_msg",["bytes.lit","msg"]],["let","k_schema",["bytes.lit","schema_version"]],["let","msg_off0",["ext.data_model.map_find","doc","root_off",["bytes.view","k_msg"]]],["let","protocol_line",["if",["&",[">=","msg_off0",0],["=",["ext.data_model.kind_at","doc","msg_off0"],5]],1,0]],["let","schema_off0",["ext.data_model.map_find","doc","root_off",["bytes.view","k_schema"]]],["let","audit_line",["if",[">=","schema_off0",0],1,0]],["if",["<","targets_off",0],["begin",["let","json0",["std.mcp.util.json.json_from_value_v1",["bytes.view","root_val"]]],["return",["std.mcp.rr.sanitize_profile._pack_ok_v1","json0"]]],0],["let","tcount",["ext.data_model.seq_len","profile_doc","targets_off"]],["if",["<","tcount",0],["return",["std.mcp.rr.sanitize_profile._pack_err_v1",2]],0],["let","cur_json",["std.mcp.util.json.json_from_value_v1",["bytes.view","root_val"]]],["let","cur_doc_b",["ext.json.data_model.parse",["bytes.view","cur_json"]]],["let","cur_doc",["bytes.view","cur_doc_b"]],["let","empty_doc_b",["bytes.alloc",0]],["if",["=",["ext.data_model.doc_is_err","cur_doc"],1],["return",["std.mcp.rr.sanitize_profile._pack_err_v1",2]],0],["let","cur_root",["ext.data_model.root_offset","cur_doc"]],["let","cur_val",["std.mcp.rr.sanitize_profile._value_copy_v1","cur_doc","cur_root"]],["for","ti",0,"tcount",["begin",["let","t_off",["ext.data_model.seq_get","profile_doc","targets_off","ti"]],["if",["<","t_off",0],0,["begin",["if",["!=",["ext.data_model.kind_at","profile_doc","t_off"],5],0,["begin",["let","t_kind",["std.mcp.rr.sanitize_profile._map_string_or_empty_v1","profile_doc","t_off",["bytes.lit","kind"]]],["let","do_apply",["begin",["let","_x07_tmp_copy",["view.to_bytes",["bytes.view","t_kind"]]],["begin",["let","t_kind_v",["bytes.view","t_kind"]],["let","k_protocol",["bytes.lit","mcp_protocol_jsonl"]],["let","k_audit",["bytes.lit","mcp_audit_jsonl"]],["if",["=",["bytes.eq","t_kind_v",["bytes.view","k_protocol"]],1],"protocol_line",["if",["=",["bytes.eq","t_kind_v",["bytes.view","k_audit"]],1],"audit_line",0]]]]],["if",["=","do_apply",1],["begin",["let","t_id",["std.mcp.rr.sanitize_profile._map_string_or_empty_v1","profile_doc","t_off",["bytes.lit","id"]]],["let","path",["std.mcp.rr.sanitize_profile._map_string_or_empty_v1","profile_doc","t_off",["bytes.lit","json_path"]]],["if",["|",["=",["bytes.len","t_id"],0],["=",["bytes.len","path"],0]],0,["begin",["let","when_off",["std.mcp.rr.sanitize_profile._map_map_off_or_neg1_v1","profile_doc","t_off",["bytes.lit","when"]]],["let","method_need",["if",[">=","when_off",0],["std.mcp.rr.sanitize_profile._map_string_or_empty_v1","profile_doc","when_off",["bytes.lit","msg_method_equals"]],["bytes.alloc",0]]],["let","method_ok",["if",["=",["bytes.len","method_need"],0],1,["std.mcp.rr.sanitize_profile._protocol_method_eq_v1","cur_doc","cur_root",["bytes.view","method_need"]]]],["if",["=","method_ok",1],["begin",["let","path_pack",["std.mcp.rr.sanitize_profile._path_pack_v1",["bytes.view","path"]]],["let","ppv",["bytes.view","path_pack"]],["if",["=",["bytes.len","path_pack"],0],0,["begin",["let","seg_count",["codec.read_u32_le","ppv",0]],["let","target_off",["if",["=","seg_count",0],"cur_root",["std.mcp.rr.sanitize_profile._find_path_off_v1","cur_doc","cur_root","ppv"]]],["if",["<","target_off",0],0,["begin",["let","san",["std.mcp.rr.sanitize_profile._sanitize_value_v1","cur_doc","target_off","profile_doc","deny_exact_off","deny_re_off","str_repls_off","replace_utf8",64]],["let","san_json",["std.mcp.util.json.json_from_value_v1",["bytes.view","san"]]],["let","assert_id",["std.mcp.rr.sanitize_profile._first_assertion_hit_id_v1","profile_doc","asserts_off",["bytes.view","san_json"]]],["if",[">",["bytes.len","assert_id"],0],["return",["std.mcp.rr.sanitize_profile._pack_assert_fail_v1","assert_id","t_id"]],0],["let","new_val",["if",["=","seg_count",0],"san",["std.mcp.rr.sanitize_profile._rewrite_set_path_v1","cur_doc","cur_root","ppv",0,["bytes.view","san"]]]],["if",["=",["bytes.len","new_val"],0],0,["begin",["set","cur_val","new_val"],["set","cur_json",["std.mcp.util.json.json_from_value_v1",["bytes.view","cur_val"]]],["set","cur_doc",["bytes.view","empty_doc_b"]],["set","cur_doc_b",["ext.json.data_model.parse",["bytes.view","cur_json"]]],["set","cur_doc",["bytes.view","cur_doc_b"]],["if",["=",["ext.data_model.doc_is_err","cur_doc"],1],["return",["std.mcp.rr.sanitize_profile._pack_err_v1",2]],0],["set","cur_root",["ext.data_model.root_offset","cur_doc"]],0]],0]],0]],0],0]]],0],0],0]],0]],0]],["std.mcp.rr.sanitize_profile._pack_ok_v1","cur_json"]],"kind":"defn","name":"std.mcp.rr.sanitize_profile._sanitize_line_v1","params":[{"name":"profile_doc","ty":"bytes_view"},{"name":"targets_off","ty":"i32"},{"name":"deny_exact_off","ty":"i32"},{"name":"deny_re_off","ty":"i32"},{"name":"str_repls_off","ty":"i32"},{"name":"asserts_off","ty":"i32"},{"name":"replace_utf8","ty":"bytes_view"},{"name":"line_json","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["if",["<","off",0],["return",["ext.data_model.value_null"]],0],["if",["<=","depth",0],["begin",["let","end",["ext.data_model.skip_value","doc","off"]],["if",["<","end",0],["return",["ext.data_model.value_null"]],0],["return",["view.to_bytes",["view.slice","doc","off",["-","end","off"]]]]],0],["let","kind",["ext.data_model.kind_at","doc","off"]],["if",["=","kind",5],["begin",["let","n",["ext.data_model.map_len","doc","off"]],["if",["<","n",0],["return",["ext.data_model.value_null"]],0],["let","entries",["vec_u8.with_capacity",256]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le","n"]]],["for","i",0,"n",["begin",["let","k",["ext.data_model.map_key_at","doc","off","i"]],["let","v_off",["ext.data_model.map_value_at","doc","off","i"]],["let","redact_key",["std.mcp.rr.sanitize_profile._key_matches_deny_v1",["bytes.view","k"],"profile_doc","deny_exact_off","deny_re_off"]],["let","v",["if",["=","redact_key",1],["ext.data_model.value_string","replace_utf8"],["std.mcp.rr.sanitize_profile._sanitize_value_v1","doc","v_off","profile_doc","deny_exact_off","deny_re_off","str_repls_off","replace_utf8",["-","depth",1]]]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",["bytes.len",["bytes.view","k"]]]]],["set","entries",["vec_u8.extend_bytes","entries",["bytes.view","k"]]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",["bytes.len",["bytes.view","v"]]]]],["set","entries",["vec_u8.extend_bytes","entries",["bytes.view","v"]]],0]],["let","entries_b",["vec_u8.into_bytes","entries"]],["let","val",["ext.data_model.value_map_from_entries",["bytes.view","entries_b"]]],["if",["=",["bytes.len","val"],0],["ext.data_model.value_null"],"val"]],["if",["=","kind",4],["begin",["let","n",["ext.data_model.seq_len","doc","off"]],["if",["<","n",0],["return",["ext.data_model.value_null"]],0],["let","elems",["vec_u8.with_capacity",256]],["set","elems",["vec_u8.extend_bytes","elems",["codec.write_u32_le","n"]]],["for","i",0,"n",["begin",["let","it",["ext.data_model.seq_get","doc","off","i"]],["let","v",["std.mcp.rr.sanitize_profile._sanitize_value_v1","doc","it","profile_doc","deny_exact_off","deny_re_off","str_repls_off","replace_utf8",["-","depth",1]]],["set","elems",["vec_u8.extend_bytes","elems",["codec.write_u32_le",["bytes.len",["bytes.view","v"]]]]],["set","elems",["vec_u8.extend_bytes","elems",["bytes.view","v"]]],0]],["let","elems_b",["vec_u8.into_bytes","elems"]],["let","val",["ext.data_model.value_seq_from_elems",["bytes.view","elems_b"]]],["if",["=",["bytes.len","val"],0],["ext.data_model.value_null"],"val"]],["if",["=","kind",3],["begin",["let","s",["ext.data_model.string_get","doc","off"]],["let","s2",["std.mcp.rr.sanitize_profile._apply_string_replacements_v1",["bytes.view","s"],"profile_doc","str_repls_off"]],["ext.data_model.value_string",["bytes.view","s2"]]],["begin",["let","end",["ext.data_model.skip_value","doc","off"]],["if",["<","end",0],["ext.data_model.value_null"],["view.to_bytes",["view.slice","doc","off",["-","end","off"]]]]]]]]],"kind":"defn","name":"std.mcp.rr.sanitize_profile._sanitize_value_v1","params":[{"name":"doc","ty":"bytes_view"},{"name":"off","ty":"i32"},{"name":"profile_doc","ty":"bytes_view"},{"name":"deny_exact_off","ty":"i32"},{"name":"deny_re_off","ty":"i32"},{"name":"str_repls_off","ty":"i32"},{"name":"replace_utf8","ty":"bytes_view"},{"name":"depth","ty":"i32"}],"result":"bytes"},{"body":["begin",["if",["<","off",0],["return",["bytes.alloc",0]],0],["let","end",["ext.data_model.skip_value","doc","off"]],["if",["<","end",0],["return",["bytes.alloc",0]],0],["view.to_bytes",["view.slice","doc","off",["-","end","off"]]]],"kind":"defn","name":"std.mcp.rr.sanitize_profile._value_copy_v1","params":[{"name":"doc","ty":"bytes_view"},{"name":"off","ty":"i32"}],"result":"bytes"},{"body":["begin",["let","pack",["std.mcp.rr.sanitize_profile._sanitize_jsonl_run_v1","profile_json","input_jsonl"]],["let","pv",["bytes.view","pack"]],["if",["<u",["view.len","pv"],8],["return",["bytes.alloc",0]],0],["let","kind",["codec.read_u32_le","pv",0]],["if",["!=","kind",1],["return",["bytes.alloc",0]],0],["let","payload_len",["codec.read_u32_le","pv",4]],["if",["<u",["view.len","pv"],["+",8,"payload_len"]],["return",["bytes.alloc",0]],0],["let","payload",["view.slice","pv",8,"payload_len"]],["let","pos",0],["if",["<u",["view.len","payload"],4],["return",["bytes.alloc",0]],0],["let","assert_id_len",["codec.read_u32_le","payload",0]],["set","pos",4],["if",["<u",["view.len","payload"],["+","pos","assert_id_len"]],["return",["bytes.alloc",0]],0],["let","assertion_id",["view.to_bytes",["view.slice","payload","pos","assert_id_len"]]],["set","pos",["+","pos","assert_id_len"]],["if",["<u",["view.len","payload"],["+","pos",4]],["return",["bytes.alloc",0]],0],["let","target_id_len",["codec.read_u32_le","payload","pos"]],["set","pos",["+","pos",4]],["if",["<u",["view.len","payload"],["+","pos","target_id_len"]],["return",["bytes.alloc",0]],0],["let","target_id",["view.to_bytes",["view.slice","payload","pos","target_id_len"]]],["begin",["let","j",["std.mcp.rr.sanitize_profile._err_report_json_v1",["bytes.view","assertion_id"],["bytes.view","target_id"]]],["let","nl",["bytes.lit","\n"]],["std.bytes.concat",["bytes.view","j"],["bytes.view","nl"]]]],"kind":"defn","name":"std.mcp.rr.sanitize_profile.sanitize_err_report_json_v1","params":[{"name":"profile_json","ty":"bytes_view"},{"name":"input_jsonl","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","pack",["std.mcp.rr.sanitize_profile._sanitize_jsonl_run_v1","profile_json","input_jsonl"]],["let","pv",["bytes.view","pack"]],["if",["<u",["view.len","pv"],8],["return",["result_bytes.err",2]],0],["let","kind",["codec.read_u32_le","pv",0]],["let","payload_len",["codec.read_u32_le","pv",4]],["if",["<u",["view.len","pv"],["+",8,"payload_len"]],["return",["result_bytes.err",2]],0],["if",["=","kind",0],["result_bytes.ok",["view.to_bytes",["view.slice","pv",8,"payload_len"]]],["result_bytes.err",["if",["=","kind",1],1,2]]]],"kind":"defn","name":"std.mcp.rr.sanitize_profile.sanitize_jsonl_v1","params":[{"name":"profile_json","ty":"bytes_view"},{"name":"input_jsonl","ty":"bytes_view"}],"result":"result_bytes"}],"imports":["ext.data_model","ext.json.data_model","ext.regex","std.bytes","std.codec","std.mcp.util.json"],"kind":"module","module_id":"std.mcp.rr.sanitize_profile","schema_version":"x07.x07ast@0.3.0"}
