{"decls":[{"kind":"export","names":["std.mcp.rr.http_sse.replay_from_fs_v1"]},{"body":["begin",["let","off",["ext.data_model.map_find","doc","map_off","key"]],["if",["<","off",0],["return",-1],0],["if",["!=",["ext.data_model.kind_at","doc","off"],2],["return",-1],0],["let","num",["ext.data_model.number_get","doc","off"]],["std.mcp.rr.http_sse._parse_i32_or_neg1_v1",["bytes.view","num"]]],"kind":"defn","name":"std.mcp.rr.http_sse._map_i32_or_neg1_v1","params":[{"name":"doc","ty":"bytes_view"},{"name":"map_off","ty":"i32"},{"name":"key","ty":"bytes_view"}],"result":"i32"},{"body":["begin",["let","off",["ext.data_model.map_find","doc","map_off","key"]],["if",["<","off",0],["return",["bytes.alloc",0]],0],["if",["!=",["ext.data_model.kind_at","doc","off"],3],["return",["bytes.alloc",0]],0],["ext.data_model.string_get","doc","off"]],"kind":"defn","name":"std.mcp.rr.http_sse._map_string_or_empty_v1","params":[{"name":"doc","ty":"bytes_view"},{"name":"map_off","ty":"i32"},{"name":"key","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","st",["std.parse.i32_status_le","b"]],["if",["if",[">=u",["bytes.len","st"],5],["=",["bytes.get_u8","st",0],1],0],["codec.read_u32_le","st",1],-1]],"kind":"defn","name":"std.mcp.rr.http_sse._parse_i32_or_neg1_v1","params":[{"name":"b","ty":"bytes_view"}],"result":"i32"},{"body":["begin",["let","raw",["std.fs.read","cassette_path"]],["let","n",["view.len",["bytes.view","raw"]]],["try",["std.test.assert_i32_eq",[">","n",0],1,["std.test.code_assert_i32_eq"]]],["try",["std.test.assert_i32_eq",["=",["view.get_u8",["bytes.view","raw"],["-","n",1]],10],1,["std.test.code_assert_i32_eq"]]],["let","k_kind",["bytes.lit","kind"]],["let","k_event_id",["bytes.lit","event_id"]],["let","k_message_method",["bytes.lit","message_method"]],["let","k_message_type",["bytes.lit","message_type"]],["let","k_progress_requested",["bytes.lit","progress_requested"]],["let","k_cancelled",["bytes.lit","cancelled"]],["let","k_prime",["bytes.lit","prime"]],["let","k_last_event_id",["bytes.lit","last_event_id"]],["let","kind_meta",["bytes.lit","meta"]],["let","kind_req",["bytes.lit","http.request"]],["let","kind_sse_event",["bytes.lit","sse.event"]],["let","m_progress",["bytes.lit","notifications/progress"]],["let","m_resources_updated",["bytes.lit","notifications/resources/updated"]],["let","type_response",["bytes.lit","response"]],["let","stream_post",["bytes.lit","post"]],["let","seen_meta",0],["let","progress_requested",0],["let","saw_progress",0],["let","saw_cancel",0],["let","saw_response",0],["let","saw_prime",0],["let","saw_sse_event",0],["let","last_sid",["bytes.alloc",0]],["let","last_stream_kind",["bytes.alloc",0]],["let","last_stream_key",["bytes.alloc",0]],["let","last_seq",-1],["let","resume_pending",0],["let","resume_sid",["bytes.alloc",0]],["let","resume_stream_kind",["bytes.alloc",0]],["let","resume_stream_key",["bytes.alloc",0]],["let","resume_seq",-1],["let","start",0],["for","i",0,"n",["begin",["let","_x07_tmp_copy",["std.bytes.copy","raw"]],["if",["=",["view.get_u8",["bytes.view","_x07_tmp_copy"],"i"],10],["begin",["let","line_v",["view.slice",["bytes.view","raw"],"start",["-","i","start"]]],["set","start",["+","i",1]],["if",[">",["view.len","line_v"],0],["begin",["let","doc_b",["ext.json.data_model.parse","line_v"]],["let","doc",["bytes.view","doc_b"]],["try",["std.test.assert_i32_eq",["ext.data_model.doc_is_err","doc"],0,["std.test.code_assert_i32_eq"]]],["let","root",["ext.data_model.root_offset","doc"]],["let","kind",["std.mcp.rr.http_sse._map_string_or_empty_v1","doc","root",["bytes.view","k_kind"]]],["if",["=",["bytes.eq",["bytes.view","kind"],["bytes.view","kind_meta"]],1],["set","seen_meta",1],0],["if",["=",["bytes.eq",["bytes.view","kind"],["bytes.view","kind_req"]],1],["begin",["let","pr",["std.mcp.rr.http_sse._map_i32_or_neg1_v1","doc","root",["bytes.view","k_progress_requested"]]],["if",["=","pr",1],["set","progress_requested",1],0],["let","cn",["std.mcp.rr.http_sse._map_i32_or_neg1_v1","doc","root",["bytes.view","k_cancelled"]]],["if",["=","cn",1],["set","saw_cancel",1],0],["let","last_event_id",["std.mcp.rr.http_sse._map_string_or_empty_v1","doc","root",["bytes.view","k_last_event_id"]]],["if",[">",["std.bytes.len","last_event_id"],0],["begin",["set","resume_sid",["std.mcp.sse.event_id_parse_session_id_v1",["bytes.view","last_event_id"]]],["set","resume_stream_kind",["std.mcp.sse.event_id_parse_stream_kind_v1",["bytes.view","last_event_id"]]],["set","resume_stream_key",["std.mcp.sse.event_id_parse_stream_key_v1",["bytes.view","last_event_id"]]],["set","resume_seq",["std.mcp.sse.event_id_parse_seq_v1",["bytes.view","last_event_id"]]],["set","resume_pending",1],0],0],0],0],["if",["=",["bytes.eq",["bytes.view","kind"],["bytes.view","kind_sse_event"]],1],["begin",["set","saw_sse_event",1],["let","event_id",["std.mcp.rr.http_sse._map_string_or_empty_v1","doc","root",["bytes.view","k_event_id"]]],["try",["std.test.assert_i32_eq",[">",["std.bytes.len","event_id"],0],1,["std.test.code_assert_i32_eq"]]],["let","sid",["std.mcp.sse.event_id_parse_session_id_v1",["bytes.view","event_id"]]],["let","stream_kind",["std.mcp.sse.event_id_parse_stream_kind_v1",["bytes.view","event_id"]]],["let","stream_key",["std.mcp.sse.event_id_parse_stream_key_v1",["bytes.view","event_id"]]],["let","seq",["std.mcp.sse.event_id_parse_seq_v1",["bytes.view","event_id"]]],["try",["std.test.assert_i32_eq",[">=","seq",0],1,["std.test.code_assert_i32_eq"]]],["if",["<","last_seq",0],["begin",["set","last_sid",["std.bytes.copy","sid"]],["set","last_stream_kind",["std.bytes.copy","stream_kind"]],["set","last_stream_key",["std.bytes.copy","stream_key"]],["set","last_seq","seq"],0],["begin",["let","same_stream",["&",["=",["bytes.eq",["bytes.view","sid"],["bytes.view","last_sid"]],1],["&",["=",["bytes.eq",["bytes.view","stream_kind"],["bytes.view","last_stream_kind"]],1],["=",["bytes.eq",["bytes.view","stream_key"],["bytes.view","last_stream_key"]],1]]]],["if",["=","same_stream",1],["try",["std.test.assert_i32_eq","seq",["+","last_seq",1],["std.test.code_assert_i32_eq"]]],0],["set","last_sid",["std.bytes.copy","sid"]],["set","last_stream_kind",["std.bytes.copy","stream_kind"]],["set","last_stream_key",["std.bytes.copy","stream_key"]],["set","last_seq","seq"],0]],["let","prime",["std.mcp.rr.http_sse._map_i32_or_neg1_v1","doc","root",["bytes.view","k_prime"]]],["if",["=","prime",1],["set","saw_prime",1],0],["let","m_method",["std.mcp.rr.http_sse._map_string_or_empty_v1","doc","root",["bytes.view","k_message_method"]]],["if",["=",["bytes.eq",["bytes.view","m_method"],["bytes.view","m_progress"]],1],["set","saw_progress",1],0],["if",["=",["bytes.eq",["bytes.view","m_method"],["bytes.view","m_resources_updated"]],1],["try",["std.test.assert_i32_eq",["=",["bytes.eq",["bytes.view","stream_kind"],["bytes.view","stream_post"]],0],1,["std.test.code_assert_i32_eq"]]],0],["let","m_type",["std.mcp.rr.http_sse._map_string_or_empty_v1","doc","root",["bytes.view","k_message_type"]]],["if",["=",["bytes.eq",["bytes.view","m_type"],["bytes.view","type_response"]],1],["set","saw_response",1],0],["if",["=","resume_pending",1],["begin",["let","same_resume_stream",["&",["=",["bytes.eq",["bytes.view","sid"],["bytes.view","resume_sid"]],1],["&",["=",["bytes.eq",["bytes.view","stream_kind"],["bytes.view","resume_stream_kind"]],1],["=",["bytes.eq",["bytes.view","stream_key"],["bytes.view","resume_stream_key"]],1]]]],["if",["=","same_resume_stream",1],["try",["std.test.assert_i32_eq",[">","seq","resume_seq"],1,["std.test.code_assert_i32_eq"]]],0],["set","resume_pending",0],0],0],0],0],0],0],0],0]]],["try",["std.test.assert_i32_eq","seen_meta",1,["std.test.code_assert_i32_eq"]]],["if",["=","saw_sse_event",1],["try",["std.test.assert_i32_eq","saw_prime",1,["std.test.code_assert_i32_eq"]]],0],["if",["=","progress_requested",1],["try",["std.test.assert_i32_eq","saw_progress",1,["std.test.code_assert_i32_eq"]]],0],["if",["=","saw_cancel",1],["try",["std.test.assert_i32_eq","saw_response",0,["std.test.code_assert_i32_eq"]]],0],["std.test.pass"]],"kind":"defn","name":"std.mcp.rr.http_sse.replay_from_fs_v1","params":[{"name":"cassette_path","ty":"bytes_view"}],"result":"result_i32"}],"imports":["ext.data_model","ext.json.data_model","std.bytes","std.fs","std.mcp.sse","std.parse","std.test"],"kind":"module","module_id":"std.mcp.rr.http_sse","schema_version":"x07.x07ast@0.5.0"}
