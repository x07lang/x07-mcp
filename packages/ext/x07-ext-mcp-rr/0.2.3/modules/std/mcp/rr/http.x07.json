{"decls":[{"kind":"export","names":["std.mcp.rr.http.replay_from_fs_v1"]},{"body":["begin",["let","nh",["view.len","hay"]],["let","nn",["view.len","needle"]],["if",["=","nn",0],["return",1],0],["if",["<u","nh","nn"],["return",0],0],["let","limit",["-","nh","nn"]],["for","i",0,["+","limit",1],["begin",["if",["=",["view.cmp_range","hay","i","nn","needle",0,"nn"],0],["return",1],0],0]],0],"kind":"defn","name":"std.mcp.rr.http._contains_bytes_v1","params":[{"name":"hay","ty":"bytes_view"},{"name":"needle","ty":"bytes_view"}],"result":"i32"},{"body":["begin",["if",["!=",["ext.data_model.kind_at","headers_val",0],5],["return",["bytes.alloc",0]],0],["let","off",["ext.data_model.map_find","headers_val",0,"name"]],["if",["<","off",0],["return",["bytes.alloc",0]],0],["if",["!=",["ext.data_model.kind_at","headers_val","off"],3],["return",["bytes.alloc",0]],0],["ext.data_model.string_get","headers_val","off"]],"kind":"defn","name":"std.mcp.rr.http._header_get_exact_v1","params":[{"name":"headers_val","ty":"bytes_view"},{"name":"name","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","entries",["vec_u8.with_capacity",4]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",0]]],["let","entries_b",["vec_u8.into_bytes","entries"]],["ext.data_model.value_map_from_entries",["bytes.view","entries_b"]]],"kind":"defn","name":"std.mcp.rr.http._headers_empty_v1","params":[],"result":"bytes"},{"body":["begin",["let","v_val",["ext.data_model.value_string","value_text"]],["let","entries",["vec_u8.with_capacity",128]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",1]]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",["bytes.len","key"]]]],["set","entries",["vec_u8.extend_bytes","entries","key"]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",["bytes.len","v_val"]]]],["set","entries",["vec_u8.extend_bytes","entries","v_val"]],["let","entries_b",["vec_u8.into_bytes","entries"]],["ext.data_model.value_map_from_entries",["bytes.view","entries_b"]]],"kind":"defn","name":"std.mcp.rr.http._headers_one_v1","params":[{"name":"key","ty":"bytes_view"},{"name":"value_text","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","off",["ext.data_model.map_find","doc","map_off","key"]],["if",["<","off",0],["return",["bytes.alloc",0]],0],["if",["!=",["ext.data_model.kind_at","doc","off"],3],["return",["bytes.alloc",0]],0],["ext.data_model.string_get","doc","off"]],"kind":"defn","name":"std.mcp.rr.http._map_string_or_empty_v1","params":[{"name":"doc","ty":"bytes_view"},{"name":"map_off","ty":"i32"},{"name":"key","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","off",["ext.data_model.map_find","doc","map_off","key"]],["if",["<","off",0],["return",["bytes.alloc",0]],0],["let","end",["ext.data_model.skip_value","doc","off"]],["if",["<","end",0],["return",["bytes.alloc",0]],0],["let","val",["view.to_bytes",["view.slice","doc","off",["-","end","off"]]]],["std.mcp.util.json.json_from_value_v1",["bytes.view","val"]]],"kind":"defn","name":"std.mcp.rr.http._map_value_json_or_empty_v1","params":[{"name":"doc","ty":"bytes_view"},{"name":"map_off","ty":"i32"},{"name":"key","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","st",["std.parse.i32_status_le","b"]],["if",["if",[">=u",["bytes.len","st"],5],["=",["bytes.get_u8","st",0],1],0],["codec.read_u32_le","st",1],-1]],"kind":"defn","name":"std.mcp.rr.http._parse_i32_or_neg1_v1","params":[{"name":"b","ty":"bytes_view"}],"result":"i32"},{"body":["begin",["if",["<","seq_off",0],["return",["bytes.alloc",0]],0],["if",["!=",["ext.data_model.kind_at","doc","seq_off"],4],["return",["bytes.alloc",0]],0],["let","n",["ext.data_model.seq_len","doc","seq_off"]],["if",["<","n",0],["return",["bytes.alloc",0]],0],["let","out",["vec_u8.with_capacity",64]],["for","i",0,"n",["begin",["let","off",["ext.data_model.seq_get","doc","seq_off","i"]],["if",["<","off",0],["return",["bytes.alloc",0]],0],["if",["!=",["ext.data_model.kind_at","doc","off"],3],["return",["bytes.alloc",0]],0],["if",[">","i",0],["begin",["set","out",["vec_u8.push","out",32]],0],0],["let","scope_part",["ext.data_model.string_get","doc","off"]],["set","out",["vec_u8.extend_bytes","out",["bytes.view","scope_part"]]],0]],["vec_u8.into_bytes","out"]],"kind":"defn","name":"std.mcp.rr.http._scope_text_from_seq_v1","params":[{"name":"doc","ty":"bytes_view"},{"name":"seq_off","ty":"i32"}],"result":"bytes"},{"body":["begin",["let","a_json",["std.mcp.auth.scopes_v1.parse_scope_str_v1","a_text"]],["let","b_json",["std.mcp.auth.scopes_v1.parse_scope_str_v1","b_text"]],["let","u_json",["std.mcp.auth.scopes_v1.scopes_union_v1",["bytes.view","a_json"],["bytes.view","b_json"]]],["let","doc_b",["ext.json.data_model.parse",["bytes.view","u_json"]]],["let","doc",["bytes.view","doc_b"]],["if",["=",["ext.data_model.doc_is_err","doc"],1],["return",["bytes.alloc",0]],0],["if",["!=",["ext.data_model.root_kind","doc"],4],["return",["bytes.alloc",0]],0],["let","root",["ext.data_model.root_offset","doc"]],["std.mcp.rr.http._scope_text_from_seq_v1","doc","root"]],"kind":"defn","name":"std.mcp.rr.http._scope_union_text_v1","params":[{"name":"a_text","ty":"bytes_view"},{"name":"b_text","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","n",["view.len","target_utf8"]],["for","i",0,"n",["begin",["if",["=",["view.get_u8","target_utf8","i"],63],["return",["view.to_bytes",["view.slice","target_utf8",0,"i"]]],0],0]],["view.to_bytes","target_utf8"]],"kind":"defn","name":"std.mcp.rr.http._target_path_v1","params":[{"name":"target_utf8","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","n",["view.len","target_utf8"]],["for","i",0,"n",["begin",["if",["=",["view.get_u8","target_utf8","i"],63],["begin",["let","start",["+","i",1]],["if",[">=","start","n"],["return",["bytes.alloc",0]],0],["return",["view.to_bytes",["view.slice","target_utf8","start",["-","n","start"]]]]],0],0]],["bytes.alloc",0]],"kind":"defn","name":"std.mcp.rr.http._target_query_v1","params":[{"name":"target_utf8","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","doc_b",["ext.json.data_model.parse","tools_json"]],["let","doc",["bytes.view","doc_b"]],["if",["=",["ext.data_model.doc_is_err","doc"],1],["return",["bytes.alloc",0]],0],["if",["!=",["ext.data_model.root_kind","doc"],5],["return",["bytes.alloc",0]],0],["let","root",["ext.data_model.root_offset","doc"]],["let","k_tools",["bytes.lit","tools"]],["let","tools_off",["ext.data_model.map_find","doc","root",["bytes.view","k_tools"]]],["if",["<","tools_off",0],["return",["bytes.alloc",0]],0],["if",["!=",["ext.data_model.kind_at","doc","tools_off"],4],["return",["bytes.alloc",0]],0],["let","n",["ext.data_model.seq_len","doc","tools_off"]],["if",["<","n",0],["return",["bytes.alloc",0]],0],["let","k_name",["bytes.lit","name"]],["let","k_auth",["bytes.lit","auth"]],["let","k_required_scopes",["bytes.lit","required_scopes"]],["for","i",0,"n",["begin",["let","item_off",["ext.data_model.seq_get","doc","tools_off","i"]],["if",["<","item_off",0],0,["if",["!=",["ext.data_model.kind_at","doc","item_off"],5],0,["begin",["let","name",["std.mcp.rr.http._map_string_or_empty_v1","doc","item_off",["bytes.view","k_name"]]],["if",["=",["view.eq",["bytes.view","name"],"tool_name"],1],["begin",["let","auth_off",["ext.data_model.map_find","doc","item_off",["bytes.view","k_auth"]]],["if",["if",[">=","auth_off",0],["=",["ext.data_model.kind_at","doc","auth_off"],5],0],["begin",["let","scopes_off",["ext.data_model.map_find","doc","auth_off",["bytes.view","k_required_scopes"]]],["return",["std.mcp.rr.http._scope_text_from_seq_v1","doc","scopes_off"]]],["return",["bytes.alloc",0]]]],0],0]]],0]],["bytes.alloc",0]],"kind":"defn","name":"std.mcp.rr.http._tool_required_scopes_text_v1","params":[{"name":"tools_json","ty":"bytes_view"},{"name":"tool_name","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","k_schema_version",["bytes.lit","schema_version"]],["let","k_project_files",["bytes.lit","project_files"]],["let","k_server",["bytes.lit","server"]],["let","k_transport",["bytes.lit","transport"]],["let","k_auth",["bytes.lit","auth"]],["let","k_name",["bytes.lit","name"]],["let","k_version",["bytes.lit","version"]],["let","k_protocol_version",["bytes.lit","protocolVersion"]],["let","k_mcp_path",["bytes.lit","mcp_path"]],["let","k_mode",["bytes.lit","mode"]],["let","k_required_scopes",["bytes.lit","required_scopes"]],["let","k_oauth_cfg_path",["bytes.lit","oauth_config_path"]],["let","k_base_url",["bytes.lit","base_url"]],["let","k_resource",["bytes.lit","resource"]],["let","k_tools_path",["bytes.lit","tools_manifest_path"]],["let","k_steps",["bytes.lit","steps"]],["let","k_req",["bytes.lit","req"]],["let","k_res",["bytes.lit","res"]],["let","k_method",["bytes.lit","method"]],["let","k_path",["bytes.lit","path"]],["let","k_headers",["bytes.lit","headers"]],["let","k_body_json",["bytes.lit","body_json"]],["let","k_status",["bytes.lit","status"]],["let","k_body_empty",["bytes.lit","body_empty"]],["let","k_oauth",["bytes.lit","oauth"]],["let","k_tools",["bytes.lit","tools"]],["let","k_resources",["bytes.lit","resources"]],["let","k_prompts",["bytes.lit","prompts"]],["let","schema_a",["bytes.lit","x07.mcp.rr.http_session@0.1.0"]],["let","schema_b",["bytes.lit","x07.mcp.rr.http-session@0.1.0"]],["let","method_get",["bytes.lit","GET"]],["let","method_post",["bytes.lit","POST"]],["let","path_prm",["bytes.lit","/.well-known/oauth-protected-resource"]],["let","path_default_mcp",["bytes.lit","/mcp"]],["let","auth_mode_none",["bytes.lit","none"]],["let","auth_mode_oauth2",["bytes.lit","oauth2"]],["let","hdr_mcp_pv",["bytes.lit","MCP-Protocol-Version"]],["let","hdr_mcp_sid",["bytes.lit","MCP-Session-Id"]],["let","hdr_authz",["bytes.lit","Authorization"]],["let","hdr_allow",["bytes.lit","Allow"]],["let","hdr_content_type",["bytes.lit","Content-Type"]],["let","hdr_www_auth",["bytes.lit","WWW-Authenticate"]],["let","needle_access_token",["bytes.lit","access_token"]],["let","v_allow_post",["bytes.lit","POST"]],["let","v_content_type_json",["bytes.lit","application/json"]],["let","suffix_prm",["bytes.lit","/.well-known/oauth-protected-resource"]],["let","raw",["std.fs.read","session_path"]],["let","doc_b",["ext.json.data_model.parse",["bytes.view","raw"]]],["let","doc",["bytes.view","doc_b"]],["try",["std.test.assert_i32_eq",["ext.data_model.doc_is_err","doc"],0,["std.test.code_assert_i32_eq"]]],["let","root",["ext.data_model.root_offset","doc"]],["let","schema_off",["ext.data_model.map_find","doc","root",["bytes.view","k_schema_version"]]],["try",["std.test.assert_i32_eq",[">=","schema_off",0],1,["std.test.code_assert_i32_eq"]]],["let","schema_val",["ext.data_model.string_get","doc","schema_off"]],["let","ok_schema",0],["if",["=",["bytes.eq",["bytes.view","schema_val"],["bytes.view","schema_a"]],1],["set","ok_schema",1],0],["if",["=",["bytes.eq",["bytes.view","schema_val"],["bytes.view","schema_b"]],1],["set","ok_schema",1],0],["try",["std.test.assert_i32_eq","ok_schema",1,["std.test.code_assert_i32_eq"]]],["let","project_files_off",["ext.data_model.map_find","doc","root",["bytes.view","k_project_files"]]],["let","cfg_path",["bytes.lit","config/mcp.server.json"]],["let","tools_path",["bytes.lit","config/mcp.tools.json"]],["let","oauth_path",["bytes.lit","config/mcp.oauth.json"]],["let","resources_path",["bytes.lit","config/mcp.resources.json"]],["let","prompts_path",["bytes.lit","config/mcp.prompts.json"]],["if",["if",[">=","project_files_off",0],["=",["ext.data_model.kind_at","doc","project_files_off"],5],0],["begin",["let","p_cfg",["std.mcp.rr.http._map_string_or_empty_v1","doc","project_files_off",["bytes.view","k_server"]]],["let","p_tools",["std.mcp.rr.http._map_string_or_empty_v1","doc","project_files_off",["bytes.view","k_tools"]]],["let","p_oauth",["std.mcp.rr.http._map_string_or_empty_v1","doc","project_files_off",["bytes.view","k_oauth"]]],["let","p_resources",["std.mcp.rr.http._map_string_or_empty_v1","doc","project_files_off",["bytes.view","k_resources"]]],["let","p_prompts",["std.mcp.rr.http._map_string_or_empty_v1","doc","project_files_off",["bytes.view","k_prompts"]]],["let","p_cfg_len",["bytes.len",["bytes.view","p_cfg"]]],["if",[">","p_cfg_len",0],["begin",["set","cfg_path","p_cfg"],0],0],["let","p_tools_len",["bytes.len",["bytes.view","p_tools"]]],["if",[">","p_tools_len",0],["begin",["set","tools_path","p_tools"],0],0],["let","p_oauth_len",["bytes.len",["bytes.view","p_oauth"]]],["if",[">","p_oauth_len",0],["begin",["set","oauth_path","p_oauth"],0],0],["let","p_resources_len",["bytes.len",["bytes.view","p_resources"]]],["if",[">","p_resources_len",0],["begin",["set","resources_path","p_resources"],0],0],["let","p_prompts_len",["bytes.len",["bytes.view","p_prompts"]]],["if",[">","p_prompts_len",0],["begin",["set","prompts_path","p_prompts"],0],0],0],0],["let","cfg_json",["std.fs.read",["bytes.view","cfg_path"]]],["let","cfg_doc_b",["ext.json.data_model.parse",["bytes.view","cfg_json"]]],["let","cfg_doc",["bytes.view","cfg_doc_b"]],["try",["std.test.assert_i32_eq",["ext.data_model.doc_is_err","cfg_doc"],0,["std.test.code_assert_i32_eq"]]],["let","cfg_root",["ext.data_model.root_offset","cfg_doc"]],["let","server_off",["ext.data_model.map_find","cfg_doc","cfg_root",["bytes.view","k_server"]]],["let","transport_off",["ext.data_model.map_find","cfg_doc","cfg_root",["bytes.view","k_transport"]]],["let","auth_off",["ext.data_model.map_find","cfg_doc","cfg_root",["bytes.view","k_auth"]]],["let","server_name",["std.mcp.rr.http._map_string_or_empty_v1","cfg_doc","server_off",["bytes.view","k_name"]]],["let","server_version",["std.mcp.rr.http._map_string_or_empty_v1","cfg_doc","server_off",["bytes.view","k_version"]]],["let","cfg_pv",["std.mcp.rr.http._map_string_or_empty_v1","cfg_doc","server_off",["bytes.view","k_protocol_version"]]],["let","mcp_path",["std.mcp.rr.http._map_string_or_empty_v1","cfg_doc","transport_off",["bytes.view","k_mcp_path"]]],["let","mcp_path_len",["bytes.len",["bytes.view","mcp_path"]]],["if",["=","mcp_path_len",0],["begin",["set","mcp_path","path_default_mcp"],0],0],["let","auth_mode",["std.mcp.rr.http._map_string_or_empty_v1","cfg_doc","auth_off",["bytes.view","k_mode"]]],["let","auth_mode_len",["bytes.len",["bytes.view","auth_mode"]]],["if",["=","auth_mode_len",0],["begin",["set","auth_mode","auth_mode_none"],0],0],["let","cfg_required_scopes",["std.mcp.rr.http._scope_text_from_seq_v1","cfg_doc",["ext.data_model.map_find","cfg_doc","auth_off",["bytes.view","k_required_scopes"]]]],["let","base_url",["std.mcp.rr.http._map_string_or_empty_v1","doc","root",["bytes.view","k_base_url"]]],["let","rs_pack",["bytes.alloc",0]],["let","resource_md_url",["bytes.alloc",0]],["let","resource_md_root_url",["bytes.alloc",0]],["let","prm_body",["bytes.alloc",0]],["let","serve_root_alias",0],["let","prm_insertion_path",["bytes.alloc",0]],["let","prm_root_path",["bytes.alloc",0]],["let","oauth_json",["bytes.alloc",0]],["let","oauth_cfg_path",["std.mcp.rr.http._map_string_or_empty_v1","cfg_doc","auth_off",["bytes.view","k_oauth_cfg_path"]]],["if",["=",["view.eq",["bytes.view","auth_mode"],["bytes.view","auth_mode_oauth2"]],1],["begin",["let","oauth_cfg_path_len",["bytes.len",["bytes.view","oauth_cfg_path"]]],["if",[">","oauth_cfg_path_len",0],["begin",["set","oauth_path","oauth_cfg_path"],0],0],["set","oauth_json",["std.fs.read",["bytes.view","oauth_path"]]],["let","rs_res",["std.mcp.auth.rs_v1.oauth2_rs_from_oauth_cfg_v1",["bytes.view","oauth_json"]]],["try",["std.test.assert_i32_eq",["result_bytes.err_code","rs_res"],0,["std.test.code_assert_i32_eq"]]],["set","rs_pack",["result_bytes.unwrap_or","rs_res",["bytes.alloc",0]]],["let","rs_doc_b",["ext.json.data_model.parse",["bytes.view","rs_pack"]]],["let","rs_doc",["bytes.view","rs_doc_b"]],["try",["std.test.assert_i32_eq",["ext.data_model.doc_is_err","rs_doc"],0,["std.test.code_assert_i32_eq"]]],["try",["std.test.assert_i32_eq",["ext.data_model.root_kind","rs_doc"],5,["std.test.code_assert_i32_eq"]]],["let","rs_root",["ext.data_model.root_offset","rs_doc"]],["let","k_md",["bytes.lit","resource_metadata_url"]],["let","k_md_root",["bytes.lit","resource_metadata_root_url"]],["let","k_prm",["bytes.lit","prm_json"]],["let","k_serve_root",["bytes.lit","serve_root_alias"]],["set","resource_md_url",["std.mcp.rr.http._map_string_or_empty_v1","rs_doc","rs_root",["bytes.view","k_md"]]],["set","resource_md_root_url",["std.mcp.rr.http._map_string_or_empty_v1","rs_doc","rs_root",["bytes.view","k_md_root"]]],["set","prm_body",["std.mcp.rr.http._map_string_or_empty_v1","rs_doc","rs_root",["bytes.view","k_prm"]]],["let","serve_off",["ext.data_model.map_find","rs_doc","rs_root",["bytes.view","k_serve_root"]]],["if",["if",[">=","serve_off",0],["=",["ext.data_model.kind_at","rs_doc","serve_off"],1],0],["set","serve_root_alias",["ext.data_model.bool_get","rs_doc","serve_off"]],0],["let","base_len",["bytes.len",["bytes.view","base_url"]]],["let","md_v",["bytes.view","resource_md_url"]],["let","md_len",["bytes.len","md_v"]],["if",["&",[">","md_len","base_len"],["=",["view.cmp_range","md_v",0,"base_len",["bytes.view","base_url"],0,"base_len"],0]],["set","prm_insertion_path",["view.to_bytes",["view.slice","md_v","base_len",["-","md_len","base_len"]]]],0],["let","mdr_v",["bytes.view","resource_md_root_url"]],["let","mdr_len",["bytes.len","mdr_v"]],["if",["&",[">","mdr_len","base_len"],["=",["view.cmp_range","mdr_v",0,"base_len",["bytes.view","base_url"],0,"base_len"],0]],["set","prm_root_path",["view.to_bytes",["view.slice","mdr_v","base_len",["-","mdr_len","base_len"]]]],0],0],0],["let","tools_json",["bytes.alloc",0]],["let","resources_json",["bytes.lit","{\"schema_version\":\"x07.mcp.resources_manifest@0.1.0\",\"resources\":[]}"]],["let","prompts_json",["bytes.lit","{\"schema_version\":\"x07.mcp.prompts_manifest@0.1.0\",\"prompts\":[]}"]],["let","tools_loaded",0],["let","steps_off",["ext.data_model.map_find","doc","root",["bytes.view","k_steps"]]],["let","n",["ext.data_model.seq_len","doc","steps_off"]],["try",["std.test.assert_i32_eq",[">","n",0],1,["std.test.code_assert_i32_eq"]]],["let","mcp_state",0],["let","session_id",["bytes.alloc",0]],["let","session_idx",1],["for","i",0,"n",["begin",["let","step_off",["ext.data_model.seq_get","doc","steps_off","i"]],["let","req_off",["ext.data_model.map_find","doc","step_off",["bytes.view","k_req"]]],["let","res_off",["ext.data_model.map_find","doc","step_off",["bytes.view","k_res"]]],["let","method",["std.mcp.rr.http._map_string_or_empty_v1","doc","req_off",["bytes.view","k_method"]]],["let","path",["std.mcp.rr.http._map_string_or_empty_v1","doc","req_off",["bytes.view","k_path"]]],["let","target_path",["std.mcp.rr.http._target_path_v1",["bytes.view","path"]]],["let","target_query",["std.mcp.rr.http._target_query_v1",["bytes.view","path"]]],["let","req_headers_off",["ext.data_model.map_find","doc","req_off",["bytes.view","k_headers"]]],["let","req_json",["std.mcp.rr.http._map_value_json_or_empty_v1","doc","req_off",["bytes.view","k_body_json"]]],0,["let","actual_status",-1],["let","actual_header_name",["bytes.alloc",0]],["let","actual_header_value",["bytes.alloc",0]],["let","actual_body",["bytes.alloc",0]],["let","auth_ctx_json",["bytes.alloc",0]],["if",["if",["=",["view.eq",["bytes.view","method"],["bytes.view","method_get"]],1],["=",["view.eq",["bytes.view","target_path"],["bytes.view","mcp_path"]],1],0],["begin",["set","actual_status",405],["set","actual_header_name",["std.bytes.copy","hdr_allow"]],["set","actual_header_value",["std.bytes.copy","v_allow_post"]],0],0],["if",["if",["<","actual_status",0],["if",["=",["view.eq",["bytes.view","method"],["bytes.view","method_get"]],1],["|",["=",["view.eq",["bytes.view","target_path"],["bytes.view","prm_insertion_path"]],1],["&",["=","serve_root_alias",1],["=",["view.eq",["bytes.view","target_path"],["bytes.view","prm_root_path"]],1]]],0],0],["begin",["if",["=",["view.eq",["bytes.view","auth_mode"],["bytes.view","auth_mode_oauth2"]],1],["begin",["set","actual_status",200],["set","actual_header_name",["std.bytes.copy","hdr_content_type"]],["set","actual_header_value",["std.bytes.copy","v_content_type_json"]],["set","actual_body",["std.bytes.copy","prm_body"]],0],["set","actual_status",404]],0],0],["if",["if",["<","actual_status",0],["if",["=",["view.eq",["bytes.view","method"],["bytes.view","method_post"]],1],["=",["view.eq",["bytes.view","target_path"],["bytes.view","mcp_path"]],1],0],0],["begin",["let","has_access_token",["std.mcp.rr.http._contains_bytes_v1",["bytes.view","target_query"],["bytes.view","needle_access_token"]]],["if",["=","has_access_token",1],["set","actual_status",400],0],["if",["<","actual_status",0],["begin",["let","ver",["std.mcp.rr.http._map_string_or_empty_v1","doc","req_headers_off",["bytes.view","hdr_mcp_pv"]]],["if",["=",["std.mcp.transport.http_rules.protocol_valid_v1",["bytes.view","ver"]],0],["set","actual_status",400],0],["let","session_id_len_req",["bytes.len",["bytes.view","session_id"]]],["if",["if",["<","actual_status",0],[">","session_id_len_req",0],0],["begin",["let","sid",["std.mcp.rr.http._map_string_or_empty_v1","doc","req_headers_off",["bytes.view","hdr_mcp_sid"]]],["let","sid_len",["bytes.len",["bytes.view","sid"]]],["if",["=","sid_len",0],["set","actual_status",400],["if",["=",["view.eq",["bytes.view","sid"],["bytes.view","session_id"]],0],["set","actual_status",404],0]],0],0],["if",["if",["<","actual_status",0],["=",["view.eq",["bytes.view","auth_mode"],["bytes.view","auth_mode_oauth2"]],1],0],["begin",["let","req_headers_end",["ext.data_model.skip_value","doc","req_headers_off"]],["let","req_headers_val",["view.to_bytes",["view.slice","doc","req_headers_off",["-","req_headers_end","req_headers_off"]]]],["let","req_headers_json",["std.mcp.util.json.json_from_value_v1",["bytes.view","req_headers_val"]]],["let","auth_pack_json",["std.mcp.auth.rs_v1.oauth2_authenticate_http_v1",["bytes.view","rs_pack"],["bytes.view","req_headers_json"],["bytes.view","cfg_required_scopes"]]],["let","auth_doc_b",["ext.json.data_model.parse",["bytes.view","auth_pack_json"]]],["let","auth_doc",["bytes.view","auth_doc_b"]],["try",["std.test.assert_i32_eq",["ext.data_model.doc_is_err","auth_doc"],0,["std.test.code_assert_i32_eq"]]],["try",["std.test.assert_i32_eq",["ext.data_model.root_kind","auth_doc"],5,["std.test.code_assert_i32_eq"]]],["let","auth_root",["ext.data_model.root_offset","auth_doc"]],["let","k_ok",["bytes.lit","ok"]],["let","ok_off",["ext.data_model.map_find","auth_doc","auth_root",["bytes.view","k_ok"]]],["try",["std.test.assert_i32_eq",[">=","ok_off",0],1,["std.test.code_assert_i32_eq"]]],["try",["std.test.assert_i32_eq",["ext.data_model.kind_at","auth_doc","ok_off"],1,["std.test.code_assert_i32_eq"]]],["let","ok",["ext.data_model.bool_get","auth_doc","ok_off"]],["if",["=","ok",1],["begin",["let","k_ctx",["bytes.lit","ctx"]],["let","ctx_off",["ext.data_model.map_find","auth_doc","auth_root",["bytes.view","k_ctx"]]],["if",[">=","ctx_off",0],["begin",["let","ctx_end",["ext.data_model.skip_value","auth_doc","ctx_off"]],["let","ctx_val",["view.to_bytes",["view.slice","auth_doc","ctx_off",["-","ctx_end","ctx_off"]]]],["set","auth_ctx_json",["std.mcp.util.json.json_from_value_v1",["bytes.view","ctx_val"]]],0],0],0],0],["if",["=","ok",0],["begin",["let","k_err_status",["bytes.lit","err_status"]],["let","k_err_www",["bytes.lit","err_www_authenticate"]],["let","err_status_off",["ext.data_model.map_find","auth_doc","auth_root",["bytes.view","k_err_status"]]],["let","err_status_num",["ext.data_model.number_get","auth_doc","err_status_off"]],["let","err_status",["std.mcp.rr.http._parse_i32_or_neg1_v1",["bytes.view","err_status_num"]]],["if",[">","err_status",0],["set","actual_status","err_status"],["set","actual_status",500]],["let","www_auth",["std.mcp.rr.http._map_string_or_empty_v1","auth_doc","auth_root",["bytes.view","k_err_www"]]],["set","actual_header_name",["std.bytes.copy","hdr_www_auth"]],["set","actual_header_value",["std.bytes.copy","www_auth"]],0],0],0],0],["if",["&",["<","actual_status",0],["&",["=",["view.eq",["bytes.view","auth_mode"],["bytes.view","auth_mode_oauth2"]],1],["&",[">",["bytes.len",["bytes.view","cfg_required_scopes"]],0],[">",["bytes.len",["bytes.view","auth_ctx_json"]],0]]]],["begin",["let","method_ok",["std.mcp.auth.rs_v1.oauth2_authorize_scopes_v1",["bytes.view","auth_ctx_json"],["bytes.view","cfg_required_scopes"]]],["if",["=","method_ok",1],0,["begin",["set","actual_status",403],["let","www",["std.mcp.auth.bearer_v1.build_www_authenticate_bearer_v1",["bytes.view","resource_md_url"],["bytes.view","cfg_required_scopes"],3]],["set","actual_header_name",["std.bytes.copy","hdr_www_auth"]],["set","actual_header_value",["std.bytes.copy","www"]],0]],0],0],["if",["<","actual_status",0],["begin",["if",["=","tools_loaded",0],["begin",["let","tools_res",["std.mcp.toolkit.tools_file.load_tools_from_fs_v1",["bytes.view","tools_path"]]],["if",["!=",["result_bytes.err_code","tools_res"],0],["set","actual_status",500],["begin",["set","tools_json",["result_bytes.unwrap_or","tools_res",["bytes.alloc",0]]],["let","resources_raw",["std.fs.read",["bytes.view","resources_path"]]],["let","resources_raw_len",["bytes.len",["bytes.view","resources_raw"]]],["if",["=","resources_raw_len",0],["begin",["set","resources_raw",["bytes.lit","{\"schema_version\":\"x07.mcp.resources_manifest.1.0\",\"resources\":[]}"]],0],0],["let","resources_raw_len2",["bytes.len",["bytes.view","resources_raw"]]],["if",[">","resources_raw_len2",0],["begin",["let","resources_res",["std.mcp.toolkit.resources_file.load_resources_from_json_v1",["bytes.view","resources_raw"]]],["if",["!=",["result_bytes.err_code","resources_res"],0],["begin",["set","actual_status",500],0],["begin",["set","resources_json",["result_bytes.unwrap_or","resources_res",["bytes.alloc",0]]],0]],0],0],["let","prompts_raw",["std.fs.read",["bytes.view","prompts_path"]]],["let","prompts_raw_len",["bytes.len",["bytes.view","prompts_raw"]]],["if",["=","prompts_raw_len",0],["begin",["set","prompts_raw",["bytes.lit","{\"schema_version\":\"x07.mcp.prompts_manifest.1.0\",\"prompts\":[]}"]],0],0],["let","prompts_raw_len2",["bytes.len",["bytes.view","prompts_raw"]]],["if",[">","prompts_raw_len2",0],["begin",["let","prompts_res",["std.mcp.toolkit.prompts_file.load_prompts_from_json_v1",["bytes.view","prompts_raw"]]],["if",["!=",["result_bytes.err_code","prompts_res"],0],["begin",["set","actual_status",500],0],["begin",["set","prompts_json",["result_bytes.unwrap_or","prompts_res",["bytes.alloc",0]]],0]],0],0],["set","tools_loaded",1],0]],0],0],["let","dispatch",["result_bytes.err",1]],["if",["<","actual_status",0],["begin",["set","dispatch",["std.mcp.toolkit.stdio_dispatch.dispatch_line_v1","mcp_state",["bytes.view","cfg_pv"],["bytes.view","server_name"],["bytes.view","server_version"],["bytes.view","tools_json"],["bytes.view","resources_json"],["bytes.view","prompts_json"],["bytes.view","req_json"]]],["if",["!=",["result_bytes.err_code","dispatch"],0],["set","actual_status",500],0],0],0],["if",["<","actual_status",0],["begin",["let","step_b",["result_bytes.unwrap_or","dispatch",["bytes.alloc",0]]],["let","kind",["std.mcp.toolkit.stdio_dispatch.step_kind_v1",["bytes.view","step_b"]]],["let","next_state",["std.mcp.toolkit.stdio_dispatch.step_next_state_v1",["bytes.view","step_b"]]],["if",["=","kind",0],["begin",["set","actual_status",202],["set","mcp_state","next_state"],0],0],["if",["=","kind",1],["begin",["set","actual_status",200],["set","actual_body",["std.mcp.toolkit.stdio_dispatch.step_resp_json_v1",["bytes.view","step_b"]]],["let","session_id_len_emit",["bytes.len",["bytes.view","session_id"]]],["if",["=","session_id_len_emit",0],["begin",["set","session_id",["std.mcp.transport.http_session.next_test_session_id_v1","session_idx"]],["set","session_idx",["+","session_idx",1]],["set","actual_header_name",["std.bytes.copy","hdr_mcp_sid"]],["set","actual_header_value",["std.bytes.copy","session_id"]],0],0],["set","mcp_state","next_state"],0],0],["if",["=","kind",2],["begin",["let","id_json",["std.mcp.toolkit.stdio_dispatch.step_tool_call_id_json_v1",["bytes.view","step_b"]]],["let","tool_name",["std.mcp.toolkit.stdio_dispatch.step_tool_call_tool_name_v1",["bytes.view","step_b"]]],["let","args_json",["std.mcp.toolkit.stdio_dispatch.step_tool_call_args_json_v1",["bytes.view","step_b"]]],["let","tool_scopes",["std.mcp.rr.http._tool_required_scopes_text_v1",["bytes.view","tools_json"],["bytes.view","tool_name"]]],["let","required_scopes_tool",["std.mcp.rr.http._scope_union_text_v1",["bytes.view","cfg_required_scopes"],["bytes.view","tool_scopes"]]],["let","need_check",["if",["&",["=",["view.eq",["bytes.view","auth_mode"],["bytes.view","auth_mode_oauth2"]],1],[">",["bytes.len",["bytes.view","auth_ctx_json"]],0]],1,0]],["let","tool_ok",["if",["=","need_check",1],["std.mcp.auth.rs_v1.oauth2_authorize_scopes_v1",["bytes.view","auth_ctx_json"],["bytes.view","required_scopes_tool"]],1]],["if",["=","tool_ok",1],["begin",["let","worker_req",["std.mcp.sandbox.worker_proto.make_request_v1",["bytes.view","tool_name"],["bytes.view","cfg_json"],["bytes.view","args_json"],["bytes.view","tools_json"]]],["let","worker_resp",["std.mcp.sandbox.worker_main.run_v1",["bytes.view","worker_req"]]],["let","tool_res",["std.mcp.sandbox.worker_proto.parse_tool_result_v1","worker_resp"]],["if",["!=",["result_bytes.err_code","tool_res"],0],["set","actual_status",500],["begin",["let","tool_payload",["result_bytes.unwrap_or","tool_res",["bytes.alloc",0]]],["set","actual_status",200],["set","actual_body",["std.mcp.jsonrpc.make_result_response_v1",["bytes.view","id_json"],["bytes.view","tool_payload"]]],["set","mcp_state","next_state"]]],0],["begin",["set","actual_status",403],["let","www",["std.mcp.auth.bearer_v1.build_www_authenticate_bearer_v1",["bytes.view","resource_md_url"],["bytes.view","required_scopes_tool"],3]],["set","actual_header_name",["std.bytes.copy","hdr_www_auth"]],["set","actual_header_value",["std.bytes.copy","www"]],0]]],0],["if",["<","actual_status",0],["set","actual_status",500],0],0],0],0],0],0],0]],0],["if",["<","actual_status",0],["set","actual_status",404],0],["let","exp_status_off",["ext.data_model.map_find","doc","res_off",["bytes.view","k_status"]]],["let","exp_status_num",["ext.data_model.number_get","doc","exp_status_off"]],["let","exp_status",["std.mcp.rr.http._parse_i32_or_neg1_v1",["bytes.view","exp_status_num"]]],["try",["std.test.assert_i32_eq","actual_status","exp_status",["std.test.code_assert_i32_eq"]]],["let","exp_headers_off",["ext.data_model.map_find","doc","res_off",["bytes.view","k_headers"]]],["if",["if",[">=","exp_headers_off",0],["=",["ext.data_model.kind_at","doc","exp_headers_off"],5],0],["begin",["let","exp_allow",["std.mcp.rr.http._map_string_or_empty_v1","doc","exp_headers_off",["bytes.view","hdr_allow"]]],["let","exp_allow_len",["bytes.len",["bytes.view","exp_allow"]]],["if",[">","exp_allow_len",0],["begin",["try",["std.test.assert_i32_eq",["view.eq",["bytes.view","actual_header_name"],["bytes.view","hdr_allow"]],1,["std.test.code_assert_i32_eq"]]],["try",["std.test.assert_i32_eq",["view.eq",["bytes.view","actual_header_value"],["bytes.view","exp_allow"]],1,["std.test.code_assert_i32_eq"]]],0],0],["let","exp_content_type",["std.mcp.rr.http._map_string_or_empty_v1","doc","exp_headers_off",["bytes.view","hdr_content_type"]]],["let","exp_content_type_len",["bytes.len",["bytes.view","exp_content_type"]]],["if",[">","exp_content_type_len",0],["begin",["try",["std.test.assert_i32_eq",["view.eq",["bytes.view","actual_header_name"],["bytes.view","hdr_content_type"]],1,["std.test.code_assert_i32_eq"]]],["try",["std.test.assert_i32_eq",["view.eq",["bytes.view","actual_header_value"],["bytes.view","exp_content_type"]],1,["std.test.code_assert_i32_eq"]]],0],0],["let","exp_sid",["std.mcp.rr.http._map_string_or_empty_v1","doc","exp_headers_off",["bytes.view","hdr_mcp_sid"]]],["let","exp_sid_len",["bytes.len",["bytes.view","exp_sid"]]],["if",[">","exp_sid_len",0],["begin",["try",["std.test.assert_i32_eq",["view.eq",["bytes.view","actual_header_name"],["bytes.view","hdr_mcp_sid"]],1,["std.test.code_assert_i32_eq"]]],["try",["std.test.assert_i32_eq",["view.eq",["bytes.view","actual_header_value"],["bytes.view","exp_sid"]],1,["std.test.code_assert_i32_eq"]]],0],0],["let","exp_www_auth",["std.mcp.rr.http._map_string_or_empty_v1","doc","exp_headers_off",["bytes.view","hdr_www_auth"]]],["let","exp_www_auth_len",["bytes.len",["bytes.view","exp_www_auth"]]],["if",[">","exp_www_auth_len",0],["begin",["try",["std.test.assert_i32_eq",["view.eq",["bytes.view","actual_header_name"],["bytes.view","hdr_www_auth"]],1,["std.test.code_assert_i32_eq"]]],["try",["std.test.assert_i32_eq",["view.eq",["bytes.view","actual_header_value"],["bytes.view","exp_www_auth"]],1,["std.test.code_assert_i32_eq"]]],0],0],0],0],["let","body_empty_off",["ext.data_model.map_find","doc","res_off",["bytes.view","k_body_empty"]]],["if",["if",[">=","body_empty_off",0],["=",["ext.data_model.kind_at","doc","body_empty_off"],1],0],["if",["=",["ext.data_model.bool_get","doc","body_empty_off"],1],["try",["std.test.assert_i32_eq",["bytes.len",["bytes.view","actual_body"]],0,["std.test.code_assert_i32_eq"]]],0],0],["let","body_json_off",["ext.data_model.map_find","doc","res_off",["bytes.view","k_body_json"]]],["if",[">=","body_json_off",0],["begin",["let","bj_end",["ext.data_model.skip_value","doc","body_json_off"]],["let","bj_val",["view.to_bytes",["view.slice","doc","body_json_off",["-","bj_end","body_json_off"]]]],["let","exp_json",["std.mcp.util.json.json_from_value_v1",["bytes.view","bj_val"]]],["let","exp_canon",["ext.json.canon.canonicalize",["bytes.view","exp_json"]]],["let","got_canon",["ext.json.canon.canonicalize",["bytes.view","actual_body"]]],["try",["std.test.assert_bytes_eq","got_canon","exp_canon",["std.test.code_assert_bytes_eq"]]],0],0],0]],["std.test.pass"]],"kind":"defn","name":"std.mcp.rr.http.replay_from_fs_v1","params":[{"name":"session_path","ty":"bytes_view"}],"result":"result_i32"}],"imports":["ext.data_model","ext.json.canon","ext.json.data_model","std.bytes","std.fs","std.mcp.auth.bearer_v1","std.mcp.auth.rs_v1","std.mcp.auth.scopes_v1","std.mcp.jsonrpc","std.mcp.sandbox.worker_main","std.mcp.sandbox.worker_proto","std.mcp.toolkit.prompts_file","std.mcp.toolkit.resources_file","std.mcp.toolkit.stdio_dispatch","std.mcp.toolkit.tools_file","std.mcp.transport.http_rules","std.mcp.transport.http_session","std.mcp.util.json","std.parse","std.test"],"kind":"module","module_id":"std.mcp.rr.http","schema_version":"x07.x07ast@0.5.0"}
