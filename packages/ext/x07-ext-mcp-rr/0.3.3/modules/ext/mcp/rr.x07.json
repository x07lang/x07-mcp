{"decls":[{"kind":"export","names":["ext.mcp.rr.replay_from_fs_v1","ext.mcp.rr.sanitize_err_report_json_v1","ext.mcp.rr.sanitize_jsonl_v1"]},{"body":["begin",["let","exp_canon",["std.mcp.rr.sanitize.sanitize_jsonl_v1","expected_raw"]],["let","got_canon",["std.mcp.rr.sanitize.sanitize_jsonl_v1","got_raw"]],["let","ev",["bytes.view","exp_canon"]],["let","gv",["bytes.view","got_canon"]],["if",["=",["bytes.eq","ev","gv"],1],["return",0],0],["let","en",["view.len","ev"]],["let","gn",["view.len","gv"]],["let","epos",0],["let","gpos",0],["let","cmp",0],["for","_",0,4096,["begin",["if",["&",[">=u","epos","en"],[">=u","gpos","gn"]],["return",["+",7603000,["+","cmp",1]]],0],["if",["|",[">=u","epos","en"],[">=u","gpos","gn"]],["return",["+",7603000,["+","cmp",1]]],0],["let","epack",["ext.mcp.rr._next_line_info_v1","ev","epos","en"]],["let","estart",["ext.mcp.rr._line_info_start_v1",["bytes.view","epack"]]],["set","epos",["ext.mcp.rr._line_info_next_pos_v1",["bytes.view","epack"]]],["let","elen",["ext.mcp.rr._line_info_len_v1",["bytes.view","epack"]]],["let","gpack",["ext.mcp.rr._next_line_info_v1","gv","gpos","gn"]],["let","gstart",["ext.mcp.rr._line_info_start_v1",["bytes.view","gpack"]]],["set","gpos",["ext.mcp.rr._line_info_next_pos_v1",["bytes.view","gpack"]]],["let","glen",["ext.mcp.rr._line_info_len_v1",["bytes.view","gpack"]]],["set","cmp",["+","cmp",1]],["let","eline",["view.slice","ev","estart","elen"]],["let","gline",["view.slice","gv","gstart","glen"]],["if",["=",["view.eq","eline","gline"],1],0,["return",["+",7603000,"cmp"]]],0]],["+",7603000,["+","cmp",1]]],"kind":"defn","name":"ext.mcp.rr._audit_compare_v1","params":[{"name":"expected_raw","ty":"bytes_view"},{"name":"got_raw","ty":"bytes_view"}],"result":"i32"},{"body":["begin",["if",["<",["view.len","dispatch_doc"],12],["return",["bytes.alloc",0]],0],["if",["!=",["codec.read_u32_le","dispatch_doc",0],1],["return",["bytes.alloc",0]],0],["let","ns_len",["codec.read_u32_le","dispatch_doc",4]],["let","start",8],["if",["<u",["view.len","dispatch_doc"],["+","start","ns_len"]],["return",["bytes.alloc",0]],0],["view.to_bytes",["view.slice","dispatch_doc","start","ns_len"]]],"kind":"defn","name":"ext.mcp.rr._dispatch_next_state_v1","params":[{"name":"dispatch_doc","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["if",["<",["view.len","dispatch_doc"],12],["return",["bytes.alloc",0]],0],["if",["!=",["codec.read_u32_le","dispatch_doc",0],1],["return",["bytes.alloc",0]],0],["let","ns_len",["codec.read_u32_le","dispatch_doc",4]],["let","out_off",["+",8,["if",["<","ns_len",0],0,"ns_len"]]],["if",["<u",["view.len","dispatch_doc"],["+","out_off",4]],["return",["bytes.alloc",0]],0],["let","out_len",["codec.read_u32_le","dispatch_doc","out_off"]],["let","audit_off",["+",["+","out_off",4],["if",["<","out_len",0],0,"out_len"]]],["if",["<u",["view.len","dispatch_doc"],["+","audit_off",4]],["return",["bytes.alloc",0]],0],["let","audit_len",["codec.read_u32_le","dispatch_doc","audit_off"]],["let","start",["+","audit_off",4]],["if",["<u",["view.len","dispatch_doc"],["+","start","audit_len"]],["return",["bytes.alloc",0]],0],["view.to_bytes",["view.slice","dispatch_doc","start","audit_len"]]],"kind":"defn","name":"ext.mcp.rr._dispatch_out_audit_jsonl_v1","params":[{"name":"dispatch_doc","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["if",["<",["view.len","dispatch_doc"],12],["return",["bytes.alloc",0]],0],["if",["!=",["codec.read_u32_le","dispatch_doc",0],1],["return",["bytes.alloc",0]],0],["let","ns_len",["codec.read_u32_le","dispatch_doc",4]],["let","out_off",["+",8,["if",["<","ns_len",0],0,"ns_len"]]],["if",["<u",["view.len","dispatch_doc"],["+","out_off",4]],["return",["bytes.alloc",0]],0],["let","out_len",["codec.read_u32_le","dispatch_doc","out_off"]],["let","start",["+","out_off",4]],["if",["<u",["view.len","dispatch_doc"],["+","start","out_len"]],["return",["bytes.alloc",0]],0],["view.to_bytes",["view.slice","dispatch_doc","start","out_len"]]],"kind":"defn","name":"ext.mcp.rr._dispatch_out_jsonl_v1","params":[{"name":"dispatch_doc","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","k_dir",["bytes.lit","dir"]],["let","off",["ext.data_model.map_find","doc","root",["bytes.view","k_dir"]]],["if",["<","off",0],["return",["bytes.alloc",0]],0],["if",["!=",["ext.data_model.kind_at","doc","off"],3],["return",["bytes.alloc",0]],0],["ext.data_model.string_get","doc","off"]],"kind":"defn","name":"ext.mcp.rr._entry_dir_v1","params":[{"name":"doc","ty":"bytes_view"},{"name":"root","ty":"i32"}],"result":"bytes"},{"body":["begin",["let","k_msg",["bytes.lit","msg"]],["let","off",["ext.data_model.map_find","doc","root",["bytes.view","k_msg"]]],["if",["<","off",0],["return",["bytes.alloc",0]],0],["let","kind",["ext.data_model.kind_at","doc","off"]],["if",["=","kind",3],["return",["ext.data_model.string_get","doc","off"]],0],["let","end",["ext.data_model.skip_value","doc","off"]],["if",["<","end",0],["return",["bytes.alloc",0]],0],["let","val",["view.to_bytes",["view.slice","doc","off",["-","end","off"]]]],["std.mcp.util.json.json_from_value_v1",["bytes.view","val"]]],"kind":"defn","name":"ext.mcp.rr._entry_msg_json_v1","params":[{"name":"doc","ty":"bytes_view"},{"name":"root","ty":"i32"}],"result":"bytes"},{"body":7601,"kind":"defn","name":"ext.mcp.rr._err_invalid_transcript_v1","params":[],"result":"i32"},{"body":7602,"kind":"defn","name":"ext.mcp.rr._err_mismatch_v1","params":[],"result":"i32"},{"body":7604,"kind":"defn","name":"ext.mcp.rr._err_progress_after_terminal_v1","params":[],"result":"i32"},{"body":7603,"kind":"defn","name":"ext.mcp.rr._err_router_v1","params":[],"result":"i32"},{"body":["begin",["let","hn",["view.len","hay"]],["let","nn",["view.len","needle"]],["if",["<=","nn",0],["return",0],0],["if",["<","hn","nn"],["return",-1],0],["let","limit",["-","hn","nn"]],["for","i",0,["+","limit",1],["begin",["let","ok",1],["for","j",0,"nn",["begin",["if",["=",["view.get_u8","hay",["+","i","j"]],["view.get_u8","needle","j"]],0,["begin",["set","ok",0],["set","j","nn"],0]],0]],["if",["=","ok",1],["return","i"],0],0]],-1],"kind":"defn","name":"ext.mcp.rr._find_sub_v1","params":[{"name":"hay","ty":"bytes_view"},{"name":"needle","ty":"bytes_view"}],"result":"i32"},{"body":["begin",["if",["<u",["view.len","pack"],12],0,["codec.read_u32_le","pack",8]]],"kind":"defn","name":"ext.mcp.rr._line_info_len_v1","params":[{"name":"pack","ty":"bytes_view"}],"result":"i32"},{"body":["begin",["if",["<u",["view.len","pack"],12],0,["codec.read_u32_le","pack",4]]],"kind":"defn","name":"ext.mcp.rr._line_info_next_pos_v1","params":[{"name":"pack","ty":"bytes_view"}],"result":"i32"},{"body":["begin",["if",["<u",["view.len","pack"],12],0,["codec.read_u32_le","pack",0]]],"kind":"defn","name":"ext.mcp.rr._line_info_start_v1","params":[{"name":"pack","ty":"bytes_view"}],"result":"i32"},{"body":["begin",["if",["<","map_off",0],["return",["bytes.alloc",0]],0],["let","off",["ext.data_model.map_find","doc","map_off","key"]],["if",["<","off",0],["return",["bytes.alloc",0]],0],["if",["!=",["ext.data_model.kind_at","doc","off"],3],["return",["bytes.alloc",0]],0],["ext.data_model.string_get","doc","off"]],"kind":"defn","name":"ext.mcp.rr._map_string_or_empty_v1","params":[{"name":"doc","ty":"bytes_view"},{"name":"map_off","ty":"i32"},{"name":"key","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["if",["<","task_off",0],["return",["std.bytes.copy","term_set"]],0],["if",["!=",["ext.data_model.kind_at","doc","task_off"],5],["return",["std.bytes.copy","term_set"]],0],["let","k_task_id",["bytes.lit","taskId"]],["let","k_status",["bytes.lit","status"]],["let","task_id",["ext.mcp.rr._map_string_or_empty_v1","doc","task_off",["bytes.view","k_task_id"]]],["let","status",["ext.mcp.rr._map_string_or_empty_v1","doc","task_off",["bytes.view","k_status"]]],["begin",["let","task_id_v",["bytes.view","task_id"]],["let","status_v",["bytes.view","status"]],["if",["|",["=",["bytes.len","task_id_v"],0],["=",["bytes.len","status_v"],0]],["std.bytes.copy","term_set"],["if",["=",["ext.mcp.rr._status_is_terminal_v1","status_v"],1],["ext.mcp.rr._terminal_set_add_task_id_v1","term_set","task_id_v"],["std.bytes.copy","term_set"]]]]],"kind":"defn","name":"ext.mcp.rr._mark_terminal_from_task_map_v1","params":[{"name":"term_set","ty":"bytes_view"},{"name":"doc","ty":"bytes_view"},{"name":"task_off","ty":"i32"}],"result":"bytes"},{"body":["begin",["let","term",["std.bytes.copy","term_set"]],["let","k_method",["bytes.lit","method"]],["let","method",["ext.mcp.rr._map_string_or_empty_v1","msg_doc","msg_root",["bytes.view","k_method"]]],["let","want_status",["bytes.lit","notifications/tasks/status"]],["if",["=",["bytes.eq",["bytes.view","method"],["bytes.view","want_status"]],1],["begin",["let","k_params",["bytes.lit","params"]],["let","params_off",["ext.data_model.map_find","msg_doc","msg_root",["bytes.view","k_params"]]],["set","term",["ext.mcp.rr._mark_terminal_from_task_map_v1",["bytes.view","term"],"msg_doc","params_off"]],0],0],["let","k_result",["bytes.lit","result"]],["let","result_off",["ext.data_model.map_find","msg_doc","msg_root",["bytes.view","k_result"]]],["if",[">=","result_off",0],["begin",["set","term",["ext.mcp.rr._mark_terminal_from_task_map_v1",["bytes.view","term"],"msg_doc","result_off"]],["let","k_task",["bytes.lit","task"]],["let","task_off",["ext.data_model.map_find","msg_doc","result_off",["bytes.view","k_task"]]],["if",[">=","task_off",0],["begin",["set","term",["ext.mcp.rr._mark_terminal_from_task_map_v1",["bytes.view","term"],"msg_doc","task_off"]],0],0],["let","k_tasks",["bytes.lit","tasks"]],["let","tasks_off",["ext.data_model.map_find","msg_doc","result_off",["bytes.view","k_tasks"]]],["if",[">=","tasks_off",0],["begin",["if",["!=",["ext.data_model.kind_at","msg_doc","tasks_off"],4],0,["begin",["let","n",["ext.data_model.seq_len","msg_doc","tasks_off"]],["if",["<","n",0],0,["for","i",0,"n",["begin",["let","it",["ext.data_model.seq_get","msg_doc","tasks_off","i"]],["if",["<","it",0],0,["begin",["set","term",["ext.mcp.rr._mark_terminal_from_task_map_v1",["bytes.view","term"],"msg_doc","it"]],0]]]]]]],0],0],0],0],"term"],"kind":"defn","name":"ext.mcp.rr._maybe_mark_terminal_from_msg_doc_v1","params":[{"name":"term_set","ty":"bytes_view"},{"name":"msg_doc","ty":"bytes_view"},{"name":"msg_root","ty":"i32"}],"result":"bytes"},{"body":["begin",["if",[">=u","pos","n"],["return",["ext.mcp.rr._pack_u32_u32_u32_v1","pos","pos",0]],0],["let","rest_len",["-","n","pos"]],["let","rest",["view.slice","src","pos","rest_len"]],["let","idx",["std.bytes.find_u8","rest",10]],["let","raw_len",["if",[">=","idx",0],"idx","rest_len"]],["let","next_p",["if",[">=","idx",0],["+","pos",["+","idx",1]],"n"]],["let","end_len","raw_len"],["if",[">","end_len",0],["begin",["let","last",["view.get_u8","rest",["-","end_len",1]]],["if",["=","last",13],["set","end_len",["-","end_len",1]],0],0],0],["if",[">","end_len",0],["ext.mcp.rr._pack_u32_u32_u32_v1","pos","next_p","end_len"],["ext.mcp.rr._next_line_info_v1","src","next_p","n"]]],"kind":"defn","name":"ext.mcp.rr._next_line_info_v1","params":[{"name":"src","ty":"bytes_view"},{"name":"pos","ty":"i32"},{"name":"n","ty":"i32"}],"result":"bytes"},{"body":["begin",["let","v",["vec_u8.with_capacity",12]],["set","v",["vec_u8.extend_bytes","v",["codec.write_u32_le","a"]]],["set","v",["vec_u8.extend_bytes","v",["codec.write_u32_le","b"]]],["set","v",["vec_u8.extend_bytes","v",["codec.write_u32_le","c"]]],["vec_u8.into_bytes","v"]],"kind":"defn","name":"ext.mcp.rr._pack_u32_u32_u32_v1","params":[{"name":"a","ty":"i32"},{"name":"b","ty":"i32"},{"name":"c","ty":"i32"}],"result":"bytes"},{"body":["begin",["let","k_method",["bytes.lit","method"]],["let","method",["ext.mcp.rr._map_string_or_empty_v1","msg_doc","msg_root",["bytes.view","k_method"]]],["let","want_progress",["bytes.lit","notifications/progress"]],["if",["=",["bytes.eq",["bytes.view","method"],["bytes.view","want_progress"]],1],["begin",["let","k_params",["bytes.lit","params"]],["let","params_off",["ext.data_model.map_find","msg_doc","msg_root",["bytes.view","k_params"]]],["if",["<","params_off",0],["return",["bytes.alloc",0]],0],["if",["!=",["ext.data_model.kind_at","msg_doc","params_off"],5],["return",["bytes.alloc",0]],0],["let","k_meta",["bytes.lit","_meta"]],["let","meta_off",["ext.data_model.map_find","msg_doc","params_off",["bytes.view","k_meta"]]],["if",["<","meta_off",0],["return",["bytes.alloc",0]],0],["if",["!=",["ext.data_model.kind_at","msg_doc","meta_off"],5],["return",["bytes.alloc",0]],0],["let","k_related",["bytes.lit","io.modelcontextprotocol/related-task"]],["let","rel_off",["ext.data_model.map_find","msg_doc","meta_off",["bytes.view","k_related"]]],["if",["<","rel_off",0],["return",["bytes.alloc",0]],0],["if",["!=",["ext.data_model.kind_at","msg_doc","rel_off"],5],["return",["bytes.alloc",0]],0],["let","k_task_id",["bytes.lit","taskId"]],["ext.mcp.rr._map_string_or_empty_v1","msg_doc","rel_off",["bytes.view","k_task_id"]]],["bytes.alloc",0]]],"kind":"defn","name":"ext.mcp.rr._progress_related_task_id_or_empty_v1","params":[{"name":"msg_doc","ty":"bytes_view"},{"name":"msg_root","ty":"i32"}],"result":"bytes"},{"body":["begin",["let","raw",["std.fs.read","transcript_path"]],["let","tv",["bytes.view","raw"]],["let","tn",["view.len","tv"]],["let","pos",0],["let","cmp_i",0],["let","hpack",["ext.mcp.rr._next_line_info_v1","tv","pos","tn"]],["let","hstart",["ext.mcp.rr._line_info_start_v1",["bytes.view","hpack"]]],["set","pos",["ext.mcp.rr._line_info_next_pos_v1",["bytes.view","hpack"]]],["let","hlen",["ext.mcp.rr._line_info_len_v1",["bytes.view","hpack"]]],["if",["=","hlen",0],["return",["result_i32.err",["ext.mcp.rr._err_invalid_transcript_v1"]]],0],["let","hline",["view.slice","tv","hstart","hlen"]],["let","hdr_need",["bytes.lit","\"schema_version\":\"x07.mcp.rr.transcript@0.2.0\""]],["if",["<",["ext.mcp.rr._find_sub_v1","hline",["bytes.view","hdr_need"]],0],["return",["result_i32.err",["ext.mcp.rr._err_invalid_transcript_v1"]]],0],["let","st_res",["ext.mcp.server.make_router_from_fs_v1","server_manifest_path"]],["if",["!=",["result_bytes.err_code","st_res"],0],["return",["result_i32.err",["ext.mcp.rr._err_router_v1"]]],0],["let","router_state",["result_bytes.unwrap_or","st_res",["bytes.alloc",0]]],["let","lit_audit",["bytes.lit","audit.jsonl"]],["let","audit_path",["ext.mcp.rr._sibling_path_v1","transcript_path",["bytes.view","lit_audit"]]],["let","expected_audit_raw",["std.fs.read",["bytes.view","audit_path"]]],["let","expected_audit_v",["bytes.view","expected_audit_raw"]],["let","expected_audit_present",["if",[">",["view.len","expected_audit_v"],0],1,0]],["let","got_audit",["vec_u8.with_capacity",0]],["let","lit_metrics",["bytes.lit","metrics.json"]],["let","metrics_path",["ext.mcp.rr._sibling_path_v1","transcript_path",["bytes.view","lit_metrics"]]],["let","expected_metrics_raw",["std.fs.read",["bytes.view","metrics_path"]]],["let","expected_metrics_v",["bytes.view","expected_metrics_raw"]],["let","expected_metrics_present",["if",[">",["view.len","expected_metrics_v"],0],1,0]],["let","lit_c2s",["bytes.lit","c2s"]],["let","lit_s2c",["bytes.lit","s2c"]],["let","k_msg",["bytes.lit","msg"]],["let","term",["bytes.alloc",1]],["set","term",["bytes.set_u8","term",0,0]],["for","_",0,128,["begin",["if",["<u","pos","tn"],0,["begin",["if",["=","expected_audit_present",1],["begin",["let","got_audit_b",["vec_u8.into_bytes","got_audit"]],["let","audit_err",["ext.mcp.rr._audit_compare_v1","expected_audit_v",["bytes.view","got_audit_b"]]],["if",["!=","audit_err",0],["return",["result_i32.err","audit_err"]],0],0],0],["if",["=","expected_metrics_present",1],["begin",["let","got_metrics",["ext.mcp.server.router_state_metrics_snapshot_json_v1","router_state"]],["if",["=",["bytes.eq","expected_metrics_v",["bytes.view","got_metrics"]],1],0,["return",["result_i32.err",7604000]]],0],0],["return",["result_i32.ok",0]]]],["let","pack",["ext.mcp.rr._next_line_info_v1","tv","pos","tn"]],["let","start",["ext.mcp.rr._line_info_start_v1",["bytes.view","pack"]]],["set","pos",["ext.mcp.rr._line_info_next_pos_v1",["bytes.view","pack"]]],["let","llen",["ext.mcp.rr._line_info_len_v1",["bytes.view","pack"]]],["if",["=","llen",0],0,["begin",["let","line",["view.slice","tv","start","llen"]],["let","line_doc_b",["ext.json.data_model.parse","line"]],["let","line_doc",["bytes.view","line_doc_b"]],["if",["=",["ext.data_model.doc_is_err","line_doc"],1],["return",["result_i32.err",["ext.mcp.rr._err_invalid_transcript_v1"]]],0],["if",["!=",["ext.data_model.root_kind","line_doc"],5],["return",["result_i32.err",["ext.mcp.rr._err_invalid_transcript_v1"]]],0],["let","line_root",["ext.data_model.root_offset","line_doc"]],["let","line_dir",["ext.mcp.rr._entry_dir_v1","line_doc","line_root"]],["if",["=",["bytes.eq",["bytes.view","line_dir"],["bytes.view","lit_c2s"]],1],["begin",["let","msg_json",["ext.mcp.rr._entry_msg_json_v1","line_doc","line_root"]],["if",["<=",["bytes.len",["bytes.view","msg_json"]],0],["return",["result_i32.err",["ext.mcp.rr._err_invalid_transcript_v1"]]],0],["let","dispatch_res",["ext.mcp.server.dispatch_jsonrpc_v1",["bytes.view","router_state"],["bytes.view","msg_json"]]],["if",["!=",["result_bytes.err_code","dispatch_res"],0],["return",["result_i32.err",["ext.mcp.rr._err_router_v1"]]],0],["let","dispatch_doc",["result_bytes.unwrap_or","dispatch_res",["bytes.alloc",0]]],["let","dv",["bytes.view","dispatch_doc"]],["set","router_state",["ext.mcp.rr._dispatch_next_state_v1","dv"]],["let","out_jsonl",["ext.mcp.rr._dispatch_out_jsonl_v1","dv"]],["begin",["let","out_audit",["ext.mcp.rr._dispatch_out_audit_jsonl_v1","dv"]],["let","out_audit_v",["bytes.view","out_audit"]],["if",[">",["view.len","out_audit_v"],0],["begin",["set","got_audit",["vec_u8.extend_bytes","got_audit","out_audit_v"]],0],0],0],["let","ov",["bytes.view","out_jsonl"]],["let","on",["view.len","ov"]],["let","opos",0],["for","j",0,16,["begin",["if",["<u","opos","on"],["begin",["let","opack",["ext.mcp.rr._next_line_info_v1","ov","opos","on"]],["let","ostart",["ext.mcp.rr._line_info_start_v1",["bytes.view","opack"]]],["set","opos",["ext.mcp.rr._line_info_next_pos_v1",["bytes.view","opack"]]],["let","olen",["ext.mcp.rr._line_info_len_v1",["bytes.view","opack"]]],["if",["=","olen",0],0,["begin",["let","oline",["view.slice","ov","ostart","olen"]],["let","epack",["ext.mcp.rr._next_line_info_v1","tv","pos","tn"]],["let","estart",["ext.mcp.rr._line_info_start_v1",["bytes.view","epack"]]],["set","pos",["ext.mcp.rr._line_info_next_pos_v1",["bytes.view","epack"]]],["let","elen",["ext.mcp.rr._line_info_len_v1",["bytes.view","epack"]]],["if",["=","elen",0],["return",["result_i32.err",["ext.mcp.rr._err_invalid_transcript_v1"]]],0],["let","eline",["view.slice","tv","estart","elen"]],["let","eline_doc_b",["ext.json.data_model.parse","eline"]],["let","eline_doc",["bytes.view","eline_doc_b"]],["if",["=",["ext.data_model.doc_is_err","eline_doc"],1],["return",["result_i32.err",["ext.mcp.rr._err_invalid_transcript_v1"]]],0],["if",["!=",["ext.data_model.root_kind","eline_doc"],5],["return",["result_i32.err",["ext.mcp.rr._err_invalid_transcript_v1"]]],0],["let","eline_root",["ext.data_model.root_offset","eline_doc"]],["let","edir",["ext.mcp.rr._entry_dir_v1","eline_doc","eline_root"]],["if",["=",["bytes.eq",["bytes.view","edir"],["bytes.view","lit_s2c"]],1],0,["return",["result_i32.err",["ext.mcp.rr._err_invalid_transcript_v1"]]]],["let","exp_json",["ext.mcp.rr._entry_msg_json_v1","eline_doc","eline_root"]],["if",["<=",["bytes.len",["bytes.view","exp_json"]],0],["return",["result_i32.err",["ext.mcp.rr._err_invalid_transcript_v1"]]],0],["let","msg_off",["ext.data_model.map_find","eline_doc","eline_root",["bytes.view","k_msg"]]],["if",["<","msg_off",0],["return",["result_i32.err",["ext.mcp.rr._err_invalid_transcript_v1"]]],0],["let","msg_kind",["ext.data_model.kind_at","eline_doc","msg_off"]],["if",["=","msg_kind",5],["begin",["let","pt_task_id0",["ext.mcp.rr._progress_related_task_id_or_empty_v1","eline_doc","msg_off"]],["if",["begin",["let","pt_task_id_v0",["bytes.view","pt_task_id0"]],["if",[">",["bytes.len","pt_task_id_v0"],0],["=",["ext.mcp.rr._terminal_set_contains_task_id_v1",["bytes.view","term"],"pt_task_id_v0"],1],0]],["return",["result_i32.err",["ext.mcp.rr._err_progress_after_terminal_v1"]]],0],["set","term",["ext.mcp.rr._maybe_mark_terminal_from_msg_doc_v1",["bytes.view","term"],"eline_doc","msg_off"]],0],["if",["=","msg_kind",3],["begin",["let","msg_json2",["ext.data_model.string_get","eline_doc","msg_off"]],["let","msg_doc_b2",["ext.json.data_model.parse",["bytes.view","msg_json2"]]],["let","msg_doc2",["bytes.view","msg_doc_b2"]],["if",["=",["ext.data_model.doc_is_err","msg_doc2"],1],["return",["result_i32.err",["ext.mcp.rr._err_invalid_transcript_v1"]]],0],["if",["!=",["ext.data_model.root_kind","msg_doc2"],5],["return",["result_i32.err",["ext.mcp.rr._err_invalid_transcript_v1"]]],0],["let","msg_root2",["ext.data_model.root_offset","msg_doc2"]],["let","pt_task_id2",["ext.mcp.rr._progress_related_task_id_or_empty_v1","msg_doc2","msg_root2"]],["if",["begin",["let","pt_task_id_v2",["bytes.view","pt_task_id2"]],["if",[">",["bytes.len","pt_task_id_v2"],0],["=",["ext.mcp.rr._terminal_set_contains_task_id_v1",["bytes.view","term"],"pt_task_id_v2"],1],0]],["return",["result_i32.err",["ext.mcp.rr._err_progress_after_terminal_v1"]]],0],["set","term",["ext.mcp.rr._maybe_mark_terminal_from_msg_doc_v1",["bytes.view","term"],"msg_doc2","msg_root2"]],0],["return",["result_i32.err",["ext.mcp.rr._err_invalid_transcript_v1"]]]]],["set","cmp_i",["+","cmp_i",1]],["if",["=",["view.eq","oline",["bytes.view","exp_json"]],1],0,["return",["result_i32.err",["+",7602000,"cmp_i"]]]]]]],0],0]]],0]]]]],["begin",["if",["=","expected_audit_present",1],["begin",["let","got_audit_b",["vec_u8.into_bytes","got_audit"]],["let","audit_err",["ext.mcp.rr._audit_compare_v1","expected_audit_v",["bytes.view","got_audit_b"]]],["if",["!=","audit_err",0],["return",["result_i32.err","audit_err"]],0],0],0],["result_i32.ok",0]]],"kind":"defn","name":"ext.mcp.rr._replay_from_fs_inner_v1","params":[{"name":"server_manifest_path","ty":"bytes_view"},{"name":"transcript_path","ty":"bytes_view"}],"result":"result_i32"},{"body":["begin",["let","needle_prog",["bytes.lit","notifications/progress"]],["let","needle_status",["bytes.lit","notifications/tasks/status"]],["if",["&",["<",["ext.mcp.rr._find_sub_v1","tv",["bytes.view","needle_prog"]],0],["<",["ext.mcp.rr._find_sub_v1","tv",["bytes.view","needle_status"]],0]],["return",0],0],["let","pos",0],["let","lit_s2c",["bytes.lit","s2c"]],["let","hdr_need",["bytes.lit","\"schema_version\":\"x07.mcp.rr.transcript@0.2.0\""]],["let","hpack",["ext.mcp.rr._next_line_info_v1","tv","pos","tn"]],["let","hstart",["ext.mcp.rr._line_info_start_v1",["bytes.view","hpack"]]],["set","pos",["ext.mcp.rr._line_info_next_pos_v1",["bytes.view","hpack"]]],["let","hlen",["ext.mcp.rr._line_info_len_v1",["bytes.view","hpack"]]],["if",["=","hlen",0],["return",["ext.mcp.rr._err_invalid_transcript_v1"]],0],["let","hline",["view.slice","tv","hstart","hlen"]],["if",["<",["ext.mcp.rr._find_sub_v1","hline",["bytes.view","hdr_need"]],0],["return",["ext.mcp.rr._err_invalid_transcript_v1"]],0],["let","term",["bytes.alloc",1]],["set","term",["bytes.set_u8","term",0,0]],["for","_",0,2147483647,["begin",["if",["<u","pos","tn"],0,["return",0]],["let","pack",["ext.mcp.rr._next_line_info_v1","tv","pos","tn"]],["let","start",["ext.mcp.rr._line_info_start_v1",["bytes.view","pack"]]],["set","pos",["ext.mcp.rr._line_info_next_pos_v1",["bytes.view","pack"]]],["let","llen",["ext.mcp.rr._line_info_len_v1",["bytes.view","pack"]]],["if",["=","llen",0],0,["begin",["let","line",["view.slice","tv","start","llen"]],["let","line_doc_b",["ext.json.data_model.parse","line"]],["let","line_doc",["bytes.view","line_doc_b"]],["if",["=",["ext.data_model.doc_is_err","line_doc"],1],["return",["ext.mcp.rr._err_invalid_transcript_v1"]],0],["if",["!=",["ext.data_model.root_kind","line_doc"],5],["return",["ext.mcp.rr._err_invalid_transcript_v1"]],0],["let","line_root",["ext.data_model.root_offset","line_doc"]],["let","line_dir",["ext.mcp.rr._entry_dir_v1","line_doc","line_root"]],["if",["=",["bytes.eq",["bytes.view","line_dir"],["bytes.view","lit_s2c"]],1],["begin",["let","msg_json",["ext.mcp.rr._entry_msg_json_v1","line_doc","line_root"]],["if",["<=",["bytes.len",["bytes.view","msg_json"]],0],["return",["ext.mcp.rr._err_invalid_transcript_v1"]],0],["let","msg_doc_b",["ext.json.data_model.parse",["bytes.view","msg_json"]]],["let","msg_doc",["bytes.view","msg_doc_b"]],["if",["=",["ext.data_model.doc_is_err","msg_doc"],1],["return",["ext.mcp.rr._err_invalid_transcript_v1"]],0],["if",["!=",["ext.data_model.root_kind","msg_doc"],5],["return",["ext.mcp.rr._err_invalid_transcript_v1"]],0],["let","msg_root",["ext.data_model.root_offset","msg_doc"]],["let","pt_task_id",["ext.mcp.rr._progress_related_task_id_or_empty_v1","msg_doc","msg_root"]],["if",["begin",["let","pt_task_id_v",["bytes.view","pt_task_id"]],["if",[">",["bytes.len","pt_task_id_v"],0],["=",["ext.mcp.rr._terminal_set_contains_task_id_v1",["bytes.view","term"],"pt_task_id_v"],1],0]],["return",["ext.mcp.rr._err_progress_after_terminal_v1"]],0],["set","term",["ext.mcp.rr._maybe_mark_terminal_from_msg_doc_v1",["bytes.view","term"],"msg_doc","msg_root"]],0],0]]],0]],0],"kind":"defn","name":"ext.mcp.rr._scan_progress_after_terminal_v1","params":[{"name":"tv","ty":"bytes_view"},{"name":"tn","ty":"i32"}],"result":"i32"},{"body":["begin",["let","n",["view.len","base_path"]],["if",["=","n",0],["return",["view.to_bytes","sibling"]],0],["for","i",0,"n",["begin",["let","idx",["-",["-","n",1],"i"]],["if",["<","idx",0],["return",["view.to_bytes","sibling"]],0],["if",["=",["view.get_u8","base_path","idx"],47],["begin",["let","prefix",["view.slice","base_path",0,["+","idx",1]]],["return",["std.bytes.concat","prefix","sibling"]]],0],0]],["view.to_bytes","sibling"]],"kind":"defn","name":"ext.mcp.rr._sibling_path_v1","params":[{"name":"base_path","ty":"bytes_view"},{"name":"sibling","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","s_completed",["bytes.lit","completed"]],["let","s_failed",["bytes.lit","failed"]],["let","s_cancelled",["bytes.lit","cancelled"]],["if",["|",["=",["bytes.eq","status_utf8",["bytes.view","s_completed"]],1],["|",["=",["bytes.eq","status_utf8",["bytes.view","s_failed"]],1],["=",["bytes.eq","status_utf8",["bytes.view","s_cancelled"]],1]]],1,0]],"kind":"defn","name":"ext.mcp.rr._status_is_terminal_v1","params":[{"name":"status_utf8","ty":"bytes_view"}],"result":"i32"},{"body":["begin",["if",["=",["view.len","task_id_utf8"],0],["return",["std.bytes.copy","term_set"]],0],["if",["=",["ext.mcp.rr._terminal_set_contains_task_id_v1","term_set","task_id_utf8"],1],["return",["std.bytes.copy","term_set"]],0],["let","nul",["bytes.alloc",1]],["set","nul",["bytes.set_u8","nul",0,0]],["let","t0",["std.bytes.concat","term_set","task_id_utf8"]],["std.bytes.concat",["bytes.view","t0"],["bytes.view","nul"]]],"kind":"defn","name":"ext.mcp.rr._terminal_set_add_task_id_v1","params":[{"name":"term_set","ty":"bytes_view"},{"name":"task_id_utf8","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["if",["=",["view.len","task_id_utf8"],0],["return",0],0],["let","nul",["bytes.alloc",1]],["set","nul",["bytes.set_u8","nul",0,0]],["let","p1",["std.bytes.concat",["bytes.view","nul"],"task_id_utf8"]],["let","needle",["std.bytes.concat",["bytes.view","p1"],["bytes.view","nul"]]],["if",[">=",["ext.mcp.rr._find_sub_v1","term_set",["bytes.view","needle"]],0],1,0]],"kind":"defn","name":"ext.mcp.rr._terminal_set_contains_task_id_v1","params":[{"name":"term_set","ty":"bytes_view"},{"name":"task_id_utf8","ty":"bytes_view"}],"result":"i32"},{"body":["ext.mcp.rr._replay_from_fs_inner_v1","server_manifest_path","transcript_path"],"kind":"defn","name":"ext.mcp.rr.replay_from_fs_v1","params":[{"name":"server_manifest_path","ty":"bytes_view"},{"name":"transcript_path","ty":"bytes_view"}],"result":"result_i32"},{"body":["std.mcp.rr.sanitize_profile.sanitize_err_report_json_v1","profile_json","input_jsonl"],"kind":"defn","name":"ext.mcp.rr.sanitize_err_report_json_v1","params":[{"name":"profile_json","ty":"bytes_view"},{"name":"input_jsonl","ty":"bytes_view"}],"result":"bytes"},{"body":["std.mcp.rr.sanitize_profile.sanitize_jsonl_v1","profile_json","input_jsonl"],"kind":"defn","name":"ext.mcp.rr.sanitize_jsonl_v1","params":[{"name":"profile_json","ty":"bytes_view"},{"name":"input_jsonl","ty":"bytes_view"}],"result":"result_bytes"}],"imports":["ext.data_model","ext.json.data_model","ext.mcp.server","std.bytes","std.codec","std.fs","std.mcp.rr.sanitize","std.mcp.rr.sanitize_profile","std.mcp.util.json"],"kind":"module","module_id":"ext.mcp.rr","schema_version":"x07.x07ast@0.5.0"}
