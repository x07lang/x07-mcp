{"decls":[{"kind":"export","names":["std.mcp.rr.sanitize.sanitize_http_session_v1","std.mcp.rr.sanitize.sanitize_jsonl_v1"]},{"body":["begin",["let","n",["view.len","b"]],["let","out",["vec_u8.with_capacity","n"]],["for","i",0,"n",["begin",["let","c",["view.get_u8","b","i"]],["let","c2",["if",["&",[">=u","c",65],["<=u","c",90]],["+","c",32],"c"]],["set","out",["vec_u8.push","out","c2"]],0]],["vec_u8.into_bytes","out"]],"kind":"defn","name":"std.mcp.rr.sanitize._ascii_lower_bytes_v1","params":[{"name":"b","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","pfx",["bytes.lit","(?i)"]],["let","n",["view.len","pat_utf8"]],["if",["&",[">=","n",4],["=",["std.bytes.eq",["view.slice","pat_utf8",0,4],["bytes.view","pfx"]],1]],["begin",["let","rest",["view.slice","pat_utf8",4,["-","n",4]]],["ext.regex.compile_opts_v1","rest",["ext.regex.opts_casei_v1"]]],["ext.regex.compile","pat_utf8"]]],"kind":"defn","name":"std.mcp.rr.sanitize._compile_pattern_v1","params":[{"name":"pat_utf8","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["if",["<","off",0],["return",1],0],["if",["<=","depth",0],["return",1],0],["let","kind",["ext.data_model.kind_at","doc","off"]],["if",["=","kind",5],["begin",["let","n",["ext.data_model.map_len","doc","off"]],["if",["<","n",0],["return",1],0],["let","k_access_token",["bytes.lit","access_token"]],["let","k_refresh_token",["bytes.lit","refresh_token"]],["let","k_id_token",["bytes.lit","id_token"]],["for","i",0,"n",["begin",["let","k",["ext.data_model.map_key_at","doc","off","i"]],["let","k_lower",["std.mcp.rr.sanitize._ascii_lower_bytes_v1",["bytes.view","k"]]],["let","v_off",["ext.data_model.map_value_at","doc","off","i"]],["let","is_token_key",["|",["=",["std.bytes.eq",["bytes.view","k_lower"],["bytes.view","k_access_token"]],1],["|",["=",["std.bytes.eq",["bytes.view","k_lower"],["bytes.view","k_refresh_token"]],1],["=",["std.bytes.eq",["bytes.view","k_lower"],["bytes.view","k_id_token"]],1]]]],["if",["=","is_token_key",1],["begin",["if",["=",["ext.data_model.kind_at","doc","v_off"],3],["begin",["let","s",["ext.data_model.string_get","doc","v_off"]],["if",[">",["bytes.len",["bytes.view","s"]],12],["return",1],0],0],0],0],0],["if",["=",["std.mcp.rr.sanitize._detect_token_like_v1","doc","v_off","re_bearer","re_basic","re_jwt",["-","depth",1]],1],["return",1],0],0]],0],["if",["=","kind",4],["begin",["let","n",["ext.data_model.seq_len","doc","off"]],["if",["<","n",0],["return",1],0],["for","i",0,"n",["begin",["let","it",["ext.data_model.seq_get","doc","off","i"]],["if",["=",["std.mcp.rr.sanitize._detect_token_like_v1","doc","it","re_bearer","re_basic","re_jwt",["-","depth",1]],1],["return",1],0],0]],0],["if",["=","kind",3],["begin",["let","s",["ext.data_model.string_get","doc","off"]],["if",["=",["std.mcp.rr.sanitize._regex_has_match_v1","re_bearer",["bytes.view","s"]],1],["return",1],0],["if",["=",["std.mcp.rr.sanitize._regex_has_match_v1","re_basic",["bytes.view","s"]],1],["return",1],0],["if",["=",["std.mcp.rr.sanitize._regex_has_match_v1","re_jwt",["bytes.view","s"]],1],["return",1],0],0],0]]]],"kind":"defn","name":"std.mcp.rr.sanitize._detect_token_like_v1","params":[{"name":"doc","ty":"bytes_view"},{"name":"off","ty":"i32"},{"name":"re_bearer","ty":"bytes_view"},{"name":"re_basic","ty":"bytes_view"},{"name":"re_jwt","ty":"bytes_view"},{"name":"depth","ty":"i32"}],"result":"i32"},{"body":["begin",["let","k_auth",["bytes.lit","authorization"]],["let","k_pauth",["bytes.lit","proxy-authorization"]],["let","k_cookie",["bytes.lit","cookie"]],["let","k_set_cookie",["bytes.lit","set-cookie"]],["let","lower",["std.mcp.rr.sanitize._ascii_lower_bytes_v1","key_utf8"]],["if",["|",["=",["std.bytes.eq",["bytes.view","lower"],["bytes.view","k_auth"]],1],["|",["=",["std.bytes.eq",["bytes.view","lower"],["bytes.view","k_pauth"]],1],["|",["=",["std.bytes.eq",["bytes.view","lower"],["bytes.view","k_cookie"]],1],["=",["std.bytes.eq",["bytes.view","lower"],["bytes.view","k_set_cookie"]],1]]]],1,0]],"kind":"defn","name":"std.mcp.rr.sanitize._key_is_sensitive_v1","params":[{"name":"key_utf8","ty":"bytes_view"}],"result":"i32"},{"body":["begin",["let","k_auth",["bytes.lit","authorization"]],["let","k_pauth",["bytes.lit","proxy-authorization"]],["let","k_cookie",["bytes.lit","cookie"]],["let","k_set_cookie",["bytes.lit","set-cookie"]],["let","lower",["std.mcp.rr.sanitize._ascii_lower_bytes_v1","key_utf8"]],["let","red_cookie",["bytes.lit","[REDACTED:cookie]"]],["let","red_auth",["bytes.lit","[REDACTED:auth]"]],["let","red_bearer",["bytes.lit","Bearer [REDACTED:bearer]"]],["let","red_basic",["bytes.lit","Basic [REDACTED:basic]"]],["if",["|",["=",["std.bytes.eq",["bytes.view","lower"],["bytes.view","k_cookie"]],1],["=",["std.bytes.eq",["bytes.view","lower"],["bytes.view","k_set_cookie"]],1]],["ext.data_model.value_string",["bytes.view","red_cookie"]],["if",["|",["=",["std.bytes.eq",["bytes.view","lower"],["bytes.view","k_auth"]],1],["=",["std.bytes.eq",["bytes.view","lower"],["bytes.view","k_pauth"]],1]],["begin",["let","kind",["ext.data_model.kind_at","doc","v_off"]],["if",["=","kind",3],["begin",["let","s",["ext.data_model.string_get","doc","v_off"]],["let","s_lower",["std.mcp.rr.sanitize._ascii_lower_bytes_v1",["bytes.view","s"]]],["let","p_bearer",["bytes.lit","bearer "]],["let","p_basic",["bytes.lit","basic "]],["let","pl_bearer",["view.len",["bytes.view","p_bearer"]]],["let","pl_basic",["view.len",["bytes.view","p_basic"]]],["let","sn",["view.len",["bytes.view","s_lower"]]],["if",["&",[">=","sn","pl_bearer"],["=",["std.bytes.eq",["view.slice",["bytes.view","s_lower"],0,"pl_bearer"],["bytes.view","p_bearer"]],1]],["ext.data_model.value_string",["bytes.view","red_bearer"]],["if",["&",[">=","sn","pl_basic"],["=",["std.bytes.eq",["view.slice",["bytes.view","s_lower"],0,"pl_basic"],["bytes.view","p_basic"]],1]],["ext.data_model.value_string",["bytes.view","red_basic"]],["ext.data_model.value_string",["bytes.view","red_auth"]]]]],["ext.data_model.value_string",["bytes.view","red_auth"]]]],["ext.data_model.value_string",["bytes.view","red_auth"]]]]],"kind":"defn","name":"std.mcp.rr.sanitize._redact_sensitive_value_v1","params":[{"name":"doc","ty":"bytes_view"},{"name":"key_utf8","ty":"bytes_view"},{"name":"v_off","ty":"i32"}],"result":"bytes"},{"body":["begin",["if",["<","off",0],["return",["bytes.alloc",0]],0],["let","kind",["ext.data_model.kind_at","doc","off"]],["if",["<=","depth",0],["return",["std.mcp.rr.sanitize._value_slice_v1","doc","off"]],0],["if",["=","kind",5],["begin",["let","n",["ext.data_model.map_len","doc","off"]],["if",["<","n",0],["return",["bytes.alloc",0]],0],["let","entries",["vec_u8.with_capacity",256]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le","n"]]],["for","i",0,"n",["begin",["let","k",["ext.data_model.map_key_at","doc","off","i"]],["let","v_off",["ext.data_model.map_value_at","doc","off","i"]],["let","is_sensitive",["std.mcp.rr.sanitize._key_is_sensitive_v1",["bytes.view","k"]]],["let","v",["if",["=","is_sensitive",1],["std.mcp.rr.sanitize._redact_sensitive_value_v1","doc",["bytes.view","k"],"v_off"],["std.mcp.rr.sanitize._redact_value_v1","doc","v_off","redacted_value_utf8","re_bearer_full","re_basic_full","re_jwt",["-","depth",1]]]],["if",["=",["bytes.len",["bytes.view","v"]],0],["return",["bytes.alloc",0]],0],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",["bytes.len",["bytes.view","k"]]]]],["set","entries",["vec_u8.extend_bytes","entries",["bytes.view","k"]]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",["bytes.len",["bytes.view","v"]]]]],["set","entries",["vec_u8.extend_bytes","entries",["bytes.view","v"]]],0]],["let","entries_b",["vec_u8.into_bytes","entries"]],["ext.data_model.value_map_from_entries",["bytes.view","entries_b"]]],["if",["=","kind",4],["begin",["let","n",["ext.data_model.seq_len","doc","off"]],["if",["<","n",0],["return",["bytes.alloc",0]],0],["let","elems",["vec_u8.with_capacity",256]],["set","elems",["vec_u8.extend_bytes","elems",["codec.write_u32_le","n"]]],["for","i",0,"n",["begin",["let","it",["ext.data_model.seq_get","doc","off","i"]],["let","v",["std.mcp.rr.sanitize._redact_value_v1","doc","it","redacted_value_utf8","re_bearer_full","re_basic_full","re_jwt",["-","depth",1]]],["if",["=",["bytes.len",["bytes.view","v"]],0],["return",["bytes.alloc",0]],0],["set","elems",["vec_u8.extend_bytes","elems",["codec.write_u32_le",["bytes.len",["bytes.view","v"]]]]],["set","elems",["vec_u8.extend_bytes","elems",["bytes.view","v"]]],0]],["let","elems_b",["vec_u8.into_bytes","elems"]],["ext.data_model.value_seq_from_elems",["bytes.view","elems_b"]]],["if",["=","kind",3],["begin",["let","s",["ext.data_model.string_get","doc","off"]],["let","out","s"],["if",["=",["std.mcp.rr.sanitize._regex_has_match_v1","re_bearer_full",["bytes.view","out"]],1],["set","out",["std.bytes.copy","redacted_value_utf8"]],0],["if",["=",["std.mcp.rr.sanitize._regex_has_match_v1","re_basic_full",["bytes.view","out"]],1],["set","out",["std.bytes.copy","redacted_value_utf8"]],0],["if",["=",["std.mcp.rr.sanitize._regex_has_match_v1","re_jwt",["bytes.view","out"]],1],["set","out",["ext.regex.replace_all_v1","re_jwt",["bytes.view","out"],"redacted_value_utf8",2147483647]],0],["ext.data_model.value_string",["bytes.view","out"]]],["std.mcp.rr.sanitize._value_slice_v1","doc","off"]]]]],"kind":"defn","name":"std.mcp.rr.sanitize._redact_value_v1","params":[{"name":"doc","ty":"bytes_view"},{"name":"off","ty":"i32"},{"name":"redacted_value_utf8","ty":"bytes_view"},{"name":"re_bearer_full","ty":"bytes_view"},{"name":"re_basic_full","ty":"bytes_view"},{"name":"re_jwt","ty":"bytes_view"},{"name":"depth","ty":"i32"}],"result":"bytes"},{"body":["begin",["let","m_b",["ext.regex.exec","compiled_re","text_utf8"]],["let","m",["bytes.view","m_b"]],["if",["=",["ext.regex.is_err","m"],1],1,["if",["=",["ext.regex.is_match","m"],1],1,0]]],"kind":"defn","name":"std.mcp.rr.sanitize._regex_has_match_v1","params":[{"name":"compiled_re","ty":"bytes_view"},{"name":"text_utf8","ty":"bytes_view"}],"result":"i32"},{"body":["begin",["let","end",["ext.data_model.skip_value","doc","off"]],["if",["<","end",0],["return",["bytes.alloc",0]],0],["view.to_bytes",["view.slice","doc","off",["-","end","off"]]]],"kind":"defn","name":"std.mcp.rr.sanitize._value_slice_v1","params":[{"name":"doc","ty":"bytes_view"},{"name":"off","ty":"i32"}],"result":"bytes"},{"body":["begin",["let","n",["view.len","b"]],["let","out",["vec_u8.with_capacity",["+","n",1]]],["set","out",["vec_u8.extend_bytes","out","b"]],["set","out",["vec_u8.push","out",10]],["vec_u8.into_bytes","out"]],"kind":"defn","name":"std.mcp.rr.sanitize._with_nl_v1","params":[{"name":"b","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","doc_b",["ext.json.data_model.parse","raw_session_json"]],["let","doc",["bytes.view","doc_b"]],["if",["=",["ext.data_model.doc_is_err","doc"],1],["return",["bytes.alloc",0]],0],["let","root",["ext.data_model.root_offset","doc"]],["if",["<","root",0],["return",["bytes.alloc",0]],0],["let","redacted_value_utf8_b",["bytes.lit","<redacted>"]],["let","pat_bearer_full",["bytes.lit","(?i)^bearer\\s+[A-Za-z0-9._~+/=-]{8,}$"]],["let","pat_basic_full",["bytes.lit","(?i)^basic\\s+[A-Za-z0-9+/=]{8,}$"]],["let","pat_jwt",["bytes.lit","[A-Za-z0-9_-]{20,}\\\\.[A-Za-z0-9_-]{20,}\\\\.[A-Za-z0-9_-]{20,}"]],["let","re_bearer_full_b",["std.mcp.rr.sanitize._compile_pattern_v1",["bytes.view","pat_bearer_full"]]],["let","re_basic_full_b",["std.mcp.rr.sanitize._compile_pattern_v1",["bytes.view","pat_basic_full"]]],["let","re_jwt_b",["std.mcp.rr.sanitize._compile_pattern_v1",["bytes.view","pat_jwt"]]],["if",["|",["=",["ext.regex.is_err",["bytes.view","re_bearer_full_b"]],1],["|",["=",["ext.regex.is_err",["bytes.view","re_basic_full_b"]],1],["=",["ext.regex.is_err",["bytes.view","re_jwt_b"]],1]]],["return",["bytes.alloc",0]],0],["let","val",["std.mcp.rr.sanitize._redact_value_v1","doc","root",["bytes.view","redacted_value_utf8_b"],["bytes.view","re_bearer_full_b"],["bytes.view","re_basic_full_b"],["bytes.view","re_jwt_b"],32]],["if",["=",["bytes.len",["bytes.view","val"]],0],["return",["bytes.alloc",0]],0],["let","json",["std.mcp.util.json.json_from_value_v1",["bytes.view","val"]]],["let","jv",["bytes.view","json"]],["if",["=",["view.len","jv"],0],["return",["bytes.alloc",0]],0],["let","pat_bearer_detect",["bytes.lit","bearer\\s+[A-Za-z0-9._~+/=-]{8,}"]],["let","pat_basic_detect",["bytes.lit","basic\\s+[A-Za-z0-9+/=]{8,}"]],["let","re_bearer_detect_b",["ext.regex.compile_opts_v1",["bytes.view","pat_bearer_detect"],["ext.regex.opts_casei_v1"]]],["let","re_basic_detect_b",["ext.regex.compile_opts_v1",["bytes.view","pat_basic_detect"],["ext.regex.opts_casei_v1"]]],["if",["|",["=",["ext.regex.is_err",["bytes.view","re_bearer_detect_b"]],1],["=",["ext.regex.is_err",["bytes.view","re_basic_detect_b"]],1]],["return",["bytes.alloc",0]],0],["let","doc2_b",["ext.json.data_model.parse","jv"]],["let","doc2",["bytes.view","doc2_b"]],["if",["=",["ext.data_model.doc_is_err","doc2"],1],["return",["bytes.alloc",0]],0],["let","root2",["ext.data_model.root_offset","doc2"]],["if",["<","root2",0],["return",["bytes.alloc",0]],0],["if",["=",["std.mcp.rr.sanitize._detect_token_like_v1","doc2","root2",["bytes.view","re_bearer_detect_b"],["bytes.view","re_basic_detect_b"],["bytes.view","re_jwt_b"],32],1],["return",["bytes.alloc",0]],0],["std.mcp.rr.sanitize._with_nl_v1","jv"]],"kind":"defn","name":"std.mcp.rr.sanitize.sanitize_http_session_v1","params":[{"name":"raw_session_json","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","n",["view.len","raw_jsonl"]],["if",["=","n",0],["return",["bytes.alloc",0]],0],["let","had_trailing_nl",["if",["=",["view.get_u8","raw_jsonl",["-","n",1]],10],1,0]],["let","out",["vec_u8.with_capacity",["+","n",16]]],["let","start",0],["for","i",0,"n",["if",["=",["view.get_u8","raw_jsonl","i"],10],["begin",["let","line_v",["view.slice","raw_jsonl","start",["-","i","start"]]],["let","canon",["ext.json.canon.canonicalize","line_v"]],["if",[">",["std.bytes.len","canon"],0],["set","out",["vec_u8.extend_bytes","out",["bytes.view","canon"]]],["set","out",["vec_u8.extend_bytes","out","line_v"]]],["set","out",["vec_u8.push","out",10]],["set","start",["+","i",1]],0],0]],["if",["<","start","n"],["begin",["let","line_v",["view.slice","raw_jsonl","start",["-","n","start"]]],["let","canon",["ext.json.canon.canonicalize","line_v"]],["if",[">",["std.bytes.len","canon"],0],["set","out",["vec_u8.extend_bytes","out",["bytes.view","canon"]]],["set","out",["vec_u8.extend_bytes","out","line_v"]]],["if",["=","had_trailing_nl",1],["begin",["set","out",["vec_u8.push","out",10]],0],0],0],0],["vec_u8.into_bytes","out"]],"kind":"defn","name":"std.mcp.rr.sanitize.sanitize_jsonl_v1","params":[{"name":"raw_jsonl","ty":"bytes_view"}],"result":"bytes"}],"imports":["ext.data_model","ext.json.canon","ext.json.data_model","ext.regex","std.bytes","std.codec","std.mcp.util.json"],"kind":"module","module_id":"std.mcp.rr.sanitize","schema_version":"x07.x07ast@0.5.0"}
