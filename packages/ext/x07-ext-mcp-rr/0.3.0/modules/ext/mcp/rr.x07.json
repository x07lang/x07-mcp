{"decls":[{"kind":"export","names":["ext.mcp.rr.replay_from_fs_v1"]},{"body":["begin",["if",["<",["view.len","dispatch_doc"],12],["return",["bytes.alloc",0]],0],["if",["!=",["codec.read_u32_le","dispatch_doc",0],1],["return",["bytes.alloc",0]],0],["let","ns_len",["codec.read_u32_le","dispatch_doc",4]],["let","start",8],["if",["<u",["view.len","dispatch_doc"],["+","start","ns_len"]],["return",["bytes.alloc",0]],0],["view.to_bytes",["view.slice","dispatch_doc","start","ns_len"]]],"kind":"defn","name":"ext.mcp.rr._dispatch_next_state_v1","params":[{"name":"dispatch_doc","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["if",["<",["view.len","dispatch_doc"],12],["return",["bytes.alloc",0]],0],["if",["!=",["codec.read_u32_le","dispatch_doc",0],1],["return",["bytes.alloc",0]],0],["let","ns_len",["codec.read_u32_le","dispatch_doc",4]],["let","out_off",["+",8,["if",["<","ns_len",0],0,"ns_len"]]],["if",["<u",["view.len","dispatch_doc"],["+","out_off",4]],["return",["bytes.alloc",0]],0],["let","out_len",["codec.read_u32_le","dispatch_doc","out_off"]],["let","start",["+","out_off",4]],["if",["<u",["view.len","dispatch_doc"],["+","start","out_len"]],["return",["bytes.alloc",0]],0],["view.to_bytes",["view.slice","dispatch_doc","start","out_len"]]],"kind":"defn","name":"ext.mcp.rr._dispatch_out_jsonl_v1","params":[{"name":"dispatch_doc","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","k_dir",["bytes.lit","dir"]],["let","off",["ext.data_model.map_find","doc","root",["bytes.view","k_dir"]]],["if",["<","off",0],["return",["bytes.alloc",0]],0],["if",["!=",["ext.data_model.kind_at","doc","off"],3],["return",["bytes.alloc",0]],0],["ext.data_model.string_get","doc","off"]],"kind":"defn","name":"ext.mcp.rr._entry_dir_v1","params":[{"name":"doc","ty":"bytes_view"},{"name":"root","ty":"i32"}],"result":"bytes"},{"body":["begin",["let","k_msg",["bytes.lit","msg"]],["let","off",["ext.data_model.map_find","doc","root",["bytes.view","k_msg"]]],["if",["<","off",0],["return",["bytes.alloc",0]],0],["let","end",["ext.data_model.skip_value","doc","off"]],["if",["<","end",0],["return",["bytes.alloc",0]],0],["let","val",["view.to_bytes",["view.slice","doc","off",["-","end","off"]]]],["std.mcp.util.json.json_from_value_v1",["bytes.view","val"]]],"kind":"defn","name":"ext.mcp.rr._entry_msg_json_v1","params":[{"name":"doc","ty":"bytes_view"},{"name":"root","ty":"i32"}],"result":"bytes"},{"body":7601,"kind":"defn","name":"ext.mcp.rr._err_invalid_transcript_v1","params":[],"result":"i32"},{"body":7602,"kind":"defn","name":"ext.mcp.rr._err_mismatch_v1","params":[],"result":"i32"},{"body":7603,"kind":"defn","name":"ext.mcp.rr._err_router_v1","params":[],"result":"i32"},{"body":["begin",["let","hn",["view.len","hay"]],["let","nn",["view.len","needle"]],["if",["<=","nn",0],["return",0],0],["if",["<","hn","nn"],["return",-1],0],["let","limit",["-","hn","nn"]],["for","i",0,["+","limit",1],["begin",["let","ok",1],["for","j",0,"nn",["begin",["if",["=",["view.get_u8","hay",["+","i","j"]],["view.get_u8","needle","j"]],0,["begin",["set","ok",0],["set","j","nn"],0]],0]],["if",["=","ok",1],["return","i"],0],0]],-1],"kind":"defn","name":"ext.mcp.rr._find_sub_v1","params":[{"name":"hay","ty":"bytes_view"},{"name":"needle","ty":"bytes_view"}],"result":"i32"},{"body":["begin",["if",["<u",["view.len","pack"],12],0,["codec.read_u32_le","pack",8]]],"kind":"defn","name":"ext.mcp.rr._line_info_len_v1","params":[{"name":"pack","ty":"bytes_view"}],"result":"i32"},{"body":["begin",["if",["<u",["view.len","pack"],12],0,["codec.read_u32_le","pack",4]]],"kind":"defn","name":"ext.mcp.rr._line_info_next_pos_v1","params":[{"name":"pack","ty":"bytes_view"}],"result":"i32"},{"body":["begin",["if",["<u",["view.len","pack"],12],0,["codec.read_u32_le","pack",0]]],"kind":"defn","name":"ext.mcp.rr._line_info_start_v1","params":[{"name":"pack","ty":"bytes_view"}],"result":"i32"},{"body":["begin",["if",[">=u","pos","n"],["return",["ext.mcp.rr._pack_u32_u32_u32_v1","pos","pos",0]],0],["let","rest_len",["-","n","pos"]],["let","rest",["view.slice","src","pos","rest_len"]],["let","idx",["std.bytes.find_u8","rest",10]],["let","raw_len",["if",[">=","idx",0],"idx","rest_len"]],["let","next_p",["if",[">=","idx",0],["+","pos",["+","idx",1]],"n"]],["let","end_len","raw_len"],["if",[">","end_len",0],["begin",["let","last",["view.get_u8","rest",["-","end_len",1]]],["if",["=","last",13],["set","end_len",["-","end_len",1]],0],0],0],["if",[">","end_len",0],["ext.mcp.rr._pack_u32_u32_u32_v1","pos","next_p","end_len"],["ext.mcp.rr._next_line_info_v1","src","next_p","n"]]],"kind":"defn","name":"ext.mcp.rr._next_line_info_v1","params":[{"name":"src","ty":"bytes_view"},{"name":"pos","ty":"i32"},{"name":"n","ty":"i32"}],"result":"bytes"},{"body":["begin",["let","v",["vec_u8.with_capacity",12]],["set","v",["vec_u8.extend_bytes","v",["codec.write_u32_le","a"]]],["set","v",["vec_u8.extend_bytes","v",["codec.write_u32_le","b"]]],["set","v",["vec_u8.extend_bytes","v",["codec.write_u32_le","c"]]],["vec_u8.into_bytes","v"]],"kind":"defn","name":"ext.mcp.rr._pack_u32_u32_u32_v1","params":[{"name":"a","ty":"i32"},{"name":"b","ty":"i32"},{"name":"c","ty":"i32"}],"result":"bytes"},{"body":["begin",["let","raw",["std.fs.read","transcript_path"]],["let","tv",["bytes.view","raw"]],["let","tn",["view.len","tv"]],["let","pos",0],["let","cmp_i",0],["let","hpack",["ext.mcp.rr._next_line_info_v1","tv","pos","tn"]],["let","hstart",["ext.mcp.rr._line_info_start_v1",["bytes.view","hpack"]]],["set","pos",["ext.mcp.rr._line_info_next_pos_v1",["bytes.view","hpack"]]],["let","hlen",["ext.mcp.rr._line_info_len_v1",["bytes.view","hpack"]]],["if",["=","hlen",0],["return",["result_i32.err",["ext.mcp.rr._err_invalid_transcript_v1"]]],0],["let","hline",["view.slice","tv","hstart","hlen"]],["let","hdr_need",["bytes.lit","\"schema_version\":\"x07.mcp.rr.transcript@0.2.0\""]],["if",["<",["ext.mcp.rr._find_sub_v1","hline",["bytes.view","hdr_need"]],0],["return",["result_i32.err",["ext.mcp.rr._err_invalid_transcript_v1"]]],0],["let","st_res",["ext.mcp.server.make_router_from_fs_v1","server_manifest_path"]],["if",["!=",["result_bytes.err_code","st_res"],0],["return",["result_i32.err",["ext.mcp.rr._err_router_v1"]]],0],["let","router_state",["result_bytes.unwrap_or","st_res",["bytes.alloc",0]]],["let","lit_c2s",["bytes.lit","c2s"]],["let","lit_s2c",["bytes.lit","s2c"]],["for","_",0,128,["begin",["if",["<u","pos","tn"],0,["return",["result_i32.ok",0]]],["let","pack",["ext.mcp.rr._next_line_info_v1","tv","pos","tn"]],["let","start",["ext.mcp.rr._line_info_start_v1",["bytes.view","pack"]]],["set","pos",["ext.mcp.rr._line_info_next_pos_v1",["bytes.view","pack"]]],["let","llen",["ext.mcp.rr._line_info_len_v1",["bytes.view","pack"]]],["if",["=","llen",0],0,["begin",["let","line",["view.slice","tv","start","llen"]],["let","line_doc_b",["ext.json.data_model.parse","line"]],["let","line_doc",["bytes.view","line_doc_b"]],["if",["=",["ext.data_model.doc_is_err","line_doc"],1],["return",["result_i32.err",["ext.mcp.rr._err_invalid_transcript_v1"]]],0],["if",["!=",["ext.data_model.root_kind","line_doc"],5],["return",["result_i32.err",["ext.mcp.rr._err_invalid_transcript_v1"]]],0],["let","line_root",["ext.data_model.root_offset","line_doc"]],["let","line_dir",["ext.mcp.rr._entry_dir_v1","line_doc","line_root"]],["if",["=",["bytes.eq",["bytes.view","line_dir"],["bytes.view","lit_c2s"]],1],["begin",["let","msg_json",["ext.mcp.rr._entry_msg_json_v1","line_doc","line_root"]],["if",["<=",["bytes.len",["bytes.view","msg_json"]],0],["return",["result_i32.err",["ext.mcp.rr._err_invalid_transcript_v1"]]],0],["let","dispatch_res",["ext.mcp.server.dispatch_jsonrpc_v1",["bytes.view","router_state"],["bytes.view","msg_json"]]],["if",["!=",["result_bytes.err_code","dispatch_res"],0],["return",["result_i32.err",["ext.mcp.rr._err_router_v1"]]],0],["let","dispatch_doc",["result_bytes.unwrap_or","dispatch_res",["bytes.alloc",0]]],["let","dv",["bytes.view","dispatch_doc"]],["set","router_state",["ext.mcp.rr._dispatch_next_state_v1","dv"]],["let","out_jsonl",["ext.mcp.rr._dispatch_out_jsonl_v1","dv"]],["let","ov",["bytes.view","out_jsonl"]],["let","on",["view.len","ov"]],["let","opos",0],["for","j",0,16,["begin",["if",["<u","opos","on"],["begin",["let","opack",["ext.mcp.rr._next_line_info_v1","ov","opos","on"]],["let","ostart",["ext.mcp.rr._line_info_start_v1",["bytes.view","opack"]]],["set","opos",["ext.mcp.rr._line_info_next_pos_v1",["bytes.view","opack"]]],["let","olen",["ext.mcp.rr._line_info_len_v1",["bytes.view","opack"]]],["if",["=","olen",0],0,["begin",["let","oline",["view.slice","ov","ostart","olen"]],["let","epack",["ext.mcp.rr._next_line_info_v1","tv","pos","tn"]],["let","estart",["ext.mcp.rr._line_info_start_v1",["bytes.view","epack"]]],["set","pos",["ext.mcp.rr._line_info_next_pos_v1",["bytes.view","epack"]]],["let","elen",["ext.mcp.rr._line_info_len_v1",["bytes.view","epack"]]],["if",["=","elen",0],["return",["result_i32.err",["ext.mcp.rr._err_invalid_transcript_v1"]]],0],["let","eline",["view.slice","tv","estart","elen"]],["let","eline_doc_b",["ext.json.data_model.parse","eline"]],["let","eline_doc",["bytes.view","eline_doc_b"]],["if",["=",["ext.data_model.doc_is_err","eline_doc"],1],["return",["result_i32.err",["ext.mcp.rr._err_invalid_transcript_v1"]]],0],["if",["!=",["ext.data_model.root_kind","eline_doc"],5],["return",["result_i32.err",["ext.mcp.rr._err_invalid_transcript_v1"]]],0],["let","eline_root",["ext.data_model.root_offset","eline_doc"]],["let","edir",["ext.mcp.rr._entry_dir_v1","eline_doc","eline_root"]],["if",["=",["bytes.eq",["bytes.view","edir"],["bytes.view","lit_s2c"]],1],0,["return",["result_i32.err",["ext.mcp.rr._err_invalid_transcript_v1"]]]],["let","exp_json",["ext.mcp.rr._entry_msg_json_v1","eline_doc","eline_root"]],["if",["<=",["bytes.len",["bytes.view","exp_json"]],0],["return",["result_i32.err",["ext.mcp.rr._err_invalid_transcript_v1"]]],0],["set","cmp_i",["+","cmp_i",1]],["if",["=",["view.eq","oline",["bytes.view","exp_json"]],1],0,["return",["result_i32.err",["+",7602000,"cmp_i"]]]]]]],0],0]]],0]]]]],["result_i32.ok",0]],"kind":"defn","name":"ext.mcp.rr.replay_from_fs_v1","params":[{"name":"server_manifest_path","ty":"bytes_view"},{"name":"transcript_path","ty":"bytes_view"}],"result":"result_i32"}],"imports":["ext.data_model","ext.json.data_model","ext.mcp.server","std.bytes","std.codec","std.fs","std.mcp.util.json"],"kind":"module","module_id":"ext.mcp.rr","schema_version":"x07.x07ast@0.5.0"}
