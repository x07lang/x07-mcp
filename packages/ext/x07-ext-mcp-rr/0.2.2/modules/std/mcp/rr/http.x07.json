{"decls":[{"kind":"export","names":["std.mcp.rr.http.replay_from_fs_v1"]},{"body":["begin",["if",["!=",["ext.data_model.kind_at","headers_val",0],5],["return",["bytes.alloc",0]],0],["let","off",["ext.data_model.map_find","headers_val",0,"name"]],["if",["<","off",0],["return",["bytes.alloc",0]],0],["if",["!=",["ext.data_model.kind_at","headers_val","off"],3],["return",["bytes.alloc",0]],0],["ext.data_model.string_get","headers_val","off"]],"kind":"defn","name":"std.mcp.rr.http._header_get_exact_v1","params":[{"name":"headers_val","ty":"bytes_view"},{"name":"name","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","entries",["vec_u8.with_capacity",4]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",0]]],["let","entries_b",["vec_u8.into_bytes","entries"]],["ext.data_model.value_map_from_entries",["bytes.view","entries_b"]]],"kind":"defn","name":"std.mcp.rr.http._headers_empty_v1","params":[],"result":"bytes"},{"body":["begin",["let","v_val",["ext.data_model.value_string","value_text"]],["let","entries",["vec_u8.with_capacity",128]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",1]]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",["bytes.len","key"]]]],["set","entries",["vec_u8.extend_bytes","entries","key"]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",["bytes.len","v_val"]]]],["set","entries",["vec_u8.extend_bytes","entries","v_val"]],["let","entries_b",["vec_u8.into_bytes","entries"]],["ext.data_model.value_map_from_entries",["bytes.view","entries_b"]]],"kind":"defn","name":"std.mcp.rr.http._headers_one_v1","params":[{"name":"key","ty":"bytes_view"},{"name":"value_text","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","off",["ext.data_model.map_find","doc","map_off","key"]],["if",["<","off",0],["return",["bytes.alloc",0]],0],["if",["!=",["ext.data_model.kind_at","doc","off"],3],["return",["bytes.alloc",0]],0],["ext.data_model.string_get","doc","off"]],"kind":"defn","name":"std.mcp.rr.http._map_string_or_empty_v1","params":[{"name":"doc","ty":"bytes_view"},{"name":"map_off","ty":"i32"},{"name":"key","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","off",["ext.data_model.map_find","doc","map_off","key"]],["if",["<","off",0],["return",["bytes.alloc",0]],0],["let","end",["ext.data_model.skip_value","doc","off"]],["if",["<","end",0],["return",["bytes.alloc",0]],0],["let","val",["view.to_bytes",["view.slice","doc","off",["-","end","off"]]]],["std.mcp.util.json.json_from_value_v1",["bytes.view","val"]]],"kind":"defn","name":"std.mcp.rr.http._map_value_json_or_empty_v1","params":[{"name":"doc","ty":"bytes_view"},{"name":"map_off","ty":"i32"},{"name":"key","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","st",["std.parse.i32_status_le","b"]],["if",["if",[">=u",["bytes.len","st"],5],["=",["bytes.get_u8","st",0],1],0],["codec.read_u32_le","st",1],-1]],"kind":"defn","name":"std.mcp.rr.http._parse_i32_or_neg1_v1","params":[{"name":"b","ty":"bytes_view"}],"result":"i32"},{"body":["begin",["if",["<","seq_off",0],["return",["bytes.alloc",0]],0],["if",["!=",["ext.data_model.kind_at","doc","seq_off"],4],["return",["bytes.alloc",0]],0],["let","n",["ext.data_model.seq_len","doc","seq_off"]],["if",["<","n",0],["return",["bytes.alloc",0]],0],["let","out",["vec_u8.with_capacity",64]],["for","i",0,"n",["begin",["let","off",["ext.data_model.seq_get","doc","seq_off","i"]],["if",["<","off",0],["return",["bytes.alloc",0]],0],["if",["!=",["ext.data_model.kind_at","doc","off"],3],["return",["bytes.alloc",0]],0],["if",[">","i",0],["begin",["set","out",["vec_u8.push","out",32]],0],0],["let","scope_part",["ext.data_model.string_get","doc","off"]],["set","out",["vec_u8.extend_bytes","out",["bytes.view","scope_part"]]],0]],["vec_u8.into_bytes","out"]],"kind":"defn","name":"std.mcp.rr.http._scope_text_from_seq_v1","params":[{"name":"doc","ty":"bytes_view"},{"name":"seq_off","ty":"i32"}],"result":"bytes"},{"body":["begin",["let","k_schema_version",["bytes.lit","schema_version"]],["let","k_project_files",["bytes.lit","project_files"]],["let","k_server",["bytes.lit","server"]],["let","k_transport",["bytes.lit","transport"]],["let","k_auth",["bytes.lit","auth"]],["let","k_name",["bytes.lit","name"]],["let","k_version",["bytes.lit","version"]],["let","k_protocol_version",["bytes.lit","protocolVersion"]],["let","k_mcp_path",["bytes.lit","mcp_path"]],["let","k_mode",["bytes.lit","mode"]],["let","k_required_scopes",["bytes.lit","required_scopes"]],["let","k_oauth_cfg_path",["bytes.lit","oauth_config_path"]],["let","k_base_url",["bytes.lit","base_url"]],["let","k_resource",["bytes.lit","resource"]],["let","k_tools_path",["bytes.lit","tools_manifest_path"]],["let","k_steps",["bytes.lit","steps"]],["let","k_req",["bytes.lit","req"]],["let","k_res",["bytes.lit","res"]],["let","k_method",["bytes.lit","method"]],["let","k_path",["bytes.lit","path"]],["let","k_headers",["bytes.lit","headers"]],["let","k_body_json",["bytes.lit","body_json"]],["let","k_status",["bytes.lit","status"]],["let","k_body_empty",["bytes.lit","body_empty"]],["let","k_oauth",["bytes.lit","oauth"]],["let","k_tools",["bytes.lit","tools"]],["let","k_resources",["bytes.lit","resources"]],["let","k_prompts",["bytes.lit","prompts"]],["let","schema_a",["bytes.lit","x07.mcp.rr.http_session@0.1.0"]],["let","schema_b",["bytes.lit","x07.mcp.rr.http-session@0.1.0"]],["let","method_get",["bytes.lit","GET"]],["let","method_post",["bytes.lit","POST"]],["let","path_prm",["bytes.lit","/.well-known/oauth-protected-resource"]],["let","path_default_mcp",["bytes.lit","/mcp"]],["let","auth_mode_none",["bytes.lit","none"]],["let","auth_mode_oauth2",["bytes.lit","oauth2"]],["let","hdr_mcp_pv",["bytes.lit","MCP-Protocol-Version"]],["let","hdr_mcp_sid",["bytes.lit","MCP-Session-Id"]],["let","hdr_authz",["bytes.lit","Authorization"]],["let","hdr_allow",["bytes.lit","Allow"]],["let","hdr_content_type",["bytes.lit","Content-Type"]],["let","hdr_www_auth",["bytes.lit","WWW-Authenticate"]],["let","v_allow_post",["bytes.lit","POST"]],["let","v_content_type_json",["bytes.lit","application/json"]],["let","suffix_prm",["bytes.lit","/.well-known/oauth-protected-resource"]],["let","raw",["std.fs.read","session_path"]],["let","doc_b",["ext.json.data_model.parse",["bytes.view","raw"]]],["let","doc",["bytes.view","doc_b"]],["try",["std.test.assert_i32_eq",["ext.data_model.doc_is_err","doc"],0,["std.test.code_assert_i32_eq"]]],["let","root",["ext.data_model.root_offset","doc"]],["let","schema_off",["ext.data_model.map_find","doc","root",["bytes.view","k_schema_version"]]],["try",["std.test.assert_i32_eq",[">=","schema_off",0],1,["std.test.code_assert_i32_eq"]]],["let","schema_val",["ext.data_model.string_get","doc","schema_off"]],["let","ok_schema",0],["if",["=",["bytes.eq",["bytes.view","schema_val"],["bytes.view","schema_a"]],1],["set","ok_schema",1],0],["if",["=",["bytes.eq",["bytes.view","schema_val"],["bytes.view","schema_b"]],1],["set","ok_schema",1],0],["try",["std.test.assert_i32_eq","ok_schema",1,["std.test.code_assert_i32_eq"]]],["let","project_files_off",["ext.data_model.map_find","doc","root",["bytes.view","k_project_files"]]],["let","cfg_path",["bytes.lit","config/mcp.server.json"]],["let","tools_path",["bytes.lit","config/mcp.tools.json"]],["let","oauth_path",["bytes.lit","config/mcp.oauth.json"]],["let","resources_path",["bytes.lit","config/mcp.resources.json"]],["let","prompts_path",["bytes.lit","config/mcp.prompts.json"]],["if",["if",[">=","project_files_off",0],["=",["ext.data_model.kind_at","doc","project_files_off"],5],0],["begin",["let","p_cfg",["std.mcp.rr.http._map_string_or_empty_v1","doc","project_files_off",["bytes.view","k_server"]]],["let","p_tools",["std.mcp.rr.http._map_string_or_empty_v1","doc","project_files_off",["bytes.view","k_tools"]]],["let","p_oauth",["std.mcp.rr.http._map_string_or_empty_v1","doc","project_files_off",["bytes.view","k_oauth"]]],["let","p_resources",["std.mcp.rr.http._map_string_or_empty_v1","doc","project_files_off",["bytes.view","k_resources"]]],["let","p_prompts",["std.mcp.rr.http._map_string_or_empty_v1","doc","project_files_off",["bytes.view","k_prompts"]]],["let","p_cfg_len",["bytes.len",["bytes.view","p_cfg"]]],["if",[">","p_cfg_len",0],["begin",["set","cfg_path","p_cfg"],0],0],["let","p_tools_len",["bytes.len",["bytes.view","p_tools"]]],["if",[">","p_tools_len",0],["begin",["set","tools_path","p_tools"],0],0],["let","p_oauth_len",["bytes.len",["bytes.view","p_oauth"]]],["if",[">","p_oauth_len",0],["begin",["set","oauth_path","p_oauth"],0],0],["let","p_resources_len",["bytes.len",["bytes.view","p_resources"]]],["if",[">","p_resources_len",0],["begin",["set","resources_path","p_resources"],0],0],["let","p_prompts_len",["bytes.len",["bytes.view","p_prompts"]]],["if",[">","p_prompts_len",0],["begin",["set","prompts_path","p_prompts"],0],0],0],0],["let","cfg_json",["std.fs.read",["bytes.view","cfg_path"]]],["let","cfg_doc_b",["ext.json.data_model.parse",["bytes.view","cfg_json"]]],["let","cfg_doc",["bytes.view","cfg_doc_b"]],["try",["std.test.assert_i32_eq",["ext.data_model.doc_is_err","cfg_doc"],0,["std.test.code_assert_i32_eq"]]],["let","cfg_root",["ext.data_model.root_offset","cfg_doc"]],["let","server_off",["ext.data_model.map_find","cfg_doc","cfg_root",["bytes.view","k_server"]]],["let","transport_off",["ext.data_model.map_find","cfg_doc","cfg_root",["bytes.view","k_transport"]]],["let","auth_off",["ext.data_model.map_find","cfg_doc","cfg_root",["bytes.view","k_auth"]]],["let","server_name",["std.mcp.rr.http._map_string_or_empty_v1","cfg_doc","server_off",["bytes.view","k_name"]]],["let","server_version",["std.mcp.rr.http._map_string_or_empty_v1","cfg_doc","server_off",["bytes.view","k_version"]]],["let","cfg_pv",["std.mcp.rr.http._map_string_or_empty_v1","cfg_doc","server_off",["bytes.view","k_protocol_version"]]],["let","mcp_path",["std.mcp.rr.http._map_string_or_empty_v1","cfg_doc","transport_off",["bytes.view","k_mcp_path"]]],["let","mcp_path_len",["bytes.len",["bytes.view","mcp_path"]]],["if",["=","mcp_path_len",0],["begin",["set","mcp_path","path_default_mcp"],0],0],["let","auth_mode",["std.mcp.rr.http._map_string_or_empty_v1","cfg_doc","auth_off",["bytes.view","k_mode"]]],["let","auth_mode_len",["bytes.len",["bytes.view","auth_mode"]]],["if",["=","auth_mode_len",0],["begin",["set","auth_mode","auth_mode_none"],0],0],["let","cfg_required_scopes",["std.mcp.rr.http._scope_text_from_seq_v1","cfg_doc",["ext.data_model.map_find","cfg_doc","auth_off",["bytes.view","k_required_scopes"]]]],["let","base_url",["std.mcp.rr.http._map_string_or_empty_v1","doc","root",["bytes.view","k_base_url"]]],["let","resource",["std.bytes.copy","base_url"]],["let","resource_md_url",["std.bytes.concat",["bytes.view","resource"],["bytes.view","suffix_prm"]]],["let","oauth_json",["bytes.alloc",0]],["let","oauth_cfg_path",["std.mcp.rr.http._map_string_or_empty_v1","cfg_doc","auth_off",["bytes.view","k_oauth_cfg_path"]]],["if",["=",["view.eq",["bytes.view","auth_mode"],["bytes.view","auth_mode_oauth2"]],1],["begin",["let","oauth_cfg_path_len",["bytes.len",["bytes.view","oauth_cfg_path"]]],["if",[">","oauth_cfg_path_len",0],["begin",["set","oauth_path","oauth_cfg_path"],0],0],["set","oauth_json",["std.fs.read",["bytes.view","oauth_path"]]],["let","oauth_doc_b",["ext.json.data_model.parse",["bytes.view","oauth_json"]]],["let","oauth_doc",["bytes.view","oauth_doc_b"]],["let","oauth_root",["ext.data_model.root_offset","oauth_doc"]],["let","resource2",["std.mcp.rr.http._map_string_or_empty_v1","oauth_doc","oauth_root",["bytes.view","k_resource"]]],["let","resource2_len",["bytes.len",["bytes.view","resource2"]]],["if",[">","resource2_len",0],["begin",["set","resource","resource2"],0],0],["set","resource_md_url",["std.bytes.concat",["bytes.view","resource"],["bytes.view","suffix_prm"]]],0],0],["let","tools_json",["bytes.alloc",0]],["let","resources_json",["bytes.lit","{\"schema_version\":\"x07.mcp.resources_manifest@0.1.0\",\"resources\":[]}"]],["let","prompts_json",["bytes.lit","{\"schema_version\":\"x07.mcp.prompts_manifest@0.1.0\",\"prompts\":[]}"]],["let","tools_loaded",0],["let","steps_off",["ext.data_model.map_find","doc","root",["bytes.view","k_steps"]]],["let","n",["ext.data_model.seq_len","doc","steps_off"]],["try",["std.test.assert_i32_eq",[">","n",0],1,["std.test.code_assert_i32_eq"]]],["let","mcp_state",0],["let","session_id",["bytes.alloc",0]],["let","session_idx",1],["for","i",0,"n",["begin",["let","step_off",["ext.data_model.seq_get","doc","steps_off","i"]],["let","req_off",["ext.data_model.map_find","doc","step_off",["bytes.view","k_req"]]],["let","res_off",["ext.data_model.map_find","doc","step_off",["bytes.view","k_res"]]],["let","method",["std.mcp.rr.http._map_string_or_empty_v1","doc","req_off",["bytes.view","k_method"]]],["let","path",["std.mcp.rr.http._map_string_or_empty_v1","doc","req_off",["bytes.view","k_path"]]],["let","req_headers_off",["ext.data_model.map_find","doc","req_off",["bytes.view","k_headers"]]],["let","req_json",["std.mcp.rr.http._map_value_json_or_empty_v1","doc","req_off",["bytes.view","k_body_json"]]],0,["let","actual_status",-1],["let","actual_header_name",["bytes.alloc",0]],["let","actual_header_value",["bytes.alloc",0]],["let","actual_body",["bytes.alloc",0]],["if",["if",["=",["view.eq",["bytes.view","method"],["bytes.view","method_get"]],1],["=",["view.eq",["bytes.view","path"],["bytes.view","mcp_path"]],1],0],["begin",["set","actual_status",405],["set","actual_header_name",["std.bytes.copy","hdr_allow"]],["set","actual_header_value",["std.bytes.copy","v_allow_post"]],0],0],["if",["if",["<","actual_status",0],["if",["=",["view.eq",["bytes.view","method"],["bytes.view","method_get"]],1],["=",["view.eq",["bytes.view","path"],["bytes.view","path_prm"]],1],0],0],["begin",["if",["=",["view.eq",["bytes.view","auth_mode"],["bytes.view","auth_mode_oauth2"]],1],["begin",["set","actual_status",200],["set","actual_header_name",["std.bytes.copy","hdr_content_type"]],["set","actual_header_value",["std.bytes.copy","v_content_type_json"]],["set","actual_body",["std.mcp.auth.prm.build_doc_v1",["bytes.view","oauth_json"],["bytes.view","resource"]]],0],["set","actual_status",404]],0],0],["if",["if",["<","actual_status",0],["if",["=",["view.eq",["bytes.view","method"],["bytes.view","method_post"]],1],["=",["view.eq",["bytes.view","path"],["bytes.view","mcp_path"]],1],0],0],["begin",["let","ver",["std.mcp.rr.http._map_string_or_empty_v1","doc","req_headers_off",["bytes.view","hdr_mcp_pv"]]],["if",["=",["std.mcp.transport.http_rules.protocol_valid_v1",["bytes.view","ver"]],0],["set","actual_status",400],0],["let","session_id_len_req",["bytes.len",["bytes.view","session_id"]]],["if",["if",["<","actual_status",0],[">","session_id_len_req",0],0],["begin",["let","sid",["std.mcp.rr.http._map_string_or_empty_v1","doc","req_headers_off",["bytes.view","hdr_mcp_sid"]]],["let","sid_len",["bytes.len",["bytes.view","sid"]]],["if",["=","sid_len",0],["set","actual_status",400],["if",["=",["view.eq",["bytes.view","sid"],["bytes.view","session_id"]],0],["set","actual_status",404],0]],0],0],["if",["if",["<","actual_status",0],["=",["view.eq",["bytes.view","auth_mode"],["bytes.view","auth_mode_oauth2"]],1],0],["begin",["let","authz",["std.mcp.rr.http._map_string_or_empty_v1","doc","req_headers_off",["bytes.view","hdr_authz"]]],["let","auth_status",["std.mcp.auth.oauth_test_static.verify_status_v1",["bytes.view","oauth_json"],["bytes.view","authz"],["bytes.view","cfg_required_scopes"]]],["if",["=","auth_status",401],["begin",["set","actual_status",401],["let","challenge_401",["std.mcp.auth.challenge.www_authenticate_401_v1",["bytes.view","resource_md_url"],["bytes.view","cfg_required_scopes"]]],["set","actual_header_name",["std.bytes.copy","hdr_www_auth"]],["set","actual_header_value",["std.bytes.copy","challenge_401"]],0],0],["if",["=","auth_status",403],["begin",["set","actual_status",403],["let","challenge_403",["std.mcp.auth.challenge.www_authenticate_403_insufficient_scope_v1",["bytes.view","resource_md_url"],["bytes.view","cfg_required_scopes"]]],["set","actual_header_name",["std.bytes.copy","hdr_www_auth"]],["set","actual_header_value",["std.bytes.copy","challenge_403"]],0],0],0],0],["if",["<","actual_status",0],["begin",["if",["=","tools_loaded",0],["begin",["let","tools_res",["std.mcp.toolkit.tools_file.load_tools_from_fs_v1",["bytes.view","tools_path"]]],["if",["!=",["result_bytes.err_code","tools_res"],0],["set","actual_status",500],["begin",["set","tools_json",["result_bytes.unwrap_or","tools_res",["bytes.alloc",0]]],["let","resources_raw",["std.fs.read",["bytes.view","resources_path"]]],["let","resources_raw_len",["bytes.len",["bytes.view","resources_raw"]]],["if",["=","resources_raw_len",0],["begin",["set","resources_raw",["bytes.lit","{\"schema_version\":\"x07.mcp.resources_manifest.1.0\",\"resources\":[]}"]],0],0],["let","resources_raw_len2",["bytes.len",["bytes.view","resources_raw"]]],["if",[">","resources_raw_len2",0],["begin",["let","resources_res",["std.mcp.toolkit.resources_file.load_resources_from_json_v1",["bytes.view","resources_raw"]]],["if",["!=",["result_bytes.err_code","resources_res"],0],["begin",["set","actual_status",500],0],["begin",["set","resources_json",["result_bytes.unwrap_or","resources_res",["bytes.alloc",0]]],0]],0],0],["let","prompts_raw",["std.fs.read",["bytes.view","prompts_path"]]],["let","prompts_raw_len",["bytes.len",["bytes.view","prompts_raw"]]],["if",["=","prompts_raw_len",0],["begin",["set","prompts_raw",["bytes.lit","{\"schema_version\":\"x07.mcp.prompts_manifest.1.0\",\"prompts\":[]}"]],0],0],["let","prompts_raw_len2",["bytes.len",["bytes.view","prompts_raw"]]],["if",[">","prompts_raw_len2",0],["begin",["let","prompts_res",["std.mcp.toolkit.prompts_file.load_prompts_from_json_v1",["bytes.view","prompts_raw"]]],["if",["!=",["result_bytes.err_code","prompts_res"],0],["begin",["set","actual_status",500],0],["begin",["set","prompts_json",["result_bytes.unwrap_or","prompts_res",["bytes.alloc",0]]],0]],0],0],["set","tools_loaded",1],0]],0],0],["let","dispatch",["result_bytes.err",1]],["if",["<","actual_status",0],["begin",["set","dispatch",["std.mcp.toolkit.stdio_dispatch.dispatch_line_v1","mcp_state",["bytes.view","cfg_pv"],["bytes.view","server_name"],["bytes.view","server_version"],["bytes.view","tools_json"],["bytes.view","resources_json"],["bytes.view","prompts_json"],["bytes.view","req_json"]]],["if",["!=",["result_bytes.err_code","dispatch"],0],["set","actual_status",500],0],0],0],["if",["<","actual_status",0],["begin",["let","step_b",["result_bytes.unwrap_or","dispatch",["bytes.alloc",0]]],["let","kind",["std.mcp.toolkit.stdio_dispatch.step_kind_v1",["bytes.view","step_b"]]],["let","next_state",["std.mcp.toolkit.stdio_dispatch.step_next_state_v1",["bytes.view","step_b"]]],["if",["=","kind",0],["begin",["set","actual_status",202],["set","mcp_state","next_state"],0],0],["if",["=","kind",1],["begin",["set","actual_status",200],["set","actual_body",["std.mcp.toolkit.stdio_dispatch.step_resp_json_v1",["bytes.view","step_b"]]],["let","session_id_len_emit",["bytes.len",["bytes.view","session_id"]]],["if",["=","session_id_len_emit",0],["begin",["set","session_id",["std.mcp.transport.http_session.next_test_session_id_v1","session_idx"]],["set","session_idx",["+","session_idx",1]],["set","actual_header_name",["std.bytes.copy","hdr_mcp_sid"]],["set","actual_header_value",["std.bytes.copy","session_id"]],0],0],["set","mcp_state","next_state"],0],0],["if",["=","kind",2],["begin",["let","id_json",["std.mcp.toolkit.stdio_dispatch.step_tool_call_id_json_v1",["bytes.view","step_b"]]],["let","tool_name",["std.mcp.toolkit.stdio_dispatch.step_tool_call_tool_name_v1",["bytes.view","step_b"]]],["let","args_json",["std.mcp.toolkit.stdio_dispatch.step_tool_call_args_json_v1",["bytes.view","step_b"]]],["let","worker_req",["std.mcp.sandbox.worker_proto.make_request_v1",["bytes.view","tool_name"],["bytes.view","cfg_json"],["bytes.view","args_json"],["bytes.view","tools_json"]]],["let","worker_resp",["std.mcp.sandbox.worker_main.run_v1",["bytes.view","worker_req"]]],["let","tool_res",["std.mcp.sandbox.worker_proto.parse_tool_result_v1","worker_resp"]],["if",["!=",["result_bytes.err_code","tool_res"],0],["set","actual_status",500],["begin",["let","tool_payload",["result_bytes.unwrap_or","tool_res",["bytes.alloc",0]]],["set","actual_status",200],["set","actual_body",["std.mcp.jsonrpc.make_result_response_v1",["bytes.view","id_json"],["bytes.view","tool_payload"]]],["set","mcp_state","next_state"]]],0],0],["if",["<","actual_status",0],["set","actual_status",500],0],0],0],0],0],0],0],["if",["<","actual_status",0],["set","actual_status",404],0],["let","exp_status_off",["ext.data_model.map_find","doc","res_off",["bytes.view","k_status"]]],["let","exp_status_num",["ext.data_model.number_get","doc","exp_status_off"]],["let","exp_status",["std.mcp.rr.http._parse_i32_or_neg1_v1",["bytes.view","exp_status_num"]]],["try",["std.test.assert_i32_eq","actual_status","exp_status",["std.test.code_assert_i32_eq"]]],["let","exp_headers_off",["ext.data_model.map_find","doc","res_off",["bytes.view","k_headers"]]],["if",["if",[">=","exp_headers_off",0],["=",["ext.data_model.kind_at","doc","exp_headers_off"],5],0],["begin",["let","exp_allow",["std.mcp.rr.http._map_string_or_empty_v1","doc","exp_headers_off",["bytes.view","hdr_allow"]]],["let","exp_allow_len",["bytes.len",["bytes.view","exp_allow"]]],["if",[">","exp_allow_len",0],["begin",["try",["std.test.assert_i32_eq",["view.eq",["bytes.view","actual_header_name"],["bytes.view","hdr_allow"]],1,["std.test.code_assert_i32_eq"]]],["try",["std.test.assert_i32_eq",["view.eq",["bytes.view","actual_header_value"],["bytes.view","exp_allow"]],1,["std.test.code_assert_i32_eq"]]],0],0],["let","exp_content_type",["std.mcp.rr.http._map_string_or_empty_v1","doc","exp_headers_off",["bytes.view","hdr_content_type"]]],["let","exp_content_type_len",["bytes.len",["bytes.view","exp_content_type"]]],["if",[">","exp_content_type_len",0],["begin",["try",["std.test.assert_i32_eq",["view.eq",["bytes.view","actual_header_name"],["bytes.view","hdr_content_type"]],1,["std.test.code_assert_i32_eq"]]],["try",["std.test.assert_i32_eq",["view.eq",["bytes.view","actual_header_value"],["bytes.view","exp_content_type"]],1,["std.test.code_assert_i32_eq"]]],0],0],["let","exp_sid",["std.mcp.rr.http._map_string_or_empty_v1","doc","exp_headers_off",["bytes.view","hdr_mcp_sid"]]],["let","exp_sid_len",["bytes.len",["bytes.view","exp_sid"]]],["if",[">","exp_sid_len",0],["begin",["try",["std.test.assert_i32_eq",["view.eq",["bytes.view","actual_header_name"],["bytes.view","hdr_mcp_sid"]],1,["std.test.code_assert_i32_eq"]]],["try",["std.test.assert_i32_eq",["view.eq",["bytes.view","actual_header_value"],["bytes.view","exp_sid"]],1,["std.test.code_assert_i32_eq"]]],0],0],["let","exp_www_auth",["std.mcp.rr.http._map_string_or_empty_v1","doc","exp_headers_off",["bytes.view","hdr_www_auth"]]],["let","exp_www_auth_len",["bytes.len",["bytes.view","exp_www_auth"]]],["if",[">","exp_www_auth_len",0],["begin",["try",["std.test.assert_i32_eq",["view.eq",["bytes.view","actual_header_name"],["bytes.view","hdr_www_auth"]],1,["std.test.code_assert_i32_eq"]]],["try",["std.test.assert_i32_eq",["view.eq",["bytes.view","actual_header_value"],["bytes.view","exp_www_auth"]],1,["std.test.code_assert_i32_eq"]]],0],0],0],0],["let","body_empty_off",["ext.data_model.map_find","doc","res_off",["bytes.view","k_body_empty"]]],["if",["if",[">=","body_empty_off",0],["=",["ext.data_model.kind_at","doc","body_empty_off"],1],0],["if",["=",["ext.data_model.bool_get","doc","body_empty_off"],1],["try",["std.test.assert_i32_eq",["bytes.len",["bytes.view","actual_body"]],0,["std.test.code_assert_i32_eq"]]],0],0],["let","body_json_off",["ext.data_model.map_find","doc","res_off",["bytes.view","k_body_json"]]],["if",[">=","body_json_off",0],["begin",["let","bj_end",["ext.data_model.skip_value","doc","body_json_off"]],["let","bj_val",["view.to_bytes",["view.slice","doc","body_json_off",["-","bj_end","body_json_off"]]]],["let","exp_json",["std.mcp.util.json.json_from_value_v1",["bytes.view","bj_val"]]],["let","exp_canon",["ext.json.canon.canonicalize",["bytes.view","exp_json"]]],["let","got_canon",["ext.json.canon.canonicalize",["bytes.view","actual_body"]]],["try",["std.test.assert_bytes_eq","got_canon","exp_canon",["std.test.code_assert_bytes_eq"]]],0],0],0]],["std.test.pass"]],"kind":"defn","name":"std.mcp.rr.http.replay_from_fs_v1","params":[{"name":"session_path","ty":"bytes_view"}],"result":"result_i32"}],"imports":["ext.data_model","ext.json.canon","ext.json.data_model","std.bytes","std.fs","std.mcp.auth.challenge","std.mcp.auth.oauth_test_static","std.mcp.auth.prm","std.mcp.jsonrpc","std.mcp.sandbox.worker_main","std.mcp.sandbox.worker_proto","std.mcp.toolkit.prompts_file","std.mcp.toolkit.resources_file","std.mcp.toolkit.stdio_dispatch","std.mcp.toolkit.tools_file","std.mcp.transport.http_rules","std.mcp.transport.http_session","std.mcp.util.json","std.parse","std.test"],"kind":"module","module_id":"std.mcp.rr.http","schema_version":"x07.x07ast@0.5.0"}
