{
  "schema_version": "x07.x07ast@0.5.0",
  "kind": "module",
  "module_id": "std.mcp.rr.session",
  "imports": [
    "ext.json.canon",
    "std.bytes",
    "std.fs",
    "std.mcp.jsonrpc",
    "std.mcp.protocol",
    "std.mcp.sandbox.worker_main",
    "std.mcp.sandbox.worker_proto",
    "std.mcp.rr.sanitize",
    "std.mcp.toolkit.server_cfg_file",
    "std.mcp.toolkit.stdio_dispatch",
    "std.mcp.toolkit.tools_file",
    "std.test"
  ],
  "decls": [
    {
      "kind": "export",
      "names": [
        "std.mcp.rr.session.assert_stdio_jsonl_from_fs_v1",
        "std.mcp.rr.session.sanitize_cassette_v1",
        "std.mcp.rr.session.wrap_stdio_with_rr_v1"
      ]
    },
    {
      "kind": "defn",
      "name": "std.mcp.rr.session.assert_stdio_jsonl_from_fs_v1",
      "params": [
        { "name": "cfg_path", "ty": "bytes_view" },
        { "name": "c2s_path", "ty": "bytes_view" },
        { "name": "s2c_path", "ty": "bytes_view" }
      ],
      "result": "result_i32",
      "body": [
        "begin",
        ["let", "cfg_res", ["std.mcp.toolkit.server_cfg_file.load_server_cfg_from_fs_v1", "cfg_path"]],
        ["try", ["std.test.assert_i32_eq", ["result_bytes.err_code", "cfg_res"], 0, ["std.test.code_assert_i32_eq"]]],
        ["let", "cfg_json", ["result_bytes.unwrap_or", "cfg_res", ["bytes.alloc", 0]]],
        ["let", "server_name", ["std.mcp.toolkit.server_cfg_file.server_name_v1", ["bytes.view", "cfg_json"]]],
        ["let", "server_version", ["std.mcp.toolkit.server_cfg_file.server_version_v1", ["bytes.view", "cfg_json"]]],
        ["let", "cfg_pv", ["std.mcp.toolkit.server_cfg_file.server_protocol_version_v1", ["bytes.view", "cfg_json"]]],
        ["let", "supported_pv", ["std.mcp.protocol.mcp_protocol_version_v1"]],
        ["try", ["std.test.assert_i32_eq", ["bytes.eq", ["bytes.view", "cfg_pv"], ["bytes.view", "supported_pv"]], 1, ["std.test.code_assert_i32_eq"]]],
        ["let", "tools_path", ["std.mcp.toolkit.server_cfg_file.tools_manifest_path_v1", ["bytes.view", "cfg_json"]]],
        ["let", "tools_res", ["std.mcp.toolkit.tools_file.load_tools_from_fs_v1", ["bytes.view", "tools_path"]]],
        ["try", ["std.test.assert_i32_eq", ["result_bytes.err_code", "tools_res"], 0, ["std.test.code_assert_i32_eq"]]],
        ["let", "tools_json", ["result_bytes.unwrap_or", "tools_res", ["bytes.alloc", 0]]],
        ["let", "c2s_b", ["std.fs.read", "c2s_path"]],
        ["let", "s2c_b", ["std.fs.read", "s2c_path"]],
        ["let", "c2s", ["bytes.view", "c2s_b"]],
        ["let", "s2c", ["bytes.view", "s2c_b"]],
        ["let", "c2s_n", ["view.len", "c2s"]],
        ["let", "s2c_n", ["view.len", "s2c"]],
        ["let", "c2s_pos", 0],
        ["let", "s2c_pos", 0],
        ["let", "state", 0],
        [
          "for",
          "_",
          0,
          ["+", "c2s_n", 1],
          [
            "if",
            ["<u", "c2s_pos", "c2s_n"],
            [
              "begin",
              ["let", "rest_len", ["-", "c2s_n", "c2s_pos"]],
              ["let", "rest", ["view.slice", "c2s", "c2s_pos", "rest_len"]],
              ["let", "idx", ["std.bytes.find_u8", "rest", 10]],
              ["let", "line_len", ["if", [">=", "idx", 0], "idx", "rest_len"]],
              ["let", "line", ["view.slice", "c2s", "c2s_pos", "line_len"]],
              ["set", "c2s_pos", ["if", [">=", "idx", 0], ["+", "c2s_pos", ["+", "idx", 1]], "c2s_n"]],
              [
                "if",
                [">", "line_len", 0],
                [
                  "begin",
                  [
                    "let",
                    "step_res",
                    [
                      "std.mcp.toolkit.stdio_dispatch.dispatch_line_v1",
                      "state",
                      ["bytes.view", "cfg_pv"],
                      ["bytes.view", "server_name"],
                      ["bytes.view", "server_version"],
                      ["bytes.view", "tools_json"],
                      "line"
                    ]
                  ],
                  ["try", ["std.test.assert_i32_eq", ["result_bytes.err_code", "step_res"], 0, ["std.test.code_assert_i32_eq"]]],
                  ["let", "step", ["result_bytes.unwrap_or", "step_res", ["bytes.alloc", 0]]],
                  ["let", "kind", ["std.mcp.toolkit.stdio_dispatch.step_kind_v1", ["bytes.view", "step"]]],
                  ["let", "next_state", ["std.mcp.toolkit.stdio_dispatch.step_next_state_v1", ["bytes.view", "step"]]],
                  [
                    "try",
                    [
                      "std.test.assert_i32_eq",
                      [
                        "if",
                        ["if", ["=", "kind", 0], 1, ["if", ["=", "kind", 1], 1, ["=", "kind", 2]]],
                        1,
                        0
                      ],
                      1,
                      ["std.test.code_assert_i32_eq"]
                    ]
                  ],
                  ["try", ["std.test.assert_i32_eq", ["<", "next_state", 0], 0, ["std.test.code_assert_i32_eq"]]],
                  ["set", "state", "next_state"],
                  [
                    "if",
                    ["=", "kind", 1],
                    [
                      "begin",
                      ["let", "got", ["std.mcp.toolkit.stdio_dispatch.step_resp_json_v1", ["bytes.view", "step"]]],
                      ["try", ["std.test.assert_i32_eq", [">", ["bytes.len", "got"], 0], 1, ["std.test.code_assert_i32_eq"]]],
                      ["try", ["std.test.assert_i32_eq", ["<u", "s2c_pos", "s2c_n"], 1, ["std.test.code_assert_i32_eq"]]],
                      ["let", "exp_rest_len", ["-", "s2c_n", "s2c_pos"]],
                      ["let", "exp_rest", ["view.slice", "s2c", "s2c_pos", "exp_rest_len"]],
                      ["let", "exp_idx", ["std.bytes.find_u8", "exp_rest", 10]],
                      ["let", "exp_line_len", ["if", [">=", "exp_idx", 0], "exp_idx", "exp_rest_len"]],
                      ["let", "exp_line", ["view.slice", "s2c", "s2c_pos", "exp_line_len"]],
                      ["set", "s2c_pos", ["if", [">=", "exp_idx", 0], ["+", "s2c_pos", ["+", "exp_idx", 1]], "s2c_n"]],
                      ["let", "exp_canon", ["ext.json.canon.canonicalize", "exp_line"]],
                      ["try", ["std.test.assert_i32_eq", [">", ["bytes.len", "exp_canon"], 0], 1, ["std.test.code_assert_i32_eq"]]],
                      ["try", ["std.test.assert_bytes_eq", "got", "exp_canon", ["std.test.code_assert_bytes_eq"]]],
                      0
                    ],
                    0
                  ],
                  [
                    "if",
                    ["=", "kind", 2],
                    [
                      "begin",
                      ["let", "id_json", ["std.mcp.toolkit.stdio_dispatch.step_tool_call_id_json_v1", ["bytes.view", "step"]]],
                      ["let", "tool_name", ["std.mcp.toolkit.stdio_dispatch.step_tool_call_tool_name_v1", ["bytes.view", "step"]]],
                      ["let", "args_json", ["std.mcp.toolkit.stdio_dispatch.step_tool_call_args_json_v1", ["bytes.view", "step"]]],
                      ["try", ["std.test.assert_i32_eq", [">", ["bytes.len", "id_json"], 0], 1, ["std.test.code_assert_i32_eq"]]],
                      ["try", ["std.test.assert_i32_eq", [">", ["bytes.len", "tool_name"], 0], 1, ["std.test.code_assert_i32_eq"]]],
                      ["try", ["std.test.assert_i32_eq", [">", ["bytes.len", "args_json"], 0], 1, ["std.test.code_assert_i32_eq"]]],
                      ["let", "req_json", ["std.mcp.sandbox.worker_proto.make_request_v1", ["bytes.view", "tool_name"], ["bytes.view", "cfg_json"], ["bytes.view", "args_json"], ["bytes.view", "tools_json"]]],
                      ["try", ["std.test.assert_i32_eq", [">", ["bytes.len", "req_json"], 0], 1, ["std.test.code_assert_i32_eq"]]],
                      ["let", "worker_resp", ["std.mcp.sandbox.worker_main.run_v1", ["bytes.view", "req_json"]]],
                      ["try", ["std.test.assert_i32_eq", [">", ["bytes.len", "worker_resp"], 0], 1, ["std.test.code_assert_i32_eq"]]],
                      ["let", "tr_res", ["std.mcp.sandbox.worker_proto.parse_tool_result_v1", ["bytes.view", "worker_resp"]]],
                      ["try", ["std.test.assert_i32_eq", ["result_bytes.err_code", "tr_res"], 0, ["std.test.code_assert_i32_eq"]]],
                      ["let", "tool_result", ["result_bytes.unwrap_or", "tr_res", ["bytes.alloc", 0]]],
                      ["try", ["std.test.assert_i32_eq", [">", ["bytes.len", "tool_result"], 0], 1, ["std.test.code_assert_i32_eq"]]],
                      ["let", "got", ["std.mcp.jsonrpc.make_result_response_v1", ["bytes.view", "id_json"], ["bytes.view", "tool_result"]]],
                      ["try", ["std.test.assert_i32_eq", [">", ["bytes.len", "got"], 0], 1, ["std.test.code_assert_i32_eq"]]],
                      ["try", ["std.test.assert_i32_eq", ["<u", "s2c_pos", "s2c_n"], 1, ["std.test.code_assert_i32_eq"]]],
                      ["let", "exp_rest_len", ["-", "s2c_n", "s2c_pos"]],
                      ["let", "exp_rest", ["view.slice", "s2c", "s2c_pos", "exp_rest_len"]],
                      ["let", "exp_idx", ["std.bytes.find_u8", "exp_rest", 10]],
                      ["let", "exp_line_len", ["if", [">=", "exp_idx", 0], "exp_idx", "exp_rest_len"]],
                      ["let", "exp_line", ["view.slice", "s2c", "s2c_pos", "exp_line_len"]],
                      ["set", "s2c_pos", ["if", [">=", "exp_idx", 0], ["+", "s2c_pos", ["+", "exp_idx", 1]], "s2c_n"]],
                      ["let", "exp_canon", ["ext.json.canon.canonicalize", "exp_line"]],
                      ["try", ["std.test.assert_i32_eq", [">", ["bytes.len", "exp_canon"], 0], 1, ["std.test.code_assert_i32_eq"]]],
                      ["try", ["std.test.assert_bytes_eq", "got", "exp_canon", ["std.test.code_assert_bytes_eq"]]],
                      0
                    ],
                    0
                  ],
                  0
                ],
                0
              ],
              0
            ],
            0
          ]
        ],
        ["try", ["std.test.assert_i32_eq", "s2c_pos", "s2c_n", ["std.test.code_assert_i32_eq"]]],
        ["std.test.pass"]
      ]
    },
    {
      "kind": "defn",
      "name": "std.mcp.rr.session.wrap_stdio_with_rr_v1",
      "params": [{ "name": "cfg_json", "ty": "bytes_view" }],
      "result": "bytes",
      "body": ["view.to_bytes", "cfg_json"]
    },
    {
      "kind": "defn",
      "name": "std.mcp.rr.session.sanitize_cassette_v1",
      "params": [{ "name": "raw_jsonl", "ty": "bytes_view" }],
      "result": "bytes",
      "body": ["std.mcp.rr.sanitize.sanitize_jsonl_v1", "raw_jsonl"]
    }
  ]
}
